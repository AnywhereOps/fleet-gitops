- name: CDK - Parent Missing From Disk Linux
  description: 'A program where the parent PID is not on disk Reveals boopkit if a
    child is spawned TODO: Make mount namespace aware'
  query: "SELECT -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS\
    \ p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS\
    \ p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  p1.path AS p1_path,\n\
    \  REGEX_MATCH (p1.path, '(.*)/', 1) AS p1_dirname,\n  p1.name AS p1_name,\n \
    \ p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent\
    \ AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN hash p0_hash\
    \ ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2\
    \ ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p1.on_disk != 1\n  AND p0.on_disk = 1\n  AND NOT p0.pid IN (1, 2)\n \
    \ AND NOT p1.pid IN (1, 2) -- launchd, kthreadd\n  -- Probably a software upgrade\n\
    \  AND NOT p1_dirname IN (\n    '/opt/google/chrome',\n    '/opt/microsoft/msedge',\n\
    \    '/usr/bin',\n    '/usr/lib',\n    '/usr/lib/electron22',\n    '/usr/lib/go/bin',\n\
    \    '/usr/lib/systemd',\n    '/usr/libexec',\n    '/usr/sbin',\n    '/usr/sbin/gdm3',\n\
    \    '/usr/share/code',\n    '/usr/share/codium'\n  ) -- long-running launchers\n\
    \  AND NOT p1.name IN (\n    'bash',\n    'chrome',\n    'dnf',\n    'Docker Desktop',\n\
    \    'electron',\n    'fish',\n    'gnome-shell',\n    'gnome-terminal',\n   \
    \ 'kube-proxy',\n    'kubelet',\n    'lightdm',\n    'make',\n    'ninja',\n \
    \   'nvim',\n    'sh',\n    'slack',\n    'zed-editor'\n  )\n  AND NOT (\n   \
    \ p1.path LIKE '/app/%'\n    AND p1.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/%'\n\
    \  )\n  AND NOT (\n    p1.path LIKE '/home/build/%'\n    AND p1.cgroup_path LIKE\
    \ '/user.slice/user-1000.slice/user@1000.service/app.slice/%'\n  )\n  AND NOT\
    \ p2.name = 'bwrap'\n  AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'\n\
    \  AND p1.cgroup_path NOT IN (\n    '/system.slice/containerd.service',\n    '/system.slice/docker.service',\n\
    \    '/system.slice/gdm.service'\n  )\n  AND p1.cgroup_path NOT LIKE '/lxc.monitor.n%'\n\
    \  AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-steam@%'\n\
    \  AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'\n\
    \  AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \  AND p1.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%'\n\
    \  AND p1.path NOT LIKE '/opt/homebrew/Cellar/%'\n  AND p1.path NOT LIKE '/tmp/.mount_%/%'\n\
    \  AND p1.path NOT LIKE '%google-cloud-sdk/.install/.backup%'\n  AND NOT (\n \
    \   p1.name LIKE 'kworker/%+events_unbound'\n    AND p0.name IN ('modprobe')\n\
    \  )\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
