- name: CDK - Missing From Disk Linux
  description: Processes that do not exist on disk, running in osquery's namespace
  query: "SELECT\n  p.pid,\n  p.euid,\n  p.cmdline,\n  p.path,\n  p.cgroup_path,\n\
    \  mnt_namespace,\n  p.cwd,\n  p.on_disk,\n  p.state,\n  file.inode,\n  pp.on_disk\
    \ AS parent_on_disk,\n  pp.path AS parent_path,\n  pp.cmdline AS parent_cmdline,\n\
    \  pp.cwd AS parent_cwd,\n  ph.sha256 AS parent_sha256\nFROM\n  processes p\n\
    \  LEFT JOIN file ON p.path = file.path\n  LEFT JOIN process_namespaces ON p.pid\
    \ = process_namespaces.pid\n  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT\
    \ JOIN hash ph ON pp.path = ph.path\nWHERE\n  p.on_disk != 1\n  AND p.path !=\
    \ ''\n  AND p.start_time < (strftime('%s', 'now') - 3600)\n  -- use osquery as\
    \ the reference mount namespace\n  AND mnt_namespace IN (\n    SELECT DISTINCT\n\
    \      (mnt_namespace)\n    FROM\n      process_namespaces\n      JOIN processes\
    \ ON processes.pid = process_namespaces.pid\n    WHERE\n      processes.name IN\
    \ ('osqueryi', 'osqueryd')\n  )\n  -- This is truly a missing program, not just\
    \ one that has been updated with a new binary.\n  AND file.inode IS NULL\n  AND\
    \ p.path != '/bpfilter_umh'\n  -- Snap packages?\n  AND p.path NOT LIKE '/home/%/.cache/yay/1password-cli/pkg/1password-cli/usr/bin/op'\n\
    \  AND p.path NOT LIKE '/tmp/.mount_%'\n  -- Probably just an upgrade\n  AND p.path\
    \ NOT LIKE '/opt/%'\n  AND p.path NOT LIKE '/usr/bin/%'\n  AND p.path NOT LIKE\
    \ '/usr/sbin/%'\n  AND p.path NOT LIKE '/home/%/.local/share/firefoxpwa/runtime%/firefox-bin'\n\
    \  AND p.path NOT IN (\n    '/usr/lib/firefox/firefox-bin',\n    '/usr/lib64/firefox/firefox'\n\
    \  )\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
