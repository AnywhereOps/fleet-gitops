- name: CDK - Unexpected Tmp Executables Linux
  description: Find unexpected executables in temp directories, often used by malware
    droppers
  query: "SELECT DISTINCT\n  file.path,\n  uid,\n  gid,\n  mode,\n  REGEX_MATCH (file.filename,\
    \ '.*\\.(.*?)$', 1) AS extension,\n  file.btime,\n  file.ctime,\n  file.mtime,\n\
    \  file.size,\n  hash.sha256,\n  magic.data\nFROM\n  file\n  LEFT JOIN hash on\
    \ file.path = hash.path\n  LEFT JOIN magic ON file.path = magic.path\nWHERE --\
    \ Optimization: don't join things until we have a whittled down list of files\n\
    \  file.path IN (\n    SELECT DISTINCT\n      path\n    FROM\n      file\n   \
    \ WHERE\n      (\n        file.directory = '/tmp'\n        OR file.directory LIKE\
    \ '/tmp/.%'\n      ) -- Prevent weird recursion\n      AND NOT file.directory\
    \ LIKE '%/../%'\n      AND NOT file.directory LIKE '%/./%' -- Exclude very temporary\
    \ files\n      AND NOT (strftime('%s', 'now') - ctime) < 60 -- Only executable\
    \ files\n      AND file.type = 'regular'\n      AND (\n        file.mode LIKE\
    \ '%7%'\n        or file.mode LIKE '%5%'\n        or file.mode LIKE '%1%'\n  \
    \    )\n      AND NOT (\n        uid > 500\n        AND (\n          file.path\
    \ LIKE '%/go-build%'\n          OR file.directory LIKE '/tmp/%/out'\n        \
    \  OR file.path IN ('/tmp/mission', '/tmp/mkinitramfs')\n          OR file.path\
    \ LIKE '/tmp/GoLand/___go_build_%_go'\n          OR file.path LIKE '/tmp/ko%/out'\n\
    \          OR file.path LIKE '/tmp/lima/%/out/%'\n          OR file.path LIKE\
    \ '/tmp/wolfi%'\n          OR file.path LIKE '%-release%/%'\n          OR file.path\
    \ LIKE '%/bin/%'\n          OR file.path LIKE '/tmp/%.sh'\n          OR file.path\
    \ LIKE '%/checkout/%'\n          OR file.path LIKE '%/ci/%'\n          OR file.path\
    \ LIKE '%/configure'\n          OR file.path LIKE '%/debug/%'\n          OR file.path\
    \ LIKE '%/dist/%'\n          OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'\n\
    \          OR file.path LIKE '%/git/%'\n          OR file.path LIKE '%/github/%'\n\
    \          OR file.path LIKE '%/go.%.sum'\n          OR file.path LIKE '%/guile-%/guile-%'\n\
    \          OR file.path LIKE '%/ko/%'\n          OR file.path LIKE '%/kots/%'\n\
    \          OR file.path LIKE '%/melange-guest-%'\n          OR file.path LIKE\
    \ '%/pdf-tools/%'\n          OR file.path LIKE '%/Rakefile'\n          OR file.path\
    \ LIKE '%/site-packages/markupsafe/_speedups.cpython-%'\n          OR file.path\
    \ LIKE '%/src/%'\n          OR file.path LIKE '%/target/%'\n          OR file.path\
    \ LIKE '%/terraformer/%'\n          OR file.path LIKE '%/tmp/epdf%'\n        \
    \  OR file.path LIKE '%integration_test%'\n          OR file.path LIKE '%test_script'\n\
    \          OR file.path LIKE \"/tmp/lima/%\"\n          OR file.path LIKE \"%/%/gradlew\"\
    \n          OR file.path LIKE \"%/bin/bash\"\n          OR file.path LIKE \"%/bin/busybox\"\
    \n          OR file.path LIKE \"%/lib/%.so.%\"\n          OR file.path LIKE \"\
    %/lib/%.so\"\n          OR file.path LIKE \"%/melange%\"\n        )\n      )\n\
    \      AND NOT (\n        file.path LIKE \"%/lib/%.so\"\n        OR file.path\
    \ LIKE '/tmp/staged-updates%launcher'\n        OR file.path LIKE \"%/bin/bash\"\
    \n        OR file.path LIKE \"%/bin/busybox\"\n        OR file.path LIKE \"%/lib/%.so.%\"\
    \n        OR file.path LIKE \"%/lib64/%.so.%\"\n        OR file.path LIKE \"%/lib64/%.so\"\
    \n        OR file.path LIKE \"%/melange%\"\n        OR file.path LIKE \"%/sbin/%\"\
    \n      )\n      -- Nix\n      AND NOT (\n        file.directory LIKE '/tmp/tmp%'\n\
    \        AND gid = 0\n        AND uid > 300\n        AND uid < 350\n      ) --\
    \ Babel\n      AND NOT (\n        file.directory LIKE '/tmp/babel-%/sh-script-%'\n\
    \        AND gid > 900\n        AND uid = 1000\n        AND size < 1024\n    \
    \  ) -- Random Testdata\n      AND NOT (\n        gid > 900\n        AND uid =\
    \ 1000\n        AND (\n          file.directory LIKE '/tmp/%/test'\n         \
    \ OR file.directory LIKE '/tmp/%/testdata'\n        )\n      ) -- Don't alert\
    \ if the file is only on disk for a moment\n      AND NOT (\n        uid > 500\n\
    \        AND file.path LIKE '/tmp/terraform_%/terraform'\n      )\n      AND NOT\
    \ (\n        file.path LIKE '/tmp/%compressed'\n        AND size < 4000\n    \
    \    AND uid > 500\n      ) -- Executables too small to even hold '#!/bin/sh\\\
    nuid'\n      AND NOT (\n        file.type = 'regular'\n        AND size < 10\n\
    \      ) -- Weird cert\n      AND NOT (\n        file.path LIKE '/tmp/tmp.%/ssl/default-fake-certificate.pem'\n\
    \        AND file.size < 4096\n      ) -- Binaries we might actually see legitimately\n\
    \      AND NOT (\n        file.path LIKE '/tmp/%'\n        AND file.uid > 500\n\
    \        AND (\n          file.filename LIKE \"%ctl\"\n          OR file.filename\
    \ LIKE \"%adm\"\n          OR file.filename LIKE \"%-cli\"\n          OR file.filename\
    \ LIKE '.org.chromium.Chromium.%'\n          OR file.filename = \"a.out\"\n  \
    \      )\n      )\n      AND NOT (\n        file.directory LIKE \"%/lib\"\n  \
    \      OR file.directory LIKE \"%/lib64\"\n        AND file.uid > 500\n      \
    \  AND (\n          file.filename LIKE \"%.so.%\"\n          OR file.filename\
    \ LIKE \"%.so\"\n        )\n      )\n  ) -- All checks with magic.data must first\
    \ check for a lack of NULL value,\n  -- otherwise you filter out platforms without\
    \ magic.data.\n  AND NOT (\n    file.uid > 500\n    AND magic.data IS NOT NULL\n\
    \    AND (\n      magic.data IN (\n        \"POSIX shell script, ASCII text executable\"\
    ,\n        \"Bourne-Again shell script, ASCII text executable\",\n        \"libtool\
    \ library file, ASCII text\",\n        \"ASCII text\",\n        \"JSON data\"\
    ,\n        \"JSON text data\"\n      )\n      OR magic.data LIKE 'ELF 32-bit LSB\
    \ pie executable, ARM, EABI5%'\n      OR magic.data LIKE 'ELF 64-bit MSB pie executable,\
    \ IBM S/390%'\n      OR magic.data LIKE 'Linux kernel %'\n      OR magic.data\
    \ LIKE 'symbolic link to %'\n      OR magic.data LIKE \"ELF 64-bit LSB shared\
    \ object,%\"\n      OR magic.data LIKE \"gzip compressed data%\" -- Exotic platforms\n\
    \      OR magic.data LIKE \"Unicode text%\"\n    )\n  )\n  AND NOT (\n    file.uid\
    \ = 0\n    AND magic.data IS NOT NULL\n    AND (\n      magic.data LIKE 'symbolic\
    \ link to %'\n      OR magic.data IN (\n        \"ELF 64-bit LSB pie executable,\
    \ x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1,\
    \ stripped\",\n        \"libtool library file, ASCII text\"\n      )\n    )\n\
    \  )\n  AND NOT (\n    file.size < 65000\n    AND file.uid > 500\n    AND file.filename\
    \ LIKE \"%.%\"\n    AND extension IN (\n      'adoc',\n      'api',\n      'authn',\n\
    \      'bat',\n      'erb',\n      'iam',\n      'java',\n      'js',\n      'json',\n\
    \      'log',\n      'nib',\n      'pem',\n      'perl',\n      'pl',\n      'pub',\n\
    \      'py',\n      'rb',\n      'registry',\n      'script',\n      'sh',\n \
    \     'strings',\n      'txt',\n      'yaml',\n      'yml'\n    )\n  )\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
