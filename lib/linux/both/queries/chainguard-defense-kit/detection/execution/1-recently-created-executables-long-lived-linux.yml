- name: CDK - Recently Created Executables Long Lived Linux
  description: 'Long-running programs who were recently added to disk, based on btime/ctime
    false-positives: * many'
  query: "SELECT\n  f.ctime AS p0_ctime,\n  f.mtime AS p0_mtime,\n  p0.start_time\
    \ - MAX(f.ctime, f.btime) AS p0_start_delay,\n  -- Child\n  p0.pid AS p0_pid,\n\
    \  p0.path AS p0_path,\n  p0.start_time AS p0_start,\n  p0.name AS p0_name,\n\
    \  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.start_time AS p1_start,\n  p1.name AS\
    \ p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS\
    \ p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.start_time AS p2_start,\n\
    \  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256\
    \ AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n\
    \  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1\
    \ ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  p0.start_time > 0\n  AND f.ctime > 0\n  AND p0.start_time\
    \ < (strftime('%s', 'now') - 86400)\n  AND (p0.start_time - MAX(f.ctime, f.btime))\
    \ < 300\n  AND p0.start_time >= MAX(f.ctime, f.ctime)\n  AND NOT f.directory IN\
    \ ('/usr/lib/firefox', '/usr/local/kolide-k2/bin') -- Typically daemons or long-running\
    \ desktop apps\n  -- These are binaries that are known to get updated and subsequently\
    \ executed\n  --\n  -- What I would give for osquery to support binary signature\
    \ verification on Linux\n  AND NOT p0.path IN (\n    '',\n    '/bin/bash',\n \
    \   '/bin/containerd',\n    '/bin/containerd-shim-runc-v2',\n    '/bin/sh',\n\
    \    '/opt/google/chrome/chrome',\n    '/opt/google/chrome/chrome_crashpad_handler',\n\
    \    '/opt/google/chrome/nacl_helper',\n    '/opt/kolide-k2/bin/launcher',\n \
    \   '/opt/kolide-k2/bin/osqueryd',\n    '/opt/Lens/chrome_crashpad_handler',\n\
    \    '/opt/Lens/lens',\n    '/opt/sublime_text/sublime_text',\n    '/usr/lib/at-spi-bus-launcher',\n\
    \    '/usr/lib/at-spi2-registryd',\n    '/usr/lib/cups/notifier/dbus',\n    '/usr/lib/docker/cli-plugins/docker-compose',\n\
    \    '/usr/lib/electron25/electron',\n    '/usr/lib/flatpak-session-helper',\n\
    \    '/usr/lib/fwupd/fwupd',\n    '/usr/lib/gdm',\n    '/usr/lib/gdm-session-worker',\n\
    \    '/usr/lib/gdm-x-session',\n    '/usr/lib/gnome-shell-calendar-server',\n\
    \    '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin/python3',\n   \
    \ '/usr/lib/ibus/ibus-dconf',\n    '/usr/lib/ibus/ibus-engine-simple',\n    '/usr/lib/ibus/ibus-portal',\n\
    \    '/usr/lib/libreoffice/program/oosplash',\n    '/usr/lib/libreoffice/program/soffice.bin',\n\
    \    '/usr/lib/opt/google/chrome/chrome',\n    '/usr/lib/opt/kolide-k2/bin/launcher',\n\
    \    '/usr/lib/opt/kolide-k2/bin/osqueryd',\n    '/usr/lib/polkit-1/polkitd',\n\
    \    '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1',\n    '/usr/lib/slack/chrome_crashpad_handler',\n\
    \    '/usr/lib/slack/slack',\n    '/usr/lib/snapd/snapd',\n    '/usr/lib/systemd/systemd',\n\
    \    '/usr/lib/systemd/systemd-executor',\n    '/usr/lib/systemd/systemd-homed',\n\
    \    '/usr/lib/systemd/systemd-hostnamed',\n    '/usr/lib/systemd/systemd-journald',\n\
    \    '/usr/lib/systemd/systemd-logind',\n    '/usr/lib/systemd/systemd-machined',\n\
    \    '/usr/lib/systemd/systemd-oomd',\n    '/usr/lib/systemd/systemd-resolved',\n\
    \    '/usr/lib/systemd/systemd-timesyncd',\n    '/usr/lib/systemd/systemd-userdbd',\n\
    \    '/usr/lib/systemd/systemd-userwork',\n    '/usr/lib/tracker-extract-3',\n\
    \    '/usr/lib/upowerd',\n    '/usr/lib/x86_64-linux-gnu/obs-plugins/obs-browser-page',\n\
    \    '/usr/lib/xdg-desktop-portal-gtk',\n    '/usr/lib/xf86-video-intel-backlight-helper',\n\
    \    '/usr/lib/xorg/Xorg',\n    '/usr/lib64/discord/Discord',\n    '/usr/lib64/electron/electron',\n\
    \    '/usr/lib64/firefox/firefox',\n    '/usr/lib64/google-cloud-sdk/platform/bundledpythonunix/bin/python3',\n\
    \    '/usr/lib64/thunderbird/thunderbird',\n    '/usr/libexec/accounts-daemon',\n\
    \    '/usr/libexec/bluetooth/bluetoothd',\n    '/usr/libexec/docker/docker-proxy',\n\
    \    '/usr/libexec/flatpak-portal',\n    '/usr/libexec/flatpak-system-helper',\n\
    \    '/usr/libexec/fwupd/fwupd',\n    '/usr/libexec/gdm-session-worker',\n   \
    \ '/usr/libexec/gdm-wayland-session',\n    '/usr/libexec/gnome-shell-calendar-server',\n\
    \    '/usr/libexec/gstreamer-1.0/gst-plugin-scanner',\n    '/usr/libexec/gvfsd-dnssd',\n\
    \    '/usr/libexec/gvfsd-metadata',\n    '/usr/libexec/gvfsd-network',\n    '/usr/libexec/gvfsd-recent',\n\
    \    '/usr/libexec/gvfsd-wsdd',\n    '/usr/libexec/ibus-dconf',\n    '/usr/libexec/ibus-engine-simple',\n\
    \    '/usr/libexec/ibus-extension-gtk3',\n    '/usr/libexec/ibus-portal',\n  \
    \  '/usr/libexec/ibus-x11',\n    '/usr/libexec/power-profiles-daemon',\n    '/usr/libexec/snapd/snapd',\n\
    \    '/usr/libexec/sssd/sssd_kcm',\n    '/usr/libexec/tracker-extract-3',\n  \
    \  '/usr/libexec/tracker-miner-fs-3',\n    '/usr/libexec/xdg-desktop-portal',\n\
    \    '/usr/libexec/xdg-document-portal',\n    '/usr/libexec/xdg-permission-store',\n\
    \    '/usr/local/bin/kind',\n    '/usr/sbin/dnsmasq',\n    '/usr/share/code/chrome_crashpad_handler',\n\
    \    '/usr/share/code/code',\n    '/usr/share/codium/chrome-sandbox',\n    '/usr/share/codium/codium',\n\
    \    '/usr/share/librewolf/librewolf',\n    '/usr/share/spotify-client/spotify',\n\
    \    '/usr/share/teams/team'\n  )\n  AND NOT p0.path LIKE '/home/%/.cache/JetBrains/%/GoLand/___%'\n\
    \  AND NOT p0.path LIKE '/home/%/.local/share/JetBrains/Toolbox/apps/%'\n  AND\
    \ NOT p0.path LIKE '/home/%/.local/share/nvim/mason/packages/%'\n  AND NOT p0.path\
    \ LIKE '/home/%/.local/share/Steam/ubuntu%'\n  AND NOT p0.path LIKE '/home/%/.rustup/toolchains/%/libexec/%'\n\
    \  AND NOT p0.path LIKE '/home/%/%.test'\n  AND NOT p0.path LIKE '/home/%/bin/%'\n\
    \  AND NOT p0.path LIKE '/home/%/.cache/JetBrains/%'\n  AND NOT p0.path LIKE '/home/%/.local/share/JetBrains/%'\n\
    \  AND NOT p0.path LIKE '/home/%/git/%'\n  AND NOT p0.path LIKE '/home/%/jbr/bin/java'\n\
    \  AND NOT p0.path LIKE '/home/%/jbr/lib/jcef_helper'\n  AND NOT p0.path LIKE\
    \ '/home/%/node_modules/.bin/%'\n  AND NOT p0.path LIKE '/home/%/Projects/%'\n\
    \  AND NOT p0.path LIKE '/home/%/terraform-provider-%'\n  AND NOT p0.path LIKE\
    \ '/home/%/upstream/%'\n  AND NOT p0.path LIKE '/nix/store/%/bin/%'\n  AND NOT\
    \ p0.path LIKE '/nix/store/%/libexec/%'\n  AND NOT p0.path LIKE '/opt/%'\n  AND\
    \ NOT p0.path LIKE '/tmp/go-build%'\n  AND NOT p0.path LIKE '/tmp/terraform_%/terraform'\n\
    \  AND NOT p0.path LIKE '/tmp/tmp0.%/%/bin/%'\n  AND NOT p0.path LIKE '/usr/local/bin/%'\n\
    \  AND NOT p0.path LIKE '/usr/local/Cellar/%'\n  AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/launcher'\n\
    \  AND NOT p0.path LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'\n\
    \  AND NOT p0.path LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'\n  AND NOT p0.path\
    \ LIKE '/var/kolide-k2/%/launcher'\n  AND NOT p0.path LIKE '/var/kolide-k2/%/osqueryd'\n\
    \  AND NOT p0.path LIKE '/var/opt/Elastic/Agent/data/elastic-agent-%/components/%'\n\
    \  AND NOT p0.path LIKE '%/.local/share/spotify-launcher/install/usr/%'\n  AND\
    \ NOT p0.path LIKE '%/.vscode/extensions/%'\n  AND NOT p0.path LIKE '%/gitstatus/gitstatusd-linux-x86_64'\n\
    \  AND NOT (\n    p0.name IN ('osqtool-x86_64', 'osqtool-arm64')\n    AND p0.cmdline\
    \ LIKE './%'\n  )\n  AND NOT p1.path IN ('/usr/bin/gnome-shell') -- Filter out\
    \ developers working on their own code\n  AND NOT p1.name IN ('makepkg', 'make',\
    \ 'dovecot')\n  AND NOT p2.path = '/usr/bin/yay'\n  AND NOT p2.cmdline LIKE '/usr/bin/yay\
    \ %'\n  AND NOT (\n    f.directory IN ('/usr/bin', '/usr/sbin')\n    AND f.filename\
    \ NOT LIKE '.%'\n  )\n  AND NOT (\n    p0.path LIKE '/home/%'\n    AND p0.uid\
    \ > 499\n    AND f.ctime = f.mtime\n    AND f.uid = p0.uid\n    AND p0.cmdline\
    \ LIKE './%'\n    AND p0.path NOT LIKE '%/.%'\n    AND p0.path NOT LIKE '%cache%'\n\
    \  )\n  AND NOT (\n    p0.path LIKE '/tmp/%/osqtool-%'\n    AND p0.uid > 499\n\
    \    AND f.ctime = f.mtime\n    AND f.uid = p0.uid\n    AND p0.cmdline LIKE './%'\n\
    \  )\n  AND NOT (\n    p0.path LIKE '/home/%/.magefile/%'\n    AND p0.uid > 499\n\
    \    AND f.ctime = f.mtime\n    AND f.uid = p0.uid\n  )\nGROUP BY\n  p0.pid\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
