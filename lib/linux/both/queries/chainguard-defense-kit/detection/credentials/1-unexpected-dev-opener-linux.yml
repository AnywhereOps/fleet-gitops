- name: CDK - Unexpected Dev Opener Linux
  description: Detects unexpected programs opening files in /dev on Linux
  query: "SELECT\n  pof.path AS device,\n  CONCAT (\n    IIF(\n      REGEX_MATCH (\n\
    \        TRIM(REPLACE(pof.path, ' (deleted)', '')),\n        '(/dev/.*)[\\d ]+$',\n\
    \        1\n      ) != '',\n      REGEX_MATCH (\n        TRIM(REPLACE(pof.path,\
    \ ' (deleted)', '')),\n        '(/dev/.*)[\\d ]+$',\n        1\n      ),\n   \
    \   TRIM(REPLACE(pof.path, ' (deleted)', ''))\n    ),\n    ',',\n    REPLACE(\n\
    \      p0.path,\n      RTRIM(p0.path, REPLACE(p0.path, '/', '')),\n      ''\n\
    \    )\n  ) AS path_exception,\n  CONCAT (\n    TRIM(\n      REPLACE(\n      \
    \  pof.path,\n        CONCAT (\n          '/',\n          REPLACE(\n         \
    \   pof.path,\n            RTRIM(pof.path, REPLACE(pof.path, '/', '')),\n    \
    \        ''\n          )\n        ),\n        ''\n      )\n    ),\n    ',',\n\
    \    REPLACE(\n      p0.path,\n      RTRIM(p0.path, REPLACE(p0.path, '/', '')),\n\
    \      ''\n    )\n  ) AS dir_exception,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.start_time\
    \ AS p0_start,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS\
    \ p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n\
    \  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path\
    \ AS p1_path,\n  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n\
    \  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n \
    \ p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  process_open_files pof\n\
    \  LEFT JOIN processes p0 ON pof.pid = p0.pid\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  pof.path LIKE '/dev/%'\n  AND pof.path NOT IN (\n \
    \   '/dev/console',\n    '/dev/dri/card0',\n    '/dev/dri/card1',\n    '/dev/dri/card2',\n\
    \    '/dev/dri/renderD128',\n    '/dev/dri/renderD129',\n    '/dev/fuse',\n  \
    \  '/dev/io8log',\n    '/dev/io8logmt',\n    '/dev/io8logtemp',\n    '/dev/null',\n\
    \    '/dev/nvidia-modeset',\n    '/dev/nvidia-uvm',\n    '/dev/nvidia0',\n   \
    \ '/dev/nvidiactl',\n    '/dev/ptmx',\n    '/dev/pts/ptmx',\n    '/dev/random',\n\
    \    '/dev/rfkill',\n    '/dev/shm/u1000-ValveIPCSharedObj-Steam',\n    '/dev/snd/seq',\n\
    \    '/dev/udmabuf',\n    '/dev/urandom',\n    '/dev/vga_arbiter',\n    '/dev/video10'\
    \ -- workaround for poor regex management (ffmpeg)\n  )\n  AND pof.path NOT LIKE\
    \ '/dev/hidraw%'\n  AND pof.path NOT LIKE '/dev/pts/%'\n  AND pof.path NOT LIKE\
    \ '/dev/shm/.com.google.Chrome.%'\n  AND pof.path NOT LIKE '/dev/shm/.org.chromium.Chromium.%'\n\
    \  AND pof.path NOT LIKE '/dev/snd/%'\n  AND pof.path NOT LIKE '/dev/tty%'\n \
    \ -- Zoom\n  AND pof.path NOT LIKE '/dev/shm/aomshm.%'\n  AND pof.path NOT LIKE\
    \ '/dev/shm/authentik_%'\n  AND NOT dir_exception IN (\n    '/dev,qemu-nbd',\n\
    \    '/dev/bus/usb,pcscd',\n    '/dev/input,acpid',\n    '/dev/input,gnome-shell',\n\
    \    '/dev/input,Hyprland',\n    '/dev/input,keyd',\n    '/dev/input,kwin_wayland',\n\
    \    '/dev/input,sway',\n    '/dev/input,systemd',\n    '/dev/input,systemd-logind',\n\
    \    '/dev/input,thermald',\n    '/dev/input,touchegg',\n    '/dev/input,upowerd',\n\
    \    '/dev/input,Xorg',\n    '/dev/net,.tailscaled-wrapped',\n    '/dev/net,tailscaled',\n\
    \    '/dev/net/tun,qemu-system-x86_64',\n    '/dev/shm,1password',\n    '/dev/shm,Brackets',\n\
    \    '/dev/shm,chrome',\n    '/dev/shm,code',\n    '/dev/shm,electron',\n    '/dev/shm,firefox',\n\
    \    '/dev/input/event,firefox',\n    '/dev/shm,gameoverlayui',\n    '/dev/shm,gopls',\n\
    \    '/dev/shm,hl2_linux',\n    '/dev/shm,Hyprland',\n    '/dev/shm,java',\n \
    \   '/dev/shm,jcef_helper',\n    '/dev/shm,Melvor Idle',\n    '/dev/shm,msedge',\n\
    \    '/dev/shm,osqueryd',\n    '/dev/shm,reaper',\n    '/dev/shm,slack',\n   \
    \ '/dev/shm,spotify',\n    '/dev/shm,steam',\n    '/dev/shm,steamwebhelper',\n\
    \    '/dev/shm,Tabletop Simulator.x86_64',\n    '/dev/shm,wine64-preloader',\n\
    \    '/dev/shm,winedevice.exe',\n    '/dev/shm,xdg-desktop-portal-hyprland',\n\
    \    '/dev/snd,.pulseaudio-wrapped',\n    '/dev/snd,alsactl',\n    '/dev/snd,pipewire',\n\
    \    '/dev/snd,pulseaudio',\n    '/dev/snd,wireplumber',\n    '/dev/usb,apcupsd',\n\
    \    '/dev/usb,upowerd'\n  )\n  AND NOT path_exception IN (\n    '/dev/autofs,systemd',\n\
    \    '/dev/console,agetty',\n    '/dev/console,busybox',\n    '/dev/cpu/0/msr,nvidia-powerd',\n\
    \    '/dev/drm_dp_aux,fwupd',\n    '/dev/fb,Xorg',\n    '/dev/hidraw,chrome',\n\
    \    '/dev/hvc,agetty',\n    '/dev/hwrng,rngd',\n    '/dev/input/event,thermald',\n\
    \    '/dev/input/event,touchegg',\n    '/dev/input/event,Xorg',\n    '/dev/input/event,sway',\n\
    \    '/dev/kmsg,bpfilter_umh',\n    '/dev/kmsg,dmesg',\n    '/dev/kmsg,k3s',\n\
    \    '/dev/kmsg,_k3s-inner',\n    '/dev/kmsg,kubelet',\n    '/dev/kmsg,systemd',\n\
    \    '/dev/kmsg,systemd-coredump',\n    '/dev/kmsg,systemd-journald',\n    '/dev/kvm,qemu-system-x86_64',\n\
    \    '/dev/mapper/control,dockerd',\n    '/dev/mapper/control,dmeventd',\n   \
    \ '/dev/mapper/control,gpartedbin',\n    '/dev/mapper/control,multipathd',\n \
    \   '/dev/mcelog,mcelog',\n    '/dev/media0,pipewire',\n    '/dev/media0,wireplumber',\n\
    \    '/dev/media,pipewire',\n    '/dev/media,wireplumber',\n    '/dev/nbd,qemu-nbd',\n\
    \    '/dev/net/tun,openvpn',\n    '/dev/net/tun,pasta.avx2',\n    '/dev/net/tun,qemu-system-x86_64',\n\
    \    '/dev/net/tun,slirp4netns',\n    '/dev/pts,incusd',\n    '/dev/sda,ntfs-3g',\n\
    \    '/dev/shm/envoy_shared_memory_1,envoy',\n    '/dev/tpmrm,launcher',\n   \
    \ '/dev/tty,agetty',\n    '/dev/tty,gdm-wayland-session',\n    '/dev/tty,gdm-x-session',\n\
    \    '/dev/tty,systemd-logind',\n    '/dev/tty,Xorg',\n    '/dev/udmabuf,gnome-shell-portal-helper',\n\
    \    '/dev/udmabuf,nautilus',\n    '/dev/udmabuf,xdg-desktop-portal-gnome',\n\
    \    '/dev/uhid,bluetoothd',\n    '/dev/uinput,bluetoothd',\n    '/dev/uinput,keyd',\n\
    \    '/dev/uinput,ydotoold',\n    '/dev/usb/hiddev,apcupsd',\n    '/dev/usb/hiddev,upowerd',\n\
    \    '/dev/vhost-net,qemu-system-x86_64',\n    '/dev/vhost-vsock,qemu-system-x86_64',\n\
    \    '/dev/video0,chrome',\n    '/dev/video,brave',\n    '/dev/video,cheese',\n\
    \    '/dev/video,chrome',\n    '/dev/video,dash',\n    '/dev/video,ffmpeg',\n\
    \    '/dev/video,firefox',\n    '/dev/video,firefox-bin',\n    '/dev/video,guvcview',\n\
    \    '/dev/video,msedge',\n    '/dev/video,obs',\n    '/dev/video,obs-ffmpeg-mux',\n\
    \    '/dev/video,pipewire',\n    '/dev/video,signal-desktop',\n    '/dev/video,slack',\n\
    \    '/dev/video,v4l2-relayd',\n    '/dev/video,vlc',\n    '/dev/video,wireplumber',\n\
    \    '/dev/video,zoom',\n    '/dev/video,zoom.real',\n    '/dev/wwan0mbim,mbim-proxy',\n\
    \    '/dev/zfs,',\n    '/dev/zfs,zed',\n    '/dev/zfs,zfs',\n    '/dev/zfs,zpool'\n\
    \  )\n  AND path_exception NOT LIKE '/dev/dm-%,qemu-system-%'\n  AND path_exception\
    \ NOT LIKE '/dev/bus/usb/%,scdaemon'\n  AND path_exception NOT LIKE '/dev/cpu_dma_latency,python%'\n\
    \  AND path_exception NOT LIKE '/dev/shm/%'\n  AND path_exception NOT LIKE '/dev/video%,chrome'\n\
    \  AND path_exception NOT LIKE '/dev/video%,chromium'\n  AND NOT (\n    pof.path\
    \ = \"/dev/uinput\"\n    AND p0.name LIKE \"solaar%\"\n    AND p0.path LIKE '/usr/bin/python%'\n\
    \  )\n  AND NOT (\n    pof.path LIKE \"/dev/input/event%\"\n    AND p0.name IN\
    \ (\"openrazer-daemo\", \"solaar\")\n  )\n  AND NOT (\n    pof.path LIKE '/dev/bus/usb/%'\n\
    \    AND p0.name IN (\n      'adb',\n      'fprintd',\n      'fwupd',\n      'gphoto2',\n\
    \      'gvfs-gphoto2-vo',\n      'gvfs-gphoto2-volume-monitor',\n      'gvfsd-gphoto2',\n\
    \      'gvfsd-mtp',\n      'pcscd',\n      'streamdeck',\n      'usbmuxd'\n  \
    \  )\n  )\nGROUP BY\n  pof.pid\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
