- name: CDK - Yara Exec Connect Process Linux
  description: 'Currently running program with Linux red flags reference: * bpfdoor
    (old)'
  query: "SELECT\n  yara.strings,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n\
    \  p0.name AS p0_name,\n  p0.start_time AS p0_start,\n  p0.cmdline AS p0_cmd,\n\
    \  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n\
    \  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path\
    \ AS p1_path,\n  p1.name AS p1_name,\n  p1.start_time AS p1_start,\n  p1.euid\
    \ AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n\
    \  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.start_time AS p2_start,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  JOIN yara ON p0.path = yara.path\n  LEFT JOIN hash p0_hash\
    \ ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2\
    \ ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p0.pid IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n\
    \      start_time > (strftime('%s', 'now') - 7200)\n      AND path != \"\"\n \
    \   GROUP BY\n      path\n  )\n  AND yara.sigrule = '\n    rule syscalls {\n \
    \   strings:\n        $inet_ntoa = \"inet_ntoa\"\n        $listen = \"listen\"\
    \n        $connect = \"connect\"\n        $execve = \"execve\"\n    condition:\n\
    \        filesize < 10MB and $execve in (0..8192) and 2 of them\n}'\n  AND yara.count\
    \ > 0\n  AND yara.path NOT IN (\n    '/usr/bin/dbus-broker-launch',\n    '/usr/bin/sudo',\n\
    \    '/usr/lib/git-core/git-remote-https',\n    '/usr/sbin/auditd',\n    '/usr/sbin/greetd',\n\
    \    '/usr/sbin/mcelog'\n  )\n  AND p0_name != 'git-remote-htp'\n"
  platform: linux
  interval: 7200
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
