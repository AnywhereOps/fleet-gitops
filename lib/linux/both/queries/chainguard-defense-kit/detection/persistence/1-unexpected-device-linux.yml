- name: CDK - Unexpected Device Linux
  description: Finds unexpected device names, sometimes used for communication to
    a rootkit Confirmed to catch revenge-rtkit
  query: "SELECT -- Remove numerals from device names\n  -- Ugly, but better than\
    \ dealing with multiple rounds of nesting COALESCE + REGEX_MATCH\n  CONCAT (\n\
    \    REPLACE(\n      REPLACE(\n        REPLACE(\n          REPLACE(\n        \
    \    REPLACE(\n              REPLACE(\n                REPLACE(\n            \
    \      REPLACE(REPLACE(REPLACE(path, \"0\", \"\"), \"1\", \"\"), \"2\", \"\"),\n\
    \                  \"3\",\n                  \"\"\n                ),\n      \
    \          \"4\",\n                \"\"\n              ),\n              \"5\"\
    ,\n              \"\"\n            ),\n            \"6\",\n            \"\"\n\
    \          ),\n          \"7\",\n          \"\"\n        ),\n        \"8\",\n\
    \        \"\"\n      ),\n      \"9\",\n      \"\"\n    ),\n    \",\",\n    file.type\n\
    \  ) AS exception_key,\n  file.*\nFROM\n  file\nWHERE\n  (\n    path LIKE '/dev/%'\n\
    \    OR directory LIKE '/dev/%'\n    OR directory LIKE '/dev/%/.%'\n    OR directory\
    \ LIKE '/dev/.%'\n  )\n  AND path NOT LIKE '%/./%'\n  AND path NOT LIKE '%/../%'\n\
    \  AND exception_key NOT IN (\n    '/dev/accel/,directory',\n    '/dev/accel/accel,character',\n\
    \    '/dev/acpi_thermal_rel,character',\n    '/dev/autofs,character',\n    '/dev/binder,character',\n\
    \    '/dev/binderfs/,directory',\n    '/dev/binderfs/binder-control,character',\n\
    \    '/dev/binderfs/binder,character',\n    '/dev/binderfs/features,directory',\n\
    \    '/dev/binderfs/hwbinder,character',\n    '/dev/binderfs/vndbinder,character',\n\
    \    '/dev/block/,directory',\n    '/dev/block/:,block',\n    '/dev/bsg/,directory',\n\
    \    '/dev/bsg/:::,character',\n    '/dev/btrfs-control,character',\n    '/dev/bus/,directory',\n\
    \    '/dev/bus/usb,directory',\n    '/dev/cdrom,block',\n    '/dev/cec,character',\n\
    \    '/dev/char/,directory',\n    '/dev/char/:,character',\n    '/dev/char/:,unknown',\n\
    \    '/dev/console,character',\n    '/dev/core,regular',\n    '/dev/cpu_dma_latency,character',\n\
    \    '/dev/cpu/,directory',\n    '/dev/cpu/microcode',\n    '/dev/cros_ec,character',\n\
    \    '/dev/cuse,character',\n    '/dev/data/,directory',\n    '/dev/data/root,block',\n\
    \    '/dev/dbc,character',\n    '/dev/default/,directory',\n    '/dev/disk/,directory',\n\
    \    '/dev/gpt-auto-root,block',\n    '/dev/ptp_kvm,character',\n    '/dev/disk/by-diskseq,directory',\n\
    \    '/dev/disk/by-dname,directory',\n    '/dev/disk/by-id,directory',\n    '/dev/disk/by-label,directory',\n\
    \    '/dev/disk/by-loop-inode,directory',\n    '/dev/disk/by-loop-ref,directory',\n\
    \    '/dev/disk/by-partlabel,directory',\n    '/dev/disk/by-partuuid,directory',\n\
    \    '/dev/disk/by-path,directory',\n    '/dev/disk/by-uuid,directory',\n    '/dev/dm-,block',\n\
    \    '/dev/dma_heap/,directory',\n    '/dev/dma_heap/system,character',\n    '/dev/dri/,directory',\n\
    \    '/dev/dri/by-path,directory',\n    '/dev/dri/card,character',\n    '/dev/dri/renderD,character',\n\
    \    '/dev/drm_dp_aux,character',\n    '/dev/ecryptfs,character',\n    '/dev/fb,character',\n\
    \    '/dev/fd/,character',\n    '/dev/fd/,directory',\n    '/dev/fd/,fifo',\n\
    \    '/dev/fd/,regular',\n    '/dev/fd/,socket',\n    '/dev/fd/,unknown',\n  \
    \  '/dev/full,character',\n    '/dev/fuse,character',\n    '/dev/gpiochip,character',\n\
    \    '/dev/HID-SENSOR-e..auto,character',\n    '/dev/hidraw,character',\n    '/dev/hpet,character',\n\
    \    '/dev/hugepages/,directory',\n    '/dev/hugepages/libvirt,directory',\n \
    \   '/dev/hwbinder,character',\n    '/dev/hwrng,character',\n    '/dev/ic-,character',\n\
    \    '/dev/iio:device,character',\n    '/dev/initctl,fifo',\n    '/dev/infiniband/,directory',\n\
    \    '/dev/input/,directory',\n    '/dev/input/by-id,directory',\n    '/dev/input/by-path,directory',\n\
    \    '/dev/input/event,character',\n    '/dev/input/js,character',\n    '/dev/input/mice,character',\n\
    \    '/dev/input/mouse,character',\n    '/dev/iommu,character',\n    '/dev/ipu-psys,character',\n\
    \    '/dev/kfd,character',\n    '/dev/kmsg,character',\n    '/dev/kvm,character',\n\
    \    '/dev/libmtp--,character',\n    '/dev/libmtp--.,character',\n    '/dev/log,socket',\n\
    \    '/dev/loop-control,character',\n    '/dev/loop,block',\n    '/dev/lp,character',\n\
    \    '/dev/mcelog,character',\n    '/dev/media,character',\n    '/dev/mei,character',\n\
    \    '/dev/mem,character',\n    '/dev/mqueue/,directory',\n    '/dev/mtd,character',\n\
    \    '/dev/mtd/,directory',\n    '/dev/mtd/by-name,directory',\n    '/dev/mtdro,character',\n\
    \    '/dev/nbd,block',\n    '/dev/nbdp,block',\n    '/dev/net/,directory',\n \
    \   '/dev/net/tun,character',\n    '/dev/ngn,character',\n    '/dev/ntsync,character',\n\
    \    '/dev/null,character',\n    '/dev/nvidia-caps/,directory',\n    '/dev/nvidia-caps/nvidia-cap,character',\n\
    \    '/dev/nvidia-modeset,character',\n    '/dev/nvidia-uvm-tools,character',\n\
    \    '/dev/nvidia-uvm,character',\n    '/dev/nvidia,character',\n    '/dev/nvidiactl,character',\n\
    \    '/dev/nvme,character',\n    '/dev/nvme-fabrics,character',\n    '/dev/nvmen,block',\n\
    \    '/dev/nvmenp,block',\n    '/dev/nvram,character',\n    '/dev/port,character',\n\
    \    '/dev/ppp,character',\n    '/dev/pps,character',\n    '/dev/psaux,character',\n\
    \    '/dev/ptmx,character',\n    '/dev/ptp,character',\n    '/dev/pts/,character',\n\
    \    '/dev/pts/,directory',\n    '/dev/pts/ptmx,character',\n    '/dev/random,character',\n\
    \    '/dev/rfkill,character',\n    '/dev/rtc,character',\n    '/dev/sda,block',\n\
    \    '/dev/sdb,block',\n    '/dev/sdc,block',\n    '/dev/sdd,block',\n    '/dev/sde,block',\n\
    \    '/dev/sdf,block',\n    '/dev/sdg,block',\n    '/dev/sdh,block',\n    '/dev/sdi,block',\n\
    \    '/dev/serial/,directory',\n    '/dev/serial/by-id,directory',\n    '/dev/serial/by-path,directory',\n\
    \    '/dev/sg,character',\n    '/dev/sgx_provision',\n    '/dev/shm/,directory',\n\
    \    '/dev/shm/.org.chromium.Chromium.NjobT,regular',\n    '/dev/shm/envoy_shared_memory_,regular',\n\
    \    '/dev/shm/jack_db-,directory',\n    '/dev/shm/libpod_lock,regular',\n   \
    \ '/dev/shm/libpod_rootless_lock_,regular',\n    '/dev/shm/lttng-ust-wait--,regular',\n\
    \    '/dev/shm/lttng-ust-wait-,regular',\n    '/dev/snapshot,character',\n   \
    \ '/dev/snd/,directory',\n    '/dev/snd/by-id,directory',\n    '/dev/snd/by-path,directory',\n\
    \    '/dev/snd/controlC,character',\n    '/dev/snd/hwCD,character',\n    '/dev/snd/pcmCDc,character',\n\
    \    '/dev/snd/pcmCDp,character',\n    '/dev/snd/seq,character',\n    '/dev/snd/timer,character',\n\
    \    '/dev/sr,block',\n    '/dev/stderr,character',\n    '/dev/stderr,fifo',\n\
    \    '/dev/stdin,character',\n    '/dev/stdin,fifo',\n    '/dev/stdout,character',\n\
    \    '/dev/stdout,fifo',\n    '/dev/tee,character',\n    '/dev/tpm,character',\n\
    \    '/dev/tpmrm,character',\n    '/dev/tty,character',\n    '/dev/ttyUSB,character',\n\
    \    '/dev/ttyACM,character',\n    '/dev/ttyprintk,character',\n    '/dev/ttyS,character',\n\
    \    '/dev/ubuntu-vg/,directory',\n    '/dev/udmabuf,character',\n    '/dev/uhid,character',\n\
    \    '/dev/uinput,character',\n    '/dev/urandom,character',\n    '/dev/usb/,directory',\n\
    \    '/dev/usb/hiddev,character',\n    '/dev/usbmon,character',\n    '/dev/userfaultfd,character',\n\
    \    '/dev/userio,character',\n    '/dev/vcs,character',\n    '/dev/vcsa,character',\n\
    \    '/dev/vcsu,character',\n    '/dev/vfio/,directory',\n    '/dev/vfio/vfio,character',\n\
    \    '/dev/vga_arbiter,character',\n    '/dev/vgubuntu/,directory',\n    '/dev/vgubuntu/incus-default,block',\n\
    \    '/dev/vgubuntu/root,block',\n    '/dev/vgubuntu/swap_,block',\n    '/dev/vgubuntu/swap,block',\n\
    \    '/dev/vhba_ctl,character',\n    '/dev/vhci,character',\n    '/dev/vhost-net,character',\n\
    \    '/dev/vhost-net',\n    '/dev/vhost-vsock,character',\n    '/dev/vhost-vsock',\n\
    \    '/dev/video,character',\n    '/dev/vl-subdev,character',\n    '/dev/vl/,directory',\n\
    \    '/dev/vl/by-id,directory',\n    '/dev/vl/by-path,directory',\n    '/dev/vlloopback,character',\n\
    \    '/dev/vndbinder,character',\n    '/dev/vsock,character',\n    '/dev/watchdog,character',\n\
    \    '/dev/wwanat,character',\n    '/dev/wwanmbim,character',\n    '/dev/wwanqcdm,character',\n\
    \    '/dev/zd,block',\n    '/dev/zero,character',\n    '/dev/zfs,character',\n\
    \    '/dev/zram,block',\n    '/dev/zvol/,directory',\n    '/dev/zvol/rpool,directory'\n\
    \  )\n  AND NOT path LIKE '/dev/%-vg/%-lv'\n  AND NOT path LIKE '/dev/mapper/%'\n\
    \  AND NOT path LIKE '/dev/mqueue/us.zoom.aom.%'\n  AND NOT path LIKE '/dev/shm/.com.google.Chrome.%'\n\
    \  AND NOT path LIKE '/dev/shm/.com.microsoft.Edge.%'\n  AND NOT path LIKE '/dev/shm/.org.chromium.Chromium.%'\n\
    \  AND NOT path LIKE '/dev/shm/aomshm.%'\n  AND NOT path LIKE '/dev/shm/%CefRaster%'\n\
    \  AND NOT path LIKE '/dev/shm/xapp-tmp-%'\n  AND NOT path LIKE '/dev/shm/byobu-%'\n\
    \  AND NOT path LIKE '/dev/shm/lsp-catalog-%.lock'\n  AND NOT path LIKE '/dev/shm/flatpak-com.brave.Browser-%'\n\
    \  AND NOT path LIKE '/dev/shm/libv4l-%'\n  AND NOT path LIKE '/dev/shm/sem.mp-%'\n\
    \  AND NOT path LIKE '/dev/shm/sem.rpc%'\n  AND NOT path LIKE '/dev/shm/u%-Shm_%'\n\
    \  AND NOT path LIKE '/dev/shm/u%-ValveIPC%'\n  AND NOT (\n    directory = '/dev/shm/'\n\
    \    AND type = 'regular'\n    AND mode = '0666'\n    AND uid IN (0, 1000, 1001)\n\
    \    AND size IN (32, 4096)\n  )\n  AND NOT exception_key LIKE '/dev/vg%/,directory'\n\
    \  AND NOT exception_key LIKE '/dev/vg%/root,block'\n  AND NOT exception_key LIKE\
    \ '/dev/vg%/swap%,block'\n  AND NOT exception_key LIKE '/dev/%vg/,directory'\n\
    \  AND NOT exception_key LIKE '/dev/%vg/root,block'\n  AND NOT exception_key LIKE\
    \ '/dev/%vg/swap%,block'\n  AND NOT exception_key LIKE '/dev/default/%,block'\n\
    \  AND NOT exception_key LIKE '/dev/shm/lsp-catalog-%.shm,regular'\nGROUP BY\n\
    \  exception_key\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
