- name: CDK - Unexpected Privilege Escalation Linux
  description: 'Find processes that run with a lower effective UID than their parent
    (state-based) related: * unexpected-privilege-escalation-events.sql'
  query: "SELECT\n  p0.uid AS p0_uid,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path\
    \ AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n\
    \  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT\
    \ JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN file p1_f ON p1.path =\
    \ p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p0.pid IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n\
    \      euid < uid\n      AND NOT path IN (\n        '/bin/ps',\n        '/opt/1Password/1password',\n\
    \        '/usr/bin/doas',\n        '/usr/bin/fusermount',\n        '/usr/bin/fusermount3',\n\
    \        '/usr/bin/login',\n        '/usr/bin/newgrp',\n        '/usr/bin/passwd',\n\
    \        '/usr/bin/su',\n        '/usr/bin/sudo',\n        '/usr/bin/top',\n \
    \       '/usr/lib/polkit-1/polkit-agent-helper-1',\n        '/usr/lib/xorg/Xorg',\n\
    \        '/usr/libexec/Xorg'\n      ) -- doas may be in the process of being upgraded\n\
    \      AND NOT path LIKE '/nix/store/%/bin/dhcpcd'\n      AND NOT path LIKE '/nix/store/%/bin/sudo'\n\
    \      AND NOT path LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'\n      AND\
    \ NOT name IN ('doas', 'sudo')\n  )\n  AND NOT (\n    p0.cmdline LIKE '%pacman%'\n\
    \    AND p1.cmdline LIKE 'yay%'\n  )\n  AND NOT (\n    p0.path LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns'\n\
    \    AND p1.path LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'\n  )\n  AND NOT\
    \ (\n    p0.name = 'polkit-agent-he'\n    AND p1.path IN (\n      '/usr/bin/gnome-shell',\n\
    \      '/usr/lib/x86_64-linux-gnu/libexec/polkit-kde-authentication'\n    )\n\
    \  )\n  AND NOT (\n    p0.name = 'fusermount3'\n    AND p1.path IN (\n      '/usr/lib/xdg-document-portal',\n\
    \      '/usr/libexec/xdg-document-portal'\n    )\n  )\n  AND NOT (\n    p0.path\
    \ = '/usr/bin/pkexec'\n    AND p1.path = '/usr/bin/update-notifier'\n  )\n  AND\
    \ NOT (\n    p0.path = '/usr/libexec/xdg-permission-store'\n    AND p1.path =\
    \ '/usr/lib/systemd/systemd'\n  )\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
