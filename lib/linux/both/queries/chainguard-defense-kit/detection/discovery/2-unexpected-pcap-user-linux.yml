- name: CDK - Unexpected Pcap User Linux
  description: 'Find root-run processes which link against libpcap WARNING: This check
    consumes an unusual amount of system memory (up to 225MB)'
  query: "SELECT\n  pmm.pid,\n  p.uid,\n  p.gid,\n  pmm.path AS lib_path,\n  p.path\
    \ AS child_path,\n  p.name AS child_name,\n  p.cmdline AS child_cmd,\n  p.cwd\
    \ AS child_cwd,\n  h.sha256 AS child_sha256,\n  pp.path AS parent_path,\n  pp.name\
    \ AS parent_name,\n  pp.cmdline AS parent_cmd,\n  pp.cwd AS parent_cwd,\n  pp.euid\
    \ AS parent_euid,\n  ph.sha256 AS parent_sha256\n  -- Using processes is much\
    \ faster than process_memory_map\nFROM\n  processes p\n  LEFT JOIN process_memory_map\
    \ pmm ON p.pid = pmm.pid\n  LEFT JOIN hash h ON p.path = h.path\n  LEFT JOIN processes\
    \ pp ON p.parent = pp.pid\n  LEFT JOIN hash AS ph ON pp.path = ph.path\nWHERE\n\
    \  p.euid = 0\n  AND pmm.path LIKE '%libpcap%'\n  AND child_path NOT LIKE '/nix/store/%-systemd-%/bin/udevadm'\n\
    \  AND child_path NOT LIKE '/nix/store/%-systemd-%/lib/systemd/systemd%'\n  AND\
    \ child_path NOT LIKE '/nix/store/%/bin/nix'\n  AND child_path NOT LIKE '/System/Library/%'\n\
    \  AND child_path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'\n\
    \  AND child_path NOT IN (\n    '/run/current-system/systemd/lib/systemd/systemd',\n\
    \    '/usr/bin/libvirtd',\n    '/usr/sbin/libvirtd',\n    '/usr/bin/tcpdump',\n\
    \    '/usr/libexec/UserEventAgent',\n    '/opt/datadog-agent/bin/agent/agent',\n\
    \    '/opt/datadog-agent/embedded/bin/system-probe',\n    '/usr/sbin/cupsd',\n\
    \    '/usr/sbin/systemstats'\n  )\n  AND child_cmd NOT IN (\n    '/nix/var/nix/profiles/default/bin/nix-daemon',\n\
    \    '/run/current-system/systemd/lib/systemd/systemd'\n  )\n  AND child_cmd NOT\
    \ LIKE '/usr/bin/python3 -s%/usr/sbin/firewalld%'\nGROUP BY\n  p.pid\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
