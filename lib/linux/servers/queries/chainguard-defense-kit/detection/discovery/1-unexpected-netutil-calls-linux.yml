- name: CDK - Unexpected Netutil Calls Linux
  description: 'Suspicious parenting of network utilities (event-based) refs: * https://attack.mitre.org/techniques/T1016/
    (System Network Configuration Discovery)'
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid\
    \ AS p0_pid,\n  pe.time,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n  pe.parent\
    \ AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name\nFROM\n  process_events pe,\n  uptime\n  LEFT JOIN processes\
    \ p ON pe.pid = p.pid\n  -- Parents (via two paths)\n  LEFT JOIN processes p1\
    \ ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n\
    \  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n\
    \  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n  -- Grandparents (via\
    \ 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent\
    \ via parent processes\n  LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid\
    \ -- Current grandparent via parent events\n  LEFT JOIN process_events pe1_pe2\
    \ ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline != '' -- Past grandparent\
    \ via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash\
    \ pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  uptime.total_seconds\
    \ > 30\n  AND pe.path IN (\n    '/bin/ifconfig',\n    '/bin/ip',\n    '/bin/iptables',\n\
    \    '/bin/nft',\n    '/bin/ufw',\n    '/sbin/ifconfig',\n    '/sbin/ip',\n  \
    \  '/sbin/iptables',\n    '/sbin/nft',\n    '/sbin/ufw',\n    '/usr/bin/ifconfig',\n\
    \    '/usr/bin/ip',\n    '/usr/bin/iptables',\n    '/usr/bin/nft',\n    '/usr/bin/ufw'\n\
    \  )\n  AND pe.cmdline != ''\n  AND pe.time > (strftime('%s', 'now') -300)\n \
    \ AND NOT (\n    pe.euid > 500\n    AND p1_name IN ('bash', 'dash', 'fish', 'nu',\
    \ 'sh', 'zsh')\n    AND p2_name IN (\n      'alacritty',\n      'gnome-terminal-',\n\
    \      'gnome-terminal-server',\n      'kitty',\n      'login',\n      'newgrp',\n\
    \      'roxterm',\n      'screen',\n      'tmux:server',\n      'tmux',\n    \
    \  'wezterm-gui',\n      'zsh'\n    )\n  )\n  AND NOT p1_cmd IN (\n    '/bin/sh\
    \ /etc/network/if-up.d/avahi-autoipd',\n    '/opt/incus/bin/incusd --group incus-admin\
    \ --logfile /var/log/incus/incusd.log',\n    '/usr/bin/libvirtd --timeout 120'\n\
    \  )\n  AND NOT p1_path IN (\n    '/opt/incus/bin/incusd',\n    '/usr/libexec/gvfsd',\n\
    \    '/usr/libexec/incus/incusd'\n  )\n  AND NOT p0_cmd LIKE '%ip link set lo\
    \ netns -1'\n  AND NOT p0_cmd LIKE '%ip route add % dev % metric 1000 scope link'\n\
    GROUP BY\n  pe.pid\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
