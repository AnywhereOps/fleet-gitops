- name: CDK - Unexpected Talkers Linux
  description: Unexpected programs communicating over non-HTTPS protocols (state-based)
    This query is a bit awkward and hobbled due to the lack of osquery support for
    looking up binary signatures in Linux.
  query: "SELECT\n  s.remote_address,\n  s.remote_port,\n  s.local_port,\n  s.local_address,\n\
    \  p.name,\n  p.path,\n  p.cmdline AS child_cmd,\n  p.cwd,\n  p.euid,\n  pp.path\
    \ AS parent_path,\n  p.parent AS parent_pid,\n  pp.cmdline AS parent_cmd,\n  p.cgroup_path,\n\
    \  s.state,\n  hash.sha256,\n  -- This intentionally avoids file.path, as it won't\
    \ join across mount namespaces\n  CONCAT (\n    MIN(s.remote_port, 32768),\n \
    \   ',',\n    s.protocol,\n    ',',\n    MIN(p.euid, 500),\n    ',',\n    REGEX_MATCH\
    \ (p.path, '.*/(.*?)$', 1),\n    ',',\n    MIN(f.uid, 500),\n    'u,',\n    MIN(f.gid,\
    \ 500),\n    'g,',\n    p.name\n  ) AS exception_key\nFROM\n  process_open_sockets\
    \ s\n  LEFT JOIN processes p ON s.pid = p.pid\n  LEFT JOIN processes pp ON p.parent\
    \ = pp.pid\n  LEFT JOIN file f ON p.path = f.path\n  LEFT JOIN hash ON p.path\
    \ = hash.path\nWHERE\n  protocol > 0\n  AND s.remote_port > 0 -- See unexpected-https-client\n\
    \  AND NOT (\n    s.remote_port = 443\n    AND protocol IN (6, 17)\n  ) -- See\
    \ unexpected-dns-traffic\n  AND NOT (\n    s.remote_port = 53\n    AND protocol\
    \ IN (6, 17)\n  )\n  AND s.remote_address NOT IN (\n    '127.0.0.1',\n    '::ffff:127.0.0.1',\n\
    \    '::1',\n    '::',\n    '0.0.0.0'\n  )\n  AND s.remote_address NOT LIKE 'fe80:%'\n\
    \  AND s.remote_address NOT LIKE '127.%'\n  AND s.remote_address NOT LIKE '192.168.%'\n\
    \  AND s.remote_address NOT LIKE '100.7%'\n  AND s.remote_address NOT LIKE '169.254.%'\n\
    \  AND s.remote_address NOT LIKE '172.1%'\n  AND s.remote_address NOT LIKE '172.2%'\n\
    \  AND s.remote_address NOT LIKE '172.30.%'\n  AND s.remote_address NOT LIKE '172.31.%'\n\
    \  AND s.remote_address NOT LIKE '::ffff:172.%'\n  AND s.remote_address NOT LIKE\
    \ '10.%'\n  AND s.remote_address NOT LIKE '::ffff:10.%'\n  AND s.remote_address\
    \ NOT LIKE '::ffff:192.168.%'\n  AND s.remote_address NOT LIKE 'fc00:%'\n  AND\
    \ p.path != ''\n  AND NOT (\n    s.remote_address LIKE '100.%'\n    AND s.local_address\
    \ LIKE '100.%'\n    AND exception_key = '32768,6,%,sshd,0u,0g,sshd'\n  )\n  AND\
    \ NOT exception_key IN (\n    '123,17,106,chronyd,0u,0g,chronyd',\n    '123,17,125,chronyd,0u,0g,chronyd',\n\
    \    '123,17,473,chronyd,0u,0g,chronyd',\n    '123,17,500,chronyd,0u,0g,chronyd',\n\
    \    '19305,6,500,msedge,0u,0g,msedge',\n    '21,6,0,rpm-ostree,0u,0g,rpm-ostree',\n\
    \    '22,6,500,azure,500u,500g,azure',\n    '22,6,500,gce,500u,500g,gce',\n  \
    \  '22,6,500,gcp,500u,500g,gcp',\n    '25565,6,500,java,500u,500g,java',\n   \
    \ '25567,6,500,java,500u,500g,java',\n    '27018,6,500,pasta.avx2,0u,0g,pasta.avx2',\n\
    \    '32520,6,0,rpm-ostree,0u,0g,rpm-ostree',\n    '32768,6,0,registry,u,g,registry',\n\
    \    '32768,6,0,tailscaled,0u,0g,tailscaled',\n    '32768,6,22,sshd-auth,0u,0g,sshd-auth',\n\
    \    '32768,6,500,mumble,0u,0g,mumble',\n    '32768,6,500,slirp4netns,0u,0g,slirp4netns',\n\
    \    '4070,6,500,spotify,0u,0g,spotify',\n    '4070,6,500,spotify,u,g,spotify',\n\
    \    '4433,6,500,openssl,0u,0g,openssl',\n    '4460,6,106,chronyd,0u,0g,chronyd',\n\
    \    '4460,6,125,chronyd,0u,0g,chronyd',\n    '49152,6,500,ContinuityCaptureAgent,Software\
    \ Signing',\n    '5222,6,500,msedge,0u,0g,msedge',\n    '587,6,500,perl,0u,0g,git-send-email',\n\
    \    '67,17,0,NetworkManager,0u,0g,NetworkManager',\n    '80,6,0,dnf5,0u,0g,dnf',\n\
    \    '80,6,0,dnf5,0u,0g,dnf5',\n    '80,6,0,grep,0u,0g,grep',\n    '80,6,0,incusd,0u,0g,incusd',\n\
    \    '80,6,0,kmod,0u,0g,depmod',\n    '80,6,0,kubelet,u,g,kubelet',\n    '80,6,0,ldconfig,0u,0g,ldconfig',\n\
    \    '80,6,0,melange,500u,500g,melange',\n    '80,6,0,NetworkManager,0u,0g,NetworkManager',\n\
    \    '80,6,0,packagekit-dnf-refresh-repo,0u,0g,packagekit-dnf-',\n    '80,6,0,packagekitd,0u,0g,packagekitd',\n\
    \    '80,6,0,pacman,0u,0g,pacman',\n    '80,6,0,pdftex,0u,0g,pdftex',\n    '80,6,0,python2.7,500u,500g,yum',\n\
    \    '80,6,0,python3.10,0u,0g,dnf',\n    '80,6,0,python3.10,0u,0g,dnf-automatic',\n\
    \    '80,6,0,python3.10,0u,0g,yum',\n    '80,6,0,python3.11,0u,0g,dnf',\n    '80,6,0,python3.11,0u,0g,dnf-automatic',\n\
    \    '80,6,0,python3.11,0u,0g,yum',\n    '80,6,0,python3.12,0u,0g,apport-gtk',\n\
    \    '80,6,0,python3.12,0u,0g,dnf',\n    '80,6,0,python3.12,0u,0g,dnf-automatic',\n\
    \    '80,6,0,python3.12,0u,0g,yum',\n    '80,6,0,python3.12,500u,500g,dnf-automatic',\n\
    \    '80,6,0,python3.9,u,g,yum',\n    '80,6,0,rpm-ostree,0u,0g,rpm-ostree',\n\
    \    '80,6,0,sort,0u,0g,sort',\n    '80,6,0,systemd-hwdb,0u,0g,systemd-hwdb',\n\
    \    '80,6,0,tailscaled,0u,0g,tailscaled',\n    '80,6,0,wget,0u,0g,wget',\n  \
    \  '80,6,0,zstd,0u,0g,zstd',\n    '80,6,0,zypper,0u,0g,Zypp-main',\n    '80,6,100,http,0u,0g,http',\n\
    \    '80,6,105,http,0u,0g,http',\n    '80,6,42,http,0u,0g,http',\n    '80,6,500,aws-iam-authenticator,0u,0g,aws-iam-authent',\n\
    \    '80,6,500,brave,0u,0g,brave',\n    '80,6,500,chrome,0u,0g,chrome',\n    '80,6,500,chrome,u,g,chrome',\n\
    \    '80,6,500,chromium,0u,0g,chromium',\n    '80,6,500,cloud_sql_proxy,0u,0g,cloud_sql_proxy',\n\
    \    '80,6,500,code,0u,0g,code',\n    '80,6,500,code-oss,u,g,code-oss',\n    '80,6,500,copilot-agent-linux,500u,500g,copilot-agent-l',\n\
    \    '80,6,500,curl,0u,0g,curl',\n    '80,6,500,dotnet,u,g,dotnet',\n    '80,6,500,dropbox,500u,500g,dropbox',\n\
    \    '80,6,500,electron,0u,0g,electron',\n    '80,6,500,firefox,0u,0g,.firefox-wrappe',\n\
    \    '80,6,500,firefox,0u,0g,firefox',\n    '80,6,500,firefox-bin,0u,0g,firefox-bin',\n\
    \    '80,6,500,firefox-bin,500u,500g,firefox-bin',\n    '80,6,500,firefox-bin,u,g,firefox-bin',\n\
    \    '80,6,500,firefox-esr,0u,0g,firefox-esr',\n    '80,6,500,flatpak,0u,0g,flatpak',\n\
    \    '80,6,500,git-remote-http,0u,0g,git-remote-http',\n    '80,6,500,gnome-software,0u,0g,gnome-software',\n\
    \    '80,6,500,http,0u,0g,http',\n    '80,6,500,http,u,g,http',\n    '80,6,500,java,0u,0g,java',\n\
    \    '80,6,500,java,u,g,java',\n    '80,6,500,librewolf,0u,0g,librewolf',\n  \
    \  '80,6,500,main,500u,500g,main',\n    '80,6,500,mateweather-applet,0u,0g,mateweather-app',\n\
    \    '80,6,500,mconvert,500u,500g,mconvert',\n    '80,6,500,mediawriter,u,g,mediawriter',\n\
    \    '80,6,500,melange,500u,500g,melange',\n    '80,6,500,minecraft-launcher,500u,500g,minecraft-launc',\n\
    \    '80,6,500,msedge,0u,0g,msedge',\n    '80,6,500,obs-browser-page,u,g,obs-browser-pag',\n\
    \    '80,6,500,ocsp.test,u,g,ocsp.test',\n    '80,6,500,pacman,0u,0g,pacman',\n\
    \    '80,6,500,python3.10,0u,0g,aws',\n    '80,6,500,python3.10,0u,0g,yum',\n\
    \    '80,6,500,python3.11,0u,0g,abrt-action-ins',\n    '80,6,500,python3.11,0u,0g,dnf',\n\
    \    '80,6,500,python3.11,0u,0g,yum',\n    '80,6,500,python3.12,0u,0g,pull-lp-source',\n\
    \    '80,6,500,qemu-system-x86_64,0u,0g,qemu-system-x86',\n    '80,6,500,qemu-system-x86_64,500u,500g,qemu-system-x86',\n\
    \    '80,6,500,rpi-imager,0u,0g,rpi-imager',\n    '80,6,500,signal-desktop,0u,0g,signal-desktop',\n\
    \    '80,6,500,signal-desktop,u,g,signal-desktop',\n    '80,6,500,slack,0u,0g,slack',\n\
    \    '80,6,500,slirp4netns,500u,500g,slirp4netns',\n    '80,6,500,spotify,0u,0g,spotify',\n\
    \    '80,6,500,spotify,500u,500g,spotify',\n    '80,6,500,spotify,u,g,spotify',\n\
    \    '80,6,500,spotify-launcher,0u,0g,spotify-launche',\n    '80,6,500,steam,500u,100g,steam',\n\
    \    '80,6,500,steam,500u,500g,steam',\n    '80,6,500,steamwebhelper,500u,500g,steamwebhelper',\n\
    \    '80,6,500,telegram-desktop,u,g,telegram-deskto',\n    '80,6,500,terraform,0u,0g,terraform',\n\
    \    '80,6,500,terraform,500u,500g,terraform',\n    '80,6,500,thunderbird,0u,0g,thunderbird',\n\
    \    '80,6,500,thunderbird,u,g,thunderbird',\n    '80,6,500,thunderbird-bin,0u,0g,thunderbird-bin',\n\
    \    '80,6,500,thunderbird-bin,u,g,thunderbird-bin',\n    '80,6,500,updater,500u,500g,updater',\n\
    \    '80,6,500,vlc,0u,0g,vlc',\n    '80,6,500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',\n\
    \    '80,6,500,wget,0u,0g,wget',\n    '80,6,500,wine64-preloader,0u,0g,control.exe',\n\
    \    '80,6,500,zen,u,g,zen',\n    '80,6,500,zoom,0u,0g,zoom',\n    '80,6,500,zoom.real,u,g,zoom.real',\n\
    \    '80,6,500,ZoomWebviewHost,0u,0g,ZoomWebviewHost',\n    '8000,6,500,brave,0u,0g,brave',\n\
    \    '8000,6,500,chrome,0u,0g,chrome',\n    '8000,6,500,firefox,0u,0g,firefox',\n\
    \    '8080,6,500,bambu-studio,u,g,bambustu_main',\n    '8080,6,500,brave,0u,0g,brave',\n\
    \    '8080,6,500,chrome,0u,0g,chrome',\n    '8080,6,500,firefox,0u,0g,firefox',\n\
    \    '8080,6,500,goland,500u,500g,goland',\n    '8080,6,500,goland,u,g,goland',\n\
    \    '8080,6,500,idea,0u,0g,idea',\n    '8080,6,500,java,u,g,java',\n    '8080,6,500,msedge,0u,0g,msedge',\n\
    \    '8080,6,500,pycharm,500u,500g,pycharm',\n    '8080,6,500,python3.11,0u,0g,speedtest-cli',\n\
    \    '8080,6,500,python3.12,u,g,hass',\n    '8080,6,500,speedtest,0u,0g,speedtest',\n\
    \    '8080,6,500,speedtest,500u,500g,speedtest',\n    '8443,6,500,chrome,0u,0g,chrome',\n\
    \    '8443,6,500,firefox,0u,0g,firefox',\n    '8443,6,500,WebKitNetworkProcess,0u,0g,WebKitNetworkPr',\n\
    \    '88,6,500,syncthing,0u,0g,syncthing',\n    '8801,17,500,zoom,0u,0g,zoom',\n\
    \    '8801,17,500,zoom.real,u,g,zoom.real',\n    '8883,6,500,bambu-studio,u,g,bambustu_main',\n\
    \    '8883,6,500,WebKitWebProcess,u,g,WebKitWebProces',\n    '89,6,500,chrome,0u,0g,chrome',\n\
    \    '8987,6,500,whois,0u,0g,whois',\n    '9,17,0,launcher,0u,0g,launcher',\n\
    \    '9418,6,0,git,0u,0g,git',\n    '9418,6,500,git,0u,0g,git',\n    '993,6,500,evolution,0u,0g,evolution',\n\
    \    '993,6,500,mbsync,0u,0g,mbsync',\n    '993,6,500,thunderbird,0u,0g,thunderbird',\n\
    \    '993,6,500,thunderbird,u,g,thunderbird',\n    '993,6,500,thunderbird-bin,0u,0g,thunderbird-bin',\n\
    \    '9999,6,500,firefox,0u,0g,firefox'\n  )\n  AND NOT exception_key LIKE '%,6,500,nuclei,500u,500g,nuclei'\n\
    \  AND NOT exception_key LIKE '%,6,500,ssh,0u,0g,ssh'\n  AND NOT exception_key\
    \ LIKE '80,6,500,terraform_1.1.5,500u,500g,terraform'\n  AND NOT exception_key\
    \ LIKE '%,6,0,rpm-ostree,0u,0g,rpm-ostree'\n  AND NOT exception_key LIKE '%,6,0,sshd-session,0u,0g,sshd-session'\n\
    \  AND NOT exception_key LIKE '%,6,22,sshd-auth,0u,0g,sshd-auth'\n\n  AND NOT\
    \ (\n    s.remote_port = 80\n    AND s.protocol = 6\n    AND p.euid > 500\n  \
    \  AND (\n      p.path LIKE '%/bin/%'\n      OR p.path LIKE '/app/%'\n      OR\
    \ p.path LIKE '/opt/%'\n    )\n  )\n  AND NOT (\n    p.name = 'java'\n    AND\
    \ p.cmdline LIKE '/home/%/.local/share/JetBrains/Toolbox/%'\n    AND s.remote_port\
    \ > 1024\n    AND s.protocol = 6\n    AND p.euid > 500\n  )\n  AND NOT (\n   \
    \ p.name = 'ruby'\n    AND p.cmdline LIKE '%fluentd%'\n    AND s.remote_port >\
    \ 1024\n    AND s.protocol = 6\n    AND p.euid > 500\n  )\n  AND NOT (\n    p.name\
    \ IN ('java', 'jcef_helper')\n    AND p.cmdline LIKE '/home/%/PhpStorm%'\n   \
    \ AND s.remote_port > 79\n    AND s.protocol = 6\n    AND p.euid > 500\n  )\n\
    \  AND NOT (\n    p.name = 'syncthing'\n    AND f.filename = 'syncthing'\n   \
    \ AND s.remote_port > 900\n    AND s.protocol = 6\n    AND p.euid > 500\n  )\n\
    \  AND NOT (\n    p.name IN ('chrome', 'chromium')\n    AND f.filename IN ('chrome',\
    \ 'chromium')\n    AND s.remote_port > 1024\n    AND s.protocol IN (6, 17)\n \
    \   AND p.euid > 500\n  )\n  AND NOT (\n    p.name = 'steam'\n    AND f.filename\
    \ = 'steam'\n    AND s.remote_port > 27000\n    AND s.protocol IN (6, 17)\n  \
    \  AND p.euid > 500\n  )\n  AND NOT (\n    p.name = 'brave'\n    AND f.filename\
    \ = 'brave'\n    AND s.remote_port > 3000\n    AND s.protocol IN (6, 17)\n   \
    \ AND p.euid > 500\n  )\n  AND NOT (\n    p.name IN (\n      'firefox',\n    \
    \  'firefox-bin',\n      'firefox-esr',\n      'librewolf'\n    )\n    AND f.filename\
    \ IN (\n      'firefox',\n      'firefox-bin',\n      'firefox-esr',\n      'librewolf'\n\
    \    )\n    AND s.remote_port > 3000\n    AND s.protocol IN (6, 17)\n    AND p.euid\
    \ > 500\n  ) -- TODO: Move this to a custom override overlay, as it is extremely\
    \ obscure (small ISP)\n  AND NOT (\n    exception_key = '32768,6,500,ssh,0u,0g,ssh'\n\
    \    AND s.remote_port = 40022\n  ) -- Qualys\n  AND NOT (\n    exception_key\
    \ = '80,6,0,curl,0u,0g,curl'\n    AND p.cgroup_path = '/system.slice/qualys-cloud-agent.service'\n\
    \    AND child_cmd LIKE ' curl -sS -H Metadata:true http://169.254.169.254/metadata/instance%'\n\
    \  )\n  AND NOT (\n    s.remote_port = 80\n    AND (\n      p.cgroup_path LIKE\
    \ '/system.slice/docker-%'\n      OR p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'\n\
    \    )\n  )\n  AND NOT parent_cmd IN ('/opt/microsoft/msedge/msedge')\n  AND NOT\
    \ (\n    exception_key LIKE '%,6,500,sshd-session,0u,0g,sshd-session'\n    AND\
    \ parent_cmd LIKE '%chainguard_dev%'\n  )\n  AND NOT p.path = '/opt/docker-desktop/bin/com.docker.backend'\n\
    GROUP BY\n  p.cmdline\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
