- name: CDK - Unexpected Https Linux
  description: Unexpected programs communicating over HTTPS (state-based) This query
    is a bit awkward and hobbled due to the lack of osquery support for looking up
    binary signatures in Linux.
  query: "SELECT\n  s.remote_address,\n  p.name,\n  p.cgroup_path,\n  p.path,\n  p.cmdline\
    \ AS child_cmd,\n  p.cwd,\n  pp.path AS parent_path,\n  p.parent AS parent_pid,\n\
    \  pp.cmdline AS parent_cmd,\n  s.local_address,\n  s.local_port,\n  s.state,\n\
    \  hash.sha256,\n  -- This intentionally avoids file.path, as it won't join across\
    \ mount namespaces\n  CONCAT (\n    MIN(p.euid, 500),\n    ',',\n    REGEX_MATCH\
    \ (p.path, '.*/(.*?)$', 1),\n    ',',\n    MIN(f.uid, 500),\n    'u,',\n    MIN(f.gid,\
    \ 500),\n    'g,',\n    p.name\n  ) AS exception_key\nFROM\n  process_open_sockets\
    \ s\n  LEFT JOIN processes p ON s.pid = p.pid\n  LEFT JOIN processes pp ON p.parent\
    \ = pp.pid\n  LEFT JOIN file f ON p.path = f.path\n  LEFT JOIN hash ON p.path\
    \ = hash.path\nWHERE\n  protocol IN (6, 17)\n  AND s.remote_port = 443\n  AND\
    \ s.remote_address NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')\n  AND s.remote_address\
    \ NOT LIKE 'fe80:%'\n  AND s.remote_address NOT LIKE '127.%'\n  AND s.remote_address\
    \ NOT LIKE '192.168.%'\n  AND s.remote_address NOT LIKE '172.1%'\n  AND s.remote_address\
    \ NOT LIKE '172.2%'\n  AND s.remote_address NOT LIKE '172.30.%'\n  AND s.remote_address\
    \ NOT LIKE '172.31.%'\n  AND s.remote_address NOT LIKE '::ffff:172.%'\n  AND s.remote_address\
    \ NOT LIKE '10.%'\n  AND s.remote_address NOT LIKE '::ffff:10.%'\n  AND s.remote_address\
    \ NOT LIKE 'fc00:%'\n  AND p.path != ''\n  AND p.path NOT LIKE '/app/bin/%'\n\
    \  AND p.path NOT LIKE '/usr/bin/%'\n  AND p.path NOT LIKE '/usr/local/bin/%'\n\
    \  AND p.path NOT LIKE '/nix/store/%/bin/%'\n  AND p.path NOT LIKE '/opt/%'\n\
    \  AND NOT exception_key IN (\n    '0,.tailscaled-wrapped,0u,0g,.tailscaled-wra',\n\
    \    '0,agentbeat,0u,0g,agentbeat',\n    '0,apk,u,g,apk',\n    '0,applydeltarpm,0u,0g,applydeltarpm',\n\
    \    '0,bash,0u,0g,bash',\n    '0,bash,0u,0g,mkinitcpio',\n    '0,bash,0u,0g,sh',\n\
    \    '0,canonical-livepatchd,0u,0g,canonical-livep',\n    '0,chainctl,0u,0g,chainctl',\n\
    \    '0,chainctl,500u,500g,chainctl',\n    '0,cmake,u,g,cmake',\n    '0,containerd,u,g,containerd',\n\
    \    '0,dirmngr,0u,0g,dirmngr',\n    '0,dockerd,0u,0g,dockerd',\n    '0,elastic-agent,0u,0g,elastic-agent',\n\
    \    '0,elastic-agent,u,g,elastic-agent',\n    '0,elastic-endpoint,0u,0g,elastic-endpoin',\n\
    \    '0,filebeat,0u,0g,filebeat',\n    '0,flatpak,0u,0g,flatpak',\n    '0,flatpak-system-helper,0u,0g,flatpak-system-',\n\
    \    '0,git-remote-http,0u,0g,git-remote-http',\n    '0,go,0u,0g,go',\n    '0,gtk4-update-icon-cache,0u,0g,gtk-update-icon',\n\
    \    '0,http,0u,0g,https',\n    '0,incusd,0u,0g,incusd',\n    '0,ir_agent,0u,0g,ir_agent',\n\
    \    '0,kmod,0u,0g,depmod',\n    '0,launcher,0u,0g,launcher',\n    '0,launcher,500u,500g,launcher',\n\
    \    '0,ldconfig,0u,0g,ldconfig',\n    '0,make,0u,0g,make',\n    '0,melange,500u,500g,melange',\n\
    \    '0,metricbeat,0u,0g,metricbeat',\n    '0,multipassd,0u,0g,multipassd',\n\
    \    '0,nessusd,0u,0g,nessusd',\n    '0,nix,0u,0g,nix',\n    '0,nix,0u,0g,nix-daemon',\n\
    \    '0,orbit,0u,0g,orbit',\n    '0,osqueryd,0u,0g,osqueryd',\n    '0,packagekit-dnf-refresh-repo,0u,0g,packagekit-dnf-',\n\
    \    '0,packagekitd,0u,0g,packagekitd',\n    '0,packetbeat,0u,0g,packetbeat',\n\
    \    '0,pacman,0u,0g,pacman',\n    '0,rapid7_endpoint_broker,0u,0g,rapid7_endpoint',\n\
    \    '0,rpi-imager,0u,0g,rpi-imager',\n    '0,skopeo,0u,0g,skopeo',\n    '0,snapd,0u,0g,snapd',\n\
    \    '0,systemctl,0u,0g,systemctl',\n    '0,tailscaled,0u,0g,tailscaled',\n  \
    \  '0,tailscaled,500u,500g,tailscaled',\n    '0,velociraptor,0u,0g,velociraptor_cl',\n\
    \    '0,yay,0u,0g,yay',\n    '105,http,0u,0g,https',\n    '106,geoclue,0u,0g,geoclue',\n\
    \    '114,geoclue,0u,0g,geoclue',\n    '115,geoclue,0u,0g,geoclue',\n    '120,fwupdmgr,0u,0g,fwupdmgr',\n\
    \    '128,fwupdmgr,0u,0g,fwupdmgr',\n    '129,fwupdmgr,0u,0g,fwupdmgr',\n    '42,http,0u,0g,https',\n\
    \    '500,sus,500u,500g,sus'\n  ) -- Exceptions where we have to be more flexible\
    \ for the process name\n  -- Regular user binaries\n  AND NOT exception_key LIKE\
    \ '500,%,500u,500g,%'\n  AND NOT exception_key LIKE '500,%,0u,0g,%'\n  AND NOT\
    \ exception_key LIKE '500,%,u,g,%'\n  AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf'\n\
    \  AND NOT exception_key LIKE '0,python3.%,0u,0g,dnf-automatic'\n  AND NOT exception_key\
    \ LIKE '0,python3.%,0u,0g,yum'\n  AND NOT exception_key LIKE '0,python3.%,500u,500g,dnf-automatic'\n\
    \  AND NOT (\n    exception_key = '0,curl,0u,0g,curl'\n    AND p.cmdline LIKE\
    \ 'curl --fail %'\n  ) -- Exclude processes running inside of containers\n  AND\
    \ NOT p.cgroup_path LIKE '/system.slice/docker-%'\n  AND NOT p.cgroup_path LIKE\
    \ '/system.slice/system.slice:docker:%'\n  AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'\
    \ -- Tests\n  AND NOT p.path LIKE '/tmp/go-build%.test'\nGROUP BY\n  p.cmdline\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
