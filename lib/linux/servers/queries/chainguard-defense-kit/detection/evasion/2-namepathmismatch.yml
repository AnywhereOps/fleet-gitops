- name: CDK - Name Path Mismatch
  description: Processes that have an unrelated name in the process tree than the
    program on disk.
  query: "SELECT\n  SUBSTR(\n    COALESCE(\n      -- TODO: Fix to not require filename!\n\
    \      REGEX_MATCH (f.filename, '(.*?)\\W', 1),\n      f.filename\n    ),\n  \
    \  0,\n    6\n  ) AS short_filename,\n  COALESCE(REGEX_MATCH (p0.path, '.*/(.*)',\
    \ 1), p0.path) AS basename,\n  COALESCE(\n    REGEX_MATCH (p0.path, '.*/([a-zA-Z]+)',\
    \ 1),\n    p0.path\n  ) AS base_letters,\n  CONCAT (\n    MIN(p0.euid, 500),\n\
    \    ',',\n    COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path),\n    ',',\n\
    \    p0.name\n  ) AS exception_key,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path\
    \ AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n\
    \  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n\
    \  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS\
    \ p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes\
    \ p0\n  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent\
    \ = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.path\
    \ != ''\n  AND NOT p0.name == basename\n  AND NOT (\n    LENGTH(basename) > 1\n\
    \    AND basename == short_filename\n  )\n  AND NOT (\n    LENGTH(p0.name) > 2\n\
    \    AND INSTR(LOWER(basename), LOWER(p0.name)) > 0\n  )\n  AND NOT (\n    LENGTH(short_filename)\
    \ > 2\n    AND INSTR(LOWER(p0.name), LOWER(short_filename)) > 0\n  ) -- Extremely\
    \ common and unpredictable process name setters\n  AND NOT base_letters IN (\n\
    \    'bash',\n    'busybox',\n    'dash',\n    'electron',\n    'firefox',\n \
    \   'gjs',\n    'librewolf',\n    'node',\n    'perl',\n    'python',\n    'ruby',\n\
    \    'systemd',\n    'thunderbird',\n    'vim'\n  )\n  AND NOT exception_key IN\
    \ (\n    '0,newgrp,sg',\n    '0,systemd-executor,(sd-pam)',\n    '0,udevadm,(udev-worker)',\n\
    \    '0,udevadm,systemd-udevd',\n    '112,systemd-executor,(sd-pam)',\n    '120,systemd-executor,(sd-pam)',\n\
    \    '128,systemd-executor,(sd-pam)',\n    '42,systemd-executor,(sd-pam)',\n \
    \   '500,busybox,sh',\n    '500,chainctl,docker-credenti',\n    '500,coreutils,tail',\n\
    \    '500,docker,code',\n    '500,gjs-console,daemon.js',\n    '500,gjs-console,gnome-character',\n\
    \    '500,libgvc6-config-update,dot',\n    '500,mate-session,x-session-manag',\n\
    \    '500,nc.openbsd,nc',\n    '500,netcat,nc',\n    '500,plugin-container,MainThread',\n\
    \    '500,pyrogenesis,main',\n    '500,rootlesskit,exe',\n    '500,rootlessport,exe',\n\
    \    '500,systemd-executor,(sd-pam)',\n    '500,udevadm,(udev-worker)',\n    '500,udevadm,systemd-udevd',\n\
    \    '500,vim.basic,vi',\n    '500,vim.nox,vi',\n    '500,vim.tiny,vi',\n    '500,x86_64-linux-gnu-as,as'\n\
    \  )\n  AND NOT exception_key LIKE '%,systemd,(sd-pam)'\n  AND NOT (\n    p0.path\
    \ LIKE '/usr/lib/%/panel/wrapper-2.0'\n    AND exception_key LIKE '500,wrapper-2.0,panel-%'\n\
    \  )\n  AND NOT p0.path IN ('/usr/lib/systemd/systemd')\n  AND NOT p0_cgroup LIKE\
    \ '/system.slice/docker-%'\nGROUP by\n  exception_key\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
