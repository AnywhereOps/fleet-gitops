- name: CDK - Unexpected Systemctl Calls Linux
  description: 'Suspicious calls to systemctl(event-based) refs: * https://attack.mitre.org/techniques/T1543/002/
    (Create or Modify System Process: Systemd Service)'
  query: "SELECT -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.time\
    \ AS p0_time,\n  pe.pid AS p0_pid,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n\
    \  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  -- Exception key\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path),\
    \ '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe,\n  uptime\n  LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two\
    \ paths)\n  LEFT JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1\
    \ ON p1.path = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n\
    \  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  uptime.total_seconds\
    \ > 30 -- NOTE: The remainder of this query is synced with unexpected-fetcher-parents\n\
    \  AND pe.path IN (\n    '/bin/systemctl',\n    '/sbin/systemctl',\n    '/usr/bin/systemctl'\n\
    \  )\n  AND pe.cmdline != ''\n  AND pe.time > (strftime('%s', 'now') -300)\n \
    \ AND NOT exception_key IN (\n    'systemctl,0,,containerd-shim-runc-v2',\n  \
    \  'systemctl,0,apt-helper,',\n    'systemctl,0,bash,pacman',\n    'systemctl,0,dash,logrotate',\n\
    \    'systemctl,0,kubeadm,containerd-shim-runc-v2',\n    'systemctl,0,pacman,pacman',\n\
    \    'systemctl,0,pacman,sudo',\n    'systemctl,0,snapd,systemd',\n    'systemctl,0,tailscaled,',\n\
    \    'systemctl,120,systemd-executor,systemd',\n    'systemctl,127,snap,systemd',\n\
    \    'systemctl,128,systemd,systemd',\n    'systemctl,500,bash,gnome-terminal-server',\n\
    \    'systemctl,500,snap,systemd',\n    'systemctl,500,snap,update-notifier',\n\
    \    'systemctl,500,snapd,systemd',\n    'systemctl,500,strace,bash',\n    'systemctl,500,systemd,',\n\
    \    'systemctl,500,systemd,systemd',\n    'systemctl,500,zsh,tmux'\n  )\n  AND\
    \ NOT p0_cmd IN (\n    '/bin/systemctl --quiet is-enabled whoopsie.path',\n  \
    \  '/bin/systemctl -q is-enabled whoopsie.path',\n    '/bin/systemctl is-enabled\
    \ -q whoopsie.path',\n    '/bin/systemctl stop --no-block nvidia-persistenced',\n\
    \    '/sbin/runlevel',\n    '/usr/bin/systemctl --user is-active slack',\n   \
    \ '/usr/bin/systemctl is-system-running',\n    '/usr/bin/systemctl try-reload-or-restart\
    \ dbus',\n    'systemctl --quiet is-enabled cups.service',\n    'systemctl --system\
    \ daemon-reexec',\n    'systemctl --user import-environment DISPLAY XAUTHORITY',\n\
    \    'systemctl --user is-active slack',\n    'systemctl -p LoadState show cups.service',\n\
    \    'systemctl -q is-enabled whoopsie',\n    'systemctl is-active systemd-resolved.service',\n\
    \    'systemctl is-enabled power-profiles-daemon.service',\n    'systemctl is-enabled\
    \ snapd.apparmor',\n    'systemctl is-enabled systemd-rfkill.service',\n    'systemctl\
    \ is-enabled systemd-rfkill.socket',\n    'systemctl is-enabled tlp.service',\n\
    \    'systemctl is-system-running',\n    'systemctl kill -s HUP rsyslog.service',\n\
    \    'systemctl reboot',\n    'systemctl restart cups.service',\n    'systemctl\
    \ restart NetworkManager.service',\n    'systemctl restart reflector.service',\n\
    \    'systemctl status kubelet',\n    'systemctl stop kubelet',\n    'systemctl\
    \ stop libvirtd.service'\n  ) -- apt-helper form\n  AND NOT p0_cmd LIKE '/usr/bin/systemctl\
    \ --user set-environment%'\n  AND NOT p0_cmd LIKE '%systemctl --user set-environment\
    \ DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%/bus'\n  AND NOT p0_cmd LIKE '%systemctl\
    \ % snap-kubectl-%.mount'\n  AND NOT p0_cmd LIKE '%systemctl is-active -q %.service'\n\
    \  AND NOT p0_cmd LIKE '%systemctl show --property=%'\nGROUP BY\n  pe.pid\n"
  platform: linux
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
