- name: CDK - Minimal Socket Client Linux
  description: Slow query to find root programs with an open socket and few shared
    libraries
  query: "SELECT\n  pos.protocol,\n  pos.pid,\n  pos.remote_address,\n  pos.local_address,\n\
    \  pos.local_port,\n  pos.remote_port,\n  pos.state,\n  GROUP_CONCAT(DISTINCT\
    \ pmm.path) AS libs,\n  COUNT(DISTINCT pmm.path) AS lib_count,\n  -- Child\n \
    \ p0.path AS proc_path,\n  p0.name AS proc_name,\n  p0.start_time AS proc_start,\n\
    \  p0.cmdline AS proc_cmd,\n  p0.cwd AS porc_cwd,\n  p0.cgroup_path AS proc_cgroup,\n\
    \  p0.euid AS proc_euid,\n  p0_hash.sha256 AS sha256\nFROM\n  processes p0\n \
    \ JOIN process_open_sockets pos ON p0.pid = pos.pid\n  JOIN process_memory_map\
    \ pmm ON p0.pid = pmm.pid\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n\
    WHERE\n  p0.path != '' -- optimization: focus on longer running processes\n  AND\
    \ p0.start_time < (strftime('%s', 'now') - 900)\n  AND p0.path NOT IN (\n    '/opt/bitnami/redis/bin/redis-server',\n\
    \    '/opt/java/openjdk/bin/java',\n    '/usr/bin/cat',\n    '/usr/bin/containerd',\n\
    \    '/usr/bin/dash',\n    '/usr/bin/daprd',\n    '/usr/bin/docker',\n    '/usr/bin/docker-proxy',\n\
    \    '/usr/bin/fusermount3',\n    '/usr/bin/i3blocks',\n    '/usr/bin/kas',\n\
    \    '/usr/bin/k3s',\n    '/usr/bin/vmalert',\n    '/usr/lib/electron/chrome-sandbox',\n\
    \    '/usr/lib/snapd/snapd',\n    '/usr/libexec/docker/docker-proxy',\n    '/usr/local/bin/containerd',\n\
    \    '/usr/local/bin/gitary',\n    '/usr/sbin/acpid',\n    '/usr/sbin/mcelog'\n\
    \  )\n  AND p0.name NOT IN (\n    'Brackets-node',\n    'chrome_crashpad',\n \
    \   'launcher',\n    'dhcpcd',\n    'gitsign-credent',\n    'gitaly',\n    'kas',\n\
    \    'k9s',\n    'redis-server',\n    'stern'\n  ) -- optimization: minimalistic\
    \ daemons typically only run 1 pid per path\n  AND p0.path NOT LIKE '/home/%/go/bin/%'\n\
    \  AND pos.family != 1\n  AND pos.pid > 0\n  AND pos.state != 'LISTEN'\n  AND\
    \ pmm.path LIKE \"%.so.%\"\n  AND NOT (\n    pos.local_address = \"127.0.0.1\"\
    \n    AND pos.remote_address = \"127.0.0.1\"\n  )\n  AND NOT proc_cgroup in ('/system.slice/snapd.service')\n\
    \  AND NOT proc_cgroup LIKE '/system.slice/docker-%'\nGROUP BY\n  pos.pid -- libc.so,\
    \ ld-linux\nHAVING\n  lib_count IN (1, 2)\n"
  platform: linux
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
