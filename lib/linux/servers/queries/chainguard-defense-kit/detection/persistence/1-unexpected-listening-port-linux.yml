- name: CDK - Unexpected Listening Port Linux
  description: Unexpected programs listening on a TCP port (state-based).
  query: "SELECT\n  lp.address,\n  lp.port,\n  lp.protocol,\n  p.euid,\n  p.cgroup_path,\n\
    \  p.parent,\n  p.pid,\n  p.name,\n  p.path,\n  p.cmdline AS p0_cmd,\n  p_p.cmdline\
    \ AS p1_cmd,\n  p_p_p.cmdline AS p2_cmd,\n  p.cgroup_path,\n  datetime(file.mtime,\
    \ 'unixepoch') AS mtime,\n  p.cwd,\n  hash.sha256,\n  CONCAT (\n    MIN(lp.port,\
    \ 32768),\n    ',',\n    lp.protocol,\n    ',',\n    MIN(p.uid, 500),\n    ',',\n\
    \    p.name\n  ) AS exception_key\nFROM\n  listening_ports lp\n  LEFT JOIN processes\
    \ p ON lp.pid = p.pid\n  LEFT JOIN processes p_p ON p.parent = p_p.pid\n  LEFT\
    \ JOIN processes p_p_p ON p_p.parent = p_p_p.pid\n  LEFT JOIN file ON p.path =\
    \ file.path\n  LEFT JOIN hash ON p.path = hash.path\nWHERE\n  port != 0\n  AND\
    \ lp.address NOT IN ('224.0.0.251', '::1', '127.0.0.1', '127.1.1.1')\n  AND lp.address\
    \ NOT LIKE '127.0.0.%'\n  AND lp.address NOT LIKE '172.1%'\n  AND lp.address NOT\
    \ LIKE 'fe80::%'\n  AND lp.address NOT LIKE '::ffff:127.0.0.%'\n  -- All outgoing\
    \ UDP (protocol 17) sessions are 'listening'\n  AND NOT (\n    lp.protocol = 17\n\
    \    AND lp.port > 1024\n  )\n  -- Random webservers\n  AND NOT (\n    p.uid >\
    \ 500\n    AND lp.port IN (8000, 8080)\n    AND lp.protocol = 6\n  )\n  -- Filter\
    \ out unmapped raw sockets\n  AND NOT p.pid = ''\n  -- Exceptions: the uid is\
    \ capped at 500 to represent regular users versus system users\n  -- port is capped\
    \ at 32768 to represent transient ports\n  AND NOT CONCAT (\n    MIN(lp.port,\
    \ 32768),\n    ',',\n    lp.protocol,\n    ',',\n    MIN(p.uid, 500),\n    ',',\n\
    \    p.name\n  ) IN (\n    '1,1,500,ping',\n    '1,255,500,mtr-packet',\n    '1,255,500,ping',\n\
    \    '10250,6,0,k3s-server',\n    '10250,6,0,kubelet',\n    '10250,6,500,kubelet',\n\
    \    '10250,6,500,metrics-server',\n    '10254,6,101,nginx-ingress-c',\n    '10256,6,0,kube-proxy',\n\
    \    '10256,6,500,kube-proxy',\n    '1337,6,500,kdenlive',\n    '1601,6,500,rsyslogd',\n\
    \    '17,255,0,.tailscaled-wra',\n    '17,255,0,dhcpcd',\n    '17,255,0,tailscaled',\n\
    \    '17,255,500,dhcpcd',\n    '17,255,500,mtr-packet',\n    '1716,6,500,daemon.js',\n\
    \    '1716,6,500,gjs',\n    '1716,6,500,kdeconnectd',\n    '17500,6,500,dropbox',\n\
    \    '18000,6,500,kourier',\n    '22,6,0,sshd',\n    '22,6,0,systemd',\n    '22,6,500,sshd',\n\
    \    '22,6,500,systemd',\n    '22000,6,500,syncthing',\n    '2222,6,500,qemu-system-x86',\n\
    \    '2379,6,500,etcd',\n    '2380,6,500,etcd',\n    '24800,6,500,synergy-core',\n\
    \    '24802,6,500,synergy-service',\n    '25,6,500,master',\n    '255,255,0,atop',\n\
    \    '255,255,500,mtr-packet',\n    '27036,6,500,steam',\n    '27500,6,500,passimd',\n\
    \    '3000,6,472,grafana-server',\n    '3000,6,500,grafana',\n    '3000,6,500,grafana-server',\n\
    \    '3000,6,500,node',\n    '32768,6,0,.tailscaled-wra',\n    '32768,6,0,tailscaled',\n\
    \    '32768,6,500,com.docker.back',\n    '32768,6,500,com.docker.backend',\n \
    \   '32768,6,500,dleyna-renderer',\n    '32768,6,500,goland',\n    '32768,6,500,java',\n\
    \    '32768,6,500,jetbrains-toolb',\n    '32768,6,500,pycharm',\n    '32768,6,500,rootlesskit',\n\
    \    '32768,6,500,spotify',\n    '32768,6,500,writerside',\n    '3551,6,0,apcupsd',\n\
    \    '4143,6,500,linkerd2-proxy',\n    '4191,6,500,linkerd2-proxy',\n    '443,6,0,docker-proxy',\n\
    \    '443,6,0,tailscaled',\n    '443,6,500,jcef_helper',\n    '4443,6,500,metrics-server',\n\
    \    '5000,6,0,registry',\n    '5000,6,500,ControlCenter',\n    '5000,6,500,registry',\n\
    \    '5001,6,0,registry',\n    '5005,6,500,rootlesskit',\n    '5050,6,500,rootlesskit',\n\
    \    '5355,6,193,systemd-resolve',\n    '5355,6,500,systemd-resolve',\n    '5432,6,70,postgres',\n\
    \    '546,17,500,dhcpcd',\n    '5556,6,500,dex',\n    '5556,6,500,openshot-qt',\n\
    \    '5558,6,500,dex',\n    '58,255,0,dhcpcd',\n    '58,255,0,NetworkManager',\n\
    \    '58,255,100,dhcpcd',\n    '58,255,100,systemd-network',\n    '58,255,500,dhcpcd',\n\
    \    '58,255,500,dnsmasq',\n    '58,255,500,mtr-packet',\n    '58,255,500,ping',\n\
    \    '58,255,500,systemd-network',\n    '631,17,0,cups-browsed',\n    '631,17,115,cups-browsed',\n\
    \    '631,17,116,cups-browsed',\n    '631,17,121,cups-browsed',\n    '631,17,132,cups-browsed',\n\
    \    '631,17,133,cups-browsed',\n    '6379,6,500,redis-server',\n    '6443,6,0,k3s-server',\n\
    \    '6443,6,0,kube-apiserver',\n    '6443,6,500,kube-apiserver',\n    '68,17,0,dhclient',\n\
    \    '68,17,100,dhcpcd',\n    '68,17,100,systemd-network',\n    '68,17,500,dhcpcd',\n\
    \    '68,17,500,systemd-network',\n    '7000,6,500,ControlCenter',\n    '80,6,0,apache2',\n\
    \    '80,6,0,docker-proxy',\n    '80,6,101,nginx',\n    '80,6,33,apache2',\n \
    \   '80,6,60,nginx',\n    '8001,6,500,__debug_bin,',\n    '8008,6,500,activator',\n\
    \    '8008,6,500,autoscaler',\n    '8008,6,500,controlplane',\n    '8008,6,500,resolvers',\n\
    \    '8008,6,500,webhook',\n    '8009,6,0,java',\n    '8080,6,0,coredns',\n  \
    \  '8080,6,0,java',\n    '8081,6,500,main',\n    '8086,6,0,influxd',\n    '8086,6,500,controller',\n\
    \    '8086,6,500,influxd',\n    '8090,6,500,linkerd-policy-',\n    '8123,6,500,Brackets-node',\n\
    \    '8181,6,0,coredns',\n    '8181,6,500,coredns',\n    '8443,6,0,kube-apiserver',\n\
    \    '8443,6,101,nginx-ingress-c',\n    '8443,6,500,controller',\n    '8443,6,500,controlplane',\n\
    \    '8443,6,500,traefik',\n    '8443,6,500,webhook',\n    '8834,6,0,nessusd',\n\
    \    '9000,6,500,authentik-proxy',\n    '9000,6,500,main',\n    '9000,6,500,traefik',\n\
    \    '9090,6,500,controlplane',\n    '9153,6,0,coredns',\n    '9153,6,500,coredns',\n\
    \    '9300,6,500,authentik-proxy',\n    '9880,6,500,rootlesskit',\n    '9999,6,500,python3'\n\
    \  )\n  AND NOT (\n    p.path LIKE '/ko-app/%'\n    AND lp.port > 1024\n    and\
    \ lp.protocol = 6\n  )\n  AND NOT (\n    p.path LIKE '%/rootlesskit'\n    AND\
    \ lp.port > 1024\n    and lp.protocol = 6\n  )\n\n  AND NOT (\n    p.name IN (\n\
    \      'caddy',\n      'com.docker.back',\n      'controller',\n      'crane',\n\
    \      'docker-proxy',\n      'hugo',\n      'kubectl',\n      'nginx-ingress-c',\n\
    \      'node',\n      'qemu-system-x86',\n      'rootlessport',\n      'webhook'\n\
    \    )\n    AND lp.port > 1024\n    and lp.protocol = 6\n  )\n  -- Exclude common/default\
    \ DNS talking\n  AND NOT (\n    p.name IN ('aardvark-dns', 'coredns', 'dnsmasq')\n\
    \    AND lp.port IN (\n      53, -- DNS\n      67, -- DHCP/BOOTP\n      547 --\
    \ DHCPv6 server\n    )\n    AND lp.protocol IN (\n      6, -- TCP\n      17 --\
    \ UDP\n    )\n  )\n  -- Exclude processes running inside of Docker containers\n\
    \  AND NOT p.cgroup_path LIKE '/system.slice/docker-%'\n  AND NOT p.cgroup_path\
    \ LIKE '/kubepods.slice/%'\n  AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/docker-%'\n\
    \  AND NOT p.cgroup_path LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'\n\
    \  AND NOT p.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'\n\
    \  AND NOT p1_cmd LIKE 'bwrap --bind%'\nGROUP BY\n  exception_key\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
