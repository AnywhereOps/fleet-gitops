- name: CDK - Unexpected Elevated Children Events Linux
  description: 'Find processes that run with a lower effective UID than their parent
    (event-based) related: * unexpected-privilege-escalation.sql'
  query: "SELECT\n  file.mode AS p0_binary_mode,\n  -- Child\n  pe.path AS p0_path,\n\
    \  pe.time AS p0_time,\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,\n  TRIM(pe.cmdline)\
    \ AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.uid AS p0_uid,\n  pe.euid AS p0_euid,\n\
    \  pe.pid AS p0_pid,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n  pe.parent\
    \ AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p1.euid, pe1.euid)\
    \ AS p1_euid,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH\
    \ (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  -- Grandparent\n\
    \  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path)\
    \ AS p2_cgroup,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n\
    \  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n\
    \  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name\nFROM\n  process_events pe\n  LEFT JOIN\
    \ file ON pe.path = file.path\n  LEFT JOIN processes p ON pe.pid = pe.pid -- Parents\
    \ (via two paths)\n  LEFT JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN\
    \ hash p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent\
    \ = pe1.pid\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path =\
    \ pe_hash1.path -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON\
    \ p1.parent = p1_p2.pid -- Current grandparent via parent processes\n  LEFT JOIN\
    \ processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent\
    \ events\n  LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND\
    \ pe1_pe2.cmdline != '' -- Past grandparent via parent events\n  LEFT JOIN hash\
    \ p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON\
    \ pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path\
    \ = pe1_pe2_hash.path\nWHERE\n  pe.pid IN (\n    SELECT\n      pid\n    FROM\n\
    \      process_events\n    WHERE\n      time > (strftime('%s', 'now') -600)\n\
    \      AND syscall = \"execve\"\n      AND euid < 500\n      AND (\n        uid\
    \ = 0\n        OR euid < uid\n      )\n  )\n  AND pe.time > (strftime('%s', 'now')\
    \ -600)\n  AND pe.syscall = \"execve\"\n  AND pe.euid < 500\n  AND (\n    pe.euid\
    \ < pe.uid\n    OR pe.euid < p1_euid\n    OR pe.euid < pe1.euid\n  )\n  AND pe.path\
    \ NOT IN (\n    '/bin/ps',\n    '/opt/1Password/1Password-KeyringHelper',\n  \
    \  '/usr/bin/doas',\n    '/usr/bin/fusermount',\n    '/usr/bin/fusermount3',\n\
    \    '/usr/bin/gpg',\n    '/usr/bin/gpgconf',\n    '/usr/bin/gpgsm',\n    '/usr/bin/i3lock',\n\
    \    '/usr/bin/login',\n    '/usr/bin/nvidia-modprobe',\n    '/usr/bin/su',\n\
    \    '/usr/bin/sudo',\n    '/usr/bin/top',\n    '/usr/bin/unix_chkpwd',\n    '/usr/lib/slack/chrome-sandbox',\n\
    \    '/usr/lib/snapd/snap-confine',\n    '/usr/lib/snapd/snap-update-ns',\n  \
    \  '/usr/lib/systemd/systemd',\n    '/usr/lib/Xorg.wrap',\n    '/usr/lib/xorg/Xorg.wrap'\n\
    \  )\n  AND pe.path NOT LIKE '/nix/store/%/bin/dhcpcd'\n  AND pe.path NOT LIKE\
    \ '/nix/store/%/bin/sudo'\n  AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine'\n\
    \  AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns'\n  AND NOT\
    \ p1_cmd IN (\n    '/bin/sh -c /usr/bin/pkexec /usr/share/apport/apport-gtk',\n\
    \    '/usr/lib/systemd/systemd --user'\n  )\n  AND NOT p0_cmd = '/usr/bin/pkexec\
    \ /usr/lib/update-notifier/package-system-locked'\n  AND NOT (\n    p0_name =\
    \ 'polkit-agent-helper-1'\n    AND p1_path IN (\n      '/usr/bin/gnome-shell',\n\
    \      '/usr/lib/gvfsd',\n      '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1'\n\
    \    )\n  )\n  AND NOT (\n    p0_name = 'fusermount3'\n    AND p1_path = '/usr/lib/xdg-document-portal'\n\
    \  )\n  AND NOT (\n    p0_name IN ('dash', 'pkexec')\n    AND p1_path = '/usr/bin/update-notifier'\n\
    \  ) -- A bizarro persistent false-positive from an Arch linux host\n  AND NOT\
    \ (\n    p.cgroup_path = \"/init.scope\"\n    AND p1.cgroup_path != \"/init.scope\"\
    \n  )\n  AND NOT p.cgroup_path LIKE '/system.slice/docker-%'\n  AND NOT p1.cgroup_path\
    \ LIKE '/system.slice/docker-%'\nGROUP BY\n  pe.pid\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
