- name: CDK - Unexpected Env Values Linux
  description: 'Applications setting environment variables to bypass security protections
    Inpsired by BPFdoor and other intrusions https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    WARNING: This query is known to require a higher than average wall time.'
  query: "SELECT\n  pe.key,\n  pe.value,\n  LENGTH(pe.value) AS value_len,\n  -- Child\n\
    \  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS\
    \ p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  -- Querying processes first and filtering by time gives a massive 20X\
    \ speed improvement\n  -- over querying process_envs first and JOIN'ing against\
    \ processes\n  processes p0\n  JOIN process_envs pe ON p0.pid = pe.pid\n  LEFT\
    \ JOIN file f ON p0.path = f.path\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n\
    \  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE -- This time should match the\
    \ interval\n  p0.start_time > (strftime('%s', 'now') - 300)\n  AND (\n    pe.key\
    \ = 'HISTFILE'\n    AND NOT pe.value LIKE '/home/%'\n    AND NOT pe.value LIKE\
    \ '/Users/%'\n    AND NOT pe.value LIKE '~/%'\n    AND NOT pe.value LIKE '%/.histfile'\n\
    \    AND NOT pe.value LIKE '/root/.%_history'\n  )\n  OR (\n    pe.key = 'LD_PRELOAD'\n\
    \    AND NOT pe.value = ''\n    AND NOT p0.path LIKE '%/firefox'\n    AND NOT\
    \ pe.value IN (\n      '/opt/splunkforwarder/lib/libdlwrapper.so',\n      '/run/host/usr/lib/extest/libextest.so',\n\
    \      '/snap/lxd/current/lib/x86_64-linux-gnu/libSegFault.so',\n      '/tmp/preload.so',\n\
    \      '/usr/lib/extest/libextest.so',\n      '/usr/lib/libjemalloc.so',\n   \
    \   '/usr/lib/libsnmallocshim-checks-memcpy-only.so',\n      '/usr/lib/libsnmallocshim.so',\n\
    \      '/usr/local/lib/libmimalloc.so',\n      'libapprun_hooks.so',\n      'libeatmydata.so',\n\
    \      'libfakeroot.so'\n    )\n    AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'\n\
    \    AND NOT pe.value LIKE ':/home/%/.local/share/Steam'\n    AND NOT pe.value\
    \ LIKE ':/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so:/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so'\n\
    \    AND NOT pe.value LIKE ':/home/%/.var/app/com.valvesoftware.Steam/%'\n   \
    \ AND NOT pe.value LIKE ':/snap/%'\n    AND NOT pe.value LIKE '/app/bin/%'\n \
    \   AND NOT pe.value LIKE 'libmozsandbox.so%'\n  )\n  -- setuid\n  OR (\n    LENGTH(pe.value)\
    \ > 1024\n    AND pe.key != 'LS_COLORS'\n    AND pe.key != 'HTTP_AUTH'\n    AND\
    \ f.mode IS NOT NULL\n    AND f.mode NOT LIKE '0%'\n  )\n"
  platform: linux
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
