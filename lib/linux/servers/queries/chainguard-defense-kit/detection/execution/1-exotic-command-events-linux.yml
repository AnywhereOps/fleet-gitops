- name: CDK - Exotic Command Events Linux
  description: Pick out exotic processes based on their command-line (events-based)
  query: "SELECT -- Child\n  pe.path AS p0_path,\n  pe.time AS p0_time,\n  pe.uptime\
    \ AS p0_uptime,\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,\n  TRIM(pe.cmdline)\
    \ AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid AS p0_pid,\n  p.cgroup_path AS p0_cgroup,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  REGEX_MATCH\
    \ (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n  \
    \  1\n  ) AS p2_name,\n  -- Exception key\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path),\
    \ '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe\n  LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)\n \
    \ LEFT JOIN processes p1 ON pe.parent = p1.pid\n  AND p1.start_time <= pe.time\n\
    \  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events\
    \ pe1 ON pe.parent = pe1.pid\n  AND pe1.time <= pe.time\n  AND pe1.cmdline !=\
    \ \"\"\n  AND pe1.cwd != \"\"\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  AND p1_p2.start_time <= p1.start_time\n\
    \  LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent\
    \ via parent events\n  AND pe1_p2.start_time <= pe1.time\n  LEFT JOIN process_events\
    \ pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline != \"\"\n  AND pe1_pe2.cwd\
    \ != \"\"\nWHERE\n  pe.time > (strftime('%s', 'now') -600)\n  AND pe.cmdline !=\
    \ \"\"\n  AND pe.cwd != \"\"\n  AND (\n    p0_name IN (\n      'bitspin',\n  \
    \    'bpftool',\n      'cpuminer-multi',\n      'cpuminer',\n      'dnscat2',\n\
    \      'esxcli',\n      'heyoka',\n      'httpdns',\n      'incbit',\n      'insmod',\n\
    \      'iodine',\n      'kmod',\n      'lushput',\n      'minerd',\n      'mkfifo',\n\
    \      'msfvenom',\n      'nc',\n      'nstx',\n      'rsh',\n      'rshell',\n\
    \      'socat',\n      'tuns',\n      'vim-cmd',\n      'xmrig'\n    ) -- Chrome\
    \ Stealer\n    OR p0_name LIKE '%attack%' -- Unusual behaviors\n    OR p0_name\
    \ LIKE '%pwn%'\n    OR p0_cmd LIKE '%cat /dev/null >%'\n    OR p0_cmd LIKE '%chattr\
    \ -i%'\n    OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts\n\
    \    OR p0_cmd LIKE '%dd if=/dev/%'\n    OR p0_cmd LIKE '%iptables -F%'\n    OR\
    \ p0_cmd LIKE '%iptables -P % ACCEPT%'\n    OR p0_cmd LIKE '%iptables stop'\n\
    \    OR p0_cmd LIKE '%setenforce 0'\n    OR p0_cmd LIKE '%truncate -s0 %'\n  \
    \  OR p0_cmd LIKE '%ufw disable%'\n    OR (\n      INSTR(p0_cmd, 'history') >\
    \ 0\n      AND p0_cmd LIKE '%history'\n      AND p0_cmd NOT LIKE 'man %'\n   \
    \ )\n    OR p0_cmd LIKE '%.aws/%'\n    OR p0_cmd LIKE '%.config/%chrome%'\n  \
    \  OR p0_cmd LIKE '%.config%gcloud%'\n    OR p0_cmd LIKE '%ld.so.preload%'\n \
    \   OR p0_cmd LIKE '%nohup%tmp%'\n    OR p0_cmd LIKE '%pkill -f%'\n    OR p0_cmd\
    \ LIKE '%systemctl disable firewalld%'\n    OR p0_cmd LIKE '%systemctl stop firewalld%'\n\
    \    OR p0_cmd LIKE '%tar % .%'\n    OR p0_cmd LIKE '%tar %/.%'\n    OR p0_cmd\
    \ LIKE '%touch -r%'\n    OR p0_cmd LIKE '%touch%acmr%'\n    OR p0_cmd LIKE '%urllib.urlopen%'\n\
    \    OR (\n      p0_cmd LIKE '%xargs kill -9%'\n      AND pe.euid = 0\n    )\n\
    \    OR p0_cmd LIKE '%@reboot%crontab%'\n    OR p0_cmd LIKE '%/dev/%cp/%'\n  \
    \  OR p0_cmd LIKE '%echo%|%base64%-d% %|%'\n    OR p0_cmd LIKE '%fsockopen%'\n\
    \    OR p0_cmd LIKE '%monero%'\n    OR p0_cmd LIKE '%nanopool%'\n    OR p0_cmd\
    \ LIKE '%nicehash%'\n    OR p0_cmd LIKE '%nohup /bin/bash%'\n    OR p0_cmd LIKE\
    \ '%openssl%quiet%'\n    OR p0_cmd LIKE '%pty.spawn%'\n    OR p0_cmd LIKE '%stratum%'\n\
    \    OR p0_cmd LIKE '%UserKnownHostsFile=/dev/null%' -- Crypto miners\n    OR\
    \ (\n      p0_cmd LIKE '%sh -i'\n      AND NOT p1_name IN ('sh', 'java')\n   \
    \ )\n    OR p0_cmd LIKE '%SOCK_STREAM%'\n    OR INSTR(p0_cmd, 'Socket.') > 0\n\
    \    OR (\n      p0_cmd LIKE '%tail -f /dev/null%'\n      AND p.cgroup_path NOT\
    \ LIKE '/system.slice/docker-%'\n    )\n  ) -- Things that could reasonably happen\
    \ at boot.\n  AND NOT (\n    pe.path IN ('/usr/bin/kmod', '/bin/kmod')\n    AND\
    \ p1_path = '/usr/lib/systemd/systemd'\n    AND p1_cmd = '/sbin/init'\n  )\n \
    \ AND NOT (\n    pe.path IN ('/usr/bin/kmod', '/bin/kmod')\n    AND p1_name IN\
    \ (\n      'dockerd',\n      'firewalld',\n      'kube-proxy',\n      'mkinitramfs',\n\
    \      'systemd'\n    )\n  )\n  AND NOT (\n    p0_cmd LIKE '/usr/bin/modprobe\
    \ %'\n    AND p1_cgroup = '/system.slice/firewalld.service'\n  )\n  AND NOT (\n\
    \    pe.path IN ('/usr/bin/kmod', '/bin/kmod')\n    AND pe.uptime < 15\n  )\n\
    \  AND NOT (\n    pe.path = '/usr/bin/mkfifo'\n    AND (\n      p0_cmd LIKE '%/org.gpgtools.log.%/fifo'\n\
    \      OR p0_cmd LIKE 'mkfifo -- %/gitstatus.POWERLEVEL9K%.fifo'\n      OR p0_cmd\
    \ LIKE '%/p10k.%'\n    )\n  )\n  AND NOT p0_cmd IN (\n    'lsmod',\n    'dd if=/dev/stdin\
    \ conv=unblock cbs=79',\n    '/usr/bin/socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket',\n\
    \    'socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket'\n  )\n  AND NOT\
    \ p0_cmd LIKE '%/usr/bin/cmake%Socket%'\n  AND NOT p0_cmd LIKE '%modprobe -va%'\n\
    \  AND NOT p0_cmd LIKE '%modprobe aufs'\n  AND NOT p0_cmd LIKE '%modprobe nf_nat_netbios_ns'\n\
    \  AND NOT p0_cmd LIKE '%modprobe overlay'\n  AND NOT p0_cmd LIKE '%touch -r /tmp/cc%.o\
    \ %'\n  AND NOT p0_cmd LIKE 'find . -executable -type f -name %grep -l GNU Libtool%touch\
    \ -r%'\n  AND NOT p0_cmd LIKE 'modinfo -k%'\n  AND NOT p0_cmd LIKE 'modprobe --all%'\n\
    \  AND NOT p0_cmd LIKE 'modprobe -ab%'\n  AND NOT p0_cmd LIKE 'pkill -f cut -c3%'\n\
    \  AND NOT p0_name IN ('ar', 'cc1', 'cc1plus', 'cmake', 'compile')\n  AND NOT\
    \ exception_key IN (\n    'bash,0,bash,containerd-shim-runc-v2',\n    'bash,500,ninja,bash',\n\
    \    'bwrap,500,melange,dash',\n    'chrome_crashpad_handler,500,systemd,systemd',\n\
    \    'grep,500,fish,konsole',\n    'kmod,0,incusd,systemd',\n    'ls,500,zsh,alacritty',\n\
    \    'nc,500,fish,konsole',\n    'tar,0,incusd,systemd'\n  )\n"
  platform: linux
  interval: 600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
