- name: CDK - Unexpected Execdir Linux
  description: Programs running out of unexpected directories, such as /tmp (state-based)
  query: "SELECT\n  -- Child\n  p0.pid AS p0_pid,\n  p0.cgroup_path AS p0_cgroup,\n\
    \  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd\
    \ AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1_f.mode\
    \ AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN hash\
    \ p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.pid IN (\n    SELECT DISTINCT\n\
    \      pid\n    FROM\n      processes\n    WHERE\n      pid > 1\n      AND path\
    \ != \"\"\n      AND INSTR(path, \"/app/\") != 1\n      AND INSTR(path, \"/bin\"\
    ) != 1\n      AND INSTR(path, \"/home/\") != 1\n      AND INSTR(path, \"/ko-app\"\
    ) != 1\n      AND INSTR(path, \"/nix/\") != 1\n      AND INSTR(path, \"/opt/\"\
    ) != 1\n      AND INSTR(path, \"/sbin/\") != 1\n      AND INSTR(path, \"/snap/\"\
    ) != 1\n      AND INSTR(path, \"/tmp/go-build\") != 1\n      AND INSTR(path, \"\
    /usr/bin/\") != 1\n      AND INSTR(path, \"/usr/lib/\") != 1\n      AND INSTR(path,\
    \ \"/lib/chromium/\") != 1\n      AND INSTR(path, \"/usr/lib64/\") != 1\n    \
    \  AND INSTR(path, \"/usr/libexec\") != 1\n      AND INSTR(path, \"/usr/local/\"\
    ) != 1\n      AND INSTR(path, \"/usr/local/kolide-k2/bin/\") != 1\n      AND INSTR(path,\
    \ \"/usr/sbin/\") != 1\n      AND INSTR(path, \"/usr/share/\") != 1\n      AND\
    \ INSTR(path, \"/usr/x86_64-pc-linux-gnu/bin\") != 1\n      AND INSTR(path, \"\
    /var/home/\") != 1\n      AND INSTR(path, \"/var/kolide-k2/\") != 1\n      AND\
    \ INSTR(path, \"/var/lib/rancher/k3s/\") != 1\n      AND INSTR(path, \"/var/lib/awx/\"\
    ) != 1\n      AND INSTR(path, \"/var/lib/flatpak\") != 1\n      AND INSTR(path,\
    \ \"/var/lib/snapd/\") != 1\n      AND INSTR(path, \"/var/opt/\") != 1\n     \
    \ AND INSTR(path, \"/var/usrlocal/bin/\") != 1\n      AND INSTR(path, \"/var/cache/melange\"\
    ) != 1\n      AND INSTR(path, \"/var/vanta/\") != 1\n      AND path NOT LIKE \"\
    %/.terraform%\"\n      AND path != '/bpfilter_umh'\n      AND NOT path LIKE '/tmp/%/osqtool'\n\
    \      AND NOT path LIKE '/tmp/GoLand/___go_build_%_go'\n      AND NOT cgroup_path\
    \ LIKE '/system.slice/docker-%' -- Interactive terminal\n      AND NOT cgroup_path\
    \ LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/libpod-%'\n \
    \     AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \      AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/snap.%'\n\
    \      AND NOT cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%'\n\
    \      AND NOT cgroup_path LIKE '/kubepods.slice/%'\n      AND NOT (\n       \
    \ cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-gnome-Alacritty-%.scope'\n\
    \        AND path LIKE '/tmp/%'\n      )\n      AND NOT (\n        (\n       \
    \   cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-%.scope'\n\
    \          OR cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/docker-%.scope'\n\
    \        )\n        AND path LIKE '/usr/share/nvm/versions/node/v%/bin/node'\n\
    \      )\n      AND NOT (\n        euid > 500\n        AND (\n          path LIKE\
    \ '/tmp/terraform_%/terraform'\n          OR path LIKE '/tmp/%/output/%'\n   \
    \       OR path LIKE '/tmp/%/_output/%'\n          OR path LIKE '/tmp/%/bin/%'\n\
    \          OR path LIKE '%/.terraform/providers/%'\n          OR path LIKE '/tmp/.mount_%'\n\
    \        )\n      )\n    GROUP BY\n      path\n  )\nGROUP BY\n  p0.pid\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
