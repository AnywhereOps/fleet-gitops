- name: CDK - Unexpected Execdir Events Linux
  description: Catch applications running from unusual directories, such as /tmp (event-based)
  query: "SELECT -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.time\
    \ AS p0_time,\n  pe.pid AS p0_pid,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n\
    \  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p1.euid,\
    \ pe1.euid) AS p1_euid,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n\
    \  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  -- Grandparent\n\
    \  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path)\
    \ AS p2_cgroup,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n\
    \  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n\
    \  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name\nFROM\n  process_events pe\n  LEFT JOIN\
    \ processes p ON pe.pid = pe.pid -- Parents (via two paths)\n  LEFT JOIN processes\
    \ p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n\
    \  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n\
    \  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path -- Grandparents (via 3\
    \ paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent\
    \ via parent processes\n  LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid\
    \ -- Current grandparent via parent events\n  LEFT JOIN process_events pe1_pe2\
    \ ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline != '' -- Past grandparent\
    \ via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash\
    \ pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  pe.pid IN (\n   \
    \ SELECT\n      pid\n    FROM\n      process_events\n    WHERE\n      time > (strftime('%s',\
    \ 'now') -300)\n      AND (\n        INSTR(path, \"/.terraform/\") > 0\n     \
    \   AND INSTR(path, \"/app/\") != 1\n        AND INSTR(path, \"/bin\") != 1\n\
    \        AND INSTR(path, \"/home/\") != 1\n        AND INSTR(path, \"/ko-app\"\
    ) != 1\n        AND INSTR(path, \"/nix/\") != 1\n        AND INSTR(path, \"/opt/\"\
    ) != 1\n        AND INSTR(path, \"/sbin/\") != 1\n        AND INSTR(path, \"/snap/\"\
    ) != 1\n        AND INSTR(path, \"/tmp/go-build\") != 1\n        AND INSTR(path,\
    \ \"/usr/bin/\") != 1\n        AND INSTR(path, \"/usr/lib/\") != 1\n        AND\
    \ INSTR(path, \"/usr/lib64/\") != 1\n        AND INSTR(path, \"/usr/libexec\"\
    ) != 1\n        AND INSTR(path, \"/usr/local/\") != 1\n        AND INSTR(path,\
    \ \"/usr/sbin/\") != 1\n        AND INSTR(path, \"/usr/share/code/\") != 1\n \
    \       AND INSTR(path, \"/usr/share/spotify\") != 1\n        AND INSTR(path,\
    \ \"/usr/share/teams/\") != 1\n        AND INSTR(path, \"/var/kolide-k2/\") !=\
    \ 1\n        AND INSTR(path, \"/var/lib/snapd/\") != 1\n      )\n      AND syscall\
    \ = \"execve\" -- REGEX_MATCH performed terribly. INSTR and LIKE are very very\
    \ close.\n    GROUP BY\n      path\n  )\n  AND pe.time > (strftime('%s', 'now')\
    \ -300)\n  AND pe.syscall = \"execve\"\n  AND p.cgroup_path NOT LIKE '/system.slice/docker-%'\n\
    \  AND p.cgroup_path NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \  AND p1.cgroup_path NOT LIKE '/system.slice/docker-%'\n  AND p1.cgroup_path\
    \ NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    GROUP BY\n  pe.pid\n"
  platform: linux
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
