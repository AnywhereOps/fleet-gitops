- name: CDK - Unexpected Chmod Exec Event Linux
  description: Things that call chmod to set executable permissions
  query: "SELECT\n  IFNULL(\n    REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)', 1),\n\
    \    CONCAT (\n      pe.cwd,\n      '/',\n      REGEX_MATCH (TRIM(pe.cmdline),\
    \ '.* (.*)', 1)\n    )\n  ) AS f_path,\n  f.mode AS f_mode,\n  f.type AS f_type,\n\
    \  hash.sha256 AS f_hash,\n  magic.data AS f_magic,\n  -- Child\n  pe.path AS\
    \ p0_path,\n  COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path) AS p0_name,\n\
    \  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid AS p0_pid,\n  --\
    \ Parent\n  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  REGEX_MATCH\
    \ (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS\
    \ p2_path,\n  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name,\n  -- Exception key\n  REGEX_MATCH (pe.path,\
    \ '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path,\
    \ pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe\n  LEFT JOIN processes p ON pe.pid = p.pid\n  -- Wow, you can do that?\n\
    \  LEFT JOIN file f ON IFNULL(\n    REGEX_MATCH (TRIM(pe.cmdline), '.* (/.*)',\
    \ 1),\n    CONCAT (\n      pe.cwd,\n      '/',\n      REGEX_MATCH (TRIM(pe.cmdline),\
    \ '.* (.*)', 1)\n    )\n  ) = f.path\n  LEFT JOIN hash ON f.path = hash.path\n\
    \  LEFT JOIN magic ON f.path = magic.path\n  -- Parents (via two paths)\n  LEFT\
    \ JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND\
    \ pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n \
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  pe.pid\
    \ IN (\n    SELECT DISTINCT\n      pid\n    FROM\n      process_events\n    WHERE\n\
    \      time > (strftime('%s', 'now') -300)\n      AND syscall = \"execve\"\n \
    \     AND (\n        cmdline LIKE '%chmod% 7%'\n        OR cmdline LIKE '%chmod\
    \ 5%'\n        OR cmdline LIKE '%chmod 1%'\n        OR cmdline LIKE '%chmod +%x'\n\
    \        OR cmdline LIKE '%chmod% +rwx%'\n        OR cmdline LIKE '%chmod% +x%'\n\
    \        OR cmdline LIKE '%chmod% u+x%'\n        OR cmdline LIKE '%chmod% a+x%'\n\
    \      )\n      AND cmdline NOT LIKE 'chmod 777 /app/%'\n      AND cmdline NOT\
    \ LIKE 'chmod 700 /tmp/apt-key-gpghome.%'\n      AND cmdline NOT LIKE 'chmod 700\
    \ /home/%/snap/%/%/.config'\n      AND cmdline NOT LIKE 'chmod +x /home/%/bin/%'\n\
    \      AND cmdline NOT LIKE '%chmod 755 /home/%/.local/share/cinnamon/applets/download-and-upload-speed@cardsurf/translation.sh'\n\
    \  )\n  AND NOT (\n    f_path = '/usr/local/bin/kubectl'\n    AND f_mode IN ('0755',\
    \ '0775')\n  )\n  AND pe.time > (strftime('%s', 'now') -300)\n  AND pe.syscall\
    \ = \"execve\"\n  AND f.type != 'directory'\n  AND p1_cgroup NOT LIKE '/system.slice/docker-%'\n\
    \  AND p1_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \  AND p2_cgroup NOT LIKE '/system.slice/docker-%'\n  AND p2_cgroup NOT LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \  AND NOT exception_key IN (\n    'chmod,500,bash,gnome-terminal-server',\n \
    \   'chmod,500,fish,alacritty',\n    'bash,500,vim.nox,bash',\n    'chmod,500,fish,alacritty',\n\
    \    'dash,500,code,code'\n  )\n  AND NOT (\n    exception_key LIKE '%sh,500,node,%sh'\n\
    \    AND f.path LIKE '%claude%'\n  )\nGROUP BY\n  p0_pid\n"
  platform: linux
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
