- name: CDK - Exotic Commands Linux
  description: Pick out exotic processes based on their command-line (state-based)
  query: "SELECT\n  DATETIME(f.ctime, 'unixepoch') AS p0_changed,\n  DATETIME(f.mtime,\
    \ 'unixepoch') AS p0_modified,\n  (strftime('%s', 'now') - p0.start_time) AS p0_runtime_s,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n\
    \  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n\
    \  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n\
    \  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS\
    \ p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes\
    \ p0\n  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  -- Known attack scripts\n  (\n    p0.name IN (\n  \
    \    'bitspin',\n      'bpftool',\n      'cpuminer-multi',\n      'cpuminer',\n\
    \      'dnscat2',\n      'esxcli',\n      'heyoka',\n      'httpdns',\n      'incbit',\n\
    \      'insmod',\n      'iodine',\n      'kmod',\n      'lushput',\n      'minerd',\n\
    \      'mkfifo',\n      'msfvenom',\n      'nc',\n      'nstx',\n      'rsh',\n\
    \      'rshell',\n      'socat',\n      'tuns',\n      'vim-cmd',\n      'xmrig'\n\
    \    )\n    OR p0.name LIKE '%pwn%'\n    OR p0.name LIKE '%xig%'\n    OR p0.name\
    \ LIKE '%xmr%'\n    OR p0.cmdline LIKE '%--pool%'\n    OR p0.cmdline LIKE '%--algo%'\n\
    \    OR p0.cmdline LIKE '%--wss%'\n    OR p0.cmdline LIKE '%wormhole%'\n    OR\
    \ p0.cmdline LIKE '%bitspin%'\n    OR p0.cmdline LIKE '%lushput%'\n    OR p0.cmdline\
    \ LIKE '%incbit%'\n    OR p0.cmdline LIKE '%traitor%'\n    OR p0.cmdline LIKE\
    \ '%ethereum%'\n    OR p0.cmdline LIKE '%msfvenom%'\n    -- Unusual behaviors\n\
    \    OR p0.cmdline LIKE '%ufw disable%'\n    OR p0.cmdline LIKE '%dd if=/dev/%'\n\
    \    OR p0.cmdline LIKE '%iptables -P % ACCEPT%'\n    OR p0.cmdline LIKE '%iptables\
    \ -F%'\n    OR p0.cmdline LIKE '%chattr -ia%'\n    OR p0.cmdline LIKE '%chflags\
    \ uchg%'\n    OR p0.cmdline LIKE '%bpftool%'\n    OR p0.cmdline LIKE '%tar % .%'\n\
    \    OR p0.cmdline LIKE '%tar %/.%'\n    OR p0.cmdline LIKE '%.config%gcloud%'\n\
    \    OR p0.cmdline LIKE '%.config/%chrome%'\n    OR p0.cmdline LIKE '%touch%acmr%'\n\
    \    OR p0.cmdline LIKE '%ld.so.preload%'\n    OR p0.cmdline LIKE '%urllib.urlopen%'\n\
    \    OR p0.cmdline LIKE '%nohup%tmp%'\n    OR p0.cmdline LIKE '%chrome%--load-extension%'\n\
    \    OR (\n      p0.cmdline LIKE '%UserKnownHostsFile=/dev/null%'\n      AND NOT\
    \ p1.name = 'limactl'\n      AND NOT p0.cmdline LIKE '%@localhost%'\n      AND\
    \ NOT p0.cmdline LIKE '%@localhost -A%'\n    ) -- Crypto miners\n    OR p0.cmdline\
    \ LIKE '%hashrate%'\n    OR p0.cmdline LIKE '%hashvault%'\n    OR p0.cmdline LIKE\
    \ '%minerd%'\n    OR p0.cmdline LIKE '%nanopool%'\n    OR p0.cmdline LIKE '%nicehash%'\n\
    \    OR p0.cmdline LIKE '%stratum%' -- Random keywords\n    OR p0.cmdline LIKE\
    \ '%plant%' -- Reverse shells\n    OR p0.cmdline LIKE '%/dev/%cp/%'\n    OR p0.cmdline\
    \ LIKE '%fsockopen%'\n    OR p0.cmdline LIKE '%openssl%quiet%'\n    OR p0.cmdline\
    \ LIKE '%pty.spawn%'\n    OR (\n      p0.cmdline LIKE '%sh -i'\n      AND NOT\
    \ p0.path = '/usr/bin/docker'\n      AND NOT p1.name IN (\n        'code',\n \
    \       'containerd-shim',\n        'emacs',\n        'goland',\n        'java',\n\
    \        'pycharm',\n        'zsh',\n        'bash',\n        'jetbrains',\n \
    \       'sh',\n        'vim',\n        'vim.nox'\n      )\n      AND NOT p1.cmdline\
    \ LIKE '%pipenv shell'\n      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'\n\
    \      AND NOT p0.cgroup_path LIKE '/user.slice/user-1000.slice/user@1000.service/user.slice/nerdctl-%'\n\
    \    )\n    OR p0.cmdline LIKE '%SOCK_STREAM%'\n    OR INSTR(p0.cmdline, '%Socket.%')\
    \ > 0 -- Keep the shell running, as in https://blog.aquasec.com/threat-alert-kinsing-malware-container-vulnerability\n\
    \    OR (\n      p0.cmdline LIKE '%tail -f /dev/null%'\n      AND NOT p0.cmdline\
    \ LIKE 'docker run%'\n      AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'\n\
    \      AND NOT p1.pid = 0\n    )\n  )\n  AND NOT p0.cmdline like '%socat UNIX-LISTEN:%com.discordapp%discord-ipc%'\n\
    \  AND NOT p0.cmdline IN ('nc 127.0.0.1 5900')\n  AND NOT p0.name IN (\n    'bwrap',\n\
    \    'cc1',\n    'cc1plus',\n    'chrome_crashpad',\n    'cmake',\n    'compile',\n\
    \    'emacs',\n    'espeak',\n    'git'\n  )\n  AND NOT p1.name IN ('bwrap')\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
