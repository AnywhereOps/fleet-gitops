- name: CDK - Unusual Process Name Linux
  description: Processes with executable names that feel weird
  query: "SELECT\n  p0.name AS pname,\n  COALESCE(REGEX_MATCH (p0.path, '.*/(.*)',\
    \ 1), p0.path) AS basename,\n  COALESCE(\n    REGEX_MATCH (p0.name, '.*/.*\\.([a-z]{2,4})$',\
    \ 1),\n    \"\"\n  ) AS pext,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n\
    \  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid\
    \ AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN hash p0_hash\
    \ ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2\
    \ ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p0.start_time < (strftime('%s', 'now') - 43200)\n  AND (\n    pname LIKE\
    \ \"%kthread%\"\n    OR pname LIKE '%xprotect%'\n    OR pname LIKE \"%-help\"\n\
    \    OR pname LIKE \"%/%\"\n    OR pname LIKE \"%acpi%\"\n    OR pname LIKE \"\
    %crypt%\"\n    OR pname LIKE \"%flush%\"\n    OR pname LIKE \"%initd%\"\n    OR\
    \ pname LIKE \"%irq%\"\n    OR pname LIKE \"%kaudit%\"\n    OR pname LIKE \"%kdev%\"\
    \n    OR pname LIKE \"%kdmp%\"\n    OR pname LIKE \"%ksoft%\"\n    OR pname LIKE\
    \ \"%kswap%\"\n    OR pname LIKE \"%kworker%\"\n    OR pname LIKE \"%launchd%\"\
    \n    OR pname LIKE \"%nvme%\"\n    OR pname LIKE \"%tasks%\"\n    OR pname LIKE\
    \ \"%thread%\"\n    OR pname LIKE \"%user_dir%\"\n    OR pname LIKE \"%xdg%\"\n\
    \    OR pname LIKE \"%zswap%\"\n    OR pname LIKE \"cpu%\"\n    OR pname LIKE\
    \ \"events%\"\n    OR pname LIKE \"idle_%\"\n    OR pname LIKE \"mm-%\"\n    OR\
    \ pname LIKE \"nm_%\"\n    OR pname LIKE \"rcu%\"\n    OR REGEX_MATCH (pname,\
    \ '([a-z]{18,})', 1) != \"\"\n    OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})',\
    \ 1) != \"\"\n    OR REGEX_MATCH (pname, '(\\w{40,})', 1) != \"\"\n    OR REGEX_MATCH\
    \ (\n      pname,\n      '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',\n\
    \      1\n    ) != \"\"\n    OR REGEX_MATCH (pname, \"([a-z].*[A-Z].*\\d+.*[a-z].*\\\
    d+)\", 1) != \"\"\n    OR REGEX_MATCH (pname, \"(\\d.*[a-z].*\\d.*[a-z].*\\d+)\"\
    , 1) != \"\"\n    OR REGEX_MATCH (pname, \"(\\d{5,})\", 1) != \"\"\n    OR REGEX_MATCH\
    \ (pname, \"^(\\d\\d)\", 1) != \"\"\n    OR (\n      REGEX_MATCH (pname, \"^(\\\
    W)\", 1) != \"\"\n      AND p0.path NOT LIKE \"/nix/store/%/.%-wrapped\"\n   \
    \ )\n    OR (\n      REGEX_MATCH (pname, \"(\\W)$\", 1) != \"\"\n      AND pname\
    \ NOT LIKE \"%)\"\n    )\n    AND pext NOT IN (\"\", \"gui\", \"cli\", \"us\"\
    , \"node\", \"com\")\n  )\n  AND NOT p1_pid = 2\n  AND NOT p0_pid = 2\n  AND NOT\
    \ pname LIKE '.%-wrap%'\n  AND NOT pname IN ('xdg-open', 'nm-openvpn-auth', 'MainThread')\n\
    \  AND p0.path NOT LIKE \"/nix/store/%\"\n  AND basename NOT IN (\n    \"acpid\"\
    ,\n    \"busybox\",\n    \"nm-openvpn-auth\",\n    \"com.docker.backend\",\n \
    \   \"nm-openvpn-service\",\n    \"com.docker.build\",\n    \"com.docker.extensions\"\
    ,\n    \"cpulimit\",\n    \"dynamiclinkmanager\",\n    'firefox',\n    'firefox-bin',\n\
    \    \"gmenudbusmenuproxy\",\n    \"irqbalance\",\n    \"kactivitymanagerd\",\n\
    \    \"nm-applet\",\n    \"perl\",\n    'pk-debconf-helper',\n    \"pt_main_thread\"\
    ,\n    \"systemd\",\n    \"systemd-executor\",\n    'udevadm',\n    \"xdg-dbpus-proxy\"\
    ,\n    'xdg-dbus-proxy',\n    \"xdg-desktop-portal\",\n    \"xdg-desktop-portal-gnome\"\
    ,\n    \"xdg-desktop-portal-gtk\",\n    \"xdg-desktop-portal-kde\",\n    \"xdg-desktop-portal-regolith\"\
    ,\n    'xdg-desktop-portal-wlr',\n    \"xdg-desktop-portal-xapp\",\n    \"xdg-document-portal\"\
    ,\n    'xdg-open',\n    \"xdg-permission-store\",\n    \"xwaylandvideobridge\"\
    \n  )\n  AND basename NOT LIKE '___Test%'\n  AND basename NOT LIKE '___2Test%'\n\
    \  AND NOT (\n    basename IN ('nm-dispatcher')\n    AND p1_pid = 1\n  )\n"
  platform: linux
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
