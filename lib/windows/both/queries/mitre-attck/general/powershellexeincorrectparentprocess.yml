---
apiVersion: v1
kind: query
spec:
  name: powershell.exe_incorrect_parent_process
  description: Detect processes masquerading as legitimate Windows processes - ATT&CK T1173,T1086,T1204
  query: SELECT name as bad_parent_child_name, pid bad_parent_child_pid FROM processes WHERE pid=(SELECT parent FROM processes WHERE parent!=(SELECT pid from processes where name='explorer.exe') AND LOWER(name)='powershell.exe')
    OR pid=(SELECT pid FROM processes WHERE parent!=(SELECT pid from processes where name='explorer.exe') AND LOWER(name)='powershell.exe');
  interval: 60
  removed: false
  platform: windows
  team: both
