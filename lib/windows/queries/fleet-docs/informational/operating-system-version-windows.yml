---
apiVersion: v1
kind: built-in
spec:
  name: Operating system version (Windows)
  platform: windows
  description: Retrieves operating system version information from a Windows device.
  query: |
    WITH display_version_table AS (
          SELECT data as display_version
          FROM registry
          WHERE path = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\DisplayVersion'
        ),
        ubr_table AS (
          SELECT data AS ubr
          FROM registry
          WHERE path ='HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\UBR'
        )
        SELECT
          os.name,
          COALESCE(d.display_version, '') AS display_version,
          COALESCE(CONCAT((SELECT version FROM os_version), '.', u.ubr), k.version) AS version
        FROM
          os_version os,
          kernel_info k
        LEFT JOIN
          display_version_table d
        LEFT JOIN
          ubr_table u
  powershell: |-
    $os = Get-CimInstance -ClassName Win32_OperatingSystem
    $osName = $os.Caption
    $osVersion = $os.Version

    $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion'

    try {
        $displayVersionObj = Get-ItemProperty -Path $regPath -Name 'DisplayVersion' -ErrorAction Stop
        $displayVersion = $displayVersionObj.DisplayVersion
    } catch {
        $displayVersion = ""
    }

    try {
        $ubrObj = Get-ItemProperty -Path $regPath -Name 'UBR' -ErrorAction Stop
        $ubr = $ubrObj.UBR
    } catch {
        $ubr = $null
    }

    $kernelVersion = [System.Environment]::OSVersion.Version.ToString()

    if ($ubr) {
        $finalVersion = "$osVersion.$ubr"
    } else {
        $finalVersion = $kernelVersion
    }

    Write-Output "Name: $osName"
    Write-Output "DisplayVersion: $displayVersion"
    Write-Output "Version: $finalVersion"
  purpose: Informational
  tags: built-in
