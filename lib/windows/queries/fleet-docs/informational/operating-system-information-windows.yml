---
apiVersion: v1
kind: built-in
spec:
  name: Operating system information (Windows)
  platform: windows
  description: Retrieves information about a Windows device's operating system.
  query: |
    WITH display_version_table AS (
        SELECT data as display_version
        FROM registry
        WHERE path = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\DisplayVersion'
      ),
      ubr_table AS (
      SELECT data AS ubr
      FROM registry
      WHERE path ='HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\UBR'
      )
      SELECT
        os.name,
        os.platform,
        os.arch,
        k.version as kernel_version,
        COALESCE(CONCAT((SELECT version FROM os_version), '.', u.ubr), k.version) AS version,
        COALESCE(d.display_version, '') AS display_version
      FROM
        os_version os,
        kernel_info k
      LEFT JOIN
        display_version_table d
      LEFT JOIN
        ubr_table u
  purpose: Informational
  tags: built-in
