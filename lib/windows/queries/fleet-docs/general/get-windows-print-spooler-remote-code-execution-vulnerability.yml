---
apiVersion: v1
kind: query
spec:
  name: Get Windows print spooler remote code execution vulnerability
  platform: windows
  description: Detects devices that are potentially vulnerable to CVE-2021-1675 because the print spooler service is not disabled.
  query: SELECT CASE cnt WHEN 2 THEN "TRUE" ELSE "FALSE" END "Vulnerable" FROM (SELECT name start_type, COUNT(name) AS cnt FROM services WHERE name = 'NTDS' or (name = 'Spooler' and start_type <> 'DISABLED'))
    WHERE cnt = 2;
  powershell: "$processes = Get-WmiObject -Query \"SELECT * FROM Win32_Process WHERE CommandLine LIKE 'nmap%'\"  \nforeach ($proc in $processes) {  \n    # Get parent's name  \n    $parentName = \"\"  \n\
    \    if ($proc.ParentProcessId) {  \n        $parentProc = Get-WmiObject Win32_Process -Filter \"ProcessId=$($proc.ParentProcessId)\" -ErrorAction SilentlyContinue  \n        if ($parentProc) {  \n\
    \            $parentName = $parentProc.Name  \n        }  \n    }  \n\n    # Get username from process owner  \n    $username = \"\"  \n    $ownerInfo = $proc.GetOwner()  \n    if ($ownerInfo.ReturnValue\
    \ -eq 0) {  \n        $username = \"$($ownerInfo.Domain)\\$($ownerInfo.User)\"  \n    }  \n\n    # Convert WMI creation date to readable time  \n    $startTime = $null  \n    if ($proc.CreationDate)\
    \ {  \n        $startTime = [Management.ManagementDateTimeConverter]::ToDateTime($proc.CreationDate)  \n    }  \n\n    # cwd is not available from Win32_Process; use placeholder  \n    $cwd = \"N/A\"\
    \  \n\n    # Create a custom object with the desired fields  \n    $result = [PSCustomObject]@{  \n        pid         = $proc.ProcessId  \n        name        = $proc.Name  \n        path        =\
    \ $proc.ExecutablePath  \n        cmdline     = $proc.CommandLine  \n        cwd         = $cwd  \n        start_time  = $startTime  \n        parent      = $proc.ParentProcessId  \n        parent_name\
    \ = $parentName  \n        username    = $username  \n    }  \n\n    Write-Output $result  \n}"
  purpose: Informational
  tags: vulnerability
  contributors: maravedi
