---
apiVersion: v1
kind: built-in
spec:
  name: Disk encryption (Windows)
  platform: windows
  description: Retrieves the disk encryption status of a Windows device.
  query: |
    WITH encrypted(enabled) AS (
        SELECT CASE WHEN
          NOT EXISTS(SELECT 1 FROM windows_optional_features WHERE name = 'BitLocker')
          OR
          (SELECT 1 FROM windows_optional_features WHERE name = 'BitLocker' AND state = 1)
        THEN (SELECT 1 FROM bitlocker_info WHERE drive_letter = 'C:' AND protection_status = 1)
      END)
      SELECT 1 FROM encrypted WHERE enabled IS NOT NULL
  powershell: |-
    $bitlockerFeature = Get-WindowsOptionalFeature -Online -FeatureName "BitLocker" -ErrorAction SilentlyContinue
    if (-not $bitlockerFeature -or $bitlockerFeature.State -eq "Enabled") {
        $bitlockerVolume = Get-BitLockerVolume -MountPoint "C:" -ErrorAction SilentlyContinue
        if ($bitlockerVolume -and ($bitlockerVolume.ProtectionStatus -eq 1 -or $bitlockerVolume.ProtectionStatus -eq "On")) {
            Write-Output "1"
        }
    }
  purpose: Informational
  tags: built-in
