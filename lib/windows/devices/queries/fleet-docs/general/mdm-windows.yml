- name: MDM (Windows)
  description: Retrieves information about the mobile device management (MDM) solution
    a windows device is enrolled in.
  query: "WITH registry_keys AS (\n            SELECT *\n            FROM registry\n\
    \            WHERE path LIKE 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Enrollments\\\
    %%'\n          ),\n          enrollment_info AS (\n            SELECT\n      \
    \        MAX(CASE WHEN name = 'UPN' THEN data END) AS upn,\n              MAX(CASE\
    \ WHEN name = 'DiscoveryServiceFullURL' THEN data END) AS discovery_service_url,\n\
    \              MAX(CASE WHEN name = 'ProviderID' THEN data END) AS provider_id,\n\
    \              MAX(CASE WHEN name = 'EnrollmentState' THEN data END) AS state,\n\
    \              MAX(CASE WHEN name = 'AADResourceID' THEN data END) AS aad_resource_id\n\
    \            FROM registry_keys\n            GROUP BY key\n          ),\n    \
    \      installation_info AS (\n            SELECT data AS installation_type\n\
    \            FROM registry\n            WHERE path = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\\
    Microsoft\\Windows NT\\CurrentVersion\\InstallationType'\n            LIMIT 1\n\
    \          )\n          SELECT\n            e.aad_resource_id,\n            e.discovery_service_url,\n\
    \            e.provider_id,\n            i.installation_type\n          FROM installation_info\
    \ i\n          LEFT JOIN enrollment_info e ON e.upn IS NOT NULL\n      -- coalesce\
    \ to 'unknown' and keep that state in the list\n      -- in order to account for\
    \ hosts that might not have this\n      -- key, and servers\n          WHERE COALESCE(e.state,\
    \ '0') IN ('0', '1', '2', '3')\n      -- old enrollments that aren't completely\
    \ cleaned up may still be around\n      -- in the registry so we want to make\
    \ sure we return the one with an actual\n      -- discovery URL set if there is\
    \ one. LENGTH is used here to prefer those\n      -- with actual URLs over empty\
    \ string/null if there are multiple\n          ORDER BY LENGTH(e.discovery_service_url)\
    \ DESC\n          LIMIT 1;\n"
  platform: windows
