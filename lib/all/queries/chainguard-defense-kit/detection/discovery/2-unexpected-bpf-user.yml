---
apiVersion: v1
kind: query
spec:
  name: CDK - Unexpected Bpf User
  description: 'Find root-run processes which link against libpf WARNING: This check consumes an unusual amount of system memory (up to 225MB)'
  query: |
    SELECT
      pmm.pid,
      pmm.path AS lib_path,
      p.path,
      p.name,
      p.cmdline,
      p.cwd,
      p.euid,
      p.parent,
      pp.path AS parent_path,
      pp.name AS parent_name,
      pp.cmdline AS parent_cmdline,
      pp.cwd AS parent_cwd,
      pp.euid AS parent_euid,
      hash.sha256 AS child_sha256,
      phash.sha256 AS parent_sha256
      -- Using processes is much faster than process_memory_map
    FROM
      processes p
      LEFT JOIN process_memory_map pmm ON p.pid = pmm.pid
      LEFT JOIN processes pp ON p.parent = pp.pid
      LEFT JOIN hash ON p.path = hash.path
      LEFT JOIN hash AS phash ON pp.path = phash.path
    WHERE
      p.euid = 0
      AND (
        lib_path LIKE '%:bpf%'
        OR lib_path LIKE '%libbpf%'
      )
      AND p.path NOT IN (
        '/opt/Elastic/Endpoint/elastic-endpoint',
        '/usr/bin/qemu-system-x86_64',
        '/usr/lib/systemd/systemd-nsresourced',
        '/usr/lib/systemd/systemd',
        '/var/opt/Elastic/Endpoint/elastic-endpoint'
      )
      AND p.cmdline != '/usr/bin/python3 /usr/sbin/execsnoop-bpfcc'
      AND p.path NOT LIKE '/nix/store/%/lib/systemd/systemd'
      AND p.name != "xcover"
    GROUP BY
      pmm.pid
  interval: 3600
  logging: snapshot
  observer_can_run: true
  automations_enabled: false
  discard_data: false
