---
apiVersion: v1
kind: query
spec:
  name: CDK - Unexpected Ssh Authorized Keys
  description: Find unexpected SSH authorized keys
  query: |
    SELECT
      file.path,
      file.uid,
      file.gid,
      file.atime,
      file.mtime,
      file.ctime,
      file.size,
      hash.sha256,
      users.username,
      users.uid AS u_uid
    FROM
      users
      JOIN file ON file.path = users.directory || "/.ssh/authorized_keys"
      JOIN hash ON file.path = hash.path
    WHERE
      file.size > 0
      AND (
        file.uid != u_uid
        OR file.uid < 500
        OR (
          file.path NOT LIKE '/home/%'
          AND file.path NOT LIKE '/Users/%'
        )
      )
  interval: 3600
  logging: snapshot
  observer_can_run: true
  automations_enabled: false
  discard_data: false
