---
apiVersion: v1
kind: query
spec:
  name: Get local user accounts
  platform: darwin, linux, windows
  description: Local user accounts (including domain accounts that have logged on locally (Windows)).
  query: SELECT uid, gid, username, description, directory, shell FROM users;
  powershell: |-
    $groupMapping = @{}
    $localGroups = Get-LocalGroup -ErrorAction SilentlyContinue
    foreach ($group in $localGroups) {
        $members = Get-LocalGroupMember -Group $group.Name -ErrorAction SilentlyContinue
        foreach ($member in $members) {
            if ($member.ObjectClass -eq 'User') {
                if (-not $groupMapping.ContainsKey($member.SID.Value)) {
                    $groupMapping[$member.SID.Value] = @()
                }
                $groupMapping[$member.SID.Value] += $group.Name
            }
        }
    }

    $users = Get-LocalUser -ErrorAction SilentlyContinue
    $results = foreach ($user in $users) {
        $userGroups = $groupMapping[$user.SID.Value]
        [PSCustomObject]@{
            uid       = $user.SID.Value
            username  = $user.Name
            type      = 'Local'
            groupname = if ($userGroups) { $userGroups -join ',' } else { 'N/A' }
        }
    }
    $results | Format-Table -AutoSize
  bash: echo "uid,username,type,groupname"; for u in $(dscl . list /Users); do uid=$(dscl . read /Users/"$u" UniqueID 2>/dev/null | awk '{print $2}'); pgrp=$(dscl . read /Users/"$u" PrimaryGroupID 2>/dev/null
    | awk '{print $2}'); grp=$(dscl . list /Groups PrimaryGroupID | awk -v id="$pgrp" '$2==id{print $1}'); type=$( [ "$uid" -lt 500 ] && echo system || echo local); echo "$uid,$u,$type,$grp"; done
  purpose: informational
  tags: hunting, inventory
  contributors: anelshaer
