---
apiVersion: v1
kind: query
spec:
  name: Discover TLS certificates
  platform: linux, windows, darwin
  description: Retrieves metadata about TLS certificates for servers listening on the local machine. Enables mTLS adoption analysis and cert expiration notifications.
  query: SELECT * FROM curl_certificate WHERE hostname IN (SELECT DISTINCT 'localhost:'||port FROM listening_ports WHERE protocol=6 AND address!='127.0.0.1' AND address!='::1');
  powershell: "function Get-CurlCertificate {\n    param(\n        [string]$hostname,\n        [int]$port\n    )\n    try {\n        $tcpClient = New-Object System.Net.Sockets.TcpClient\n        $tcpClient.Connect($hostname,\
    \ $port)\n        $networkStream = $tcpClient.GetStream()\n        $sslStream = New-Object System.Net.Security.SslStream($networkStream, $false, { return $true })\n        $sslStream.ReadTimeout = 5000\n\
    \        $sslStream.WriteTimeout = 5000\n        $sslStream.AuthenticateAsClient($hostname)\n        $remoteCert = $sslStream.RemoteCertificate\n        if ($remoteCert) {\n            $cert = New-Object\
    \ System.Security.Cryptography.X509Certificates.X509Certificate2 $remoteCert\n            [PSCustomObject]@{\n                Hostname   = \"$hostname`:$port\"\n                Subject    = $cert.Subject\n\
    \                Issuer     = $cert.Issuer\n                NotBefore  = $cert.NotBefore\n                NotAfter   = $cert.NotAfter\n                Thumbprint = $cert.Thumbprint\n            }\n\
    \        }\n        else {\n            [PSCustomObject]@{\n                Hostname   = \"$hostname`:$port\"\n                Error      = \"No certificate returned\"\n            }\n        }\n  \
    \      $sslStream.Close()\n        $tcpClient.Close()\n    }\n    catch {\n        [PSCustomObject]@{\n            Hostname = \"$hostname`:$port\"\n            Error    = \"Failed to retrieve certificate\
    \ - $_\"\n        }\n    }\n}\n\n# Get distinct TCP listening ports where local address is not 127.0.0.1 or ::1\n$ports = Get-NetTCPConnection -State Listen -Protocol TCP |\n    Where-Object { $_.LocalAddress\
    \ -ne \"127.0.0.1\" -and $_.LocalAddress -ne \"::1\" } |\n    Select-Object -ExpandProperty LocalPort -Unique\n\nforeach ($port in $ports) {\n    # Use \"localhost\" as the hostname to match the pattern\
    \ \"localhost:port\"\n    $result = Get-CurlCertificate -hostname \"localhost\" -port $port\n    $result\n}"
  bash: echo "Hostname,Subject,Issuer"; netstat -an | grep LISTEN | grep -v '127.0.0.1' | grep -v '::1' | awk '{print $4}' | sed -E 's/.*\.//' | sort -u | while read port; do cert=$(echo | openssl s_client
    -connect localhost:$port -servername localhost 2>/dev/null | openssl x509 -noout -subject -issuer 2>/dev/null); subject=$(echo "$cert" | grep '^subject=' | sed 's/subject=//'); issuer=$(echo "$cert"
    | grep '^issuer=' | sed 's/issuer=//'); echo "localhost:$port,$subject,$issuer"; done
  purpose: Informational
  tags: network, tls
  contributors: nabilschear
  team: servers
