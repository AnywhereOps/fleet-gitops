---
apiVersion: v1
kind: query
spec:
  name: Get local users and their privileges
  platform: darwin, linux, windows
  description: Collects the local user accounts and their respective user group.
  query: SELECT uid, username, type, groupname FROM users u JOIN groups g ON g.gid = u.gid;
  powershell: |-
    $groupMapping = @{}
    $localGroups = Get-LocalGroup -ErrorAction SilentlyContinue
    foreach ($group in $localGroups) {
        $members = Get-LocalGroupMember -Group $group.Name -ErrorAction SilentlyContinue
        foreach ($member in $members) {
            if ($member.ObjectClass -eq 'User') {
                if (-not $groupMapping.ContainsKey($member.SID.Value)) {
                    $groupMapping[$member.SID.Value] = @()
                }
                $groupMapping[$member.SID.Value] += $group.Name
            }
        }
    }

    $users = Get-LocalUser -ErrorAction SilentlyContinue
    $results = foreach ($user in $users) {
        $userGroups = $groupMapping[$user.SID.Value]
        [PSCustomObject]@{
            uid       = $user.SID.Value
            username  = $user.Name
            type      = 'Local'
            groupname = if ($userGroups) { $userGroups -join ',' } else { 'N/A' }
        }
    }
    $results | Format-Table -AutoSize
  purpose: informational
  tags: inventory
  contributors: noahtalerman
