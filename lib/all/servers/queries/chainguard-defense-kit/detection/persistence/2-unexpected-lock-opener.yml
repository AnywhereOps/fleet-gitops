- name: CDK - Unexpected Lock Opener
  description: Find unexpected programs with open lock files
  query: "SELECT\n  CONCAT (\n    MIN(p0.euid, 500),\n    ',',\n    COALESCE(REGEX_MATCH\
    \ (p0.path, '.*/(.*)', 1), p0.path),\n    ',',\n    COALESCE(\n      REGEX_MATCH\
    \ (REPLACE(pof.path, u.directory, '~'), '(.*)/.*', 1),\n      REPLACE(pof.path,\
    \ u.directory, '~')\n    )\n  ) AS exception_key,\n  pof.path AS lock,\n  -- Child\n\
    \  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.start_time\
    \ AS p0_start,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path\
    \ AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.start_time\
    \ AS p1_start,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  JOIN users u ON p0.euid\
    \ = u.uid\n  LEFT JOIN process_open_files pof ON p0.pid = pof.pid\n  LEFT JOIN\
    \ hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  pof.path LIKE \"%.lock\"\n  AND NOT pof.path NOT LIKE \"/run/user/%/%.lock\"\
    \n  AND NOT p0.path LIKE '/System/%'\n  AND NOT exception_key IN (\n    '0,com.apple.MobileSoftwareUpdate.CryptegraftService,/private/var/db/softwareupdate/SplunkHistory',\n\
    \    '0,snapd,/var/lib/snapd',\n    '120,gnome-shell,/run/user/120',\n    '120,pipewire,/run/user/120',\n\
    \    '127,pipewire,/run/user/127',\n    '200,NRDUpdated,/private~/SplunkHistory',\n\
    \    '200,softwareupdated,/private~/SplunkHistory',\n    '500,Adobe Premiere Pro\
    \ 2023,~/Library/Caches/Adobe/Premiere Pro/23.0/SentryIO-db',\n    '500,Beeper,~/Library/Application\
    \ Support/Beeper/EventStore',\n    '500,bridge,~/Library/Application Support/protonmail/bridge-v3/sentry_cache',\n\
    \    '500,bridge,~/Library/Caches/protonmail/bridge-v3',\n    '500,bridge-gui,~/Library/Application\
    \ Support/protonmail/bridge-v3/sentry_cache',\n    '500,bridge-gui,~/Library/Caches/protonmail/bridge-v3',\n\
    \    '500,buildkitd,~/.local/share/buildkit',\n    '500,Clipy,~/Library/Application\
    \ Support/com.clipy-app.Clipy',\n    '500,com.docker.backend,~/Library/Containers/com.docker.docker',\n\
    \    '500,com.docker.build,~/.docker/desktop-build',\n    '500,Craft,~/Library/Containers/com.lukilabs.lukiapp/Data/Library/Application\
    \ Support/com.lukilabs.lukiapp',\n    '500,Ecamm Live Stream Deck Plugin,~/Library/Application\
    \ Support/com.elgato.StreamDeck/Sentry',\n    '500,firefox,/run/user/1000/snap.firefox',\n\
    \    '500,flyctl,~/.fly',\n    '500,gnome-shell,/run/user/1000',\n    '500,Hyprland,/run/user/1000',\n\
    \    '500,iMovie,~/Movies/iMovie Library.imovielibrary',\n    '500,kwin_wayland_wrapper,/run/user/1000',\n\
    \    '500,Opera,~/Library/Application Support/com.operasoftware.Opera',\n    '500,photolibraryd,~/Library/Photos/Libraries/Syndication.photoslibrary/database',\n\
    \    '500,photolibraryd,~/Pictures/Photos Library.photoslibrary/database',\n \
    \   '500,pipewire,/run/user/1000',\n    '500,reMarkable,~/Library/Application\
    \ Support/remarkable/desktop',\n    '500,Stream Deck,~/Library/Application Support/com.elgato.StreamDeck/Sentry',\n\
    \    '500,sway,/run/user/1000',\n    '500,TwitchStudioStreamDeck,~/Library/Application\
    \ Support/com.elgato.StreamDeck/Sentry'\n  )\n  AND NOT exception_key LIKE '%,gnome-shell,/run/user/%'\n\
    \  AND NOT exception_key LIKE '%,pipewire%,/run/user/%'\n  AND NOT exception_key\
    \ LIKE '0,prl_disp_service,/Users/%/Parallels/%.pvm'\n  AND NOT exception_key\
    \ LIKE '500,%,/private/var/folders/%/T/Sentry_StreamDeck'\n  AND NOT exception_key\
    \ LIKE '500,com.apple.Virtualization.VirtualMachine,/private/var/folders/%'\n\
    \  AND NOT exception_key LIKE '500,com.apple.Virtualization.VirtualMachine,~/%'\n\
    \  AND NOT exception_key LIKE '500,com.docker.backend,/private/var/folders/%/go/pkg/mod/cache/%'\n\
    \  AND NOT exception_key LIKE '500,gnome-software,/var/tmp/flatpak-cache-%'\n\
    \  AND NOT exception_key LIKE '500,go,~/go/pkg/mod/cache/download/%'\n  AND NOT\
    \ exception_key LIKE '500,golangci-lint,/private/var/folders/%/T'\n  AND NOT exception_key\
    \ LIKE '500,iMovie,%.imovielibrary'\n  AND NOT exception_key LIKE '500,iTermServer-%,~/Library/Application\
    \ Support/iTerm2'\n  AND NOT exception_key LIKE '500,lua-language-server,~/%'\n\
    \  AND NOT exception_key LIKE '500,remindd,/private/var/folders/%/T/.AddressBookLocks'\n\
    \  AND NOT exception_key LIKE '500,ykman-gui,/private/var/folders/%/T'\nGROUP\
    \ BY\n  p0.path,\n  pof.path\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
