- name: CDK - Listening From Unusual Location
  description: Unexpected programs listening from /tmp or other weird directories
    Canonical example of information to include for processes
  query: "SELECT\n  lp.address,\n  lp.port,\n  lp.protocol,\n  REPLACE(f.directory,\
    \ u.directory, '~') AS homepath,\n  REPLACE(p0.cwd, u.directory, '~') AS homecwd,\n\
    \  CONCAT (\n    MIN(lp.port, 32768),\n    ',',\n    lp.protocol,\n    ',',\n\
    \    MIN(p0.uid, 500),\n    ',',\n    p0.name\n  ) AS exception_key,\n  -- Child\n\
    \  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.start_time\
    \ AS p0_start,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path\
    \ AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.start_time\
    \ AS p1_start,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  listening_ports lp\n  JOIN processes p0\
    \ ON lp.pid = p0.pid\n  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN users\
    \ u ON f.uid = u.uid\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT\
    \ JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  lp.port != 0\n  AND NOT lp.address\
    \ IN (\"127.0.0.1\", \"::1\")\n  AND (\n    p0.path LIKE \"/private/tmp%\"\n \
    \   OR p0.path LIKE \"/private/var/tmp%\"\n    OR p0.path LIKE \"/var/tmp%\"\n\
    \    OR p0.path LIKE \"/tmp%\"\n    OR p0.path LIKE \"/dev%\"\n    OR p0.path\
    \ LIKE \"/Users/Shared%\"\n    OR p0.path LIKE \"%/.%\"\n    OR p0.cwd LIKE \"\
    /private/tmp%\"\n    OR p0.cwd LIKE \"/private/var/tmp%\"\n    OR p0.cwd LIKE\
    \ \"/var/tmp%\"\n    OR p0.cwd LIKE \"/tmp%\"\n    OR p0.cwd LIKE \"/dev%\"\n\
    \    OR p0.cwd LIKE \"%/.%\"\n    OR p0.cwd LIKE \"/Users/Shared%\"\n  )\n  AND\
    \ NOT (\n    p0.name IN (\n      'aws',\n      'caddy',\n      'controller',\n\
    \      'crane',\n      'docker-proxy',\n      'gopls',\n      'hugo',\n      'kubectl',\n\
    \      'limactl',\n      'nginx-ingress-c',\n      'node',\n      'nuclei',\n\
    \      'ollama',\n      'ping',\n      'qemu-system-aarch64',\n      'qemu-system-x86',\n\
    \      'rootlessport',\n      'webhook'\n    )\n    AND lp.port > 1024\n    and\
    \ lp.protocol = 6\n  )\n  -- Overly broad, but prevents a lot of false positives\n\
    \  AND NOT homepath LIKE \"~/.%\"\n  AND NOT homecwd LIKE \"~/.%\"\n  AND NOT\
    \ homecwd LIKE \"~/src/%\"\n  AND NOT homecwd LIKE \"~/repos/%\"\n  AND NOT homecwd\
    \ LIKE '/Users/%/.gradle/daemon/%'\n  AND NOT homecwd LIKE '/home/%/.gradle/daemon/%'\n\
    \  AND NOT f.directory IN (\n    '/Applications/Keybase.app/Contents/SharedSupport/bin',\n\
    \    '/opt/docker-desktop/bin'\n  )\n  AND NOT exception_key IN (\n    '16620,6,500,psi-bastion',\n\
    \    '2112,6,500,rebuilder',\n    '32768,6,500,java',\n    '32768,6,500,logioptionsplus_agent',\n\
    \    '32768,17,500,logioptionsplus_agent',\n    '32768,6,500,Chromium',\n    '32768,6,500,Code\
    \ Helper (Plugin)',\n    '24024,17,500,MTGA',\n    '32768,6,500,Python',\n   \
    \ '32768,6,500,python3',\n    '32768,17,499,viscosity_openvpn',\n    '9867,6,500,bazel-remote',\n\
    \    '1,1,500,ping'\n  )\n  AND NOT p0.path LIKE '/nix/store/%'\n  AND NOT p0.path\
    \ LIKE '/Users/Shared/Epic Games/%'\n  AND NOT p0.path LIKE '/tmp/go-build%'\n\
    \  AND NOT (\n    exception_key = '32768,17,500,qemu-system-x86'\n    AND homecwd\
    \ LIKE '/tmp/wolfi-%'\n  )\n  AND NOT (\n    exception_key = '32768,17,500,go'\n\
    \    AND homecwd LIKE '%/.terraform/modules/%'\n  )\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
