- name: CDK - Sketchy Fetcher
  description: 'Suspicious URL requests by built-in fetching tools (state-based) refs:
    * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer) * https://attack.mitre.org/techniques/T1571/
    (Non-Standard Port)'
  query: "SELECT\n  REGEX_MATCH (p0.cmdline, '(\\w+:\\/\\/.*)\\b', 1) AS url,\n  REGEX_MATCH\
    \ (p0.cmdline, '//(\\d+\\.\\d+\\.\\d+\\.\\d+)[:/]', 1) AS ip,\n  REGEX_MATCH (p0.cmdline,\
    \ ':(\\d+)', 1) AS port,\n  REGEX_MATCH (p0.cmdline, '//([\\w\\-\\.]+)[:/]', 1)\
    \ AS addr,\n  REGEX_MATCH (p0.cmdline, '//[\\w\\-\\.]+\\.(\\w+)[:/]', 1) AS tld,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n\
    \  p0.start_time AS p0_start,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n\
    \  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1.start_time AS p1_start,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n\
    \  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name\
    \ AS p2_name,\n  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN\
    \ hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  -- NOTE: Sync remaining portion with sketchy-fetcher-events\n  (\n  \
    \  INSTR(p0.cmdline, 'wget ') > 0\n    OR INSTR(p0.cmdline, 'curl ') > 0\n  )\n\
    \  -- Sketchy fetcher events always seem to contain a switch\n  AND p0.cmdline\
    \ LIKE '%-%'\n  AND p0.cmdline LIKE '%/%'\n  AND (\n    ip NOT IN ('', '127.0.0.1',\
    \ '::1')\n    AND ip NOT LIKE '172.17.%'\n    OR port != ''\n    OR tld NOT IN\
    \ (\n      '',\n      'app',\n      'ca',\n      'cloud',\n      'com',\n    \
    \  'de',\n      'dev',\n      'edu',\n      'fun',\n      'gov',\n      'io',\n\
    \      'md',\n      'mil',\n      'net',\n      'org',\n      'se',\n      'sh',\n\
    \      'so',\n      'uk'\n    )\n    OR p0.cmdline LIKE '%.onion%'\n    OR p0.cmdline\
    \ LIKE '%aliyun%'\n    OR p0.cmdline LIKE '%chmod%'\n    OR p0.cmdline LIKE '%curl\
    \ -k%'\n    OR p0.cmdline LIKE '%curl -sL %'\n    OR p0.cmdline LIKE '%curl %--user-agent%'\n\
    \    OR p0.cmdline LIKE '%curl%--connect-timeout%'\n    OR p0.cmdline LIKE '%curl%--insecure%'\n\
    \    OR p0.cmdline LIKE '%curl%-o-%'\n    OR p0.cmdline LIKE '%pastebin%'\n  \
    \  OR p0.cmdline LIKE '%tor2web%'\n    OR p0.cmdline LIKE '%wget -nc%'\n    OR\
    \ p0.cmdline LIKE '%wget -q%'\n    OR p0.cmdline LIKE '%wget -t%'\n    OR p0.cmdline\
    \ LIKE '%wget %--no-check-certificate%'\n    OR p0.cmdline LIKE '%wget %--user-agent%'\n\
    \    OR (\n      p0.cmdline LIKE '%wget %'\n      AND p0.euid < 500\n      --\
    \ TODO: Update this query to understand containers\n      AND p1.path NOT IN (\n\
    \        \"/usr/bin/bwrap\",\n        \"/bin/busybox\",\n        \"/usr/bin/melange\"\
    \n      )\n    )\n    OR (\n      p0.cmdline LIKE '%curl %'\n      AND p0.euid\
    \ < 500\n      AND p0.cmdline NOT LIKE \"%./configure %--with-curl%\"\n    )\n\
    \  )\n  -- Exceptions for all calls\n  AND p1.name NOT IN ('makepkg') -- Exceptions\
    \ for non-privileged calls\n  AND NOT (\n    p0.euid > 500\n    AND (\n      p0.cmdline\
    \ LIKE '%--dump-header%'\n      OR p0.cmdline LIKE '%--progress-bar%'\n      OR\
    \ p0.cmdline LIKE '%.well-known/openid-configuration%'\n      OR p0.cmdline LIKE\
    \ '%/api/v%'\n      OR p0.cmdline LIKE '%/openid/v1/jwks%'\n      OR p0.cmdline\
    \ LIKE '%127.0.0.1:%'\n      OR p0.cmdline LIKE '%169.254.169.254%'\n      OR\
    \ p0.cmdline LIKE '%application/json%'\n      OR p0.cmdline LIKE '%aws-ec2-metadata%'\n\
    \      OR p0.cmdline LIKE '%ctlog%'\n      OR p0.cmdline LIKE '%curl -X %'\n \
    \     OR p0.cmdline LIKE '%go mod %'\n      OR p0.cmdline LIKE '%grpcurl%'\n \
    \     OR p0.cmdline LIKE '%Homebrew%'\n      OR p0.cmdline LIKE '%If-None-Match%'\n\
    \      OR p0.cmdline LIKE '%LICENSES/vendor/%'\n      OR p0.cmdline LIKE '%localhost:%'\n\
    \      OR p0.cmdline LIKE '%Nixpkgs/%'\n      OR p0.cmdline LIKE 'curl -sL wttr.in%'\n\
    \      OR p0.cmdline LIKE 'git %'\n      OR p1.cmdline LIKE '/nix/store/%-builder.sh'\n\
    \      OR p1.cmdline LIKE '%brew.rb%'\n      OR p1.cmdline LIKE '%brew.sh%'\n\
    \      OR p0.name IN ('apko')\n    )\n  )\n  -- These are typically curl -k calls\n\
    \  -- We need the addr \"IS NOT NULL\" to avoid filtering out\n  -- NULL entries\n\
    \  AND NOT (\n    addr IS NOT NULL\n    AND (\n      addr IN (\n        'releases.hashicorp.com',\n\
    \        'github.com',\n        'dl.enforce.dev'\n      )\n      -- Ignore local\
    \ addresses (Docker development)\n      OR addr NOT LIKE '%.%'\n      OR ip LIKE\
    \ '172.21.%'\n      OR ip LIKE '192.168.%'\n    )\n  )\n  -- Qualys Cloud Agent\n\
    \  AND NOT (\n    addr = \"169.254.169.254\"\n    AND p2.path = \"/usr/local/qualys/cloud-agent/bin/qualys-scan-util\"\
    \n  )\n  -- Elastic Agent\n  AND NOT p0.path LIKE '/Library/Elastic/Agent/%'\n\
    \  AND NOt p0.cmdline LIKE '%/osqueryd %'\n  -- Dumb things run under Docker\n\
    \  AND NOT p0_cgroup LIKE '/system.slice/docker-%'\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
