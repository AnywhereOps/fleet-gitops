- name: CDK - Sketchy Fetcher Events
  description: 'Suspicious URL requests by built-in fetching tools (event-based) refs:
    * https://attack.mitre.org/techniques/T1105/ (Ingress Tool Transfer) * https://attack.mitre.org/techniques/T1571/
    (Non-Standard Port)'
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid\
    \ AS p0_pid,\n  pe.time AS p0_time,\n  p.cgroup_path AS p0_cgroup,\n  -- Parent\n\
    \  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n  TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  -- Extra fields\n  REGEX_MATCH (pe.cmdline, '(\\w+:\\\
    /\\/.*)\\b', 1) AS url,\n  REGEX_MATCH (pe.cmdline, '[ /](\\d+\\.\\d+\\.\\d+\\\
    .\\d+)[:/]', 1) AS ip,\n  REGEX_MATCH (pe.cmdline, ':(\\d+)', 1) AS port,\n  REGEX_MATCH\
    \ (pe.cmdline, '//([\\w\\-\\.]+)[:/]', 1) AS addr,\n  REGEX_MATCH (pe.cmdline,\
    \ '//[\\w\\-\\.]+\\.(\\w+)[:/]', 1) AS tld\nFROM\n  process_events pe,\n  uptime\n\
    \  LEFT JOIN processes p ON pe.pid = p.pid\n  -- Parents (via two paths)\n  LEFT\
    \ JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND\
    \ pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n \
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n  -- Extra\
    \ fields\nWHERE\n  pe.time > (strftime('%s', 'now') -120)\n  AND pe.cmdline !=\
    \ ''\n  -- NOTE: Sync remaining portion with sketchy-fetchers\n  AND (\n    INSTR(pe.cmdline,\
    \ 'wget ') > 0\n    OR INSTR(pe.cmdline, 'curl ') > 0\n  )\n  -- Sketchy fetcher\
    \ events always seem to contain a switch\n  AND pe.cmdline LIKE '%-%'\n  AND pe.cmdline\
    \ LIKE '%/%'\n  AND (\n    -- If it's an IP or port, it's suspicious\n    ip NOT\
    \ IN ('', '127.0.0.1', '0.0.0.0', '::1')\n    OR port != ''\n    OR tld NOT IN\
    \ (\n      '',\n      'app',\n      'ca',\n      'cloud',\n      'com',\n    \
    \  'de',\n      'dev',\n      'edu',\n      'fun',\n      'gov',\n      'io',\n\
    \      'md',\n      'mil',\n      'net',\n      'org',\n      'se',\n      'sh',\n\
    \      'so',\n      'uk',\n      'us'\n    )\n    -- Or if it matches weird keywords\
    \ we've seen\n    OR p.cmdline LIKE '%chmod%'\n    OR pe.cmdline LIKE '%.onion%'\n\
    \    OR pe.cmdline LIKE '%aliyun%'\n    OR pe.cmdline LIKE '%curl -k%'\n    OR\
    \ pe.cmdline LIKE '%curl -sL %'\n    OR pe.cmdline LIKE '%curl %--user-agent%'\n\
    \    OR pe.cmdline LIKE '%curl.*â€”write-out%'\n    OR pe.cmdline LIKE '%curl%--connect-timeout%'\n\
    \    OR pe.cmdline LIKE '%curl%--insecure%'\n    OR pe.cmdline LIKE '%curl%--O\
    \ /dev/null%'\n    OR pe.cmdline LIKE '%curl%--output /dev/null%'\n    OR pe.cmdline\
    \ LIKE '%curl%-o-%'\n    OR pe.cmdline LIKE '%pastebin%'\n    OR pe.cmdline LIKE\
    \ '%tor2web%'\n    OR pe.cmdline LIKE '%wget -nc%'\n    OR pe.cmdline LIKE '%wget\
    \ -q%'\n    OR pe.cmdline LIKE '%wget -t%'\n    OR pe.cmdline LIKE '%wget %--no-check-certificate%'\n\
    \    OR pe.cmdline LIKE '%wget %--user-agent%'\n    -- Or anything launched by\
    \ a system user\n    OR (\n      pe.cmdline LIKE '%wget -%'\n      AND pe.euid\
    \ < 500\n      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'\n    )\n  \
    \  OR (\n      pe.cmdline LIKE '%curl %'\n      AND pe.euid < 500\n      AND pe.cmdline\
    \ NOT LIKE \"%./configure %--with-curl%\"\n      AND p.cgroup_path NOT LIKE '/system.slice/docker-%'\n\
    \    )\n  )\n  -- Exceptions for all calls\n  AND NOT (\n    pe.euid > 500\n \
    \   AND (\n      p1_cmd LIKE '%brew.rb%'\n      OR p1_cmd LIKE '%brew.sh%'\n \
    \     OR pe.cmdline LIKE '% localhost:%'\n      OR pe.cmdline LIKE '%--dump-header%'\n\
    \      OR pe.cmdline LIKE '%--progress-bar%'\n      OR pe.cmdline LIKE '%.well-known/openid-configuration%'\n\
    \      OR pe.cmdline LIKE '%/192.168.%:%'\n      OR pe.cmdline LIKE '%/chainctl_%'\n\
    \      OR pe.cmdline LIKE '%/openid/v1/jwks%'\n      OR pe.cmdline LIKE '%127.0.0.1:%'\n\
    \      OR pe.cmdline LIKE '%application/json%'\n      OR pe.cmdline LIKE '%Authorization:\
    \ Bearer%'\n      OR pe.cmdline LIKE '%ctlog%'\n      OR pe.cmdline LIKE '%curl\
    \ -X %'\n      OR pe.cmdline LIKE '%go mod %'\n      OR pe.cmdline LIKE '%grpcurl%'\n\
    \      OR pe.cmdline LIKE '%Homebrew%'\n      OR pe.cmdline LIKE '%https://api.github.com/%'\n\
    \      OR pe.cmdline LIKE '%If-None-Match%'\n      OR pe.cmdline LIKE '%LICENSES/vendor/%'\n\
    \      OR pe.cmdline LIKE '%localhost:%'\n      OR pe.cmdline LIKE 'curl -sL wttr.in%'\n\
    \      OR pe.cmdline LIKE 'git %'\n      OR pe.cmdline LIKE 'wget --no-check-certificate\
    \ https://github.com/%'\n      OR pe.cmdline LIKE \"%libcurl%\"\n    )\n  )\n\
    \  AND NOT (\n    pe.euid > 500\n    AND pe.cmdline LIKE '%/api'\n    AND pe.cmdline\
    \ NOT LIKE '%-o%'\n    AND pe.cmdline NOT LIKE '%-O%'\n  )\n  AND NOT (\n    pe.euid\
    \ > 500\n    -- /usr/bin/curl https://34.117.0.114:443 -k\n    AND REGEX_MATCH\
    \ (pe.cmdline, '(curl https://[\\w\\.\\:\\/]+ -k)$', 1) != \"\"\n  )\n  AND NOT\
    \ (\n    pe.euid > 500\n    -- /usr/bin/curl -k https://34.117.0.114:443\n   \
    \ AND REGEX_MATCH (pe.cmdline, '(curl -k https://[\\w\\.\\:\\/]+)$', 1) != \"\"\
    \n  )\n  -- These are typically curl -k calls\n  -- We need the addr \"IS NOT\
    \ NULL\" to avoid filtering out\n  -- NULL entries\n  AND NOT (\n    addr IS NOT\
    \ NULL\n    AND (\n      addr IN (\n        'cdn.zoom.us',\n        'dl.enforce.dev',\n\
    \        'github.com',\n        'releases.hashicorp.com',\n        'repo1.maven.org'\n\
    \      )\n      -- Ignore local addresses (Docker development)\n      OR addr\
    \ NOT LIKE '%.%'\n      OR ip LIKE '172.2%'\n      OR ip LIKE '192.168.%'\n  \
    \    OR ip LIKE '127.%'\n      OR ip LIKE '10.%'\n    )\n  )\n  AND NOT p1_cmd\
    \ LIKE '/usr/bin/bash /usr/bin/makepkg %'\n  AND NOT url in ('https://aur.archlinux.org')\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
