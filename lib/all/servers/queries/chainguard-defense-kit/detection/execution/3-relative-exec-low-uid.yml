- name: CDK - Relative Exec Low Uid
  description: Programs running as root with a relative path
  query: "SELECT -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS\
    \ p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.start_time AS p0_start,\n  p0.cwd AS\
    \ p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.start_time AS p1_start,\n\
    \  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.name AS p2_name,\n  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n\
    \  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n\
    \  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN hash p0_hash ON p0.path =\
    \ p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN file\
    \ p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  p0.pid IN (\n    SELECT\n      pid\n    FROM\n    \
    \  processes\n    WHERE\n      euid < 500\n      AND cmdline LIKE './%'\n    \
    \  AND NOT cmdline LIKE './out/osqtool-% %'\n      AND NOT cmdline LIKE './osqueryi%'\n\
    \      AND NOT cmdline LIKE './OneDrivePkgTelemetry%'\n      AND NOT cmdline LIKE\
    \ './xcover %'\n      AND NOT cmdline LIKE './updater -insecure %'\n      AND\
    \ NOT cmdline = './utrace -p utrace --debug'\n      AND NOT cgroup_path LIKE '/system.slice/docker-%'\n\
    \  )\nGROUP BY\n  p0.pid\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
