- name: CDK - Unexpected Fetcher Parent Events
  description: 'Suspicious parenting of fetch tools (event-based) refs: * https://attack.mitre.org/techniques/T1105/
    (Ingress Tool Transfer)'
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid\
    \ AS p0_pid,\n  pe.time AS p0_time,\n  pe.euid AS p0_euid,\n  p.cgroup_path AS\
    \ p0_cgroup,\n  -- Parent\n  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n\
    \  TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path)\
    \ AS p1_path,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH\
    \ (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  -- Grandparent\n\
    \  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path)\
    \ AS p2_cgroup,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n\
    \  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n\
    \  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name,\n  -- Exception key\n  REGEX_MATCH (pe.path,\
    \ '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path,\
    \ pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe,\n  uptime\n  LEFT JOIN processes p ON pe.pid = p.pid\n  -- Parents (via\
    \ two paths)\n  LEFT JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash\
    \ p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent\
    \ = pe1.pid\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path =\
    \ pe_hash1.path\n  -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2\
    \ ON p1.parent = p1_p2.pid -- Current grandparent via parent processes\n  LEFT\
    \ JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via\
    \ parent events\n  LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n\
    \  AND pe1_pe2.cmdline != '' -- Past grandparent via parent events\n  LEFT JOIN\
    \ hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash\
    \ ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path\
    \ = pe1_pe2_hash.path\nWHERE\n  -- NOTE: The remainder of this query is synced\
    \ with unexpected-fetcher-parents\n  pe.cmdline != ''\n  AND pe.time > (strftime('%s',\
    \ 'now') -450)\n  AND p0_name IN ('curl', 'wget', 'ftp', 'tftp')\n  AND NOT exception_key\
    \ IN (\n    'curl,0,nm-dispatcher,',\n    'curl,0,nm-dispatcher,nm-dispatcher',\n\
    \    'curl,500,bash,bash',\n    'curl,500,bash,nix-daemon',\n    'curl,500,bash,ShellLauncher',\n\
    \    'curl,500,bash,yay',\n    'curl,500,bash,zsh',\n    'curl,500,env,env',\n\
    \    'curl,500,fish,gnome-terminal-',\n    'curl,500,ruby,zsh',\n    'curl,500,ShellLauncher,',\n\
    \    'curl,500,ShellLauncher,login',\n    'curl,500,zsh,login',\n    'curl,500,zsh,sh',\n\
    \    'wget,500,env,env'\n  )\n  AND NOT (\n    pe.euid > 500\n    AND p1_name\
    \ IN ('bash', 'dash', 'fish', 'sh', 'zsh')\n    AND p2_name IN (\n      'alacritty',\n\
    \      'gnome-terminal-',\n      'kitty',\n      'login',\n      'roxterm',\n\
    \      'stable',\n      'tmux:server',\n      'tmux',\n      'wezterm-gui',\n\
    \      'zsh'\n    )\n  )\n  AND NOT p1_name IN ('yay', 'nvim')\n  AND NOT (\n\
    \    pe.euid > 500\n    AND p0_cmd IN ('curl --fail https://ipinfo.io/timezone')\n\
    \  )\n  AND NOT (\n    pe.euid > 500\n    AND p1_name = 'env'\n    AND p1_cmd\
    \ LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'\n  )\n  AND NOT (\n    pe.euid\
    \ > 500\n    AND p1_name = 'ruby'\n    AND p1_cmd LIKE '%/Homebrew/brew.rb%'\n\
    \  )\n  AND NOT (\n    pe.euid > 500\n    AND p1_name = 'env'\n    AND p1_cmd\
    \ LIKE '/usr/bin/env bash ./hack/%.sh'\n  )\n  AND NOT p0_cmd LIKE 'wget --no-check-certificate\
    \ https://github.com/istio/istio/%'\n  AND NOT p0_cmd LIKE '%curl -L https://artifacts.elastic.co/%'\n\
    \  AND NOT p.cgroup_path LIKE '/system.slice/docker-%'\nGROUP BY\n  pe.pid\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
