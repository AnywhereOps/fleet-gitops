- name: CDK - Unexpected Setuid Binaries
  description: Find unexpected setuid binaries on disk
  query: "SELECT\n  GROUP_CONCAT(path) AS paths,\n  gid,\n  uid,\n  mode,\n  type,\n\
    \  size,\n  data,\n  sha256\nFROM\n  (\n    SELECT\n      file.path,\n      file.gid,\n\
    \      file.uid,\n      file.inode,\n      file.mode,\n      file.type,\n    \
    \  file.size,\n      magic.data,\n      hash.sha256\n    FROM\n      file\n  \
    \    LEFT JOIN hash ON file.path = hash.path\n      LEFT JOIN magic ON file.path\
    \ = magic.path\n    WHERE\n      file.directory IN (\n        '/bin',\n      \
    \  '/etc',\n        '/opt/google-cloud-sdk/bin',\n        '/opt/homebrew/bin',\n\
    \        '/opt/homebrew/sbin',\n        '/sbin',\n        '/tmp',\n        '/usr/bin',\n\
    \        '/usr/lib',\n        '/usr/lib/jvm/default/bin',\n        '/usr/lib64',\n\
    \        '/usr/libexec',\n        '/usr/local/bin',\n        '/usr/local/lib',\n\
    \        '/usr/local/lib64',\n        '/usr/local/libexec',\n        '/usr/local/sbin',\n\
    \        '/usr/sbin',\n        '/var/lib',\n        '/var/tmp'\n      )\n    \
    \  AND type = 'regular'\n      AND mode NOT LIKE '0%'\n      AND mode NOT LIKE\
    \ '1%'\n      AND mode NOT LIKE '2%'\n      AND NOT (\n        mode LIKE '4%11'\n\
    \        AND uid = 0\n        AND gid = 0\n        AND file.path IN (\n      \
    \    '/bin/bwrap',\n          '/bin/cdda2wav',\n          '/bin/cdrecord',\n \
    \         '/bin/chfn',\n          '/bin/chsh',\n          '/bin/grub2-set-bootflag',\n\
    \          '/bin/icedax',\n          '/bin/mount.nfs',\n          '/bin/mount.nfs4',\n\
    \          '/bin/readcd',\n          '/bin/readom',\n          '/bin/rscsi',\n\
    \          '/bin/staprun',\n          '/bin/sudo',\n          '/bin/sudoedit',\n\
    \          '/bin/umount.nfs',\n          '/bin/umount.nfs4',\n          '/bin/wodim',\n\
    \          '/usr/local/libexec/ssh-keysign',\n          '/sbin/cdda2wav',\n  \
    \        '/sbin/cdrecord',\n          '/sbin/chfn',\n          '/sbin/chsh',\n\
    \          '/sbin/icedax',\n          '/sbin/mount.nfs',\n          '/sbin/mount.nfs4',\n\
    \          '/sbin/readcd',\n          '/sbin/readom',\n          '/sbin/rscsi',\n\
    \          '/bin/userhelper',\n          '/usr/bin/userhelper',\n          '/sbin/sudo',\n\
    \          '/sbin/sudoedit',\n          '/sbin/umount.nfs',\n          '/sbin/umount.nfs4',\n\
    \          '/sbin/userhelper',\n          '/sbin/wodim',\n          '/usr/bin/bwrap',\n\
    \          '/usr/bin/cdda2wav',\n          '/usr/bin/cdrecord',\n          '/usr/bin/chfn',\n\
    \          '/usr/bin/chsh',\n          '/usr/bin/grub2-set-bootflag',\n      \
    \    '/usr/bin/icedax',\n          '/usr/bin/mount.nfs',\n          '/usr/bin/mount.nfs4',\n\
    \          '/usr/bin/readcd',\n          '/usr/bin/readom',\n          '/usr/bin/rscsi',\n\
    \          '/usr/bin/staprun',\n          '/usr/bin/sudo',\n          '/usr/bin/sudoedit',\n\
    \          '/usr/bin/umount.nfs',\n          '/usr/bin/umount.nfs4',\n       \
    \   '/usr/bin/wodim',\n          '/usr/libexec/security_authtrampoline',\n   \
    \       '/usr/libexec/xf86-video-intel-backlight-helper',\n          '/usr/sbin/cdda2wav',\n\
    \          '/usr/sbin/cdrecord',\n          '/usr/sbin/chfn',\n          '/usr/sbin/chsh',\n\
    \          '/usr/sbin/icedax',\n          '/usr/sbin/mount.nfs',\n          '/usr/sbin/mount.nfs4',\n\
    \          '/usr/sbin/readcd',\n          '/usr/sbin/readom',\n          '/usr/sbin/rscsi',\n\
    \          '/usr/sbin/sudo',\n          '/usr/sbin/sudoedit',\n          '/usr/sbin/umount.nfs',\n\
    \          '/usr/sbin/umount.nfs4',\n          '/usr/sbin/userhelper',\n     \
    \     '/usr/sbin/wodim'\n        )\n      )\n      AND NOT (\n        mode LIKE\
    \ '4%55'\n        AND uid = 0\n        AND gid = 0\n        AND file.path IN (\n\
    \          '/bin/at',\n          '/bin/atq',\n          '/bin/screen',\n     \
    \     '/bin/screen-5.0.0',\n          '/sbin/screen',\n          '/sbin/screen-5.0.0',\n\
    \          '/usr/bin/screen',\n          '/usr/bin/screen-5.0.0',\n          '/usr/sbin/screen',\n\
    \          '/usr/sbin/screen-5.0.0',\n          '/bin/atrm',\n          '/bin/bwrap',\n\
    \          '/bin/chage',\n          '/bin/chfn',\n          '/bin/chsh',\n   \
    \       '/bin/crontab',\n          '/bin/doas',\n          '/bin/expiry',\n  \
    \        '/bin/firejail',\n          '/bin/fusermount',\n          '/bin/fusermount-glusterfs',\n\
    \          '/bin/fusermount3',\n          '/bin/gpasswd',\n          '/sbin/fusermount-glusterfs',\n\
    \          '/usr/sbin/fusermount-glusterfs',\n          '/bin/grub2-set-bootflag',\n\
    \          '/bin/keybase-redirector',\n          '/bin/ksu',\n          '/bin/mount',\n\
    \          '/bin/mount.nfs',\n          '/bin/mount.nfs4',\n          '/bin/mullvad-exclude',\n\
    \          '/bin/ndisc6',\n          '/bin/newgidmap',\n          '/bin/newgrp',\n\
    \          '/bin/newuidmap',\n          '/bin/ntfs-3g',\n          '/bin/nvidia-modprobe',\n\
    \          '/bin/pam_timestamp_check',\n          '/bin/passwd',\n          '/bin/pkexec',\n\
    \          '/bin/ps',\n          '/sbin/atq',\n          '/sbin/atrm',\n     \
    \     '/sbin/at',\n          '/usr/sbin/atq',\n          '/usr/sbin/atrm',\n \
    \         '/usr/sbin/at',\n          '/bin/rdisc6',\n          '/bin/rltraceroute6',\n\
    \          '/bin/schroot',\n          '/bin/sg',\n          '/bin/su',\n     \
    \     '/bin/sudo',\n          '/sbin/vmware-user',\n          '/sbin/vmware-user-suid-wrapper',\n\
    \          '/usr/sbin/vmware-user',\n          '/usr/sbin/vmware-user-suid-wrapper',\n\
    \          '/bin/sudoedit',\n          '/bin/suexec',\n          '/bin/ubuntu-core-launcher',\n\
    \          '/bin/umount',\n          '/bin/umount.nfs',\n          '/bin/umount.nfs4',\n\
    \          '/bin/unix_chkpwd',\n          '/bin/vmware-user',\n          '/bin/vmware-user-suid-wrapper',\n\
    \          '/sbin/chage',\n          '/sbin/chfn',\n          '/sbin/chsh',\n\
    \          '/sbin/crontab',\n          '/sbin/doas',\n          '/sbin/expiry',\n\
    \          '/sbin/firejail',\n          '/sbin/fusermount',\n          '/sbin/fusermount3',\n\
    \          '/sbin/gpasswd',\n          '/sbin/grub2-set-bootflag',\n         \
    \ '/sbin/ksu',\n          '/sbin/mount',\n          '/sbin/mount.cifs',\n    \
    \      '/sbin/mount.nfs',\n          '/sbin/mount.nfs4',\n          '/sbin/mount.ntfs',\n\
    \          '/sbin/mount.ntfs-3g',\n          '/sbin/mount.smb3',\n          '/sbin/mullvad-exclude',\n\
    \          '/sbin/ndisc6',\n          '/sbin/newgrp',\n          '/sbin/nvidia-modprobe',\n\
    \          '/sbin/pam_timestamp_check',\n          '/sbin/passwd',\n         \
    \ '/sbin/pkexec',\n          '/sbin/rdisc6',\n          '/sbin/rltraceroute6',\n\
    \          '/sbin/sg',\n          '/sbin/su',\n          '/sbin/sudo',\n     \
    \     '/sbin/sudoedit',\n          '/sbin/suexec',\n          '/sbin/umount',\n\
    \          '/sbin/umount.nfs',\n          '/sbin/umount.nfs4',\n          '/sbin/unix_chkpwd',\n\
    \          '/sbin/usernetctl',\n          '/usr/bin/at',\n          '/usr/bin/atq',\n\
    \          '/usr/bin/atrm',\n          '/usr/bin/batch',\n          '/usr/bin/bwrap',\n\
    \          '/usr/bin/chage',\n          '/usr/bin/chfn',\n          '/usr/bin/chsh',\n\
    \          '/usr/bin/crontab',\n          '/usr/bin/doas',\n          '/usr/bin/expiry',\n\
    \          '/usr/bin/firejail',\n          '/usr/bin/fusermount',\n          '/usr/bin/fusermount-glusterfs',\n\
    \          '/usr/bin/fusermount3',\n          '/usr/bin/gpasswd',\n          '/usr/bin/grub2-set-bootflag',\n\
    \          '/usr/bin/keybase-redirector',\n          '/usr/bin/ksu',\n       \
    \   '/usr/bin/login',\n          '/usr/bin/mount',\n          '/usr/bin/mount.nfs',\n\
    \          '/usr/bin/mount.nfs4',\n          '/usr/bin/mullvad-exclude',\n   \
    \       '/usr/bin/ndisc6',\n          '/usr/bin/newgidmap',\n          '/usr/bin/newgrp',\n\
    \          '/usr/bin/newuidmap',\n          '/usr/bin/ntfs-3g',\n          '/usr/bin/nvidia-modprobe',\n\
    \          '/usr/bin/pam_timestamp_check',\n          '/usr/bin/passwd',\n   \
    \       '/usr/bin/pkexec',\n          '/usr/bin/quota',\n          '/usr/bin/rdisc6',\n\
    \          '/usr/bin/rltraceroute6',\n          '/usr/bin/schroot',\n        \
    \  '/usr/bin/sg',\n          '/usr/bin/su',\n          '/usr/bin/sudo',\n    \
    \      '/usr/bin/sudoedit',\n          '/usr/bin/suexec',\n          '/usr/bin/top',\n\
    \          '/usr/bin/ubuntu-core-launcher',\n          '/usr/bin/umount',\n  \
    \        '/usr/bin/umount.nfs',\n          '/usr/bin/umount.nfs4',\n         \
    \ '/usr/bin/unix_chkpwd',\n          '/usr/bin/vmware-user',\n          '/usr/bin/vmware-user-suid-wrapper',\n\
    \          '/usr/lib/mail-dotlock',\n          '/usr/lib/xf86-video-intel-backlight-helper',\n\
    \          '/usr/lib/Xorg.wrap',\n          '/usr/lib64/mail-dotlock',\n     \
    \     '/usr/lib64/xf86-video-intel-backlight-helper',\n          '/usr/lib64/Xorg.wrap',\n\
    \          '/usr/libexec/authopen',\n          '/usr/libexec/libgtop_server2',\n\
    \          '/usr/libexec/polkit-agent-helper-1',\n          '/usr/libexec/qemu-bridge-helper',\n\
    \          '/usr/libexec/spice-client-glib-usb-acl-helper',\n          '/usr/libexec/Xorg.wrap',\n\
    \          '/usr/local/bin/doas',\n          '/usr/sbin/chage',\n          '/usr/sbin/chfn',\n\
    \          '/usr/sbin/chsh',\n          '/usr/sbin/crontab',\n          '/usr/sbin/doas',\n\
    \          '/usr/sbin/expiry',\n          '/usr/sbin/firejail',\n          '/usr/sbin/fusermount',\n\
    \          '/usr/sbin/fusermount3',\n          '/usr/sbin/gpasswd',\n        \
    \  '/usr/sbin/grub2-set-bootflag',\n          '/usr/sbin/ksu',\n          '/usr/sbin/mount',\n\
    \          '/usr/sbin/mount.cifs',\n          '/usr/sbin/mount.nfs',\n       \
    \   '/usr/sbin/mount.nfs4',\n          '/usr/sbin/mount.ntfs',\n          '/usr/sbin/mount.ntfs-3g',\n\
    \          '/usr/sbin/mount.smb3',\n          '/usr/sbin/mullvad-exclude',\n \
    \         '/usr/sbin/ndisc6',\n          '/usr/sbin/newgrp',\n          '/usr/sbin/nvidia-modprobe',\n\
    \          '/usr/sbin/pam_timestamp_check',\n          '/usr/sbin/passwd',\n \
    \         '/usr/sbin/pkexec',\n          '/usr/sbin/rdisc6',\n          '/usr/sbin/rltraceroute6',\n\
    \          '/usr/sbin/sg',\n          '/usr/sbin/su',\n          '/usr/sbin/sudo',\n\
    \          '/usr/sbin/sudoedit',\n          '/usr/sbin/suexec',\n          '/usr/sbin/traceroute',\n\
    \          '/usr/sbin/traceroute6',\n          '/usr/sbin/umount',\n         \
    \ '/usr/sbin/umount.nfs',\n          '/usr/sbin/umount.nfs4',\n          '/usr/sbin/unix_chkpwd',\n\
    \          '/usr/sbin/usernetctl'\n        )\n      )\n      AND NOT (\n     \
    \   mode = '4754'\n        AND uid = 0\n        AND gid = 30\n        AND file.path\
    \ IN ('/usr/sbin/pppd', '/sbin/pppd')\n      )\n      AND NOT (\n        mode\
    \ = '6755'\n        AND uid = 0\n        AND gid IN (0,8)\n        AND file.path\
    \ IN (\n          '/bin/light',\n          '/bin/man',\n          '/bin/mandb',\n\
    \          '/bin/mount.cifs',\n          '/bin/mount.smb3',\n          '/bin/procmail',\n\
    \          '/bin/unix_chkpwd',\n          '/sbin/mandb',\n          '/sbin/mount.cifs',\n\
    \          '/sbin/mount.smb3',\n          '/sbin/unix_chkpwd',\n          '/usr/bin/light',\n\
    \          '/usr/bin/mandb',\n          '/usr/bin/mount.cifs',\n          '/usr/bin/mount.smb3',\n\
    \          '/usr/bin/procmail',\n          '/usr/bin/unix_chkpwd',\n         \
    \ '/usr/lib/xtest',\n          '/usr/lib64/xtest',\n          '/usr/sbin/mandb',\n\
    \          '/usr/sbin/mount.cifs',\n          '/usr/sbin/mount.smb3',\n      \
    \    '/usr/sbin/unix_chkpwd',\n          '/bin/procmail',\n          '/usr/bin/procmail'\n\
    \        )\n      )\n      AND NOT (\n        mode = '4110'\n        AND uid =\
    \ 0\n        AND gid = 156\n        AND file.path IN ('/bin/staprun', '/usr/bin/staprun',\
    \ '/sbin/staprun', '/usr/sbin/staprun')\n      )\n  )\nGROUP BY\n  inode\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
