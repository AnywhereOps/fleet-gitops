- name: CDK - Ssh Notty
  description: Find ssh sessions that are hiding from 'w'/'who'
  query: "SELECT\n  *\nFROM\n  (\n    SELECT\n      p.pid,\n      p.name,\n      p.cmdline\
    \ AS cmd,\n      p.start_time,\n      p.cwd,\n      cp.name AS child_name,\n \
    \     cp.cmdline AS child_cmd,\n      gcp.name AS grandchild_name,\n      gcp.cmdline\
    \ AS grandchild_cmd,\n      GROUP_CONCAT(DISTINCT pof.path) AS open_files\n  \
    \  FROM\n      processes p\n      LEFT JOIN process_open_files pof ON p.pid =\
    \ pof.pid\n      LEFT JOIN processes cp ON p.pid = cp.parent\n      LEFT JOIN\
    \ processes gcp ON cp.pid = gcp.parent\n    WHERE\n      p.name = 'sshd'\n   \
    \ GROUP BY\n      p.pid\n  )\nWHERE\n  (\n    INSTR(cmd, '@notty') > 0\n    OR\
    \ (\n      open_files != '/dev/null'\n      AND INSTR(open_files, '/dev/ptmx')\
    \ = 0\n    )\n  )\n  -- You must specifically check for NULL here, or risk inadvertently\
    \ filtering everything out.\n  AND (\n    grandchild_name IS NULL\n    OR grandchild_name\
    \ != 'zfs'\n  )\n  AND child_name IS NOT NULL\n  AND child_name NOT IN ('', 'zfs')\n\
    \  AND child_cmd NOT LIKE '%osquery-defense-kit%make verify'\n  AND grandchild_cmd\
    \ NOT LIKE '%osquery-defense-kit%make verify'\n  AND grandchild_name NOT IN ('unison')\n\
    \  AND cmd != 'sshd: docker@notty'\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
