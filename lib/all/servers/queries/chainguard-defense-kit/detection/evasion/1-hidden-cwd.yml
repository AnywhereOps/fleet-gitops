- name: CDK - Hidden Cwd
  description: Programs running with a hidden current working directory (state-based)
  query: "SELECT\n  REPLACE(p0.cwd, u.directory, '~') AS dir,\n  REGEX_MATCH (\n \
    \   REPLACE(p0.cwd, u.directory, '~'),\n    '([/~].*?/.*?)/',\n    1\n  ) AS top_dir,\n\
    \  CONCAT (\n    p0.name,\n    ',',\n    IIF(\n      REGEX_MATCH (\n        REPLACE(p0.cwd,\
    \ u.directory, '~'),\n        '([/~].*?/.*?/.*?)/',\n        1\n      ) != '',\n\
    \      REGEX_MATCH (\n        REPLACE(p0.cwd, u.directory, '~'),\n        '([/~].*?/.*?/.*?)/',\n\
    \        1\n      ),\n      REPLACE(p0.cwd, u.directory, '~')\n    )\n  ) AS exception_key,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.cgroup_path AS p0_cgroup,\n  p0.path AS\
    \ p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.cgroup_path AS p1_cgroup,\n  p1.name\
    \ AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS\
    \ p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n\
    \  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256\
    \ AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n\
    \  LEFT JOIN users u ON p0.uid = u.uid\n  LEFT JOIN hash p0_hash ON p0.path =\
    \ p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN file\
    \ p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  p0.pid IN (\n    SELECT DISTINCT\n      pid\n    FROM\n\
    \      processes\n    WHERE\n      cwd LIKE '%/.%'\n      AND NOT name IN (\n\
    \        'apfsd',\n        'bindfs',\n        'Code Helper (Plugin)',\n      \
    \  'Code Helper',\n        'code',\n        'find',\n        'git',\n        'gitsign',\n\
    \        'mc',\n        'nvim',\n        'terraform',\n        'updatedb',\n \
    \       'vi',\n        'vim'\n      )\n      AND NOT cgroup_path LIKE '/system.slice/docker-%'\n\
    \      AND NOT cgroup_path LIKE '/system.slice/system.slice:docker:%'\n  )\n \
    \ AND NOT (\n    exception_key IN (\n      'Arduino IDE Helper,/private/var/folders',\n\
    \      'arduino-language-server,/private/var/folders',\n      'as,~/.cache/yay',\n\
    \      'bash,/var/home/linuxbrew',\n      'bash,/var/lib/incus',\n      'bash,/var/tmp/.vscode-server',\n\
    \      'bash,~/.local/share',\n      'bash,~/.Trash',\n      'bash,~/go/src',\n\
    \      'c++,~/.cache/yay',\n      'cc1,/home/build/.cache',\n      'cc1plus,~/.cache/yay',\n\
    \      'cgo,~/.gimme/versions',\n      'clangd,/private/var/folders',\n      'conmon,/var~/.local/share',\n\
    \      'curl,/var/home/linuxbrew',\n      'dirhelper,/private/var/folders',\n\
    \      'zsh,~/Documents/My Vault',\n      'Electron,~/.vscode/extensions',\n \
    \     'exe,/var~/.local/share',\n      'fileproviderd,~/Library/Mobile Documents',\n\
    \      'fish,~/.local/share',\n      'fish,~/.Trash',\n      'git,~/.local/share',\n\
    \      'java,/home/build/.gradle',\n      'java,/home/build/.kotlin',\n      'java,/root/.gradle/daemon',\n\
    \      'java,~/.gradle/daemon',\n      'java,~/.local/share',\n      'make,~/.cache/yay',\n\
    \      'makepkg,~/.cache/yay',\n      'mysqld,~/.local/share',\n      'npm install,/home/build/.npm',\n\
    \      'npm install,~/.npm/_cacache',\n      'opera_autoupdate,/private/var/folders',\n\
    \      'postinstall,/Library/InstallerSandboxes/.PKInstallSandboxManager',\n \
    \     'rm,/private/var/folders',\n      'rust-analyzer-p,~/.cargo/registry',\n\
    \      'rustc,/home/build/.cargo',\n      'telegram-deskto,~/snap/telegram-desktop',\n\
    \      'vet,/home/build/.cache',\n      'zsh,/private/tmp/workspace',\n      'zsh,~/.Trash',\n\
    \      'zsh,~/Library/Mobile Documents'\n    )\n    OR exception_key LIKE '%sh,~/.Trash/%'\n\
    \    OR exception_key LIKE '%sh,~/dev/%'\n    OR exception_key LIKE 'java,/.gradle/%'\n\
    \    OR exception_key LIKE 'wineserver,/tmp/.wine-1000/server-%'\n    OR dir IN\
    \ (\n      '/home/build',\n      '/var/home/linuxbrew/.linuxbrew/Cellar',\n  \
    \    '/var/home/linuxbrew/.linuxbrew/Homebrew',\n      '~/.cache/yay',\n     \
    \ '~/.config',\n      '~/.emacs.d',\n      '~/.gmailctl',\n      '~/.hunter/_Base',\n\
    \      '~/.local/bin',\n      '~/.local/share/chezmoi',\n      '~/.local/share/nvim',\n\
    \      '~/.local/share/Steam',\n      '~/.oh-my-zsh',\n      '~/.provisio',\n\
    \      '~/.terraform.d',\n      '~/.vim',\n      '~/.zsh',\n      '~/dev/extra-packages/.chainguard'\n\
    \    )\n    OR top_dir IN (\n      '~/dev',\n      '/root/.gradle',\n      '~/src',\n\
    \      '~/Git',\n      '~/Sync',\n      '/var~/.config',\n      '/var~/.local',\n\
    \      '~/workspace'\n    )\n    OR dir LIKE '/.gradle/%'\n    OR dir LIKE '/home/build/.%'\n\
    \    OR dir LIKE '/home/build/%'\n    OR dir LIKE '/Library/Apple/System/Library/InstallerSandboxes/.PKInstallSandboxManager-SystemSoftware/%'\n\
    \    OR dir LIKE '/opt/homebrew/%/.cache/%'\n    OR dir LIKE '/private/tmp/%/.git'\n\
    \    OR dir LIKE '/run/.ro%'\n    OR dir LIKE '/tmp/.mount_%'\n    OR dir LIKE\
    \ '/tmp/%/.git'\n    OR dir LIKE '/tmp/%/.github/workflows'\n    OR dir LIKE '%/.build'\n\
    \    OR dir LIKE '%/.cache/melange%'\n    OR dir LIKE '%/.cargo-arm64%'\n    OR\
    \ dir LIKE '%/.cargo/%'\n    OR dir LIKE '%/.git'\n    OR dir LIKE '%/.git/%'\n\
    \    OR dir LIKE '%/.github'\n    OR dir LIKE '%/.github/%'\n    OR dir LIKE '%/.gradle'\n\
    \    OR dir LIKE '%/.venv'\n    OR dir LIKE '%/.venv/%'\n    OR dir LIKE '%/node_modules/.bin'\n\
    \    OR dir LIKE '~/.%'\n    OR dir LIKE '/private/var/%/T/.com.google.Chrome.%'\n\
    \    OR dir LIKE '~/.gradle/%'\n    OR dir LIKE '~/%/.config/nvim'\n    OR dir\
    \ LIKE '~/%/.docker%'\n    OR dir LIKE '~/%/.modcache/%'\n    OR dir LIKE '~/%/.terraform%'\n\
    \    OR dir LIKE '~/%/.terragrunt-cache/%'\n    OR dir LIKE '~/%/.tests/%'\n \
    \   OR dir LIKE '~/%/.vercel%'\n    OR dir LIKE '~/%/github.com/%'\n    OR dir\
    \ LIKE '~/%/node_modules/.pnpm/%'\n    OR dir LIKE '~/%/src/%'\n    OR dir LIKE\
    \ '~/%enterprise-packages/.chainguard'\n    OR dir LIKE '~/%google-cloud-sdk/.install/.backup%'\n\
    \    OR dir LIKE '~/code/%'\n    OR dir LIKE '~/dev/%/dots/%/.config%'\n    OR\
    \ dir LIKE '~/src/%' -- For sudo calls to other things\n    OR (\n      dir LIKE\
    \ '/home/.terraform.d/%'\n      AND p0.euid = 0\n    )\n  )\nGROUP BY\n  p0.pid\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
