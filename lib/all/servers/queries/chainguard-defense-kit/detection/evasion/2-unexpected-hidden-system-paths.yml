- name: CDK - Unexpected Hidden System Paths
  description: Find unexpected hidden directories in operating-system folders
  query: "SELECT\n  file.path,\n  file.inode,\n  file.directory,\n  uid,\n  gid,\n\
    \  mode,\n  atime,\n  btime,\n  mtime,\n  ctime,\n  type,\n  size,\n  hash.sha256,\n\
    \  magic.data\nFROM\n  file\n  LEFT JOIN hash ON file.path = hash.path\n  LEFT\
    \ JOIN magic ON file.path = magic.path\nWHERE\n  (\n    file.path LIKE '/lib/.%'\n\
    \    OR file.path LIKE '/.%'\n    OR file.path LIKE '/bin/%/.%'\n    OR file.path\
    \ LIKE '/dev/.%'\n    OR file.path LIKE '/etc/.%'\n    OR file.path LIKE '/etc/%/.%'\n\
    \    OR file.path LIKE '/lib/%/.%'\n    OR file.path LIKE '/libexec/.%'\n    OR\
    \ file.path LIKE '/Library/.%'\n    OR file.path LIKE '/sbin/.%'\n    OR file.path\
    \ LIKE '/sbin/%/.%'\n    OR file.path LIKE '/tmp/.%'\n    OR file.path LIKE '/tmp/.%/%'\n\
    \    OR file.path LIKE '/usr/bin/.%'\n    OR file.path LIKE '/usr/lib/.%'\n  \
    \  OR file.path LIKE '/usr/lib/%/.%'\n    OR file.path LIKE '/usr/libexec/.%'\n\
    \    OR file.path LIKE '/usr/local/bin/.%'\n    OR file.path LIKE '/usr/local/lib/.%'\n\
    \    OR file.path LIKE '/usr/local/lib/.%'\n    OR file.path LIKE '/usr/local/libexec/.%'\n\
    \    OR file.path LIKE '/usr/local/sbin/.%'\n    OR file.path LIKE '/usr/sbin/.%'\n\
    \    OR file.path LIKE '/var/.%'\n    OR file.path LIKE '/var/%/.%'\n    OR file.path\
    \ LIKE '/var/lib/.%'\n    OR file.path LIKE '/var/tmp/.%'\n    OR file.path LIKE\
    \ '/var/tmp/.%/%'\n  )\n  AND file.path NOT LIKE '%/../%'\n  AND file.path NOT\
    \ LIKE '%/./%' -- Avoid mentioning extremely temporary files\n  AND file.path\
    \ NOT LIKE '/usr/lib/x86_64-linux-gnu/.lib%.hmac'\n  AND file.path NOT LIKE '/lib/x86_64-linux-gnu/.lib%.hmac'\n\
    \  AND strftime('%s', 'now') - file.ctime > 20\n  AND file.path NOT IN (\n   \
    \ '/.autorelabel',\n    '/.cache/',\n    '/.equarantine/',\n    '/.file',\n  \
    \  '/.kconfig',\n    '/.lesshst',\n    '/.mozilla/',\n    '/.netrwhist',\n   \
    \ '/.nofollow/',\n    '/.profile',\n    '/.ostree.cfs',\n    '/.resolve/',\n \
    \   '/.vim/',\n    '/.viminfo',\n    '/.vol/',\n    '/.VolumeIcon.icns',\n   \
    \ '/dev/.blkid.tab',\n    '/dev/.mdadm/',\n    '/etc/.#sudoers',\n    '/etc/.bootcount',\n\
    \    '/etc/.clean',\n    '/etc/.etckeeper',\n    '/etc/.git/',\n    '/etc/.gitattributes',\n\
    \    '/etc/.java/',\n    '/etc/.resolv.conf.systemd-resolved.bak',\n    '/etc/selinux/.config_backup',\n\
    \    '/etc/skel/.local/',\n    '/etc/skel/.mozilla/',\n    '/etc/skel/.var/',\n\
    \    '/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',\n    '/tmp/._contentbarrier_installed',\n\
    \    '/tmp/.accounts-agent/',\n    '/tmp/.aqua/',\n    '/tmp/.audio-agent/',\n\
    \    '/tmp/.bazelci/',\n    '/tmp/.BBE72B41371180178E084EEAF106AED4F350939DB95D3516864A1CC62E7AE82F',\
    \ -- Xcode\n    '/tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',\n\
    \    '/tmp/.content-agent/',\n    '/tmp/.dl.log',\n    '/tmp/.docker-tmp/',\n\
    \    '/tmp/.docker/',\n    '/tmp/.dotnet/',\n    '/tmp/.dotnet/lockfiles/',\n\
    \    '/tmp/.dotnet/shm/',\n    '/tmp/.dracula-tmux-data',\n    '/tmp/.dracula-tmux-weather.lock',\n\
    \    '/tmp/.DS_Store',\n    '/tmp/.eos-update-notifier.log',\n    '/tmp/.featureflags-agent/',\n\
    \    '/tmp/.font-unix/',\n    '/tmp/.git/',\n    '/tmp/.github/',\n    '/tmp/.go-version',\n\
    \    '/tmp/.helmrepo',\n    '/tmp/.ICE-unix/',\n    '/tmp/.last_survey_prompt.yaml',\n\
    \    '/tmp/.last_update_check.json',\n    '/tmp/.melange.yaml',\n    '/tmp/.metrics-agent/',\n\
    \    '/tmp/.PKGINFO',\n    '/tmp/.s.PGSQL.5432',\n    '/tmp/.s.PGSQL.5432.lock',\n\
    \    '/tmp/.searcher.tmp/',\n    '/tmp/.ses',\n    '/tmp/.settings-agent/',\n\
    \    '/tmp/.terraform.lock.hcl',\n    '/tmp/.terraform/',\n    '/tmp/.Test-unix/',\n\
    \    '/tmp/.touchpaddefaults',\n    '/tmp/.ui-agent/',\n    '/tmp/.updater-agent/',\n\
    \    '/tmp/.venv/',\n    '/tmp/.vscode.dmypy_status/',\n    '/tmp/.wsdl/',\n \
    \   '/tmp/.X0-lock',\n    '/tmp/.X1-lock',\n    '/tmp/.X11-unix/',\n    '/tmp/.X2-lock',\n\
    \    '/tmp/.XIM-unix/',\n    '/tmp/.ydotool_socket',\n    '/usr/bin/.kcapi-hasher.hmac',\n\
    \    '/usr/lib/jvm/.java-1.17.0-openjdk-amd64.jinfo',\n    '/usr/lib/nvidia-visual-profiler/.eclipseproduct',\n\
    \    '/usr/local/bin/.swtpm',\n    '/usr/local/libexec/.ksysguard/',\n    '/var/.ntw_cache',\n\
    \    '/var/.Parallels_swap/',\n    '/var/.pwd_cache',\n    '/var/.slm/',\n   \
    \ '/var/.slmauth/',\n    '/var/.slmbackup/',\n    '/var/db/.AppleInstallType.plist',\n\
    \    '/var/db/.AppleUpgrade',\n    '/var/db/.com.apple.iokit.graphics',\n    '/var/db/.com.intego.netupdate.serviceId',\n\
    \    '/var/db/.EntReg',\n    '/var/db/.GKRearmTimer',\n    '/var/db/.InstallerTMExcludes.plist',\n\
    \    '/var/db/.intl8859cache.db',\n    '/var/db/.LastGKApp',\n    '/var/db/.LastGKReject',\n\
    \    '/var/db/.lvm_setupdone',\n    '/var/db/.MASManifest',\n    '/var/db/.RunLanguageChooserToo',\n\
    \    '/usr/lib/x86_64-linux-gnu/.libkcapi.so.1.5.0.hmac',\n    '/lib/x86_64-linux-gnu/.libkcapi.so.1.5.0.hmac',\n\
    \    '/bin/X11/.kcapi-hasher.hmac',\n    '/var/db/.SoftwareUpdateOptions',\n \
    \   '/var/db/.StagedAppleUpgrade',\n    '/var/db/.SystemPolicy-default',\n   \
    \ '/var/discourse/.git/',\n    '/var/discourse/.github/',\n    '/var/home/.duperemove.hash',\n\
    \    '/var/home/.snapshots',\n    '/var/home/.snapshots/',\n    '/var/mail/.cache/',\n\
    \    '/var/root/.bash_history',\n    '/var/root/.bash_profile',\n    '/var/root/.cache/',\n\
    \    '/var/root/.CFUserTextEncoding',\n    '/var/root/.config/',\n    '/var/root/.docker/',\n\
    \    '/var/root/.forward',\n    '/var/root/.lesshst',\n    '/var/root/.nix-channels',\n\
    \    '/var/root/.nix-defexpr/',\n    '/var/root/.nix-profile/',\n    '/var/root/.nx/',\n\
    \    '/var/root/.osquery/',\n    '/var/root/.PenTablet/',\n    '/var/root/.provisio',\n\
    \    '/var/root/.ssh/',\n    '/var/root/.Trash/',\n    '/var/root/.viminfo',\n\
    \    '/var/tmp/.DS_Store',\n    '/var/root/.zsh_history',\n    '/var/roothome/.bash_history',\n\
    \    '/var/roothome/.bash_logout',\n    '/var/roothome/.bash_profile',\n    '/var/roothome/.bashrc',\n\
    \    '/var/roothome/.cache/',\n    '/var/roothome/.cargo/',\n    '/var/roothome/.config/',\n\
    \    '/var/roothome/.dbus/',\n    '/var/roothome/.justfile',\n    '/var/roothome/.lesshst',\n\
    \    '/var/roothome/.local/',\n    '/var/roothome/.mozilla/',\n    '/var/roothome/.osquery/',\n\
    \    '/var/roothome/.ssh/',\n    '/var/roothome/.var/',\n    '/var/roothome/.viminfo',\n\
    \    '/var/run/.heim_org.h5l.kcm-socket',\n    '/var/run/.sim_diagnosticd_socket',\n\
    \    '/var/run/.vfs_rsrc_streams_0x2b725bbfb94ba4ef0/',\n    '/var/setup/.AppleSetupUser',\n\
    \    '/var/setup/.fseventsd/',\n    '/var/setup/.TemporaryItems',\n    '/var/setup/.TemporaryItems/',\n\
    \    '/var/tmp/.ses',\n    '/var/tmp/.ses.bak'\n  )\n  AND file.directory NOT\
    \ IN (\n    '/etc/etckeeper/commit.d',\n    '/etc/skel',\n    '/etc/skel/.config',\n\
    \    '/var/root/.provisio'\n  )\n  -- haven't seen any malware use sockets yet\n\
    \  AND NOT file.type = 'socket'\n  AND file.filename NOT LIKE '.%.swo'\n  AND\
    \ file.filename NOT LIKE '.%.swp'\n  AND file.path NOT LIKE '%/.build-id/'\n \
    \ AND file.path NOT LIKE '%/.dwz/'\n  AND file.path NOT LIKE '%/.updated'\n  AND\
    \ file.path NOT LIKE '%/google-cloud-sdk/.install/'\n  AND file.path NOT LIKE\
    \ '%/lib/.lib%.hmac'\n  AND file.path NOT LIKE '/%bin/bootstrapping/.default_components'\n\
    \  AND file.path NOT LIKE '/lib/jvm/.java-%.jinfo'\n  AND file.path NOT LIKE '/tmp/.#%'\n\
    \  AND file.path NOT LIKE '/tmp/.%.gcode'\n  AND file.path NOT LIKE '/tmp/.cdx.json%'\n\
    \  AND file.path NOT LIKE '/tmp/.com.google.Chrome.%'\n  AND file.path NOT LIKE\
    \ '/tmp/.com.microsoft.Edge.%'\n  AND file.path NOT LIKE '/tmp/.com.valvesoftware.Steam.%/'\n\
    \  AND file.path NOT LIKE '/tmp/.dropbox-dist-%'\n  AND file.path NOT LIKE '/tmp/.io.nwjs.%'\n\
    \  AND file.path NOT LIKE '/tmp/.lark_cache_%'\n  AND file.path NOT LIKE '/tmp/.org.chromium.Chromium%'\n\
    \  AND file.path NOT LIKE '/tmp/.testcontainers-tmp-%'\n  AND file.path NOT LIKE\
    \ '/tmp/.tmp%/'\n  AND file.path NOT LIKE '/tmp/.tmp%/stdin'\n  AND file.path\
    \ NOT LIKE '/tmp/.vbox-%-ipc/'\n  AND file.path NOT LIKE '/tmp/.vbox-%-ipc/lock'\n\
    \  AND file.path NOT LIKE '/tmp/.wine-%'\n  AND file.path NOT LIKE '/tmp/.SIGN.RSA%.rsa.pub'\n\
    \  AND file.path NOT LIKE '/tmp/.X1%-lock'\n  AND file.path NOT LIKE '/tmp/.gradle%'\n\
    \  AND file.path NOT LIKE '/tmp/.git_signing_key%'\n  AND file.path NOT LIKE '/tmp/.xfsm-ICE-%'\n\
    \  AND file.path NOT LIKE '/usr/lib/jvm/.java-%-openjdk-%.jinfo'\n  AND file.path\
    \ NOT LIKE '/usr/local/%/.keepme'\n  AND file.path NOT LIKE '/var/roothome/.xauth%'\n\
    \  AND file.path NOT LIKE '/var/run/.vfs_rsrc_streams_%/'\n  AND NOT (\n    type\
    \ = 'regular'\n    AND (\n      filename LIKE '%.swp'\n      OR filename LIKE\
    \ '%.swo'\n      OR filename LIKE '%.swn'\n      OR size < 2\n    )\n  )\n  AND\
    \ NOT (\n    type = 'regular'\n    AND filename IN ('.placeholder', '.abignore',\
    \ '.gitignore')\n  ) -- A curious addition seen on NixOS and Fedora machines\n\
    \  AND NOT (\n    file.path = '/.cache/'\n    AND file.uid = 0\n    AND file.gid\
    \ = 0\n    AND file.mode IN ('0755', '0700')\n    AND file.size < 4\n  ) -- Ecamm\
    \ Live\n  AND NOT (\n    file.path LIKE \"/tmp/.elive%\"\n    AND file.size <\
    \ 7\n  )\n  AND NOT (\n    file.path = '/.config/'\n    AND file.uid = 0\n   \
    \ AND file.gid = 0\n    AND file.mode IN ('0755', '0700')\n    AND file.size =\
    \ 4\n  )\n  AND NOT (\n    file.path = '/var/tmp/.DS_Store'\n    AND file.uid\
    \ = 501\n    AND file.mode = '0644'\n    AND file.size < 10000\n  )\n  AND NOT\
    \ (\n    file.path LIKE '/tmp/.java_pid%'\n    AND file.type = 'socket'\n    AND\
    \ file.size = 0\n  )\n  AND NOT (\n    file.path = '/var/root/.oracle_jre_usage/'\n\
    \    AND file.size = 96\n  )\n  AND NOT (\n    file.path LIKE '/tmp/.ssh-%'\n\
    \    AND file.type = \"socket\"\n    AND file.mode = '0600'\n  )\n  -- still not\
    \ sure what the hell this is\n  AND NOT (\n    file.path LIKE '/tmp/.%3D'\n  \
    \  AND file.size < 35000\n    AND file.size > 20000\n    AND file.mode = '0644'\n\
    \    AND uid = 501\n    AND gid = 0\n  )\n  -- RX100\n  AND NOT (\n    file.path\
    \ LIKE '/var/db/.%'\n    AND file.gid = 0\n    AND file.uid = 0\n    AND file.size\
    \ = 28\n    AND file.mode = '0666'\n  )\n  AND NOT (\n    file.path LIKE '/tmp/.comments/%.jpg.xml'\n\
    \    AND file.uid > 0\n    AND file.size < 15000\n  )\n  AND NOT (\n    file.path\
    \ LIKE '/tmp/.tmp%'\n    AND file.uid > 500\n    AND size < 4096\n  )\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
