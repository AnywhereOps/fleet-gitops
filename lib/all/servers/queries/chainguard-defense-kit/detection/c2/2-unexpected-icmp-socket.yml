- name: CDK - Unexpected Icmp Socket
  description: Unexpected programs speaking over ICMP (state-based)
  query: "SELECT\n  pop.pid AS p0_pid,\n  pop.socket,\n  pop.local_address,\n  pop.remote_address,\n\
    \  -- Child\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n\
    \  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n\
    \  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path\
    \ AS p1_path,\n  p1.name AS p1_name,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  process_open_sockets pop\n  LEFT JOIN processes p0 ON pop.pid = p0.pid\n\
    \  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1\
    \ ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  pop.family = 2 -- PF_INET\n  AND pop.protocol = 1 --\
    \ ICMP\n  AND p0.name NOT IN ('ping')\n  AND p0.path NOT IN ('/opt/docker-desktop/bin/com.docker.backend')\n\
    GROUP BY\n  p0_pid\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
