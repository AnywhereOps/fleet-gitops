- name: CDK - Unexpected Dns Traffic
  description: 'Catch DNS traffic going to machines other than the host-configured
    DNS server (state-based) NOTE: This only supports IPv4 traffic due to an osquery
    bug with ''dns_resolvers'''
  query: "SELECT\n  s.family,\n  protocol,\n  s.local_port,\n  s.remote_port,\n  s.local_address,\n\
    \  s.remote_address,\n  p.name,\n  p.path,\n  p.cmdline AS child_cmd,\n  p.cwd,\n\
    \  s.pid,\n  p.parent AS parent_pid,\n  pp.cmdline AS parent_cmd,\n  hash.sha256,\n\
    \  GROUP_CONCAT(\n    (\n      SELECT DISTINCT\n        address\n      FROM\n\
    \        dns_resolvers\n      WHERE\n        type = 'nameserver'\n        AND\
    \ address != ''\n    ),\n    ','\n  ) AS sys_resolvers,\n  CONCAT (p.name, ',',\
    \ remote_address, ',', remote_port) AS exception_key\nFROM\n  process_open_sockets\
    \ s\n  LEFT JOIN processes p ON s.pid = p.pid\n  LEFT JOIN processes pp ON p.parent\
    \ = pp.pid\n  LEFT JOIN hash ON p.path = hash.path\nWHERE\n  remote_port IN (53,\
    \ 5353)\n  AND remote_address NOT LIKE '%:%'\n  AND s.remote_address NOT LIKE\
    \ '172.1%'\n  AND s.remote_address NOT LIKE '172.2%'\n  AND s.remote_address NOT\
    \ LIKE '172.30.%'\n  AND s.remote_address NOT LIKE '172.31.%'\n  AND s.remote_address\
    \ NOT LIKE '10.%'\n  AND s.remote_address NOT LIKE '192.168.%'\n  AND s.remote_address\
    \ NOT LIKE '127.%'\n  AND remote_address NOT IN (\n    SELECT DISTINCT\n     \
    \ address\n    FROM\n      dns_resolvers\n    WHERE\n      type = 'nameserver'\n\
    \      and address != ''\n  )\n  -- systemd-resolve sometimes shows up this way\n\
    \  -- If we could narrow this down using 'sys_resolvers' I would, but it is misuse\
    \ of GROUP_CONCAT\n  AND NOT (\n    s.pid = -1\n    AND s.remote_port = 53\n \
    \   and s.protocol = 17\n    and p.parent = ''\n  )\n  -- Some applications hard-code\
    \ a safe DNS resolver, or allow the user to configure one\n  AND s.remote_address\
    \ NOT IN (\n    '1.0.0.1', -- Cloudflare\n    '1.1.1.1', -- Cloudflare\n    '1.1.1.2',\
    \ -- Cloudflare\n    '8.8.8.8', -- Google\n    '8.8.4.4', -- Google (backup)\n\
    \    '208.67.222.222', -- OpenDNS\n    '75.75.75.75', -- Comcast\n    '68.105.28.13',\
    \ -- Cox\n    '84.116.46.21' -- Liberty Gloval B.V. (major NL telco)\n  )\n  --\
    \ Other exceptions\n  AND exception_key NOT IN (\n    'Arc Helper,1.0.0.1,53',\n\
    \    'coredns,0.0.0.0,53',\n    'goland,149.112.112.10,53',\n    'nessusd,50.16.123.71,53',\n\
    \    'syncthing,46.162.192.181,53'\n  )\n  -- Local DNS servers and custom clients\
    \ go here\n  AND p.path NOT IN (\n    '/Applications/Evernote.app/Contents/Frameworks/Evernote\
    \ Helper.app/Contents/MacOS/Evernote Helper',\n    '/Applications/Evernote.app/Contents/MacOS/Evernote',\n\
    \    '/Applications/Slack.app/Contents/Frameworks/Slack Helper.app/Contents/MacOS/Slack\
    \ Helper',\n    '/Applications/Spotify.app/Contents/Frameworks/Spotify Helper.app/Contents/MacOS/Spotify\
    \ Helper',\n    '/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/Contents/MacOS/IPNExtension',\n\
    \    '/opt/podman/bin/gvproxy',\n    '/Applications/Finch/lima/bin/limactl',\n\
    \    '/sbin/apk',\n    '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/Contents/MacOS/com.apple.WebKit.Networking',\n\
    \    '/usr/bin/tailscaled',\n    '/usr/lib/systemd/systemd-resolved',\n    '/usr/sbin/mDNSResponder'\n\
    \  )\n  AND p.path NOT LIKE '%/podman/gvproxy'\n  AND p.path NOT LIKE '%/eksctl'\n\
    \  AND p.path NOT LIKE '/opt/homebrew/Cellar/lima/%/bin/limactl'\n  AND p.path\
    \ NOT LIKE '%/Steam/Steam.AppBundle/Steam/Contents/MacOS/Frameworks/Steam Helper.app/Contents/MacOS/Steam\
    \ Helper'\n  AND p.path NOT LIKE '/Applications/Google Chrome.app/Contents/Frameworks/Google\
    \ Chrome Framework.framework/Versions/%/Helpers/Google Chrome Helper.app/Contents/MacOS/Google\
    \ Chrome Helper'\n  -- Workaround for the GROUP_CONCAT subselect adding a blank\
    \ ent\n  -- Workaround for the GROUP_CONCAT subselect adding a blank ent\nGROUP\
    \ BY\n  s.remote_address,\n  s.remote_port\nHAVING\n  remote_address != ''\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
