- name: CDK - High Disk Bytes Read
  description: Programs which are reading an unusually large amount of data Can be
    used to detect exfiltration
  query: "SELECT\n  -- WARNING: Writes to tmpfs are not reflected against this counter\n\
    \  p0.disk_bytes_read AS bytes_read,\n  (strftime('%s', 'now') - p0.start_time)\
    \ AS age,\n  p0.disk_bytes_read / (strftime('%s', 'now') - p0.start_time) AS bytes_read_rate,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n\
    \  p0.cgroup_path AS p0_cgroup,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n\
    \  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n \
    \ p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN\
    \ hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  -- On my Linux machine, tarring up a home directory clocks in at 2,800,000\
    \ - 4,986,722\n  bytes_read_rate > 3000000\n  AND age > 180\n  AND p0.path NOT\
    \ LIKE '/app/%'\n  AND p0.path NOT LIKE '/Applications/%.app/Contents/%'\n  --\
    \ Don't exclude /usr so that we find things like tar & rsync\n  AND p0.path NOT\
    \ LIKE '/home/%/.local/share/Steam/steamapps/%'\n  AND p0.path NOT LIKE '/Library/Apple/System/Library/%'\n\
    \  AND p0.path NOT LIKE '/opt/%'\n  AND p0.path NOT LIKE '/System/Applications/%'\n\
    \  AND p0.path NOT LIKE '/System/Library/%'\n  AND p0.name NOT IN (\n    'apko',\n\
    \    'Autodesk Fusion 360',\n    'Autodesk Identity Manager',\n    'baloo_file',\n\
    \    'baloo_file_extr',\n    'bash',\n    'BDLDaemon',\n    'bincapz',\n    'bwrap',\n\
    \    'cargo',\n    'chrome',\n    'clamscan',\n    'code',\n    'codium',\n  \
    \  'com.apple.MobileSoftwareUpdate.UpdateBrainService',\n    'com.apple.NRD.UpdateBrainService',\n\
    \    'com.apple.WebKit.Networking',\n    'cpptools',\n    'Disk Inventory X',\n\
    \    'dnf',\n    'docker',\n    'elastic-endpoin',\n    'elastic-endpoint',\n\
    \    'electron',\n    'emacs',\n    'factorio',\n    'Fedora Media Writer',\n\
    \    'firefox',\n    'firefox-bin',\n    'fish',\n    'fleet_backend',\n    'fsdaemon',\n\
    \    'fsnotifier',\n    'git',\n    'gnome-software',\n    'go',\n    'containerd-shim',\n\
    \    'goland',\n    'golangci-lint',\n    'Google Chrome',\n    'GoogleSoftwareUpdateAgent',\n\
    \    'gopls',\n    'grype',\n    'hugo',\n    'java',\n    'kandji-library-manager',\n\
    \    'kandji-parameter-agent',\n    'kube-apiserver',\n    'kube-controller',\n\
    \    'kube-scheduler',\n    'kue',\n    'launcher',\n    'LogiFacecamService',\n\
    \    'mal',\n    'mediawriter',\n    'Meeting Center',\n    'melange',\n    'minecraft-launc',\n\
    \    'meta',\n    'Microsoft Update Assistant',\n    'nautilus',\n    'nessusd',\n\
    \    'nix',\n    'nix-daemon',\n    'nvim',\n    'ollama',\n    'ollama-runer',\n\
    \    'ollama_llama_server',\n    'osqueryd',\n    'osqueryi',\n    'plasmashell',\n\
    \    'pycharm',\n    'qemu-system-aarch64',\n    'qemu-system-x86',\n    'qemu-system-x86-64',\n\
    \    'rpi-imager',\n    'rpm-ostree',\n    'rsync',\n    'Safari',\n    'sh',\n\
    \    'simdiskimaged',\n    'slack',\n    'snapd',\n    'spotify',\n    'steam',\n\
    \    'steam_osx',\n    'systemd',\n    'terraform',\n    'terraform-ls',\n   \
    \ 'terraform-provider-apko',\n    'thunderbird',\n    'tilt',\n    'unattended-upgr',\n\
    \    'update_dyld_sim_shared_cache',\n    'UpdateBrainService',\n    'updatedb',\n\
    \    'vim',\n    'wineserver',\n    'bundle',\n    'rake',\n    'wolfictl',\n\
    \    'yay',\n    'ykman-gui',\n    'yum',\n    'zsh',\n    'ZwiftAppMetal',\n\
    \    'ZwiftAppSilicon'\n  )\n  AND NOT p0.path IN (\n    '/app/libexec/mediawriter/helper',\n\
    \    '/usr/libexec/syspolicyd',\n    '/usr/libexec/logd',\n    '/usr/libexec/logd_helper',\n\
    \    '/usr/libexec/lsd',\n    '/usr/libexec/packagekitd',\n    '/usr/libexec/diskimagesiod',\n\
    \    '/Library/Application Support/Adobe/Adobe Desktop Common/HDBox/Setup',\n\
    \    '/Library/Elastic/Endpoint/elastic-endpoint',\n    '/System/Volumes/Preboot/Cryptexes/App/System/Applications/Safari.app/Contents/XPCServices/com.apple.Safari.BrowserDataImportingService.xpc/Contents/MacOS/com.apple.Safari.BrowserDataImportingService',\n\
    \    '/System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.WebContent.xpc/Contents/MacOS/com.apple.WebKit.WebContent'\n\
    \  )\n  AND NOT p0.path LIKE '/Library/SystemExtensions/%/io.kandji.KandjiAgent.ESF-Extension.systemextension/Contents/MacOS/io.kandji.KandjiAgent.ESF-Extension'\n\
    \  AND NOT p0.path LIKE '/private/var/folders/%/T/go-build%'\n  AND NOT p0.path\
    \ LIKE '/Users/%/Library/Application Support/Google/GoogleUpdater/%/GoogleUpdater.app/Contents/MacOS/GoogleUpdater'\n\
    \  AND NOT (\n    p0.name = 'bindfs'\n    AND p0.cmdline LIKE 'bindfs%-o fsname=%'\n\
    \  )\n  AND NOT (\n    p0.name = 'jetbrains-toolb'\n    AND p0.path LIKE '/tmp/.mount_jet%/jetbrains-toolbox'\n\
    \  )\n  AND NOT (\n    p0.name LIKE 'gopls_%'\n    AND p0.path LIKE '%gopls/gopls%'\n\
    \  )\n  AND NOT p0.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%com.apple.MobileSoftwareUpdate.UpdateBrainService.%.xpc/Contents/MacOS/com.apple.MobileSoftwareUpdate.UpdateBrainService'\n\
    \  AND NOT (\n    p0.name = 'FindMy'\n    AND p0.path = '/System/Applications/FindMy.app/Contents/MacOS/FindMy'\n\
    \  )\n  AND NOT (\n    p0.name = 'go'\n    AND p0.cmdline LIKE 'go run %'\n  )\n\
    \  AND NOT (\n    p0.name = 'kernel_task'\n    AND p0.path = ''\n    AND p0.parent\
    \ IN (0, 1)\n    AND p0.on_disk = -1\n  )\n  AND NOT (\n    p0.name = 'node'\n\
    \    AND p0.cwd LIKE '%/console-ui/app'\n  )\n  AND NOT (\n    p0.name = 'ruby'\n\
    \    AND p0.cmdline LIKE '%brew.rb upgrade'\n  )\n  AND NOT (\n    p0.name = 'terraform-ls'\n\
    \    AND p0.cmdline LIKE 'terraform-ls serve%'\n  )\n  AND NOT (\n    p0.name\
    \ = \"\"\n    AND p1.name = \"nvim\"\n  )\n  AND NOT p0.path LIKE \"%/terraform-provider-%\"\
    \n  AND NOT p0_cmd LIKE '%/gcloud.py components update'\n  AND NOT (\n    p0.path\
    \ LIKE '/home/%/Apps/PhpStorm%/jbr/bin/java'\n  )\n  AND NOT p0.cgroup_path LIKE\
    \ '/system.slice/docker-%'\nGROUP BY\n  p0.pid\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
