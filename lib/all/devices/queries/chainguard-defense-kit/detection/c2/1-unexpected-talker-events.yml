- name: CDK - Unexpected Talker Events
  description: Unexpected socket events
  query: "SELECT\n  s.status,\n  s.family,\n  s.path,\n  s.fd,\n  REPLACE(s.remote_address,\
    \ \"::ffff:\", \"\") AS remote_address,\n  s.remote_port,\n  s.local_port,\n \
    \ COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path) AS basename,\n  REPLACE(f.directory,\
    \ u.directory, '~') AS homedir,\n  CONCAT (\n    MIN(s.auid, 500),\n    \",\"\
    ,\n    MIN(f.uid, 500),\n    \",\",\n    MIN(s.remote_port, 32768),\n    \",\"\
    ,\n    COALESCE(REGEX_MATCH (s.path, '.*/(.*)', 1), s.path)\n  ) as exception_key,\n\
    \  RTRIM(\n    COALESCE(\n      REGEX_MATCH (\n        REPLACE(f.directory, u.directory,\
    \ '~'),\n        '([/~].*?/.*?)/',\n        1\n      ),\n      f.directory\n \
    \   ),\n    \"/\"\n  ) AS top2_dir,\n  -- Child\n  s.path AS p0_path,\n  s.pid\
    \ AS p0_pid,\n  s.auid AS p0_euid,\n  TRIM(COALESCE(p.cmdline, pe.cmdline)) AS\
    \ p0_cmd,\n  TRIM(COALESCE(p.cwd, pe.cwd)) AS p0_cwd,\n  hash.sha256 AS p0_sha256,\n\
    \  -- Parent\n  COALESCE(p.parent, pe.parent) AS p1_pid\nFROM\n  socket_events\
    \ AS s\n  LEFT JOIN process_events pe ON s.pid = pe.pid\n  AND pe.time > (strftime('%s',\
    \ 'now') -7200)\n  LEFT JOIN processes p ON s.pid = p.pid\n  LEFT JOIN file f\
    \ ON s.path = f.path\n  LEFT JOIN users u ON f.uid = u.uid\n  LEFT JOIN hash ON\
    \ s.path = hash.path\nWHERE\n  s.time > (strftime('%s', 'now') -600)\n  AND s.action\
    \ = \"connect\"\n  AND s.remote_port > 10\n  AND s.remote_address NOT IN (\n \
    \   '127.0.0.1',\n    '::ffff:127.0.0.1',\n    '::1',\n    '::',\n    '0.0.0.0'\n\
    \  )\n  AND s.remote_address NOT LIKE 'fe80:%'\n  AND s.remote_address NOT LIKE\
    \ '127.%'\n  AND s.remote_address NOT LIKE '192.168.%'\n  AND s.remote_address\
    \ NOT LIKE '100.7%'\n  AND s.remote_address NOT LIKE '172.1%'\n  AND s.remote_address\
    \ NOT LIKE '172.2%'\n  AND s.remote_address NOT LIKE '0000:%'\n  AND s.remote_address\
    \ NOT LIKE '172.30.%'\n  AND s.remote_address NOT LIKE '172.31.%'\n  AND s.remote_address\
    \ NOT LIKE '::ffff:172.%'\n  AND s.remote_address NOT LIKE '10.%'\n  AND s.remote_address\
    \ NOT LIKE '::ffff:10.%'\n  AND s.remote_address NOT LIKE '::ffff:192.168.%'\n\
    \  AND s.remote_address NOT LIKE 'fc00:%'\n  AND NOT s.path LIKE '/Applications/%'\
    \ -- NOTE: Do not filter out /bin (bash) or /usr/bin (nc)\n  AND NOT s.path LIKE\
    \ '/private/var/folders/%/T/go-build%'\n  AND NOT s.path = '/Library/Internet\
    \ Plug-Ins/JavaAppletPlugin.plugin/Contents/Resources/Java Updater.app/Contents/MacOS/Java\
    \ Updater'\n  AND NOT top2_dir IN (\n    '/Library/Apple',\n    '/Library/Application\
    \ Support',\n    '/Library/Developer',\n    '/Library/Kandji',\n    '/opt/homebrew',\n\
    \    '/snap/firefox',\n    '/System/Applications',\n    '/System/Library',\n \
    \   '/System/Volumes',\n    '/usr/bin',\n    '/usr/libexec',\n    '/usr/local',\n\
    \    '/usr/sbin',\n    '~/.provisio',\n    '~/Applications',\n    '~/Apps',\n\
    \    '~/bin',\n    '~/code',\n    '~/github',\n    '~/go',\n    '~/homebrew',\n\
    \    '~/src',\n    '~/work'\n  )\n  AND NOT homedir IN (\n    '/opt/spotify',\n\
    \    '/usr/lib/google-cloud-sdk/platform/bundledpythonunix/bin',\n    '~/Library/Application\
    \ Support/Foxit Software/Addon/Foxit PDF Reader/FoxitPDFReaderUpdateService.app/Contents/MacOS'\n\
    \  )\n  AND NOT exception_key IN (\n    '0,velociraptor,velociraptor,500u,80g',\n\
    \    '500,0,110,syncthing',\n    '500,0,123,sntp',\n    '500,0,1234,spotify',\n\
    \    '500,0,20480,com.adguard.mac.adguard.network-extension',\n    '500,0,20480,io.tailscale.ipn.macsys.network-extension',\n\
    \    '500,0,22,ssh',\n    '500,0,27668,com.adguard.mac.adguard.network-extension',\n\
    \    '500,0,31488,sntp',\n    '500,0,32768,Authy',\n    '500,0,32768,BDLDaemon',\n\
    \    '500,0,32768,com.adguard.mac.adguard.network-extension',\n    '500,0,32768,com.apple.MobileSoftwareUpdate.UpdateBrainService',\n\
    \    '500,0,32768,com.apple.NRD.UpdateBrainService',\n    '500,0,32768,elastic-endpoint',\n\
    \    '500,0,32768,firefox',\n    '500,0,32768,git-remote-http',\n    '500,0,32768,io.tailscale.ipn.macsys.network-extension',\n\
    \    '500,0,32768,ir_agent',\n    '500,0,32768,ksfetch',\n    '500,0,32768,networkQuality',\n\
    \    '500,0,32768,syncthing',\n    '500,0,3478,firefox',\n    '500,0,4070,spotify',\n\
    \    '500,0,43,whois',\n    '500,0,443,Authy',\n    '500,0,443,BDCoreIssues',\n\
    \    '500,0,443,BDLDaemon',\n    '500,0,443,bdredline',\n    '500,0,443,BDUpdDaemon',\n\
    \    '500,0,443,Brackets',\n    '500,0,443,chrome_crashpad_handler',\n    '500,0,443,chrome',\n\
    \    '500,0,443,com.adguard.mac.adguard.network-extension',\n    '500,0,443,com.apple.MobileSoftwareUpdate.UpdateBrainService',\n\
    \    '500,0,443,com.apple.NRD.UpdateBrainService',\n    '500,0,443,com.bitdefender.cst.net.dci.dci-network-extension',\n\
    \    '500,0,443,com.docker.backend',\n    '500,0,443,com.fortinet.forticlient.macos.vpn.nwextension',\n\
    \    '500,0,443,com.google.one.NetworkExtension',\n    '500,0,443,curl',\n   \
    \ '500,0,443,docker-buildx',\n    '500,0,443,elastic-agent',\n    '500,0,443,elastic-endpoint',\n\
    \    '500,0,443,electron',\n    '500,0,443,filebeat',\n    '500,0,443,firefox',\n\
    \    '500,0,443,fwupdmgr',\n    '500,0,443,git-remote-http',\n    '500,0,443,gnome-software',\n\
    \    '500,0,443,go',\n    '500,0,443,http',\n    '500,0,443,incusd',\n    '500,0,443,io.tailscale.ipn.macsys.network-extension',\n\
    \    '500,0,443,ir_agent',\n    '500,0,443,kioslave5',\n    '500,0,443,ksfetch',\n\
    \    '500,0,443,launcher',\n    '500,0,443,metricbeat',\n    '500,0,443,nessusd',\n\
    \    '500,0,443,networkQuality',\n    '500,0,443,node',\n    '500,0,443,OneDriveStandaloneUpdater',\n\
    \    '500,0,443,packetbeat',\n    '500,0,443,pingsender',\n    '500,0,443,Python',\n\
    \    '500,0,443,rapid7_endpoint_broker',\n    '500,0,443,slack',\n    '500,0,443,snapd',\n\
    \    '500,0,443,spotify',\n    '500,0,443,ssh',\n    '500,0,443,syncthing',\n\
    \    '500,0,443,terraform',\n    '500,0,443,velociraptor',\n    '500,0,443,wget',\n\
    \    '500,0,5228,chrome',\n    '500,0,53,Brackets',\n    '500,0,53,chrome',\n\
    \    '500,0,53,electron',\n    '500,0,53,firefox',\n    '500,0,53,git',\n    '500,0,53,launcher',\n\
    \    '500,0,53,nessusd',\n    '500,0,53,NetworkManager',\n    '500,0,53,slack',\n\
    \    '500,0,53,spotify',\n    '500,0,53,wget',\n    '500,0,5632,ssh',\n    '500,0,80,BDUpdDaemon',\n\
    \    '500,0,80,chrome',\n    '500,0,80,com.adguard.mac.adguard.network-extension',\n\
    \    '500,0,80,com.apple.NRD.UpdateBrainService',\n    '500,0,80,com.bitdefender.cst.net.dci.dci-network-extension',\n\
    \    '500,0,80,electron',\n    '500,0,80,filebeat',\n    '500,0,80,firefox',\n\
    \    '500,0,80,http',\n    '500,0,80,incusd',\n    '500,0,80,io.tailscale.ipn.macsys.network-extension',\n\
    \    '500,0,80,ir_agent',\n    '500,0,80,ksfetch',\n    '500,0,80,metricbeat',\n\
    \    '500,0,80,slack',\n    '500,0,8080,com.bitdefender.cst.net.dci.dci-network-extension',\n\
    \    '500,0,9,launcher',\n    '500,0,9,snapd',\n    '500,500,13568,Code Helper',\n\
    \    '500,500,20480,Code Helper',\n    '500,500,20480,Google Chrome Helper',\n\
    \    '500,500,20480,GoogleUpdater',\n    '500,500,20480,ksfetch',\n    '500,500,22,ssh',\n\
    \    '500,500,2304,cloud_sql_proxy',\n    '500,500,2304,terraform-provider-google_v4.37.0_x5',\n\
    \    '500,500,3024,ZwiftAppSilicon',\n    '500,500,32768,Chromium Helper',\n \
    \   '500,500,32768,cloud-sql-proxy',\n    '500,500,32768,Code Helper',\n    '500,500,32768,DropboxMacUpdate',\n\
    \    '500,500,32768,Electron',\n    '500,500,32768,G2MUpdate',\n    '500,500,32768,GoogleUpdater',\n\
    \    '500,500,32768,java',\n    '500,500,32768,ksfetch',\n    '500,500,32768,melange',\n\
    \    '500,500,32768,Microsoft.ServiceHub.Controller',\n    '500,500,32768,Microsoft.VisualStudio.Code.Server',\n\
    \    '500,500,32768,Microsoft.VisualStudio.Code.ServiceHost',\n    '500,500,32768,node',\n\
    \    '500,500,32768,old',\n    '500,500,32768,rzls',\n    '500,500,32768,terraform-ls',\n\
    \    '500,500,3307,cloud_sql_proxy',\n    '500,500,4318,Code Helper (Plugin)',\n\
    \    '500,500,443,Acrobat Updater',\n    '500,500,443,apk',\n    '500,500,443,aws',\n\
    \    '500,500,443,chainctl',\n    '500,500,443,Chromium Helper',\n    '500,500,443,Cisco\
    \ WebEx Start',\n    '500,500,443,CleanMyMac X Updater',\n    '500,500,443,cloud_sql_proxy',\n\
    \    '500,500,443,Code Helper (Plugin)',\n    '500,500,443,Code Helper (Renderer)',\n\
    \    '500,500,443,Code Helper',\n    '500,500,443,copilot-agent-macos-arm64',\n\
    \    '500,500,443,DropboxMacUpdate',\n    '500,500,443,Electron',\n    '500,500,443,figma_agent',\n\
    \    '500,500,443,gh',\n    '500,500,443,git-remote-http',\n    '500,500,443,gitsign',\n\
    \    '500,500,443,GitX',\n    '500,500,443,go',\n    '500,500,443,Google Chrome\
    \ Helper',\n    '500,500,443,GoogleUpdater',\n    '500,500,443,grype',\n    '500,500,443,istioctl',\n\
    \    '500,500,443,ksfetch',\n    '500,500,443,kubectl',\n    '500,500,443,Meeting\
    \ Center',\n    '500,500,443,minikube',\n    '500,500,443,node',\n    '500,500,443,old',\n\
    \    '500,500,443,Signal Helper (Renderer)',\n    '500,500,443,Signal',\n    '500,500,443,sublime_text',\n\
    \    '500,500,443,syft',\n    '500,500,443,webexmtaV2',\n    '500,500,443,wolfibump',\n\
    \    '500,500,443,wolfictl',\n    '500,500,443,ZwiftAppSilicon',\n    '500,500,53,Code\
    \ Helper',\n    '500,500,53,gitsign',\n    '500,500,53,Google Chrome Helper',\n\
    \    '500,500,53,Meeting Center',\n    '500,500,80,cloud_sql_proxy',\n    '500,500,80,Code\
    \ Helper (Plugin)',\n    '500,500,80,Code Helper',\n    '500,500,80,copilot-agent-macos-arm64',\n\
    \    '500,500,80,elastic-agent',\n    '500,500,80,firefox-bin',\n    '500,500,80,Google\
    \ Chrome Helper',\n    '500,500,80,GoogleUpdater',\n    '500,500,80,ksfetch',\n\
    \    '500,500,80,node',\n    '500,500,9000,Meeting Center',\n    '500,99,13568,Slack\
    \ Helper',\n    '500,99,32768,Slack Helper',\n    '500,99,32768,Slack',\n    '500,99,443,Slack\
    \ Helper',\n    '500,99,443,Slack',\n    '500,99,53,Slack Helper'\n  )\n  AND\
    \ NOT exception_key LIKE '500,0,%,chrome'\n  AND NOT exception_key LIKE '500,0,%,syncthing'\n\
    \  AND NOT exception_key LIKE '500,500,%,chrome'\n  AND NOT exception_key LIKE\
    \ '500,500,%,Google Chrome Helper'\n  AND NOT exception_key LIKE '500,500,2304,terraform%'\n\
    \  AND NOT exception_key LIKE '500,500,32768,terraform-provider-%'\n  AND NOT\
    \ exception_key LIKE '500,500,443,___%_%'\n  AND NOT exception_key LIKE '500,500,443,kubectl.%'\n\
    \  AND NOT exception_key LIKE '500,500,443,terraform%'\n  AND NOT exception_key\
    \ LIKE '500,500,53,terraform%'\n  AND NOT exception_key LIKE '500,500,80,terraform%'\n\
    \  AND NOT p0_path LIKE '/private/var/folders/%/T/AppTranslocation/%/%.app/Contents/MacOS/%'\n\
    \  AND NOT p0_path LIKE '/System/%'\n  AND NOT p0_path LIKE '/Users/%/code/%'\n\
    \  AND NOT p0_path LIKE '/Users/%/dev/%'\n  AND NOT p0_path LIKE '/Users/%/go/%'\n\
    \  AND NOT p0_path LIKE '/Users/%/Library/Caches/JetBrains/GoLand%'\n  AND NOT\
    \ p0_path LIKE '/Users/%/src/%'\n  AND NOT (\n    basename = \"Python\"\n    AND\
    \ (\n      p0_cmd LIKE '%/gcloud.py%'\n      OR p0_cmd LIKE '%/bin/aws%'\n   \
    \   OR p0_cmd LIKE '%/google-cloud-sdk/%'\n      OR p0_cmd LIKE '%googlecloudsdk/%'\n\
    \      OR p0_cmd LIKE '%pip install%'\n      OR p0_cmd LIKE \"%/gsutil/%\"\n \
    \   )\n  )\nGROUP BY\n  s.pid,\n  exception_key\n"
  interval: 601
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
