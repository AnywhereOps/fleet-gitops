- name: CDK - Unexpected Executable Permissions
  description: Find processes running that are tied to binaries with unsual permissions.
    Namely, 0777.
  query: "SELECT\n  f.mode,\n  f.uid,\n  f.gid,\n  f.ctime,\n  -- Child\n  p0.pid\
    \ AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n\
    \  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n\
    \  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path\
    \ AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n\
    \  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name\
    \ AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256\
    \ AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n\
    \  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1\
    \ ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  f.mode NOT IN (\n    '0500',\n    '0551',\n    '0544',\n\
    \    '0555',\n    '0711',\n    '0750',\n    '0755',\n    '0775',\n    '0744',\n\
    \    '6755',\n    '0700',\n    '2755',\n    '4511',\n    '4555',\n    '4755'\n\
    \  )\n  -- Vendors who are very relaxed about permissions\n  AND NOT (\n    f.path\
    \ IN (\n      '/Applications/Camera Settings.app/Contents/MacOS/LogitechCamera',\n\
    \      '/Applications/motionVFX/Plugins/mUtility.app/Contents/PlugIns/mUtility\
    \ XPC Service.pluginkit/Contents/MacOS/mUtility XPC Service',\n      '/Library/Application\
    \ Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService'\n\
    \    )\n    AND f.mode = '0777'\n    AND f.uid > 500\n  )\n  AND NOT (\n    f.path\
    \ IN (\n      '/Applications/EA app.app/Contents/Applications/EABackgroundService.app/Contents/MacOS/EABackgroundService',\n\
    \      '/Applications/EA app.app/Contents/Applications/EABackgroundAgent.app/Contents/MacOS/EABackgroundAgent',\n\
    \      '/Applications/Finch/lima/bin/limactl',\n      '/Applications/Finch/lima/bin/qemu-system-aarch64'\n\
    \    )\n    AND f.mode = '0777'\n    AND f.uid = 0\n  )\n  AND NOT (\n    f.path\
    \ LIKE '/Users/%/.local/bin/%'\n    AND f.mode = '0777'\n    AND f.uid > 500\n\
    \  )\n  AND NOT (\n    f.path LIKE '/Users/%/Library/Application Support/Code/User/globalStorage/grafana.vscode-jsonnet/bin/jsonnet-language-server'\n\
    \    AND f.mode = '0777'\n    AND f.uid > 500\n  )\n  AND NOT (\n    f.path LIKE\
    \ '/Users/%/.vscode/extensions/sumneko.lua-%-darwin-arm64/server/bin/lua-language-server'\n\
    \    AND f.mode = '0777'\n    AND f.uid > 500\n  )\n  AND NOT (\n    f.path LIKE\
    \ '/Users/%/Library/Application Support/Zwift/ZwiftApp%'\n    AND f.mode = '0777'\n\
    \    AND f.uid > 500\n  )\n  AND NOT (\n    f.path = '/usr/bin/sudo'\n    AND\
    \ f.mode = '4111'\n    AND f.uid = 0\n  )\n  AND NOT (\n    f.path LIKE '/home/%/.local/share/JetBrains/Toolbox/bin/jetbrains-toolbox'\n\
    \    AND f.mode = '0744'\n  )\n  AND NOT (\n    f.path LIKE '/home/%/.cache/JetBrains/%/semantic-search/server/%/embeddings-server'\n\
    \    AND f.mode = '0764'\n  )\n  AND NOT (\n    f.path LIKE '/Users/%/Applications\
    \ (Parallels)/%.app/Contents/MacOS/WinAppHelper'\n    AND f.mode = '0777'\n  )\n\
    \  AND NOT (\n    f.path LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'\n\
    \    AND f.mode = '1555'\n  )\n  AND NOT (\n    f.path LIKE '/opt/homebrew/Cellar/dnsmasq/%/sbin/dnsmasq'\n\
    \    AND f.mode = '1555'\n  )\n  AND NOT (\n    f.path LIKE '/Users/%/Library/Application\
    \ Support/com.raycast.macos/NodeJS/runtime/%/bin/node'\n    AND f.mode = '0754'\n\
    \  )\n  AND NOT (\n    f.path LIKE '%/Elastic/Agent/data/elastic-agent%/elastic-agent'\n\
    \    AND f.mode = '0770'\n  )\n  AND NOT (\n    f.path = '/Library/Bitdefender/AVP/product/bin/EndpointSecurityforMac.app/Contents/MacOS/EndpointSecurityforMac'\n\
    \    AND f.mode = '0655'\n  )\n  AND NOT (\n    p0.name = 'ShortcutDroplet'\n\
    \    AND f.mode = '0751'\n  )\n  AND NOT (\n    f.path = '/home/%/.local/share/AppImage/ZenBrowser.AppImage'\n\
    \    AND f.mode = '0600'\n  )\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
