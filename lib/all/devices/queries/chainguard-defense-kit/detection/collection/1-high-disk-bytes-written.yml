- name: CDK - High Disk Bytes Written
  description: Programs which are writing an unusually large amount of data Can be
    used to detect ransomware
  query: "SELECT\n  -- WARNING: Writes to tmpfs are not reflected against this counter\n\
    \  p0.disk_bytes_written AS bytes_written,\n  (strftime('%s', 'now') - p0.start_time)\
    \ AS age,\n  p0.disk_bytes_written / (strftime('%s', 'now') - p0.start_time) AS\
    \ bytes_written_rate,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n\
    \  p0.name AS p0_name,\n  p0.cgroup_path AS p0_cgroup,\n  p0.cmdline AS p0_cmd,\n\
    \  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n\
    \  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n\
    \  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS\
    \ p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes\
    \ p0\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes\
    \ p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  -- On my Linux machine, creating a gzip archive clocks\
    \ in at 6780210\n  bytes_written_rate > 4800000\n  AND age > 200\n  AND p0.pid\
    \ > 2\n  AND p0.parent != 2\n  AND p0.path NOT IN (\n    '/app/libexec/mediawriter/helper',\n\
    \    '/bin-busybox',\n    '/bin/bash',\n    '/bin/sh',\n    '/Library/Application\
    \ Support/Adobe/Adobe Desktop Common/HDBox/Setup',\n    '/opt/homebrew/bin/qemu-system-aarch64',\n\
    \    '/opt/osquery/lib/osquery.app/Contents/MacOS/osqueryd',\n    '/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/Current/AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup',\n\
    \    '/usr/bin/apt',\n    '/usr/bin/aptd',\n    '/usr/bin/bash',\n    '/usr/bin/bwrap',\n\
    \    '/usr/bin/curl',\n    '/usr/bin/darktable',\n    '/usr/bin/dockerd',\n  \
    \  '/usr/bin/fish',\n    '/usr/bin/git',\n    '/usr/bin/gnome-disks',\n    '/usr/bin/gnome-shell',\n\
    \    '/usr/bin/gnome-software',\n    '/usr/bin/gnome-text-editor',\n    '/usr/bin/make',\n\
    \    '/usr/bin/nautilus',\n    '/usr/bin/melange',\n    '/usr/bin/pacman',\n \
    \   '/usr/bin/toolbox',\n    '/usr/bin/qemu-system-x86_64',\n    '/usr/bin/yay',\n\
    \    '/usr/bin/zsh',\n    '/usr/lib/baloo_file',\n    '/usr/lib/baloo_file_extractor',\n\
    \    '/usr/lib/flatpak-system-helper',\n    '/usr/lib/snapd/snapd',\n    '/usr/lib/systemd/systemd',\n\
    \    '/usr/lib/systemd/systemd-journald',\n    '/usr/lib64/thunderbird/thunderbird',\n\
    \    '/usr/libexec/coreduetd',\n    '/usr/libexec/flatpak-system-helper',\n  \
    \  '/usr/libexec/logd_helper',\n    '/usr/libexec/mobileassetd',\n    '/usr/libexec/packagekitd',\n\
    \    '/usr/libexec/rosetta/oahd',\n    '/usr/libexec/rtcreportingd',\n    '/usr/libexec/secd',\n\
    \    '/usr/libexec/sharingd',\n    '/usr/sbin/screencapture',\n    '/usr/share/spotify-client/spotify'\n\
    \  )\n  AND NOT (\n    p0.name LIKE 'jbd%/dm-%'\n    AND p0.on_disk = -1\n  )\n\
    \  AND NOT (\n    p0.name = 'bindfs'\n    AND p0.cmdline LIKE 'bindfs -f -o fsname=%'\n\
    \  )\n  AND NOT (\n    p0.name = 'btrfs-transaction'\n    AND p0.on_disk = -1\n\
    \  )\n  AND NOT (\n    p0.name = 'kernel_task'\n    AND p0.path = ''\n    AND\
    \ p0.parent IN (0, 1)\n    AND p0.on_disk = -1\n  )\n  AND NOT (\n    p0.name\
    \ = 'launchd'\n    AND p0.path = '/sbin/launchd'\n    AND p0.parent = 0\n  )\n\
    \  AND NOT (\n    p0.name = 'logd'\n    AND p0.cmdline = '/usr/libexec/logd'\n\
    \    AND p0.parent = 1\n  )\n  AND NOT (\n    p0.name = 'aptd'\n    AND p0.cmdline\
    \ = '/usr/bin/python3 /usr/sbin/aptd'\n  )\n  AND NOT p0.name IN (\n    'apkoaas',\n\
    \    'Autodesk Fusion 360',\n    'baloo_file_extr',\n    'bincapz',\n    'bwrap',\n\
    \    'cargo',\n    'chrome',\n    'clair',\n    'code',\n    'com.apple.MobileSoftwareUpdate.UpdateBrainService',\n\
    \    'com.apple.NRD.UpdateBrainService',\n    'containerd',\n    'containerd-',\n\
    \    'containerd-shim',\n    'darkfiles',\n    'dlv',\n    'dnf',\n    'dnf-automatic',\n\
    \    'docker-index',\n    'esbuild',\n    'firefox',\n    'wolfi-package-info-who-owns',\n\
    \    'flatpak-session',\n    'fsdaemon',\n    'git',\n    'gnome-terminal-',\n\
    \    'go',\n    'goland',\n    'golangci-lint-v',\n    'GoogleUpdater',\n    'gopls',\n\
    \    'grype',\n    'idea',\n    'Install',\n    'java',\n    'jetbrains-toolb',\n\
    \    'kandji-daemon',\n    'kpromo',\n    'launcher',\n    'limactl',\n    'logioptionsplus_updater',\n\
    \    'lxd',\n    'mal',\n    'mediawriter',\n    'melange',\n    'melange-run',\n\
    \    'monorail',\n    'nami',\n    'nessusd',\n    'ninja',\n    'node',\n   \
    \ 'osqueryd',\n    'photorec',\n    'qemu-system-aarch64',\n    'qemu-system-x86',\n\
    \    'qemu-system-x86_64',\n    'postgres',\n    'rpm-ostree',\n    'rsync',\n\
    \    'rust-analyzer',\n    'rustup',\n    'slack',\n    'snyk',\n    'snyk-macos',\n\
    \    'spotify',\n    'staticcheck',\n    'steam',\n    'steam_osx',\n    'syft',\n\
    \    'terraform',\n    'terraform-provider-apko',\n    'thunderbird-bin',\n  \
    \  'tmux:server',\n    'topgrade',\n    'tracker-miner-f',\n    'trivy',\n   \
    \ 'trivy-db',\n    'unattended-upgr',\n    'vi',\n    'vim',\n    'wimlib-imagex',\n\
    \    'wineserver',\n    'wolfictl',\n    'yum',\n    'zsh'\n  )\n  AND NOT p1.name\
    \ IN ('bwrap')\n  AND p0.path NOT LIKE '/Applications/%.app/Contents/%'\n  AND\
    \ p0.path NOT LIKE '/home/%/.local/share/Steam'\n  AND p0.path NOT LIKE '/Library/Application\
    \ Support/%'\n  AND p0.path NOT LIKE '/nix/store/%/bin/%sh'\n  AND p0.path NOT\
    \ LIKE '/nix/store/%/bin/nix'\n  AND p0.path NOT LIKE '/nix/store/%kolide-launcher-%/bin/launcher'\n\
    \  AND p0.path NOT LIKE '/System/Applications/%'\n  AND p0.path NOT LIKE '/System/Library/%'\n\
    \  AND p0.path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'\n\
    \  AND p0.path NOT LIKE '/var/folders/%/T/go-build%'\n  AND p0.path NOT LIKE '/var/kolide-k2/%/osqueryd'\n\
    \  AND p0.path NOT LIKE \"%/terraform-provider-%\"\n  AND NOT p0.cmdline LIKE\
    \ '%/gsutil %rsync%'\n  AND NOT p0.cmdline LIKE '%python -m build%'\n  AND NOT\
    \ p0.cmdline LIKE '%python -m pip%'\n  AND NOT p0.cmdline LIKE '%/lib/gcloud.py\
    \ components update'\n  AND NOT p0.cmdline LIKE '%brew.rb upgrade%'\n  AND NOT\
    \ p0.cgroup_path LIKE '/system.slice/docker-%'\n  AND p0.cwd != '/home/build'\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
