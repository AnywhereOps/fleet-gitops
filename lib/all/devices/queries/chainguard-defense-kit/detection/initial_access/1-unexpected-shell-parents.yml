- name: CDK - Unexpected Shell Parents
  description: Unexpected process that spawns shell processes (event based)
  query: "SELECT\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name\
    \ AS p0_name,\n  p0.start_time AS p0_start,\n  p0.cmdline AS p0_cmd,\n  p0.cwd\
    \ AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256\
    \ AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n\
    \  p1.name AS p1_name,\n  p1.start_time AS p1_start,\n  p1.euid AS p1_euid,\n\
    \  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n \
    \ p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.start_time AS p2_start,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT\
    \ JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.name IN ('sh', 'fish', 'zsh',\
    \ 'bash', 'dash')\n  -- Ignore partial table joins\n  AND p1_path != ''\n  --\
    \ Editors & terminals mostly.\n  -- I know it's tempting to list \"electron\"\
    \ here but please find a more specific exclusion.\n  AND p1.name NOT IN (\n  \
    \  'abrt-action-per',\n    'abrt-handle-eve',\n    'AGSService',\n    'alacritty',\n\
    \    'Alfred',\n    'anacron',\n    'arduino-cli',\n    'auditd',\n    'bash',\n\
    \    'build-script-build',\n    'buildkit-runc',\n    'chezmoi',\n    'clang-11',\n\
    \    'Code - Insiders Helper (Renderer)',\n    'Code - Insiders Helper',\n   \
    \ 'Code Helper (Renderer)',\n    'code',\n    'collect2',\n    'com.docker.back',\n\
    \    'configure',\n    'conmon',\n    'containerd-shim',\n    'Core Sync',\n \
    \   'Cursor Helper',\n    'Cursor',\n    'dash',\n    'demoit',\n    'direnv',\n\
    \    'dnf',\n    'dnf-automatic',\n    'doas',\n    'Docker Desktop',\n    'dumb-init',\n\
    \    'elastic-security',\n    'erl_child_setup',\n    'find',\n    'FinderSyncExtension',\n\
    \    'fish',\n    'i3',\n    'flock',\n    'gdm-wayland-ses',\n    'gephi',\n\
    \    'git',\n    'git-remote-http',\n    'git-remote-https',\n    'GitKraken Helper\
    \ (Renderer)',\n    'gnome-session-b',\n    'gnome-shell',\n    'go',\n    'goland',\n\
    \    'GoogleSoftwareUpdateAgent',\n    'GoogleUpdater',\n    'gopls',\n    'gosec',\n\
    \    'helm',\n    'Hyper',\n    'i3bar',\n    'i3blocks',\n    'idea',\n    'incusd',\n\
    \    'inittool2',\n    'java',\n    'jetbrains_client',\n    'just',\n    'kandji-library-manager',\n\
    \    'kitty',\n    'ko',\n    'konsole',\n    'kubectl',\n    'kue',\n    'ld',\n\
    \    'lightdm',\n    'linux-sandbox',\n    'LogiMgrDaemon',\n    'LogiTune',\n\
    \    'logrotate',\n    'MacVim',\n    'make',\n    'Microsoft.VisualStudio.Reliability.Monitor',\n\
    \    'monorail',\n    'newgrp',\n    'ninja',\n    'nix',\n    'nix-build',\n\
    \    'nix-daemon',\n    'node',\n    'nu',\n    'nvim',\n    'OpenLens',\n   \
    \ 'package_script_service',\n    'pacman',\n    'perl',\n    'pia-daemon',\n \
    \   'PK-Backend',\n    'provisio',\n    'ptyxis-agent',\n    'pycharm',\n    'qcalc',\n\
    \    'Rancher Desktop',\n    'roxterm',\n    'rpmbuild',\n    'Runner.Listener',\n\
    \    'Runner.Worker',\n    'screen',\n    'sdk',\n    'sdzoomplugin',\n    'sh',\n\
    \    'skhd',\n    'ssh',\n    'sshd',\n    'sshd-session',\n    'steam_osx',\n\
    \    'swift',\n    'systemd',\n    'terminator',\n    'terraform',\n    'terraform-provi',\n\
    \    'test2json',\n    'timeout',\n    'tmux',\n    'tmux:server',\n    'udev-worker',\n\
    \    'unattended-upgr',\n    'update-notifier',\n    'vi',\n    'vim',\n    'vim-nox11',\n\
    \    'VisualStudio',\n    'watch',\n    'waybar',\n    'wezterm-gui',\n    'xargs',\n\
    \    'xcrun',\n    'xfce4-session',\n    'xfce4-terminal',\n    'yum',\n    'zed-editor',\n\
    \    'zellij',\n    'zsh'\n  )\n  AND p1_path NOT LIKE '/Applications/%.app/Contents/MacOS/%'\n\
    \  AND p1_path NOT IN (\n    '/Applications/Alfred 5.app/Contents/Preferences/Alfred\
    \ Preferences.app/Contents/MacOS/Alfred Preferences',\n    '/Applications/Amazon\
    \ Photos.app/Contents/MacOS/Amazon Photos',\n    '/Applications/DDPM/DDPM.app/Contents/MacOS/DDPM',\n\
    \    '/Applications/Docker.app/Contents/MacOS/Docker',\n    '/Applications/Docker.app/Contents/MacOS/install',\n\
    \    '/Applications/Docker.app/Contents/Resources/bin/com.docker.cli',\n    '/Applications/Docker.app/Contents/Resources/bin/docker-credential-desktop',\n\
    \    '/Applications/Hyper.app/Contents/MacOS/Hyper',\n    '/Applications/IntelliJ\
    \ IDEA.app/Contents/MacOS/idea',\n    '/Applications/Parallels Desktop.app/Contents/MacOS/Parallels\
    \ Service',\n    '/Applications/Parallels Desktop.app/Contents/MacOS/prl_update_helper',\n\
    \    '/Applications/RStudio.app/Contents/Resources/app/bin/rsession-arm64',\n\
    \    '/Applications/Visual Studio Code.app/Contents/MacOS/Electron',\n    '/bin/dash',\n\
    \    '/bin/sh',\n    '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS/logioptionsplus_agent',\n\
    \    '/Library/Developer/CommandLineTools/usr/bin/git',\n    '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateDaemon',\n\
    \    '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Library Manager.app/Contents/MacOS/kandji-library-manager',\n\
    \    '/Library/Kandji/Kandji Agent.app/Contents/MacOS/kandji-library-manager',\n\
    \    '/opt/X11/libexec/launchd_startx',\n    '/sbin/launchd',\n    '/System/Library/Frameworks/Security.framework/authtrampoline',\n\
    \    '/usr/bin/alacritty',\n    '/usr/bin/apt-get',\n    '/usr/bin/apt',\n   \
    \ '/usr/bin/bash',\n    '/usr/bin/bwrap',\n    '/usr/bin/crond',\n    '/usr/bin/dash',\n\
    \    '/usr/bin/dirname',\n    '/usr/bin/less',\n    '/usr/bin/login',\n    '/usr/bin/make',\n\
    \    '/usr/bin/man',\n    '/usr/bin/networksetup',\n    '/usr/bin/perl',\n   \
    \ '/usr/bin/su',\n    '/usr/bin/sudo',\n    '/usr/bin/sysdiagnose',\n    '/usr/bin/xargs',\n\
    \    '/usr/bin/zsh',\n    '/usr/lib/xorg/Xorg',\n    '/usr/libexec/gdm-x-session',\n\
    \    '/usr/libexec/gnome-terminal-server',\n    '/usr/libexec/periodic-wrapper',\n\
    \    '/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent',\n    '/usr/sbin/networksetup'\n\
    \  )\n  AND NOT p0.cmdline IN (\n    -- npm run server\n    'sh -c -- exec-bin\
    \ node_modules/.bin/hugo/hugo server',\n    'sh -c /usr/bin/defaults write us.zoom.xos\
    \ NSQuitAlwaysKeepsWindows -bool false',\n    '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',\n\
    \    '/bin/sh -c system_profiler SPDisplaysDataType | grep \"Chipset Model\"',\n\
    \    '/usr/bin/python3 /usr/bin/terminator',\n    'sh -c echo zoomMute:disabled,zoomVideo:disabled,zoomStatus:closed,zoomShare:disabled,zoomRecord:disabled',\n\
    \    '/bin/sh -c sysctl hw.model kern.osrelease',\n    '/bin/sh /etc/security/audit_warn\
    \ soft /var/audit',\n    'sh -c hugo-installer --version otherDependencies.hugo\
    \ --extended --destination node_modules/.bin/hugo',\n    '/bin/bash -c ioreg -l\
    \ -w 0 | grep SecureInput',\n    \"sh -c acpi -b | grep -v 'unavailable'\",\n\
    \    'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path\
    \ 2>/dev/null',\n    -- Brother printer\n    'sh -c ps -xcocommand,pid | grep\
    \ \"LOGINserver\"'\n  )\n  AND NOT (\n    p1.name = 'sshd'\n    AND p0.cmdline\
    \ LIKE '%askpass%'\n  )\n  AND NOT (\n    p1.name = '(udev-worker)'\n    AND p0.cmdline\
    \ LIKE '/bin/sh -c echo % > /sys/bus/usb/drivers/brcmfmac/new_id'\n  )\n  AND\
    \ NOT (\n    p1.name = 'steam'\n    AND p0.cmdline LIKE 'sh -c %steamwebhelper.sh%'\n\
    \  )\n  AND NOT (\n    p1.name = 'bash'\n    AND p0.cmdline LIKE 'sh -s _hostname\
    \ %'\n  )\n  AND NOT (\n    p1.cmdline LIKE 'perl%/help2man%'\n    AND p0.cmdline\
    \ LIKE 'sh -c man/%'\n  )\n  AND NOT p0.cmdline LIKE '/bin/sh %/bin/docker-credential-gcloud\
    \ get'\n  AND NOT p1_path LIKE '/private/var/folders/%/T/go-build%.test'\n  AND\
    \ NOT p1_path LIKE '/Users/%/.vscode/extensions/stateful.runme-%/bin/runme'\n\
    \  AND NOT p1_path LIKE '/private/tmp/PKInstallSandbox.%/tmp/Python/Python3.framework/Versions/%/Resources/Python.app/Contents/MacOS/Python'\n\
    \  AND NOT p0.cmdline LIKE '%/Library/Apple/System/Library/InstallerSandboxes%'\n\
    \  AND NOT p0.cmdline LIKE '%gcloud config config-helper%'\n  AND NOT p0.cmdline\
    \ LIKE '%hugo/hugo server%'\n  AND NOT p1.cmdline LIKE '%/bin/pytest %'\n  AND\
    \ NOT p0.cmdline LIKE '%/bin/codeclimate %'\n  AND NOT p0.cmdline LIKE '%/ChromeRecovery\
    \ --browser-version=%'\n  AND NOT p1.cmdline LIKE '/Applications/Warp.app/%'\n\
    \  AND NOT p1.cmdline IN ('npm run start', 'npm install')\n  AND NOT p1.cmdline\
    \ LIKE '%brew.rb%'\n  AND NOT p1.cmdline LIKE '%/Homebrew/build.rb%'\n  AND NOT\
    \ p1.cmdline LIKE '%Code Helper%'\n  AND NOT p1.cmdline LIKE '%Code - Insiders\
    \ Helper%'\n  AND NOT p1.cmdline LIKE '%gcloud.py config config-helper%'\n  AND\
    \ NOT p1.cmdline LIKE '/usr/lib/electron19/electron /usr/lib/code/out/bootstrap-fork\
    \ --type=ptyHost --logsPath /home/%/.config/Code - OSS/logs/%'\n  AND NOT p1.name\
    \ LIKE '%term%'\n  AND NOT p1.name LIKE '%Term%'\n  AND NOT p1.name LIKE 'Emacs%'\n\
    \  AND NOT p1.name LIKE 'terraform-prov%'\n  AND NOT p1.path LIKE '/Users/%/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS/GoogleSoftwareUpdateAgent'\n\
    \  -- Oh, NixOS.\n  AND NOT p1.name LIKE '%/bin/bash'\n  AND NOT p1.name LIKE\
    \ '%/bin/direnv'\n  AND NOT p1_path LIKE '/nix/store/%sh'\n  AND NOT p1_path LIKE\
    \ '/opt/homebrew/%'\n  AND NOT p0.cgroup_path LIKE '/system.slice/docker-%'\n\
    \  AND NOT p0.cgroup_path LIKE '/system.slice/system.slice:docker:%'\n"
  interval: 60
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
