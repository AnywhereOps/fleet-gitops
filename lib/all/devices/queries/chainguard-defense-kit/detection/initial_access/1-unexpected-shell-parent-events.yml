- name: CDK - Unexpected Shell Parent Events
  description: Unexpected process that spawns shell processes (event-based)
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.time\
    \ AS p0_time,\n  pe.pid AS p0_pid,\n  pe.euid AS p0_euid,\n  p.cgroup_path AS\
    \ p0_cgroup,\n  -- Parent\n  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n\
    \  TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path)\
    \ AS p1_path,\n  COALESCE(p1.euid, pe1.euid) AS p1_euid,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup,\n  TRIM(\n  \
    \  COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n\
    \  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  -- Exception key\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path),\
    \ '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe\n  LEFT JOIN processes p ON pe.pid = p.pid\n  -- Parents (via two paths)\n\
    \  LEFT JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND\
    \ pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n \
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  pe.time\
    \ > (strftime('%s', 'now') -300)\n  AND pe.cmdline != ''\n  AND pe.parent > 0\n\
    \  AND p0_name IN ('sh', 'fish', 'zsh', 'bash', 'dash')\n  AND NOT (\n    p1_name\
    \ IN (\n      'abrt-handle-eve',\n      'alacritty',\n      'at-spi-bus-launcher',\n\
    \      'BambuStudio',\n      'bash',\n      'build-script-build',\n      'chainctl',\n\
    \      'chezmoi',\n      'clang-11',\n      'Code - Insiders Helper (Renderer)',\n\
    \      'Code Helper (Renderer)',\n      'code',\n      'collect2',\n      'com.docker.backend',\n\
    \      'conmon',\n      'containerd-shim-runc-v2',\n      'containerd-shim',\n\
    \      'cpptools',\n      'dash',\n      'dbus-run-session',\n      'demoit',\n\
    \      'direnv',\n      'doas',\n      'Docker Desktop',\n      'docker-credential-desktop',\n\
    \      'docker-credential-gcr',\n      'docker',\n      'dotnet',\n      'dpkg',\n\
    \      'Emacs-arm64-11',\n      'env',\n      'erl_child_setup',\n      'find',\n\
    \      'FinderSyncExtension',\n      'fish',\n      'gatherheaderdoc',\n     \
    \ 'gdm-session-worker',\n      'gdm-wayland-session',\n      'gdm-x-session',\n\
    \      'gdm3',\n      'git',\n      'gke-gcloud-auth-plugin',\n      'gnome-session-binary',\n\
    \      'gnome-shell',\n      'gnome-terminal-server',\n      'go',\n      'goland',\n\
    \      'gopls',\n      'helm',\n      'HP Diagnose & Fix',\n      'i3bar',\n \
    \     'i3blocks',\n      'idea',\n      'java',\n      'jetbrains-toolbox',\n\
    \      'kitty',\n      'ko',\n      'konsole',\n      'kubectl',\n      'lazygit',\n\
    \      'lightdm',\n      'local-path-provisioner',\n      'login',\n      'MacVim',\n\
    \      'make',\n      'mc',\n      'monorail',\n      'my_print_defaults',\n \
    \     'ninja',\n      'nix-build',\n      'nix-daemon',\n      'nix',\n      'nm-dispatcher',\n\
    \      'node',\n      'nu',\n      'nvim',\n      'obs',\n      'package_script_service',\n\
    \      'pacman',\n      'perl',\n      'PK-Backend',\n      'provisio',\n    \
    \  'pulumi',\n      -- 'python' - do not include this, or you won't detect supply-chain\
    \ attacks.\n      'ression-arm64',\n      'roxterm',\n      'sddm-helper',\n \
    \     'sdk',\n      'sdzoomplugin',\n      'sh',\n      'ShellLauncher',\n   \
    \   'skhd',\n      'snyk-macos',\n      'snyk',\n      'sshd',\n      'stable',\n\
    \      'Stream Deck',\n      'su',\n      'sudo',\n      'swift',\n      'systemd-sleep',\n\
    \      'systemd',\n      'terminator',\n      'terraform-ls',\n      'terraform',\n\
    \      'test2json',\n      'tmux:server',\n      'tmux',\n      'update-notifier',\n\
    \      'vi',\n      'vim.nox',\n      'vim',\n      'Vim',\n      'watch',\n \
    \     'wezterm-gui',\n      'xargs',\n      'xcrun',\n      'xfce4-terminal',\n\
    \      'xinit',\n      'Xorg',\n      'xterm',\n      'yacls',\n      'yay',\n\
    \      'yum',\n      'zed',\n      'zellij',\n      'zsh'\n    )\n    OR p1_name\
    \ LIKE 'terraform-provider-%'\n    OR p1_name LIKE 'iTermServer-%'\n    -- Do\
    \ not add shells to this list if you want your query to detect\n    -- bad programs\
    \ that were started from a shell.\n    OR p2_name IN ('env', 'git')\n    -- Homebrew,\
    \ except we don't want to allow all of ruby\n    OR p0_cmd IN (\n      '/bin/bash\
    \ /usr/bin/xdg-settings set default-url-scheme-handler slack Slack.desktop',\n\
    \      '/bin/bash /usr/local/bin/mount-product-files',\n      '/bin/sh -c black\
    \ .',\n      '/bin/sh -c ioreg -rd1 -c IOPlatformExpertDevice',\n      '/bin/sh\
    \ -c lsb_release -a --short',\n      '/bin/sh -c ps ax -ww -o pid,ppid,uid,gid,args',\n\
    \      '/bin/sh -c scutil --get ComputerName',\n      '/bin/sh -c sysctl hw.model\
    \ kern.osrelease',\n      '/bin/sh -c uname -m 2>/dev/null',\n      '/bin/sh /usr/bin/lsb_release\
    \ -a --short',\n      '/bin/sh /usr/bin/lsb_release -a',\n      '/bin/zsh -c ls',\n\
    \      '/usr/bin/python3 /usr/bin/terminator',\n      'sh -c /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild\
    \ -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk\
    \ -find python3 2> /dev/null',\n      'sh -c /bin/stty size 2>/dev/null',\n  \
    \    'sh -c /usr/bin/xcrun clang 2>&1',\n      'sh -c cat /proc/sys/kernel/pid_max',\n\
    \      'sh -c pactl --version',\n      'sh -c python3.7 --version 2>&1',\n   \
    \   'sh -c xcode-select --print-path >/dev/null 2>&1 && xcrun --sdk macosx --show-sdk-path\
    \ 2>/dev/null',\n      \"/bin/sh -c defaults delete 'com.cisco.webexmeetingsapp'\"\
    ,\n      \"sh -c osascript -e 'user locale of (get system info)'\",\n      \"\
    sh -c pacmd list-sinks |grep 'name:\\|module:'\"\n    )\n    OR (\n      p1_name\
    \ = 'WhatsApp'\n      -- WhatsApp grabs the serial number from people's machines\
    \ :(\n      AND p0_cmd = '/bin/sh -c ioreg -c IOPlatformExpertDevice -d 2'\n \
    \   )\n    OR (\n      p1_name LIKE 'emacs-%'\n      AND p1_path LIKE '%/bin/emacs%'\n\
    \    )\n    OR p1_cmd IN (\n      '/usr/bin/python3 /usr/share/apport/apport-gtk',\n\
    \      'php ./autodocs update images'\n    )\n    OR (\n      p1_cmd LIKE '%Python%\
    \ /opt/homebrew/bin/jupyter%'\n      AND p0_cmd = '/bin/sh -c osascript'\n   \
    \ )\n    OR (\n      p1_name = 'osqueryd'\n      AND p0_cmd LIKE '/bin/sh /etc/NetworkManager/dispatcher.d/%'\n\
    \    )\n    OR (\n      p1_name = 'ssh'\n      AND p0_cmd LIKE '%gcloud.py compute\
    \ start-iap-tunnel%'\n    )\n    OR exception_key IN (\n      'bash,0,auditd,launchd',\n\
    \      'bash,0,etcd,containerd-shim-runc-v2',\n      'bash,0,kube-apiserver,containerd-shim-runc-v2',\n\
    \      'bash,0,mutter-x11-frames,gnome-shell',\n      'bash,0,perl5.30,system_installd',\n\
    \      'bash,0,pia-daemon,launchd',\n      'bash,0,udevadm,udevadm',\n      'bash,500,.man-wrapped,zsh',\n\
    \      'bash,500,accounts-daemon,systemd',\n      'bash,500,busybox,bwrap',\n\
    \      'bash,500,bwrap,bwrap',\n      'bash,500,com.docker.dev-envs,com.docker.backend',\n\
    \      'bash,500,docker-builder,bash',\n      'bash,500,Foxit PDF Reader,launchd',\n\
    \      'bash,500,gdb,perl',\n      'bash,500,gnome-session-binary,systemd',\n\
    \      'bash,500,gpg-agent,launchd',\n      'bash,500,Hyprland,gdm-wayland-session',\n\
    \      'bash,500,incusd,incusd',\n      'bash,500,lazygit,nvim',\n      'bash,500,plasmashell,systemd',\n\
    \      'bash,500,Private Internet Access,launchd',\n      'bash,500,ruby,zsh',\n\
    \      'bash,500,screen,screen',\n      'bash,500,script,bash',\n      'bash,500,steam,bash',\n\
    \      'bash,500,xdg-desktop-portal,systemd',\n      'bash,500,xdg-permission-store,systemd',\n\
    \      'dash,0,anacron,systemd',\n      'dash,0,dpkg,apt',\n      'dash,0,dpkg,python3.10',\n\
    \      'dash,0,kindnetd,containerd-shim-runc-v2',\n      'dash,0,kube-proxy,containerd-shim-runc-v2',\n\
    \      'dash,0,run-parts,dash',\n      'dash,0,snapd,systemd',\n      'dash,500,gdm-wayland-session,gdm-session-worker',\n\
    \      'dash,500,python3.12,firefox-bin',\n      'sh,0,auditd,launchd',\n    \
    \  'sh,0,Ecamm Live,launchd',\n      'sh,0,expect,kandji-daemon',\n      'sh,500,cloud_sql_proxy,zsh',\n\
    \      'sh,500,docs,zsh',\n      'sh,500,Google Drive,launchd',\n      'sh,500,LogiTune,launchd',\n\
    \      'sh,500,Meeting Center,launchd',\n      'sh,500,snyk-macos,snyk',\n   \
    \   'sh,500,splunkd,splunkd',\n      'sh,500,ssh,Code Helper (Plugin)',\n    \
    \  'sh,500,ssh,mosh-client',\n      'sh,500,updater,Foxit PDF Reader',\n     \
    \ 'sh,500,viddy,zsh',\n      'sh,500,yabai,launchd',\n      'zsh,500,Hyper,launchd',\n\
    \      'zsh,500,old,launchd',\n      'zsh,500,old,old',\n      'zsh,500,OpenLens,launchd',\n\
    \      'zsh,500,pycharm,launchd',\n      'zsh,500,python3.10,gnome-shell',\n \
    \     'zsh,500,rubymine,launchd',\n      'zsh,500,stable,launchd'\n    )\n   \
    \ OR p0_cmd LIKE '/bin/bash /Users/%/homebrew/Library/Homebrew/shims/shared/curl\
    \ %'\n    OR p0_cmd LIKE '/bin/bash /usr/bin/xdg-settings check %'\n    OR p0_cmd\
    \ LIKE '/bin/bash /usr/local/Homebrew/%'\n    OR p0_cmd LIKE '/bin/bash %/opt/homebrew/%'\n\
    \    OR p0_cmd LIKE '/bin/bash %git credential-osxkeychain get'\n    OR p0_cmd\
    \ LIKE '/bin/sh -c /Applications/%'\n    OR p0_cmd LIKE '/bin/sh -c pkg-config\
    \ %'\n    OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-open %'\n    OR p0_cmd LIKE '/bin/sh\
    \ /usr/bin/xdg-settings check %'\n    OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings\
    \ get %'\n    OR p0_cmd LIKE '/bin/sh /usr/bin/xdg-settings set %'\n    OR p0_cmd\
    \ LIKE '/bin/sh %/bin/gcloud%config config-helper%'\n    OR p0_cmd LIKE '/bin/sh\
    \ %/bin/xvim block %'\n    OR p0_cmd LIKE '/bin/sh %/docker-credential-gcloud\
    \ get'\n    OR p0_cmd LIKE '/bin/sh %/google-cloud-sdk/bin/gcloud config get project'\n\
    \    OR p0_cmd LIKE '%/bash -e%/bin/as -arch%'\n    OR p0_cmd LIKE '%/google-chrome%\
    \ --flag-switches-begin % --product-version'\n    OR p0_cmd LIKE '%/usr/bin/python3\
    \ /usr/bin/terminator%'\n    OR p0_cmd LIKE '%gcloud config config-helper --format=json'\n\
    \    OR p0_cmd LIKE '%gcloud config get-value%'\n    OR p0_cmd LIKE '%sh -c ntia-checker\
    \ %'\n    OR p1_cmd LIKE '/%google-cloud-sdk/lib/gcloud.py%'\n    OR p1_cmd LIKE\
    \ '/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby -W1 --disable=gems,rubyopt\
    \ -- /Users/%/homebrew/Library/Homebrew/build.rb%'\n    OR p1_cmd LIKE '%/bin/pipenv\
    \ shell'\n    OR p1_cmd LIKE '%/usr/bin/terminator%'\n    OR p1_cmd LIKE 'gcloud%\
    \ auth%login%'\n    OR (\n      exception_key IN ('sh,500,ruby,zsh', 'bash,500,ruby,zsh')\n\
    \      AND p1_cmd LIKE '%brew.rb'\n    )\n    OR (\n      exception_key = 'sh,500,ruby,ruby'\n\
    \      AND p1_cmd LIKE '%homebrew%'\n    )\n    OR p1_cmd LIKE '%Python /opt/homebrew/bin/aws\
    \ configure sso'\n    OR p2_cmd LIKE '/bin/bash /usr/local/bin/brew%'\n    OR\
    \ p2_cmd LIKE '/usr/bin/python3 -m py_compile %'\n  )\n  AND NOT p0_cgroup LIKE\
    \ '/system.slice/docker-%'\n  AND NOT p1_cgroup LIKE '/system.slice/docker-%'\n\
    \  AND NOT p2_cgroup LIKE '/system.slice/docker-%'\nGROUP BY\n  pe.pid\n"
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
