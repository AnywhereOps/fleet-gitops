---
apiVersion: v1
kind: query
spec:
  name: Get local user accounts
  platform: darwin, linux, windows
  description: Local user accounts (including domain accounts that have logged on locally (Windows)).
  query: SELECT uid, gid, username, description, directory, shell FROM users;
  powershell: "$groupMapping = @{}\n$localGroups = Get-LocalGroup -ErrorAction SilentlyContinue\nforeach ($group in $localGroups) {\n    $members = Get-LocalGroupMember -Group $group.Name -ErrorAction SilentlyContinue\n\
    \    foreach ($member in $members) {\n        if ($member.ObjectClass -eq 'User') {\n            if (-not $groupMapping.ContainsKey($member.SID.Value)) {\n                $groupMapping[$member.SID.Value]\
    \ = @()\n            }\n            $groupMapping[$member.SID.Value] += $group.Name\n        }\n    }\n}\n\n$users = Get-LocalUser -ErrorAction SilentlyContinue\n$results = foreach ($user in $users)\
    \ {\n    $userGroups = $groupMapping[$user.SID.Value]\n    [PSCustomObject]@{\n        uid       = $user.SID.Value\n        username  = $user.Name\n        type      = 'Local'\n        groupname = if\
    \ ($userGroups) { $userGroups -join ',' } else { 'N/A' }\n    }\n}\n$results | Format-Table -AutoSize"
  bash: echo "uid,username,type,groupname"; for u in $(dscl . list /Users); do uid=$(dscl . read /Users/"$u" UniqueID 2>/dev/null | awk '{print $2}'); pgrp=$(dscl . read /Users/"$u" PrimaryGroupID 2>/dev/null
    | awk '{print $2}'); grp=$(dscl . list /Groups PrimaryGroupID | awk -v id="$pgrp" '$2==id{print $1}'); type=$( [ "$uid" -lt 500 ] && echo system || echo local); echo "$uid,$u,$type,$grp"; done
  purpose: informational
  tags: hunting, inventory
  contributors: anelshaer
  team: both
