- name: CDK - Unexpected Rsa Keys
  description: Indicative of stored RSA keys just sitting around unencrypted
  query: "SELECT\n  file.path,\n  file.type,\n  file.size,\n  file.mtime,\n  file.uid,\n\
    \  file.ctime,\n  file.gid,\n  hash.sha256,\n  magic.data\nFROM\n  file\n  LEFT\
    \ JOIN hash ON file.path = hash.path\n  LEFT JOIN users u ON file.uid = u.uid\n\
    \  LEFT JOIN magic ON file.path = magic.path\nWHERE\n  (\n    file.directory LIKE\
    \ '/Users/%/Downloads/%'\n    OR file.directory LIKE '/home/%/%'\n    OR file.directory\
    \ LIKE '/home/%/'\n    OR file.directory LIKE '/home/%/.%'\n    OR file.directory\
    \ LIKE '/home/%/Downloads/%'\n    OR file.directory LIKE '/tmp/%'\n    OR file.directory\
    \ LIKE '/tmp/'\n    OR file.directory LIKE '/Users/%/%'\n    OR file.directory\
    \ LIKE '/Users/%/'\n    OR file.directory LIKE '/Users/%/.%'\n    OR file.directory\
    \ LIKE '/var/tmp/%'\n    OR file.directory LIKE '/var/tmp/'\n  )\n  AND file.directory\
    \ NOT LIKE \"%/../%\"\n  AND file.directory NOT LIKE \"%/./%\"\n  AND filename\
    \ LIKE \"%.rsa\"\n  AND size BETWEEN 128 AND 8192\n  -- Don't alert on tokens\
    \ that begin with the username-, as they may be personal\n  AND NOT INSTR(filename,\
    \ CONCAT (u.username, \"-\")) == 1\n  -- Don't alert on tokens that begin with\
    \ the users full name and a dash\n  AND NOT INSTR(\n    filename,\n    REPLACE(LOWER(TRIM(description)),\
    \ \" \", \"-\")\n  ) == 1\n  -- Common filenames that are non-controversial\n\
    \  AND NOT INSTR(file.filename, 'melange.rsa') > 0\n  AND NOT INSTR(file.filename,\
    \ 'local-melange-enterprise.rsa') > 0\n  -- Demo keys\n  AND NOT sha256 IN (\n\
    \    'a68b29401730a9c5f3e06099f6703a43797ee5c6ad6c741961c6eb8ab39786de'\n  )\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
