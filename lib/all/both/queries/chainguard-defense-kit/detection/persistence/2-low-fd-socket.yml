- name: CDK - Low Fd Socket
  description: Find programs where fd0 (stdin), fd1 (stdout), or fd2 (stderr) are
    connected to a socket
  query: "SELECT\n  pos.protocol,\n  pos.pid,\n  pos.remote_address,\n  pos.local_address,\n\
    \  pos.local_port,\n  pos.remote_port,\n  pos.state,\n  -- Child\n  p0.pid AS\
    \ p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.start_time AS p0_start,\n\
    \  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.start_time AS\
    \ p1_start,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  process_open_sockets pos\n  JOIN processes\
    \ p0 ON pos.pid = p0.pid\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n\
    \  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  pos.fd < 3\n  AND pos.family\
    \ != 1\n  AND p0.path NOT IN (\n    '/Applications/NetSpot.app/Contents/MacOS/NetSpot',\n\
    \    '/Applications/WiFiman Desktop.app/Contents/Resources/wifiman-desktopd',\n\
    \    '/Library/Application Support/Viscosity/viscosity_openvpn',\n    '/usr/bin/skopeo',\n\
    \    '/usr/libexec/bootpd',\n    '/usr/libexec/pcp/bin/pmcd',\n    '/usr/local/bin/velociraptor'\n\
    \  )\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
