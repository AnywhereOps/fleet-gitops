- name: CDK - Hidden Executable
  description: Programs running with a hidden file path or process name
  query: "SELECT\n  f.directory,\n  f.btime,\n  p0.start_time,\n  RTRIM(\n    COALESCE(\n\
    \      REGEX_MATCH (\n        REPLACE(f.directory, u.directory, '~'),\n      \
    \  '([/~].*?/.*?)/',\n        1\n      ),\n      f.directory\n    ),\n    \"/\"\
    \n  ) AS top2_dir,\n  COALESCE(\n    REGEX_MATCH (\n      REPLACE(f.directory,\
    \ u.directory, '~'),\n      '([/~].*?/.*?/.*?)/',\n      1\n    ),\n    REPLACE(f.directory,\
    \ u.directory, '~')\n  ) AS top3_dir,\n  REPLACE(f.directory, u.directory, '~')\
    \ AS homedir,\n  REPLACE(f.path, u.directory, '~') AS homepath,\n  -- Child\n\
    \  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS p0_cgroup,\n  p0.euid AS\
    \ p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path\
    \ = f.path\n  LEFT JOIN users u ON f.uid = u.uid\n  LEFT JOIN hash p0_hash ON\
    \ p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT\
    \ JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent\
    \ = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  (\n \
    \   p0.name LIKE '.%'\n    OR f.filename LIKE '.%'\n    OR f.directory LIKE '%/.%'\n\
    \  )\n  AND NOT homedir LIKE '%/node_modules/.%'\n  -- exclude top-level hidden\
    \ home directories (there are many)\n  AND NOT (\n    homedir LIKE '~/.%'\n  \
    \  AND NOT homedir LIKE '~/.config/%'\n    AND NOT homedir LIKE '~/.cache/%'\n\
    \  )\n  AND NOT homedir LIKE '~/%/node_modules/.bin%'\n  AND NOT homepath LIKE\
    \ '~/%arm64%'\n  AND NOT homepath LIKE '~/%x86_64%'\n  AND NOT top2_dir IN (\n\
    \    '/nix/store/.links',\n    '/var~/.local',\n    '~/.goenv',\n    '~/.vs-kubernetes',\n\
    \    '~/chainguard-images',\n    '~/code',\n    '~/Code',\n    '~/Projects',\n\
    \    '~/projects',\n    '~/git',\n    '~/repos',\n    '~/src'\n  )\n  AND NOT\
    \ top3_dir IN (\n    '/home/linuxbrew/.linuxbrew',\n    '/var~/.local/share',\n\
    \    '~/.cache/gitstatus',\n    '~/.cache/cloud-code',\n    '~/.cache/go-build',\n\
    \    '~/.cache/JetBrains',\n    '~/.cache/rod',\n    '~/.cache/selenium',\n  \
    \  '~/.config/bluejeans-v2',\n    '~/.config/Code',\n    '~/.config/nvm',\n  \
    \  '~/Documents/GitHub',\n    '~/node_modules/.bin',\n    '~/thinkorswim/.install4j'\n\
    \  )\n  AND NOT f.directory = '/nix/store/.links'\n  AND NOT f.directory LIKE\
    \ '%/.terraform/%'\n  AND NOT f.directory LIKE '%/.zig-cache/%'\n  AND NOT f.directory\
    \ LIKE '%/anchore/grype/.tool%'\n  AND NOT f.directory LIKE '%/Applications/PSI\
    \ Bridge Secure Browser.app/Contents/Resources/.apps/darwin/%'\n  AND NOT f.directory\
    \ LIKE '%/com.jetbrains.GoLand/cache/JetBrains/GoLand%'\n  AND NOT f.directory\
    \ LIKE '/Applications/Corsair iCUE5 Software/.cuepkg-%'\n  AND NOT f.directory\
    \ LIKE '/var/home/linuxbrew/.linuxbrew/Cellar/%'\n  AND NOT f.directory LIKE '/var/home/linuxbrew/.linuxbrew/Homebrew/%'\n\
    \  AND NOT f.directory LIKE '/Volumes/com.getdropbox.dropbox-%'\n  AND NOT f.path\
    \ LIKE '/nix/store/%/%-wrapped'\n  AND NOT homepath LIKE '~/.ape-1%'\n  AND NOT\
    \ (\n    f.path LIKE '/nix/store/%'\n    AND p0.name LIKE '%-wrappe%'\n  )\n \
    \ AND NOT homedir LIKE '%/.Trash/1Password %.app/Contents/Library/LoginItems/1Password\
    \ Extension Helper.app/Contents/MacOS'\n  AND NOT homedir LIKE '%/.Trash/Logi\
    \ Options.app/Contents/Support/LogiMgrDaemon.app/Contents/MacOS'\n  AND NOT homedir\
    \ LIKE '/Users/%/.Trash/lghub.app/Contents/MacOS/lghub_agent.app/Contents/MacOS'\n\
    \  AND NOT homedir LIKE '~/%/.venv/bin'\n  AND NOT homedir LIKE '~/.local/share/AppImage/ZenBrowser.AppImage'\n\
    \  AND NOT homedir LIKE '~/.Trash/1Password %.app/Contents/Library/LoginItems/1Password\
    \ Extension Helper.app/Contents/MacOS'\n  AND NOT homedir LIKE '~/Library/Application\
    \ Support/Code/User/globalStorage/ms-dotnettools.vscode-dotnet-runtime/.dotnet/%'\n\
    \  AND NOT p0_cgroup LIKE '/system.slice/docker-%'\nGROUP BY\n  f.path\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
