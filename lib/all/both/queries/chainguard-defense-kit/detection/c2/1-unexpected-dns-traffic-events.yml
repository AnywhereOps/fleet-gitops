- name: CDK - Unexpected Dns Traffic Events
  description: 'Catch DNS traffic going to machines other than the host-configured
    DNS server (event-based) NOTE: The interval above must match WHERE clause to avoid
    missing events This only supports IPv4 traffic due to an osquery bug with ''dns_resolvers''
    The non-event version is unexpected-dns-traffic.sql'
  query: "SELECT\n  protocol,\n  s.remote_port,\n  s.remote_address,\n  s.local_port,\n\
    \  s.local_address,\n  s.action,\n  s.status,\n  p.name,\n  COALESCE(REGEX_MATCH\
    \ (p.path, '.*/(.*)', 1), p.path) AS basename,\n  p.path,\n  p.cmdline AS child_cmd,\n\
    \  p.cwd,\n  s.pid,\n  p.parent AS parent_pid,\n  pp.cmdline AS parent_cmd,\n\
    \  hash.sha256\nFROM\n  socket_events s\n  LEFT JOIN processes p ON s.pid = p.pid\n\
    \  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT JOIN hash ON p.path = hash.path\n\
    WHERE\n  s.time > (strftime('%s', 'now') -300)\n  AND remote_port IN (53, 5353)\n\
    \  AND remote_address NOT LIKE '%:%'\n  AND s.remote_address NOT LIKE '172.1%'\n\
    \  AND s.remote_address NOT LIKE '172.2%'\n  AND s.remote_address NOT LIKE '172.30.%'\n\
    \  AND s.remote_address NOT LIKE '172.31.%'\n  AND s.remote_address NOT LIKE '10.%'\n\
    \  AND s.remote_address NOT LIKE '192.168.%'\n  AND s.remote_address NOT LIKE\
    \ '127.%'\n  AND remote_address NOT IN (\n    SELECT DISTINCT\n      address\n\
    \    FROM\n      dns_resolvers\n    WHERE\n      type = 'nameserver'\n      and\
    \ address != ''\n  )\n  -- systemd-resolve sometimes shows up this way\n  -- If\
    \ we could narrow this down using 'sys_resolvers' I would, but it is misuse of\
    \ GROUP_CONCAT\n  AND NOT (\n    s.pid = -1\n    AND s.remote_port = 53\n    and\
    \ p.parent = ''\n  )\n  -- Some applications hard-code a safe DNS resolver, or\
    \ allow the user to configure one\n  AND s.remote_address NOT IN (\n    '0.0.0.0',\n\
    \    '100.100.100.100', -- Tailscale Magic DNS\n    '1.0.0.1', -- Cloudflare\n\
    \    '1.1.1.1', -- Cloudflare\n    '1.1.1.2', -- Cloudflare\n    '185.125.190.31',\
    \ -- Canonical\n    '185.125.190.77', -- Canonical\n    '208.67.220.123', -- OpenDNS\
    \ FamilyShield\n    '208.67.222.222', -- OpenDNS\n    '34.160.111.32', -- wolfi.dev\n\
    \    '68.105.28.13', -- Cox\n    '75.75.75.75', -- Comcast\n    '75.75.76.76',\
    \ -- Comcast\n    '80.248.7.1', -- 21st Century (NG)\n    '3.125.36.175' -- Vercel\n\
    \  )\n  AND s.remote_address NOT LIKE '185.199.%' -- GitHub\n  -- Local DNS servers\
    \ and custom clients go here\n  AND basename NOT IN (\n    'adguard_dns',\n  \
    \  'agentbeat',\n    'apk',\n    'aws',\n    'apko',\n    'AssetCacheLocatorService',\n\
    \    'Beeper Desktop',\n    'brave',\n    'buildkitd',\n    'canonical-livep',\n\
    \    'CapCut',\n    'cg',\n    'chainctl',\n    'ChatGPT',\n    'chrome',\n  \
    \  'chromium',\n    'cloudcode_cli',\n    'cosign',\n    'crane',\n    'git-lfs',\n\
    \    'gitsign-credential-cache',\n    'Code Helper (Plugin)',\n    'com.apple.WebKit.Networking',\n\
    \    'com.docker.backend',\n    'com.docker.buil',\n    'com.docker.build',\n\
    \    'com.docker.vpnkit',\n    'com.nordvpn.macos.helper',\n    'containerd',\n\
    \    'crc',\n    'coredns',\n    'Creative Cloud Content Manager.node',\n    'distnoted',\n\
    \    'docker-language-server-linux-amd64',\n    'docker',\n    'docker-buildx',\n\
    \    'dockerd',\n    'drkonqi-coredump-processor',\n    'eksctl',\n    'firefox-bin',\n\
    \    'EpicWebHelper',\n    'gcsfuse',\n    'go',\n    'grype',\n    'gvproxy',\n\
    \    'helm',\n    'incusd',\n    'io.tailscale.ipn.macsys.network-extension',\n\
    \    'IPNExtension',\n    'Jabra Direct Helper',\n    'java',\n    'launcher',\n\
    \    'limactl',\n    'librewolf',\n    'mDNSResponder',\n    'Meeting Center',\n\
    \    'melange',\n    'msedge',\n    'nessusd',\n    'node',\n    'nuclei',\n \
    \   'ollama',\n    'Pieces OS',\n    'plugin-container',\n    'ServiceExtension',\n\
    \    'Signal Helper (Renderer)',\n    'signal-desktop',\n    'slack',\n    'snapd',\n\
    \    'Socket Process',\n    'syncthing',\n    'systemd-resolved',\n    'tailscaled',\n\
    \    'Telegram',\n    'terraform',\n    'terraform-ls',\n    'terraform-provi',\n\
    \    'vunnel',\n    'WebexHelper',\n    'WhatsApp',\n    'wolfictl',\n    'yum',\n\
    \    'ZaloCall',\n    'zed',\n    'ZoomPhone'\n  )\n  -- Chromium/Electron apps\
    \ seem to send stray packets out like nobodies business\n  AND basename NOT LIKE\
    \ '% Helper'\n  AND basename NOT LIKE 'terraform-provider-%'\n  AND p.name !=\
    \ 'terraform-provi'\n  AND p.path NOT LIKE '/snap/%'\n  AND pp.path NOT IN ('/usr/bin/containerd-shim-runc-v2')\n\
    \  -- Workaround for the GROUP_CONCAT subselect adding a blank ent\nGROUP BY\n\
    \  s.remote_address,\n  s.remote_port\nHAVING\n  remote_address != ''\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
