- name: CDK - Unexpected Bpf User
  description: 'Find root-run processes which link against libpf WARNING: This check
    consumes an unusual amount of system memory (up to 225MB)'
  query: "SELECT\n  pmm.pid,\n  pmm.path AS lib_path,\n  p.path,\n  p.name,\n  p.cmdline,\n\
    \  p.cwd,\n  p.euid,\n  p.parent,\n  pp.path AS parent_path,\n  pp.name AS parent_name,\n\
    \  pp.cmdline AS parent_cmdline,\n  pp.cwd AS parent_cwd,\n  pp.euid AS parent_euid,\n\
    \  hash.sha256 AS child_sha256,\n  phash.sha256 AS parent_sha256\n  -- Using processes\
    \ is much faster than process_memory_map\nFROM\n  processes p\n  LEFT JOIN process_memory_map\
    \ pmm ON p.pid = pmm.pid\n  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT\
    \ JOIN hash ON p.path = hash.path\n  LEFT JOIN hash AS phash ON pp.path = phash.path\n\
    WHERE\n  p.euid = 0\n  AND (\n    lib_path LIKE '%:bpf%'\n    OR lib_path LIKE\
    \ '%libbpf%'\n  )\n  AND p.path NOT IN (\n    '/opt/Elastic/Endpoint/elastic-endpoint',\n\
    \    '/usr/bin/qemu-system-x86_64',\n    '/usr/lib/systemd/systemd-nsresourced',\n\
    \    '/usr/lib/systemd/systemd',\n    '/var/opt/Elastic/Endpoint/elastic-endpoint'\n\
    \  )\n  AND p.cmdline != '/usr/bin/python3 /usr/sbin/execsnoop-bpfcc'\n  AND p.path\
    \ NOT LIKE '/nix/store/%/lib/systemd/systemd'\n  AND p.name != \"xcover\"\nGROUP\
    \ BY\n  pmm.pid\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
