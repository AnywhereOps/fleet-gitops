- name: CDK - Setxid Env Overflow Attempt
  description: 'Find setuid process events with large environment sizes ******************************************************************
    NOTE: This is a rare case of a non-working query. It does not work in my environment
    (osquery 5.5.1 running with Kolide) as process_events.env_size is NULL. I believe
    this to be a bug, but requires more investigation. ******************************************************************
    Uncomment once the underlying problem is addressed:'
  query: "SELECT\n  file.mode AS p0_binary_mode,\n  pe.env AS p0_env,\n  pe.time AS\
    \ p0_time,\n  pe.env_size AS p0_env_size,\n  -- Child\n  pe.path AS p0_path,\n\
    \  REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n\
    \  pe.euid AS p0_euid,\n  pe.cwd AS p0_cwd,\n  pe.pid AS p0_pid,\n  p.cgroup_path\
    \ AS p0_cgroup,\n  -- Parent\n  pe.parent AS p1_pid,\n  p1.cgroup_path AS p1_cgroup,\n\
    \  TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd,\n  COALESCE(p1.path, pe1.path)\
    \ AS p1_path,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH\
    \ (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  -- Grandparent\n\
    \  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n  COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path)\
    \ AS p2_cgroup,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n\
    \  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n\
    \  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name\nFROM\n  process_events pe\n  LEFT JOIN\
    \ file ON pe.path = file.path\n  LEFT JOIN processes p ON pe.pid = p.pid\n  --\
    \ Parents (via two paths)\n  LEFT JOIN processes p1 ON pe.parent = p1.pid\n  LEFT\
    \ JOIN hash p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events pe1\
    \ ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON\
    \ pe1.path = pe_hash1.path\n  -- Grandparents (via 3 paths)\n  LEFT JOIN processes\
    \ p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent processes\n\
    \  LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent\
    \ via parent events\n  LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n\
    \  AND pe1_pe2.cmdline != '' -- Past grandparent via parent events\n  LEFT JOIN\
    \ hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash\
    \ ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path\
    \ = pe1_pe2_hash.path\nWHERE\n  pe.time > (strftime('%s', 'now') -60)\n  AND file.mode\
    \ NOT LIKE '0%'\n  AND pe.env_size > 3500\n"
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
