- name: CDK - Yara Recently Downloaded Packed
  description: Flag packed binaries that have recently been downloaded
  query: "SELECT\n  file.path,\n  file.size,\n  file.btime,\n  file.ctime,\n  file.mtime,\n\
    \  magic.data,\n  hash.sha256,\n  yara.*\nFROM\n  file\n  JOIN yara ON file.path\
    \ = yara.path\n  LEFT JOIN magic ON file.path = magic.path\n  LEFT JOIN hash ON\
    \ file.path = hash.path\nWHERE\n  file.path IN (\n    SELECT\n      path\n   \
    \ FROM\n      file\n    WHERE\n      (\n        file.path LIKE '/home/%/Downloads/%'\n\
    \        OR file.path LIKE '/home/%/Downloads/%/%'\n        OR file.path LIKE\
    \ '/Users/%/Downloads/%'\n        OR file.path LIKE '/Users/%/Downloads/%/%'\n\
    \        OR file.path LIKE '/tmp/%'\n        OR file.path LIKE '/var/tmp/%'\n\
    \      )\n      AND file.type = \"regular\"\n      AND file.size > 2000\n    \
    \  AND file.size < 400000\n      AND (\n        file.btime > (strftime('%s', 'now')\
    \ -43200)\n        OR file.ctime > (strftime('%s', 'now') -43200)\n        OR\
    \ file.mtime > (strftime('%s', 'now') -43200)\n      )\n  )\n  AND yara.sigrule\
    \ = '\nrule cxFreeze_Python_executable : high {\n  meta:\n    hash_2023_MacStealer_weed\
    \ = \"6a4f8b65a568a779801b72bce215036bea298e2c08ec54906bb3ebbe5c16c712\"\n  strings:\n\
    \    $cxfreeze = \"cx_Freeze\"\n  condition:\n    filesize < 10485760 and $cxfreeze\n\
    }\nimport \"math\"\n\nrule obfuscated_elf : high {\n  meta:\n    description =\
    \ \"Obfuscated ELF binary (missing content)\"\n    hash_2023_APT31_1d60 = \"1d60edb577641ce47dc2a8299f8b7f878e37120b192655aaf80d1cde5ee482d2\"\
    \n    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_Earthwrom_1ae6 = \"1ae62dbec330695d2eddc7cb9a65d47bad5f45af95e6c8a803f0780e0749a3ad\"\
    \n  strings:\n    $dlsym = \"dlsym\" fullword\n    $gcc = \"gcc\" fullword\n \
    \   $libstdc = \"libstdc\" fullword\n    $glibc = \"glibc\" fullword\n    $setsid\
    \ = \"setsid\" fullword\n    $gmon = \"__gmon_start__\"\n    $glibc2 = \"@GLIBC\"\
    \n    $cxa = \"__cxa_finalize\"\n    $dereg = \"__deregister_frame_info\"\n  \
    \  $symtab = \".symtab\" fullword\n    $__libc_start_main = \"__libc_start_main\"\
    \n  condition:\n    uint32(0) == 1179403647 and none of them\n}\n\nrule high_entropy_header\
    \ : high {\n  meta:\n    description = \"Obfuscated ELF binary (high entropy content)\"\
    \n    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = \"f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0\"\
    \n  strings:\n    $not_pyinst = \"pyi-bootloader-ignore-signals\"\n    $not_go\
    \ = \"syscall_linux.go\"\n    $not_go2 = \"vdso_linux.go\"\n  condition:\n   \
    \ uint32(0) == 1179403647 and math.entropy(1200, 4096) > 7 and none of ($not*)\n\
    }\nimport \"math\"\n\nprivate rule smallBinary {\n\tcondition:\n\t\t// matches\
    \ ELF or machO binary\n\t\tfilesize < 64MB and (uint32(0) == 1179403647 or uint32(0)\
    \ == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0)\
    \ == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962)\n}\n\n\
    rule high_entropy_7_5 : medium {\n    meta:\n        description = \"higher entropy\
    \ binary (>7.5)\"\n    condition:\n\t\tsmallBinary and math.entropy(1,filesize)\
    \ >= 7.5\n}\n\nrule high_entropy_7_9 : high {\n    meta:\n        description\
    \ = \"high entropy binary (>7.9)\"\n\tstrings:\n\t\t// prevent bazel false positive\n\
    \t\t$bin_java = \"bin/java\"\n    condition:\n\t\tsmallBinary and math.entropy(1,filesize)\
    \ >= 7.9 and not $bin_java\n}\nrule kiteshield : high {\n  meta:\n    author =\
    \ \"Alex.Turing, Wang Hao\"\n    date = \"2024-05-28\"\n    description = \"Rule\
    \ to identify files packed by Kiteshield\"\n    hash_amdc6766_1 = \"2c80808b38140f857dc8b2b106764dd8\"\
    \n    hash_amdc6766_2 = \"909c015d5602513a770508fa0b87bc6f\"\n    hash_amdc6766_3\
    \ = \"5ea33d0655cb5797183746c6a46df2e9\"\n    hash_gafgyt = \"4afedf6fbf4ba95bbecc865d45479eaf\"\
    \n    hash_winnti = \"f5623e4753f4742d388276eaee72dea6\"\n    reference = \"https://blog.xlab.qianxin.com/kiteshield_packer_is_being_abused_by_linux_cyber_threat_actors\"\
    \n    tool = \"Kiteshield\"\n    tool_repository = \"https://github.com/GunshipPenguin/kiteshield\"\
    \n\n  strings:\n    $loader_jmp = {31 D2 31 C0 31 C9 31 F6 31 FF 31 ED 45 31 C0\
    \ 45 31 C9 45 31 D2 45 31 DB 45 31 E4 45 31 ED 45 31 F6 45 31 FF 5B FF E3}\n \
    \   // \"/proc/%d/status\"\n    $loader_s1 = {ac f4 f7 e9 e4 a7 ac ee a4 ff f9\
    \ ef fb e5 e2}\n    // \"TracerPid:\"\n    $loader_s2 = {d7 f6 e4 e5 e2 fa d9\
    \ e3 ef b6}\n    // \"/proc/%d/stat\"\n    $loader_s3 = {ac f4 f7 e9 e4 a7 ac\
    \ ee a4 ff f9 ef fb}\n    // \"LD_PRELOAD\"\n    $loader_s4 = {cf c0 da d6 d5\
    \ cd c5 c5 ca c8}\n    // \"LD_AUDIT\"\n    $loader_s5 = {cf c0 da c7 d2 cc c0\
    \ de}\n    // \"LD_DEBUG\"\n    $loader_s6 = {cf c0 da c2 c2 ca dc cd}\n    //\
    \ \"0123456789abcdef\"\n    $loader_s7 = {b3 b5 b7 b5 b3 bd bf bd b3 b5 ec ec\
    \ ec f4 f4 f4}\n\n  condition:\n    $loader_jmp and all of ($loader_s*) and\n\
    \    // ELF Magic at offset 0\n    uint32(0) == 0x464c457f and\n    // ET_EXEC\
    \ at offset 16\n    uint16(16) == 0x0002 and\n    (\n        // x86_64 at offset\
    \ 18\n        uint16(18) == 0x003e or\n        // aarch64 at offset 18\n     \
    \   uint16(18) == 0x00b7\n    )\n}\n\nrule shc : high {\n  meta:\n    description\
    \ = \"Binary generated with SHC (Shell Script Compiler)\"\n    ref = \"https://github.com/neurobin/shc\"\
    \n    hash_2023_Linux_Malware_Samples_1328 = \"1328f1c2c9fe178f13277c18847dd9adb9474f389985e17126fcb895aac035f2\"\
    \n    hash_2023_Linux_Malware_Samples_77b8 = \"77b881109c2141aef8a86263de75e041794556489055c1488f1d36feb7d70dd3\"\
    \n    hash_2023_Linux_Malware_Samples_edbe = \"edbee3b92100cc9a6a8a3c1a5fc00212627560c5e36d29569d497613ea3e3c16\"\
    \n  strings:\n    $ref = \"argv[0] nor $_\"\n  condition:\n    $ref\n}\n\nrule\
    \ upx : high {\n  meta:\n    description = \"Binary is packed with UPX\"\n   \
    \ hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_38B09D690FAFE81E964CBD45EC7CF20DCB296B4D_elf = \"f155fafa36d1094433045633741df98bbbc1153997b3577c3fa337cc525713c0\"\
    \n  strings:\n    $u_upx_sig = \"UPX!\"\n    $u_packed = \"executable packer\"\
    \n    $u_is_packed = \"This file is packed\"\n    $not_upx = \"UPX_DEBUG_DOCTEST_DISABLE\"\
    \n  condition:\n    any of ($u*) in (0..1024) and none of ($not*)\n}\n\nrule upx_elf\
    \ : high {\n  meta:\n    description = \"Linux ELF binary packed with UPX\"\n\
    \    hash_2023_UPX_0c25 = \"0c25a05bdddc144fbf1ffa29372481b50ec6464592fdfb7dec95d9e1c6101d0d\"\
    \n    hash_2023_UPX_5a59 = \"5a5960ccd31bba5d47d46599e4f10e455b74f45dad6bc291ae448cef8d1b0a59\"\
    \n    hash_2023_FontOnLake_1F52DB8E3FC3040C017928F5FFD99D9FA4757BF8_elf = \"efbd281cebd62c70e6f5f1910051584da244e56e2a3228673e216f83bdddf0aa\"\
    \n  strings:\n    $proc_self = \"/proc/self/exe\"\n    $prot_exec = \"PROT_EXEC|PROT_WRITE\
    \ failed\"\n  condition:\n    uint32(0) == 1179403647 and $prot_exec and $proc_self\n\
    }\n\nrule upx_elf_tampered : critical {\n  meta:\n    description = \"Linux ELF\
    \ binary packed with modified UPX\"\n    hash_2023_Unix_Trojan_DarkNexus_2527\
    \ = \"2527fc4d6491bd8fc9a79344790466eaedcce8795efe540ac323ea93e59c5ab5\"\n   \
    \ hash_2023_Unix_Trojan_DarkNexus_2e1d = \"2e1d9acd6ab43d63f3eab9fc995080fc67a0a5bbdc66be3aff53ed3745c9e811\"\
    \n    hash_2023_Unix_Trojan_DarkNexus_3a55 = \"3a55dcda90c72acecb548f4318d41708bb73c4c3fb099ff65c988948dc8b216f\"\
    \n  strings:\n    $prot_exec = \"PROT_EXEC|PROT_WRITE failed\"\n    $upx = \"\
    UPX!\"\n  condition:\n    uint32(0) == 1179403647 and $prot_exec and not $upx\n\
    }\n  '\n  AND yara.count > 0\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
