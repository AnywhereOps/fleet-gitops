- name: CDK - Unexpected Fetcher Parents
  description: 'Suspicious parenting of fetch tools (state-based) refs: * https://attack.mitre.org/techniques/T1105/
    (Ingress Tool Transfer)'
  query: "SELECT\n  p.pid,\n  p.path,\n  p.name AS child_name,\n  p.cmdline AS cmd,\n\
    \  p.cwd,\n  p.euid,\n  p.parent,\n  p.cgroup_path,\n  pp.path AS parent_path,\n\
    \  pp.name AS parent_name,\n  pp.cmdline AS parent_cmd,\n  pp.euid AS parent_euid,\n\
    \  gp.name AS gparent_name,\n  gp.cmdline AS gparent_cmd,\n  pp.pid AS gparent_pid,\n\
    \  hash.sha256 AS parent_sha256,\n  CONCAT (\n    p.name,\n    ',',\n    MIN(p.euid,\
    \ 500),\n    ',',\n    pp.name,\n    ',',\n    gp.name\n  ) AS exception_key\n\
    FROM\n  processes p\n  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT JOIN\
    \ processes gp ON pp.parent = gp.pid\n  LEFT JOIN hash ON pp.path = hash.path\n\
    WHERE -- NOTE: The remainder of this query is synced with unexpected-fetcher-parent-events\n\
    \  child_name IN ('curl', 'ftp', 'tftp', 'wget') -- And not a regular local user\n\
    \  AND NOT exception_key IN (\n    'curl,0,09-timezone,nm-dispatcher',\n    'curl,0,bash,kandji-library-manager',\n\
    \    'curl,0,build.sh,buildkit-runc',\n    'curl,0,eos-rankmirrors,eos-rankmirrors',\n\
    \    'curl,0,nm-dispatcher,',\n    'curl,0,nm-dispatcher,nm-dispatcher',\n   \
    \ 'curl,0,sh,qualys-cloud-ag',\n    'curl,0,sh,qualys-scan-uti',\n    'curl,300,bash,nix',\n\
    \    'curl,301,bash,nix',\n    'curl,302,bash,nix',\n    'curl,303,bash,nix',\n\
    \    'curl,305,bash,nix',\n    'curl,307,bash,nix',\n    'curl,500,bash,bash',\n\
    \    'curl,500,bash,fakeroot',\n    'curl,500,bash,fish',\n    'curl,500,bash,nix-daemon',\n\
    \    'curl,500,bash,ShellLauncher',\n    'curl,500,bash,zsh',\n    'curl,500,colima,zsh',\n\
    \    'curl,500,emacs,systemd',\n    'curl,500,endpoint-instal,bash',\n    'curl,500,env,env',\n\
    \    'curl,500,Stats,launchd',\n    'curl,500,update-tools.sh,fish',\n    'curl,500,eos-connection-,eos-update-noti',\n\
    \    'curl,500,fish,gnome-terminal-',\n    'curl,500,invoke,sh',\n    'curl,500,bash,make',\n\
    \    'curl,500,launchd,kernel_task',\n    'curl,500,make,bash',\n    'curl,500,make,fish',\n\
    \    'curl,500,makepkg,yay',\n    'curl,500,node-cve-count.,bash',\n    'curl,500,nvim,nvim',\n\
    \    'wget,0,bash,runc',\n    'curl,500,nwg-panel,systemd',\n    'curl,500,ruby,zsh',\n\
    \    'curl,500,sh,make',\n    'curl,500,ShellLauncher,',\n    'curl,500,ShellLauncher,login',\n\
    \    'curl,500,Slack,launchd',\n    'curl,500,Stats,bash',\n    'curl,500,zsh,Code\
    \ Helper',\n    'curl,500,zsh,Cursor Helper',\n    'curl,500,zsh,Emacs-arm64-11',\n\
    \    'curl,500,zsh,Hyper',\n    'curl,500,download-packag,zsh',\n    'curl,500,zsh,login',\n\
    \    'curl,500,zsh,mc',\n    'curl,500,zsh,sh',\n    'curl,500,zsh,zellij',\n\
    \    'wget,500,bootstrap,sh',\n    'wget,500,env,env',\n    'wget,500,invoke,sh',\n\
    \    'wget,500,sh,bwrap',\n    'wget,500,zsh,bash'\n  )\n  AND NOT (\n    p.euid\
    \ > 500\n    AND parent_name IN ('bash', 'dash', 'fish', 'sh', 'zsh')\n    AND\
    \ gparent_name IN (\n      'alacritty',\n      'bash',\n      'Code Helper',\n\
    \      'Cursor Helper',\n      'emacs',\n      'gnome-terminal-',\n      'goland',\n\
    \      'kitty',\n      'login',\n      'node',\n      'old',\n      'pycharm',\n\
    \      'roxterm',\n      'stable',\n      'tmux',\n      'tmux:server',\n    \
    \  'vim',\n      'wezterm-gui',\n      'zsh'\n    )\n  )\n  AND NOT p.cmdline\
    \ IN (\n    'curl -s -6 https://api.serhiy.io/v1/stats/ip',\n    'curl -s -4 https://api.serhiy.io/v1/stats/ip',\n\
    \    'curl https://wttr.in/?format=1 -s'\n  )\n  AND NOT parent_name IN ('yay',\
    \ 'dget')\n  AND NOT p.cmdline LIKE 'curl -s https://support-sp.apple.com/sp/product%'\n\
    \  AND NOT (\n    p.euid > 500\n    AND parent_name = 'env'\n    AND parent_cmd\
    \ LIKE '/usr/bin/env -i % HOMEBREW_BREW_FILE=%'\n  )\n  AND NOT (\n    p.euid\
    \ > 500\n    AND parent_name = 'ruby'\n    AND parent_cmd LIKE '%/Library/Homebrew/brew.rb%'\n\
    \  )\n  AND NOT (\n    p.euid > 500\n    AND parent_name = 'env'\n    AND parent_cmd\
    \ LIKE '/usr/bin/env bash ./hack/%.sh'\n  )\n  AND NOT (\n    p.euid > 500\n \
    \   AND parent_name = 'bash'\n    AND parent_cmd LIKE 'bash ./hack/%.sh'\n  )\n\
    \  AND NOT (\n    p.euid > 500\n    AND parent_name = 'bash'\n    AND parent_cmd\
    \ LIKE 'bash %/bin/go-build %'\n  )\n  AND NOT (\n    p.euid > 500\n    AND parent_name\
    \ = 'ruby'\n    AND p.cmdline LIKE '/usr/bin/curl --disable --cookie /dev/null\
    \ --globoff --show-error --user-agent Homebrew/%'\n  )\n  AND NOT p.cgroup_path\
    \ LIKE '/system.slice/docker-%'\nGROUP BY\n  p.pid\n"
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
