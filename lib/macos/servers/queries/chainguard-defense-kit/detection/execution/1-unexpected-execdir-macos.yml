- name: CDK - Unexpected Execdir Macos
  description: Find programs running from strange directories on macOS See "execdir-events"
    for the version that is more likely to catch things
  query: "SELECT DISTINCT\n  COALESCE(REGEX_MATCH (p0.path, '(.*)/', 1), p0.path)\
    \ AS dir,\n  REPLACE(f.directory, u.directory, '~') AS homedir,\n  COALESCE(\n\
    \    REGEX_MATCH (\n      REPLACE(f.directory, u.directory, '~'),\n      '(~/.*?/.*?/.*?/)',\n\
    \      1\n    ),\n    REPLACE(f.directory, u.directory, '~')\n  ) AS top3_homedir,\n\
    \  REGEX_MATCH (\n    REPLACE(f.directory, u.directory, '~'),\n    '(~/.*?/)',\n\
    \    1\n  ) AS top_homedir,\n  s.authority AS p0_auth,\n  s.identifier AS p0_id,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.start_time AS p0_start,\n  p0.path AS p0_path,\n\
    \  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid\
    \ AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n\
    \  p1.start_time AS p1_start,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN users\
    \ u ON p0.uid = u.uid\n  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN\
    \ hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash\
    \ ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n\
    \  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.pid IN (\n  \
    \  SELECT\n      pid\n    FROM\n      processes\n    WHERE\n      pid > 0\n  \
    \    AND REGEX_MATCH (\n        path,\n        \"^(/System|/usr/libexec/|/usr/sbin/|/usr/bin/|/usr/lib/|/bin/|/Applications|/Library/Apple/|/sbin/|/usr/local/kolide-k2)\"\
    ,\n        1\n      ) IS NULL\n    GROUP BY\n      path\n  )\n  AND NOT dir IN\
    \ (\n    '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS',\n\
    \    '/Library/Application Support/Logitech.localized/Logitech Options.localized/LogiMgrUpdater.app/Contents/Resources',\n\
    \    '/Library/DropboxHelperTools/Dropbox_u501',\n    '/Library/Filesystems/kbfuse.fs/Contents/Resources',\n\
    \    '/Library/Frameworks/Python.framework/Versions/3.10/bin',\n    '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers.app/Contents/MacOS',\n\
    \    '/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app/Contents/MacOS',\n\
    \    '/Library/Kandji/Kandji Agent.app/Contents/MacOS/',\n    '/Library/Printers/DYMO/Utilities',\n\
    \    '/Library/PrivilegedHelperTools',\n    '/Library/TeX/texbin',\n    '/nix/store',\n\
    \    '/nix/var/nix/profiles/default/bin',\n    '/opt/homebrew/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin/gke-gcloud-auth-plugin',\n\
    \    '/opt/usr/bin',\n    '/opt/X11/bin',\n    '/opt/X11/libexec',\n    '/run/current-system/sw/bin',\n\
    \    '/usr/local/aws-cli'\n  )\n  AND NOT homedir IN (\n    '~/.cache/gitstatus',\n\
    \    '~/.docker/cli-plugins',\n    '~/.gvm/binscripts',\n    '~/.local/share/gh/extensions/gh-sbom',\n\
    \    '~/.magefile',\n    '~/bin'\n  )\n  AND NOT homedir LIKE '~/%/bin'\n  AND\
    \ NOT homedir LIKE '~/Downloads/%.app/Contents/MacOS'\n  AND NOT top_homedir IN\
    \ (\n    '~/.cargo/',\n    '~/.config/',\n    '~/.kuberlr/',\n    '~/.provisio/',\n\
    \    '~/.clickshare_button/',\n    '~/.clickshare/',\n    '~/.pulumi/',\n    '~/.pyenv/',\n\
    \    '~/.rbenv/',\n    '~/.rustup/',\n    '~/.steampipe/',\n    '~/.supermaven/',\n\
    \    '~/.tflint.d/',\n    '~/.terraform.d/',\n    '~/.Trash/',\n    '~/chainguard-dev/',\n\
    \    '~/.vs-kubernetes/',\n    '~/.vscode/',\n    '~/Applications (Parallels)/',\n\
    \    '~/Applications/',\n    '~/bin/',\n    '~/code/',\n    '~/Code/',\n    '~/dev/',\n\
    \    '~/Development/',\n    '~/git/',\n    '~/go/',\n    '~/google-cloud-sdk/',\n\
    \    '~/homebrew/',\n    '~/Parallels/',\n    '~/proj/',\n    '~/projects/',\n\
    \    '~/Projects/',\n    '~/sigstore/',\n    '~/src/',\n    '~/thinkorswim/',\n\
    \    '~/work/',\n    '~/workspace/'\n  )\n  AND NOT top_homedir LIKE '~/%repos/'\n\
    \  AND NOT top3_homedir IN (\n    '/Library/Application Support/EcammLive',\n\
    \    '/Library/Developer/Xcode/',\n    '/opt/rapid7/ir_agent',\n    '~/.cache/rod/browser/',\n\
    \    '~/.cache/selenium/chromedriver/',\n    '~/.local/share/bob/',\n    '~/.local/share/nvim/',\n\
    \    '~/.terraform.d/plugin-cache/registry.terraform.io/',\n    '~/anaconda3/Anaconda-Navigator.app/Contents/',\n\
    \    '~/Library/Arduino15/packages/',\n    '~/Library/Caches/com.grammarly.ProjectLlama/',\n\
    \    '~/Library/Caches/com.mimestream.Mimestream/',\n    '~/Library/Caches/com.sempliva.Tiles/',\n\
    \    '~/Library/Caches/Cypress/',\n    '~/Library/Caches/go-build/',\n    '~/Library/Caches/JetBrains/',\n\
    \    '~/Library/Caches/org.gpgtools.updater/',\n    '~/Library/Caches/snyk/',\n\
    \    '~/Library/pnpm',\n    '~/Library/Razer/RazerAppEngine/',\n    '~/Library/Services/UE4EditorServices.app/',\n\
    \    '~/opentelemetry-operator/cmd/otel-allocator',\n    '~/zed/target/release/'\n\
    \  )\n  AND dir NOT LIKE '/Applications/%'\n  AND dir NOT LIKE '/private/tmp/%.app/Contents/MacOS'\n\
    \  AND dir NOT LIKE '/private/tmp/go-build%/exe'\n  AND dir NOT LIKE '/private/tmp/KSInstallAction.%/Install\
    \ Google Software Update.app/Contents/Helpers'\n  AND dir NOT LIKE '/private/tmp/nix-build-%'\n\
    \  AND dir NOT LIKE '/private/tmp/PKInstallSandbox.%/Scripts/com.microsoft.OneDrive.%'\n\
    \  AND dir NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%.xpc/Contents/MacOS'\n\
    \  AND dir NOT LIKE '/private/var/folders/%/bin'\n  AND dir NOT LIKE '/private/var/folders/%/Contents/%'\n\
    \  AND dir NOT LIKE '/private/var/folders/%/d/Wrapper/%.app'\n  AND dir NOT LIKE\
    \ '/private/var/folders/%/go-build%'\n  AND dir NOT LIKE '/private/var/folders/%/GoLand'\n\
    \  AND dir NOT LIKE '/Volumes/com.getdropbox.dropbox-%'\n  AND dir NOT LIKE '%/.terraform/providers/%'\n\
    \  AND dir NOT LIKE '~/%_arm64'\n  AND homedir NOT LIKE '~/.local/%/packages/%'\n\
    \  AND homedir NOT LIKE '~/%/google-cloud-sdk/bin/%'\n  AND homedir NOT LIKE '~/%/node_modules/%'\n\
    \  AND homedir NOT LIKE '~/Library/Application Support/%'\n  AND homedir NOT LIKE\
    \ '~/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%/Updater.app/Contents/MacOS'\n\
    \  AND homedir NOT LIKE '~/Library/Caches/ms-playwright/%'\n  AND homedir NOT\
    \ LIKE '~/Library/Printers/%/Contents/MacOS'\n  AND homedir NOT LIKE '~/Documents/%/mono/%'\n\
    \  AND homedir NOT LIKE '~/Documents/GH/%'\n  AND s.authority NOT IN (\n    'Apple\
    \ iPhone OS Application Signing',\n    'Apple Mac OS Application Signing',\n \
    \   'Developer ID Application: Adobe Inc. (JQ525L2MZD)',\n    'Developer ID Application:\
    \ Cisco (DE8Y96K9QP)',\n    'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',\n\
    \    'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',\n    'Developer\
    \ ID Application: Docker Inc (9BNSXJN65R)',\n    'Developer ID Application: Dropbox,\
    \ Inc. (G7HH3F8CAK)',\n    'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',\n\
    \    'Developer ID Application: EnterpriseDB Corporation (26QKX55P9K)',\n    'Developer\
    \ ID Application: Epic Games International, S.a.r.l. (96DBZ92D3Y)',\n    'Developer\
    \ ID Application: Figma, Inc. (T8RA8NE3B7)',\n    'Developer ID Application: GEORGE\
    \ NACHMAN (H7V7XYVQ7D)',\n    'Developer ID Application: Google LLC (EQHXZ8M8AV)',\n\
    \    'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',\n    'Developer\
    \ ID Application: Hercules Labs Inc. (B8PC799ZGU)',\n    'Developer ID Application:\
    \ JetBrains s.r.o. (2ZEFAR8TH3)',\n    'Developer ID Application: Logitech Inc.\
    \ (QED4VVPZWA)',\n    'Developer ID Application: Microsoft Corporation (UBF8T346G9)',\n\
    \    'Developer ID Application: Node.js Foundation (HX7739G8FX)',\n    'Developer\
    \ ID Application: Razer USA Ltd. (R2H967U7J8)',\n    'Developer ID Application:\
    \ Objective Development Software GmbH (MLZF7K7B5R)',\n    'Developer ID Application:\
    \ Objective-See, LLC (VBG97UB4TA)',\n    'Developer ID Application: Opal Camera\
    \ Inc (97Z3HJWCRT)',\n    'Developer ID Application: Oracle America, Inc. (VB5E2TV963)',\n\
    \    'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',\n    'Developer ID Application:\
    \ Sublime HQ Pty Ltd (Z6D26JE4Y4)',\n    'Developer ID Application: TablePlus\
    \ Inc (3X57WP8E8V)',\n    'Developer ID Application: Tenable, Inc. (4B8J598M7U)',\n\
    \    'Developer ID Application: Valve Corporation (MXGJJ98X76)',\n    'Developer\
    \ ID Application: Wireshark Foundation, Inc. (7Z6EMTD2C6)',\n    'Software Signing'\n\
    \  ) -- Locally built executables\n  AND NOT (\n    s.identifier = \"a.out\"\n\
    \    AND homedir LIKE '~/%'\n    AND (\n      p1.name LIKE '%sh'\n      OR p1.name\
    \ = 'make'\n    )\n    AND (\n      p2.name = 'login'\n      OR p2.name LIKE '%sh'\n\
    \    )\n    AND p0.path NOT LIKE '%/Cache%'\n    AND p0.path NOT LIKE '%/Library/%'\n\
    \    AND p0.path NOT LIKE '%/.%'\n  )\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
