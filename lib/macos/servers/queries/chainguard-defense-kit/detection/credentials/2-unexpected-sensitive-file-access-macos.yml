- name: CDK - Unexpected Sensitive File Access Macos
  description: Unexpected programs accessing sensitive data stores (state-based) This
    query is unfortunately of limited use, as the query is slow (250ms) and it requires
    catching a program at the exact moment it has the file open. An event-based version
    is advised.
  query: "SELECT\n  pof.pid,\n  pof.fd,\n  pof.path,\n  f.uid AS file_uid,\n  p.cwd\
    \ AS cwd,\n  p.euid,\n  p.uid AS process_uid,\n  p.name AS program_name,\n  p.cmdline\
    \ AS cmdline,\n  pp.name AS parent_name,\n  pp.cwd AS parent_cwd,\n  pp.path AS\
    \ parent_path,\n  pf.filename AS program_base,\n  hash.sha256,\n  REPLACE(f.directory,\
    \ u.directory, '~') AS dir,\n  CONCAT (\n    pf.filename,\n    ',',\n    p.name,\n\
    \    ',',\n    IIF(\n      REGEX_MATCH (\n        REPLACE(f.directory, u.directory,\
    \ '~'),\n        '([/~].*?/.*?/.*?)/',\n        1\n      ) != '',\n      REGEX_MATCH\
    \ (\n        REPLACE(f.directory, u.directory, '~'),\n        '([/~].*?/.*?/.*?)/',\n\
    \        1\n      ),\n      REPLACE(f.directory, u.directory, '~')\n    )\n  )\
    \ AS exception_key\nFROM\n  -- Starting with processes is just slightly faster\
    \ than starting with pof\n  processes p\n  LEFT JOIN process_open_files pof ON\
    \ p.pid = pof.pid\n  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT JOIN\
    \ file f ON pof.path = f.path\n  LEFT JOIN file pf ON p.path = pf.path\n  LEFT\
    \ JOIN users u ON p.uid = u.uid\n  LEFT JOIN hash ON p.path = hash.path\n  LEFT\
    \ JOIN hash hp ON pp.path = hp.path\nWHERE\n  -- minor optimization: filtering\
    \ out low parents saves us another 5% of runtime\n  p.parent > 2\n  -- Large files\
    \ are probably not secrets\n  AND pf.filename != ''\n  AND f.size < 1000000\n\
    \  AND (\n    pof.path IN ('/var/run/docker.sock')\n    OR pof.path LIKE '/home/%/.aws%'\n\
    \    OR pof.path LIKE '/home/%/.bash_history'\n    OR pof.path LIKE '/home/%/.cache/mozilla/firefox%'\n\
    \    OR pof.path LIKE '/home/%/.config/gcloud/%'\n    OR pof.path LIKE '/home/%/.config/google-chrome/%'\n\
    \    OR pof.path LIKE '/home/%/.config/mozilla/firefox%'\n    OR pof.path LIKE\
    \ '/home/%/.config/Slack/%'\n    OR pof.path LIKE '/home/%/.mozilla/firefox/%'\n\
    \    OR pof.path LIKE '/home/%/.ssh/%'\n    OR pof.path LIKE '/root/.bash_history'\n\
    \    OR pof.path LIKE '/root/.ssh/%'\n  )\n  AND NOT (\n    file_uid == process_uid\n\
    \    AND exception_key IN (\n      'aws,aws,~/.aws',\n      'chrome_crashpad_handler,chrome_crashpad,',\n\
    \      'chrome_crashpad_handler,chrome_crashpad,~/.config/google-chrome',\n  \
    \    'chrome,chrome,~/.config/google-chrome',\n      'firefox,.firefox-wrappe,~/.cache/mozilla',\n\
    \      'firefox,.firefox-wrappe,~/.mozilla/firefox',\n      'firefox,file:// Content,~/.cache/mozilla',\n\
    \      'firefox,file:// Content,~/.mozilla/firefox',\n      'firefox,file:// Content,~/snap/firefox',\n\
    \      'firefox,firefox,~/.cache/mozilla',\n      'firefox,firefox,~/.mozilla/firefox',\n\
    \      'firefox,firefox,~/snap/firefox',\n      'firefox,Isolated Servic,~/.cache/mozilla',\n\
    \      'firefox,Isolated Servic,~/.mozilla/firefox',\n      'firefox,Isolated\
    \ Servic,~/snap/firefox',\n      'firefox,Isolated Web Co,~/.cache/mozilla',\n\
    \      'firefox,Isolated Web Co,~/.mozilla/firefox',\n      'firefox,Isolated\
    \ Web Co,~/snap/firefox',\n      'firefox,Privileged Cont,~/.cache/mozilla',\n\
    \      'firefox,Privileged Cont,~/.mozilla/firefox',\n      'firefox,Privileged\
    \ Cont,~/snap/firefox',\n      'firefox,Web Content,~/.cache/mozilla',\n     \
    \ 'firefox,Web Content,~/.mozilla/firefox',\n      'firefox,Web Content,~/snap/firefox',\n\
    \      'firefox,WebExtensions,~/.cache/mozilla',\n      'firefox,WebExtensions,~/.mozilla/firefox',\n\
    \      'firefox,WebExtensions,~/snap/firefox',\n      'plugin-container,MainThread,~/.mozilla/firefox',\n\
    \      'plugin-container,MainThread,~/snap/firefox',\n      'python3,python3,~/.config/gcloud',\n\
    \      'python3.10,python3,~/.config/gcloud',\n      'python3.11,python3,~/.config/gcloud',\n\
    \      'python3.12,python3,~/.config/gcloud',\n      'slack,slack,~/.config/Slack',\n\
    \      'slack,slack,~/snap/slack',\n      'soffice.bin,soffice.bin,~/.mozilla/firefox',\n\
    \      'vim,vim,~/.aws'\n    )\n  )\nGROUP BY\n  pof.pid,\n  pof.path\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
