- name: CDK - Unexpected Pcap User Macos
  description: Find root-run processes which link against libpcap
  query: "SELECT\n  s.authority,\n  s.identifier,\n  pmm.path,\n  -- Child\n  p0.pid\
    \ AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.start_time AS\
    \ p0_start,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.cgroup_path AS\
    \ p0_cgroup,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n\
    \  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.start_time\
    \ AS p1_start,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  JOIN process_memory_map\
    \ pmm ON p0.pid = pmm.pid\n  LEFT JOIN signature s ON p0.path = s.path\n  LEFT\
    \ JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p0.pid IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n\
    \      euid = 0\n      AND path NOT LIKE '/Library/Apple/%'\n      AND path NOT\
    \ LIKE '/nix/store/%/bin/nix'\n      AND path NOT LIKE '/opt/homebrew/Cellar/btop/%/bin/btop'\n\
    \      AND path NOT LIKE '/opt/homebrew/Cellar/socket_vmnet/%/bin/socket_vmnet'\n\
    \      AND path NOT LIKE '/opt/homebrew/Cellar/vim/%/bin/vim'\n      AND path\
    \ NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'\n      AND path\
    \ NOT LIKE '/sbin/%'\n      AND path NOT LIKE '/System/%'\n      AND path NOT\
    \ LIKE '/usr/bin/%'\n      AND path NOT LIKE '/usr/libexec/%'\n      AND path\
    \ NOT LIKE '/usr/local/Cellar/htop/%/bin/htop'\n      AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'\n\
    \      AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'\n\
    \      AND path NOT LIKE '/usr/sbin/%'\n      AND path NOT IN (\n        '/opt/socket_vmnet/bin/socket_vmnet',\n\
    \        '/usr/local/sbin/velociraptor'\n      )\n  )\n  AND pmm.path LIKE '%libpcap%'\n\
    \  -- These are all protected directories\n  AND NOT s.authority IN (\n    'Apple\
    \ Mac OS Application Signing',\n    'Developer ID Application: Docker Inc (9BNSXJN65R)',\n\
    \    'Developer ID Application: Kolide Inc (YZ3EM74M78)',\n    'Developer ID Application:\
    \ OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',\n    'Developer ID Application:\
    \ Rapid7 LLC (UL6CGN7MAL)',\n    'Software Signing'\n  )\n  AND NOT p0.path LIKE\
    \ '/opt/homebrew/Cellar/kubernetes-cli/%/bin/kubectl'\nGROUP BY\n  p0.pid\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
