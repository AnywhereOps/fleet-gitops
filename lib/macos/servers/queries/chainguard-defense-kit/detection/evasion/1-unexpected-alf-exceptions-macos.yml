- name: CDK - Unexpected Alf Exceptions Macos
  description: macOS application layer firewall (ALF) service exceptions.
  query: "SELECT\n  ae.path,\n  ae.state,\n  file.mtime,\n  file.ctime,\n  file.uid,\n\
    \  file.directory,\n  file.size,\n  file.type,\n  hash.sha256,\n  signature.identifier,\n\
    \  signature.authority,\n  CONCAT (\n    signature.authority,\n    ',',\n    signature.identifier,\n\
    \    ',',\n    ae.path,\n    ',',\n    MIN(file.uid, 501)\n  ) AS exception_key\n\
    FROM\n  alf_exceptions ae\n  LEFT JOIN file ON ae.path = file.path\n  LEFT JOIN\
    \ hash ON ae.path = hash.path\n  LEFT JOIN signature ON ae.path = signature.path\n\
    WHERE -- Filter out stock exceptions to decrease overhead\n  ae.path NOT IN (\n\
    \    '/System/Library/CoreServices/UniversalControl.app/',\n    '/System/Library/PrivateFrameworks/Admin.framework/Versions/A/Resources/readconfig',\n\
    \    '/System/Library/PrivateFrameworks/EmbeddedOSInstall.framework/Versions/A/XPCServices/EmbeddedOSInstallService.xpc/',\n\
    \    '/System/Volumes/Preboot/Cryptexes/OS/System/Library/Frameworks/WebKit.framework/Versions/A/XPCServices/com.apple.WebKit.Networking.xpc/',\n\
    \    '/usr/bin/nmblookup',\n    '/usr/libexec/bootpd',\n    '/usr/libexec/configd',\n\
    \    '/usr/libexec/discoveryd',\n    '/usr/libexec/xartstorageremoted',\n    '/usr/sbin/mDNSResponder',\n\
    \    '/usr/sbin/racoon'\n  ) -- Ignore files that ahve already been removed\n\
    \  AND file.filename NOT NULL\n  AND exception_key NOT IN (\n    ',a.out,/private/tmp/learning-labs-static/server,501',\n\
    \    ',a.out,/Users/amouat/proj/learning-labs-static/server,501',\n    ',a.out,/Users/dlorenc/.wash/downloads/nats-server,501',\n\
    \    ',com.docker.docker,/Applications/Docker.app/,501',\n    ',deskflow-server,/Applications/Deskflow.app/Contents/MacOS/deskflow-server,501',\n\
    \    'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',\n\
    \    'Apple Mac OS Application Signing,io.tailscale.ipn.macos.network-extension,/Applications/Tailscale.localized/Tailscale.app/Contents/PlugIns/IPNExtension.appex/,0',\n\
    \    'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF),com.adguard.mac.adguard.network-extension,/Library/SystemExtensions/AD3BCA34-237A-4135-B7A4-0F7477D9144C/com.adguard.mac.adguard.network-extension.systemextension/,0',\n\
    \    'Developer ID Application: Ned Deily (DJ3H93M7VJ),org.python.python,/Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,0',\n\
    \    'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.11/Resources/Python.app/,0',\n\
    \    'Developer ID Application: Python Software Foundation (BMM5U3QVKW),org.python.python,/Library/Frameworks/Python.framework/Versions/3.12/Resources/Python.app/,0',\n\
    \    'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/A30AF854-E980-4345-A658-17000BF66D00/io.tailscale.ipn.macsys.network-extension.systemextension/,0'\n\
    \  )\n  -- Signed\n  AND NOT exception_key LIKE 'Developer ID Application:%,/Applications/%.app/,501'\n\
    \  -- Unsigned\n  AND NOT exception_key LIKE ',,/Applications/%.app/,'\n  -- Locally\
    \ compiled\n  AND NOT exception_key LIKE ',a.out,/Users/%,501'\n  -- Homebrew\n\
    \  AND NOT exception_key LIKE ',%,/opt/homebrew/Cellar/%,501'\n  -- Nix\n  AND\
    \ NOT exception_key LIKE ',%,/nix/store/%,0'\n  AND NOT exception_key LIKE ',%,/nix/store/%,501'\n\
    \  -- Apple (root)\n  AND NOT exception_key LIKE 'Software Signing,com.apple.%,0'\n\
    \  -- App Store\n  AND NOT exception_key LIKE 'Apple Mac OS Application Signing,%,/Applications/%.app/,0'\n\
    \  -- Other weirdo apps\n  AND NOT exception_key LIKE 'Developer ID Application:\
    \ Cypress.Io, Inc. (7D655LWGLY),com.electron.cypress,/Users/%/Library/Caches/Cypress/%/Cypress.app/,501'\n\
    \  AND NOT exception_key LIKE 'Developer ID Application: Tailscale Inc. (W5364U7YZB),io.tailscale.ipn.macsys.network-extension,/Library/SystemExtensions/%'\n\
    \  AND NOT exception_key LIKE 'Developer ID Application: The Foundry (82R497YNSK),org.python.python,/Applications/Nuke%/Contents/Frameworks/Python.framework/Versions/%/Resources/Python.app/,501'\n\
    \  AND NOT signature.authority IN (\n    'Developer ID Application: Docker Inc\
    \ (9BNSXJN65R)',\n    'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',\n\
    \    'Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)',\n    'Developer\
    \ ID Application: The Foundry (82R497YNSK)'\n  )\n  AND NOT (\n    signature.identifier\
    \ LIKE 'fake-%'\n    AND ae.path LIKE '%/exe/fake'\n  )\n  AND NOT (\n    signature.identifier\
    \ = 'nix'\n    AND ae.path LIKE '/nix/store/%-nix-%/bin/nix'\n  )\n  AND NOT (\n\
    \    ae.path LIKE '/Users/%/Library/Application%20Support/Steam/Steam.AppBundle/Steam/'\n\
    \  )\n  AND NOT (\n    signature.authority = ''\n    AND signature.identifier\
    \ = 'org.chromium.Chromium'\n    AND ae.path LIKE '/Users/%/Library/pnpm/global/%/.pnpm/carlo@%/node_modules/carlo/lib/.local-data/mac-%/chrome-mac/Chromium.app/'\n\
    \  )\n  -- End user tools\n  AND NOT (\n    (\n      signature.identifier = 'a.out'\n\
    \      OR signature.identifier LIKE '%-%'\n    )\n    AND file.uid > 500\n   \
    \ AND (\n      file.directory LIKE '/opt/homebrew/Cellar/%/bin'\n      OR file.directory\
    \ LIKE '/private/var/folders/%/T/go-build%/exe'\n      OR file.directory LIKE\
    \ '/Users/%/%-cli'\n      OR file.directory LIKE '/Users/%/bin'\n      OR file.directory\
    \ LIKE '/Users/%/code/%'\n      OR file.directory LIKE '/Users/%/debug/%'\n  \
    \    OR file.directory LIKE '/Users/%/gh/%'\n      OR file.directory LIKE '/Users/%/git/%'\n\
    \      OR file.directory LIKE '/Users/%/node_modules/.bin/%'\n      OR file.directory\
    \ LIKE '/Users/%/sigstore/%'\n      OR file.directory LIKE '/Users/%/src/%'\n\
    \      OR file.directory LIKE '/Users/%/target/%'\n      OR file.directory LIKE\
    \ '/Users/%/tmp/%'\n    )\n  )\nGROUP BY\n  exception_key\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
