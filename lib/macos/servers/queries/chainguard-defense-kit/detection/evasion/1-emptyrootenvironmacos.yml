- name: CDK - Empty Root Environ Macos
  description: Find programs which spawn root children without propagating environment
    variables
  query: "SELECT\n  COUNT(key) AS count,\n  p.pid,\n  p.path,\n  p.name,\n  p.euid,\n\
    \  p.on_disk,\n  p.parent,\n  p.cmdline,\n  p.cwd,\n  pp.name AS parent_name,\n\
    \  pp.cmdline AS parent_cmd,\n  signature.identifier,\n  signature.authority,\n\
    \  hash.sha256,\n  CONCAT (\n    MIN(p.euid, 500),\n    ',',\n    p.name,\n  \
    \  ',',\n    signature.identifier,\n    ',',\n    signature.authority\n  ) AS\
    \ exception_key\nFROM\n  processes p\n  LEFT JOIN process_envs pe ON p.pid = pe.pid\n\
    \  LEFT JOIN processes pp ON p.parent = pp.pid\n  LEFT JOIN hash ON p.path = hash.path\n\
    \  LEFT JOIN signature ON p.path = signature.path\nWHERE\n  p.pid IN (\n    SELECT\n\
    \      pid\n    FROM\n      processes\n    WHERE\n      euid = 0\n      AND start_time\
    \ > (strftime('%s', 'now') - 601)\n      AND start_time < (strftime('%s', 'now')\
    \ - 1)\n      AND path NOT LIKE '/opt/homebrew/Cellar/%'\n      AND path NOT LIKE\
    \ '/System/Library/%'\n  )\n  AND signature.authority NOT IN (\n    'Apple Mac\
    \ OS Application Signing',\n    'Developer ID Application: Adobe Inc. (JQ525L2MZD)',\n\
    \    'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',\n    'Developer\
    \ ID Application: Docker Inc (9BNSXJN65R)',\n    'Developer ID Application: GitHub\
    \ (VEKTX9H2N7)',\n    'Developer ID Application: Google LLC (EQHXZ8M8AV)',\n \
    \   'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',\n    'Developer\
    \ ID Application: Keybase, Inc. (99229SGT5K)',\n    'Developer ID Application:\
    \ Kolide Inc (YZ3EM74M78)',\n    'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n\
    \    'Developer ID Application: Microsoft Corporation (UBF8T346G9)',\n    'Developer\
    \ ID Application: Mozilla Corporation (43AQ936H96)',\n    'Developer ID Application:\
    \ Node.js Foundation (HX7739G8FX)',\n    'Developer ID Application: Objective\
    \ Development Software GmbH (MLZF7K7B5R)',\n    'Developer ID Application: Opal\
    \ Camera Inc (97Z3HJWCRT)',\n    'Developer ID Application: Parallels International\
    \ GmbH (4C6364ACXT)',\n    'Developer ID Application: Yubico Limited (LQA3CS5MM7)',\n\
    \    'Software Signing'\n  )\nGROUP BY\n  p.pid\nHAVING\n  count == 0;\n"
  platform: darwin
  interval: 600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
