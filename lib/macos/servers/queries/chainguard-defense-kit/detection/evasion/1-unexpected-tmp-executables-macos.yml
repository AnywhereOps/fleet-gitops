- name: CDK - Unexpected Tmp Executables Macos
  description: Find unexpected executables in temp directories, often used by malware
    droppers
  query: "SELECT DISTINCT\n  file.path,\n  uid,\n  gid,\n  mode,\n  REGEX_MATCH (RTRIM(file.path,\
    \ '/'), '.*\\.(.*?)$', 1) AS extension,\n  file.btime,\n  file.ctime,\n  file.mtime,\n\
    \  file.type,\n  file.size,\n  hash.sha256,\n  magic.data,\n  signature.identifier,\n\
    \  signature.authority\nFROM\n  file\n  LEFT JOIN hash on file.path = hash.path\n\
    \  LEFT JOIN magic ON file.path = magic.path\n  LEFT JOIN signature ON file.path\
    \ = signature.path\nWHERE -- Optimization: don't join things until we have a whittled\
    \ down list of files\n  file.path IN (\n    SELECT\n      path\n    FROM\n   \
    \   file\n    WHERE\n      (\n        file.directory = '/tmp'\n        OR file.directory\
    \ LIKE '/tmp/.%'\n        or file.directory LIKE '/tmp/.%/.%'\n        OR file.directory\
    \ LIKE '/tmp/.%/%'\n        OR file.directory LIKE '/tmp/%'\n        OR file.directory\
    \ LIKE '/tmp/%/.%'\n        OR file.directory LIKE '/tmp/%/%'\n      ) -- Prevent\
    \ weird recursion\n      AND NOT file.directory LIKE '%/../%'\n      AND NOT file.directory\
    \ LIKE '%/./%' -- Exclude very temporary files\n      AND NOT (strftime('%s',\
    \ 'now') - ctime) < 60 -- Only executable files\n      AND file.type = 'regular'\n\
    \      AND (\n        file.mode LIKE '%7%'\n        or file.mode LIKE '%1%'\n\
    \        or file.mode LIKE '%5%'\n      )\n      AND NOT (\n        uid > 500\n\
    \        AND (\n          file.path LIKE '%/go-build%'\n          OR file.path\
    \ LIKE '/tmp/%/AdobePIM.dylib'\n          OR file.path LIKE '/tmp/%ctl'\n    \
    \      OR file.path LIKE '/tmp/com.apple.installer%'\n          OR file.path LIKE\
    \ '/tmp/flow/%.npmzS_cacachezStmpzSgit-clone%'\n          OR file.path LIKE '/tmp/GoLand/___Test%.test'\n\
    \          OR file.path LIKE '/tmp/KSInstallAction.%/m/.keystone_install'\n  \
    \        OR file.path LIKE '/tmp/lima/%'\n          OR file.path LIKE '/tmp/melange%'\n\
    \          OR file.path LIKE '%-release%/%'\n          OR file.path LIKE '%.tfstate.sh'\n\
    \          OR file.path LIKE '%/bin/%'\n          OR file.path LIKE '%/CCLBS/%'\n\
    \          OR file.path LIKE '%/checkout/%'\n          OR file.path LIKE '%/ci/%'\n\
    \          OR file.path LIKE '%/debug/%'\n          OR file.path LIKE '%/dist/%'\n\
    \          OR file.path LIKE '%/elastic-agent-%'\n          OR file.path LIKE\
    \ '%/etc/network/if-up.d/%'\n          OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%'\n\
    \          OR file.path LIKE '%/git/%'\n          OR file.path LIKE '%/github/%'\n\
    \          OR file.path LIKE '%/go.%.sum'\n          OR file.path LIKE '%/guile-%/guile-%'\n\
    \          OR file.path LIKE '%/ko/%'\n          OR file.path LIKE '%/kots/%'\n\
    \          OR file.path LIKE '%/nix/%'\n          OR file.path LIKE '%/pdf-tools/%'\n\
    \          OR file.path LIKE '%/Photoshop Installer.app/Contents/%'\n        \
    \  OR file.path LIKE '%/sbin/%'\n          OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%'\n\
    \          OR file.path LIKE '%/src/%'\n          OR file.path LIKE '%/target/%'\n\
    \          OR file.path LIKE '%/terraformer/%'\n          OR file.path LIKE '%/tmp/epdf%'\n\
    \          OR file.path LIKE \"%/%/gradlew\"\n          OR file.path LIKE \"%/lib/%.so.%\"\
    \n          OR file.path LIKE \"%/lib/%.so\"\n          OR file.filename IN (\n\
    \            'chainctl',\n            'configure',\n            'cosign',\n  \
    \          'golangci-lint',\n            'goreleaser',\n            'grype',\n\
    \            'mysqld_exporter'\n          )\n        )\n      )\n      -- Melange\n\
    \      AND NOT file.directory LIKE '/tmp/melange-guest-%'\n      -- Nix\n    \
    \  AND NOT (\n        file.directory LIKE '/tmp/tmp%'\n        AND gid = 0\n \
    \       AND uid > 300\n        AND uid < 350\n      ) -- Babel\n      AND NOT\
    \ (\n        file.directory LIKE '/tmp/babel-%/sh-script-%'\n        AND gid >\
    \ 900\n        AND uid = 1000\n        AND size < 1024\n      ) -- Random Testdata\n\
    \      AND NOT (\n        gid > 900\n        AND uid = 1000\n        AND (\n \
    \         file.directory LIKE '/tmp/%/test'\n          OR file.directory LIKE\
    \ '/tmp/%/testdata'\n        )\n      ) -- macOS updates\n      AND NOT file.directory\
    \ LIKE '/tmp/msu-target-%' -- I don't know man. I don't work here.\n      AND\
    \ NOT file.directory LIKE '/tmp/UpdateBrain-%/AssetData/com.apple.MobileSoftwareUpdate.UpdateBrainService.xpc/Contents/MacOS'\
    \ -- terraform\n      AND NOT file.directory LIKE '/tmp/staged-updates%'\n   \
    \   AND NOT (\n        uid > 500\n        AND file.path LIKE '/tmp/terraform_%/terraform'\n\
    \      )\n      AND NOT (\n        file.path LIKE '/tmp/%compressed'\n       \
    \ AND size < 4000\n        AND uid > 500\n      ) -- Executables too small to\
    \ even hold '#!/bin/sh\\nuid'\n      AND NOT (\n        file.type = 'regular'\n\
    \        AND size < 10\n      ) -- TODO: Remove this hardcoded entry after Apr\
    \ 2023\n      AND NOT (\n        file.path = '/tmp/policy-tester'\n        AND\
    \ file.uid = 501\n        AND file.gid = 20\n        AND file.size = 90921938\n\
    \      )\n  )\n  AND NOT signature.authority IN (\n    'Developer ID Application:\
    \ Adobe Inc. (JQ525L2MZD)',\n    'Developer ID Application: Docker Inc (9BNSXJN65R)'\n\
    \  )\n  AND NOT (\n    magic.data IN ('JSON data', 'ASCII text')\n    OR magic.data\
    \ LIKE 'ELF %-bit %SB executable%'\n    OR magic.data LIKE 'symbolic link to %'\n\
    \    OR magic.data LIKE 'ELF %-bit LSB shared object%'\n    OR magic.data LIKE\
    \ 'libtool library file,%'\n    OR magic.data LIKE \"POSIX shell script, ASCII\
    \ text executable%\"\n    OR (\n      file.size < 50000\n      AND file.uid >\
    \ 500\n      AND extension IN (\n        'adoc',\n        'bat',\n        'conf',\n\
    \        'java',\n        'js',\n        'json',\n        'log',\n        'md',\n\
    \        'nib',\n        'pem',\n        'perl',\n        'pl',\n        'py',\n\
    \        'rb',\n        'script',\n        'sh',\n        'status',\n        'strings',\n\
    \        'txt',\n        'yaml',\n        'yml'\n      )\n      AND (\n      \
    \  magic.data IS NULL\n        OR magic.data NOT LIKE \"%Mach-O%\"\n      )\n\
    \    )\n  )\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
