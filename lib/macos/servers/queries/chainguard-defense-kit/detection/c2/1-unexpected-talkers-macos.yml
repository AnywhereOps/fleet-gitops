- name: CDK - Unexpected Talkers Macos
  description: Unexpected programs communicating over non-HTTPS running from weird
    locations
  query: "SELECT\n  pos.protocol,\n  pos.local_port,\n  pos.remote_port,\n  remote_address,\n\
    \  pos.local_port,\n  pos.local_address,\n  CONCAT (MIN(p0.euid, 500), ',', s.authority)\
    \ AS signed_exception,\n  CONCAT (\n    MIN(p0.euid, 500),\n    ',',\n    pos.protocol,\n\
    \    ',',\n    MIN(pos.remote_port, 32768),\n    ',',\n    COALESCE(REGEX_MATCH\
    \ (p0.path, '.*/(.*?)$', 1), p0.name),\n    ',',\n    p0.name\n  ) AS unsigned_exception,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  s.authority AS p0_sauth,\n\
    \  s.identifier AS p0_sid,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n \
    \ p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n \
    \ -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n\
    \  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256\n\
    FROM\n  process_open_sockets pos\n  LEFT JOIN processes p0 ON pos.pid = p0.pid\n\
    \  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1\
    \ ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN file f ON p0.path = f.path\n  LEFT JOIN signature s ON p0.path =\
    \ s.path\nWHERE\n  pos.pid IN (\n    SELECT\n      pid\n    from\n      process_open_sockets\n\
    \    WHERE\n      protocol > 0\n      AND local_port > 0\n      AND remote_port\
    \ > 0\n      AND NOT (\n        remote_port IN (53, 443)\n        AND protocol\
    \ IN (6, 17)\n      )\n      AND remote_address NOT IN (\n        '0.0.0.0',\n\
    \        '::127.0.0.1',\n        '127.0.0.1',\n        '::ffff:127.0.0.1',\n \
    \       '::1',\n        '::'\n      )\n      AND remote_address NOT LIKE 'fe80:%'\n\
    \      AND remote_address NOT LIKE '127.%'\n      AND remote_address NOT LIKE\
    \ '192.168.%'\n      AND remote_address NOT LIKE '172.1%'\n      AND remote_address\
    \ NOT LIKE '172.2%'\n      AND remote_address NOT LIKE '169.254.%'\n      AND\
    \ remote_address NOT LIKE '172.30.%'\n      AND remote_address NOT LIKE '172.31.%'\n\
    \      AND remote_address NOT LIKE '::ffff:172.%'\n      AND remote_address NOT\
    \ LIKE '10.%'\n      AND remote_address NOT LIKE '::ffff:10.%'\n      AND remote_address\
    \ NOT LIKE 'fc00:%'\n      AND remote_address NOT LIKE 'fdfd:%'\n      AND state\
    \ != 'LISTEN'\n  ) -- Ignore most common application paths\n  AND protocol > 0\n\
    \  AND p0.path NOT LIKE '/Applications/%.app/Contents/%/MacOS/%'\n  AND p0.path\
    \ NOT LIKE '/Applications/%.app/Contents/MacOS/%'\n  AND p0.path NOT LIKE '/Applications/%.app/Contents/Resources/%'\n\
    \  AND p0.path NOT LIKE '/Users/%/Applications/%.app/Contents/MacOS/%'\n  AND\
    \ p0.path NOT LIKE '/Library/Apple/%'\n  AND p0.path NOT LIKE '/Library/Application\
    \ Support/%/Contents/%'\n  AND p0.path NOT LIKE '/opt/%/bin/%'\n  AND p0.path\
    \ NOT LIKE '/System/%'\n  AND p0.path NOT LIKE '/Users/%/bin/%'\n  AND p0.path\
    \ NOT LIKE '/usr/bin/%'\n  AND p0.path NOT LIKE '/usr/libexec/%'\n  AND p0.path\
    \ NOT LIKE '/usr/sbin/%'\n  AND NOT signed_exception IN (\n    '0,Developer ID\
    \ Application: Objective Development Software GmbH (MLZF7K7B5R)',\n    '0,Developer\
    \ ID Application: Tailscale Inc. (W5364U7YZB)',\n    '0,Developer ID Application:\
    \ Y Soft Corporation, a.s. (3CPED8WGS9)',\n    '500,Apple Mac OS Application Signing',\n\
    \    '500,Developer ID Application: Docker Inc (9BNSXJN65R)',\n    '500,Developer\
    \ ID Application: Adguard Software Limited (TC3Q7MAJXF)',\n    '500,Developer\
    \ ID Application: Autodesk (XXKJ396S2Y)',\n    '500,Developer ID Application:\
    \ AMZN Mobile LLC (94KV3E626L)',\n    '500,Developer ID Application: Azul Systems,\
    \ Inc. (TDTHCUPYFR)',\n    '500,Developer ID Application: Blackmagic Design Inc\
    \ (9ZGFBWLSYP)',\n    '500,Developer ID Application: Bookry Ltd (4259LE8SU5)',\n\
    \    '500,Developer ID Application: Cisco (DE8Y96K9QP)',\n    '500,Developer ID\
    \ Application: David Kocher (G69SCX94XU)',\n    '500,Developer ID Application:\
    \ Google LLC (EQHXZ8M8AV)',\n    '500,Developer ID Application: JetBrains s.r.o.\
    \ (2ZEFAR8TH3)',\n    '500,Developer ID Application: Microsoft Corporation (UBF8T346G9)',\n\
    \    '500,Developer ID Application: ngrok LLC (TEX8MHRDQ9)',\n    '500,Developer\
    \ ID Application: Razer USA Ltd. (R2H967U7J8)',\n    '500,Developer ID Application:\
    \ Red Hat, Inc. (HYSCB8KRL2)',\n    '500,Developer ID Application: Oracle America,\
    \ Inc. (VB5E2TV963)',\n    '500,Developer ID Application: Sky UK Limited (GJ24C8864F)',\n\
    \    '500,Developer ID Application: Spotify (2FNC3A47ZF)',\n    '500,Developer\
    \ ID Application: The Browser Company of New York Inc. (S6N382Y83G)',\n    '500,Developer\
    \ ID Application: Valve Corporation (MXGJJ98X76)',\n    '500,Developer ID Application:\
    \ Zoom Video Communications, Inc. (BJ4HAAB9B3)',\n    '500,Developer ID Application:\
    \ Zwift, Inc (C2GM8Y9VFM)',\n    '500,Software Signing'\n  )\n  AND NOT (\n  \
    \  unsigned_exception = '500,6,80,main,main'\n    AND p0.path LIKE '/var/folders/%/T/go-build%/b001/exe/main'\n\
    \  )\n  AND NOT (\n    unsigned_exception = '500,6,443,.Telegram-wrapped,.Telegram-wrapped'\n\
    \    AND p0.path LIKE '/nix/store/%-telegram-desktop-%/Applications/Telegram.app/Contents/MacOS/Telegram'\n\
    \  )\n  -- port 0 means the connection has come and gone since the original process_open_sockets\
    \ entry\n  AND NOT unsigned_exception IN (\n    '500,0,0,,',\n    '500,0,0,.Telegram-wrapped,.Telegram-wrapped',\n\
    \    '500,0,0,chainlink,chainlink',\n    '500,0,0,git,git',\n    '500,6,22,ssh,ssh',\n\
    \    '500,0,0,gvproxy,gvproxy',\n    '500,0,0,jspawnhelper,jspawnhelper',\n  \
    \  '500,0,0,Python,Python',\n    '500,17,0,com.adguard.mac.adguard.network-extension,com.adguard.mac.adguard.network-extension',\n\
    \    '500,17,0,limactl,limactl',\n    '500,17,123,gvproxy,gvproxy',\n    '500,17,123,crc,crc',\n\
    \    '500,17,443,,',\n    '500,17,53,gvproxy,gvproxy',\n    '500,6,0,fuscript,fuscript',\n\
    \    '500,6,0,gvproxy,gvproxy',\n    '500,6,32768,cloud_sql_proxy,cloud_sql_proxy',\n\
    \    '500,6,32768,gvproxy,gvproxy',\n    '500,6,443,,',\n    '500,6,443,.Telegram-wrapped,.Telegram-wrapped',\n\
    \    '500,6,443,chainlink,chainlink',\n    '500,6,443,cloud_sql_proxy,cloud_sql_proxy',\n\
    \    '500,6,443,gvproxy,gvproxy',\n    '500,6,5223,apsd,apsd',\n    '500,6,5228,,',\n\
    \    '500,6,5228,Google Chrome for Testing Helper,Google Chrome for Testing Helper',\n\
    \    '500,6,80,.Telegram-wrapped,.Telegram-wrapped',\n    '500,6,80,chainlink,chainlink',\n\
    \    '500,6,8080,Python,Python',\n    '500,6,90,java,java',\n    '500,6,9418,git,git',\n\
    \    '500,6,32768,.limactl-wrapped,.limactl-wrapped'\n  )\n  AND NOT unsigned_exception\
    \ LIKE '500,6,%,firefox,firefox'\nGROUP BY\n  p0.cmdline\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
