- name: CDK - Unexpected Https Macos
  description: Unexpected programs communicating over HTTPS (state-based)
  query: "SELECT\n  pos.protocol,\n  pos.local_port,\n  pos.remote_port,\n  pos.remote_address,\n\
    \  pos.local_port,\n  pos.local_address,\n  CONCAT (\n    MIN(p0.euid, 500),\n\
    \    ',',\n    REGEX_MATCH (p0.path, '.*/(.*?)$', 1),\n    ',',\n    p0.name,\n\
    \    ',',\n    s.authority,\n    ',',\n    s.identifier\n  ) AS exception_key,\n\
    \  CONCAT (\n    MIN(p0.euid, 500),\n    ',',\n    REGEX_MATCH (p0.path, '.*/(.*?)$',\
    \ 1),\n    ',',\n    p0.name,\n    ',',\n    MIN(f.uid, 500),\n    'u,',\n   \
    \ MIN(f.gid, 500),\n    'g'\n  ) AS alt_exception_key,\n  -- Child\n  p0.pid AS\
    \ p0_pid,\n  p0.path AS p0_path,\n  s.authority AS p0_sauth,\n  s.identifier AS\
    \ p0_sid,\n  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n\
    \  p0.euid AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent\
    \ AS p1_pid,\n  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n\
    \  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n \
    \ p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  process_open_sockets pos\n\
    \  LEFT JOIN processes p0 ON pos.pid = p0.pid\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent\
    \ = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n  LEFT JOIN file\
    \ f ON p0.path = f.path\n  LEFT JOIN signature s ON p0.path = s.path\nWHERE\n\
    \  pos.protocol IN (6, 17)\n  AND pos.remote_port = 443\n  AND pos.remote_address\
    \ NOT IN ('127.0.0.1', '::ffff:127.0.0.1', '::1')\n  AND pos.remote_address NOT\
    \ LIKE 'fe80:%'\n  AND pos.remote_address NOT LIKE '127.%'\n  AND pos.remote_address\
    \ NOT LIKE '192.168.%'\n  AND pos.remote_address NOT LIKE '172.1%'\n  AND pos.remote_address\
    \ NOT LIKE '172.2%'\n  AND pos.remote_address NOT LIKE '172.30.%'\n  AND pos.remote_address\
    \ NOT LIKE '172.31.%'\n  AND pos.remote_address NOT LIKE '::ffff:172.%'\n  AND\
    \ pos.remote_address NOT LIKE '10.%'\n  AND pos.remote_address NOT LIKE '::ffff:10.%'\n\
    \  AND pos.remote_address NOT LIKE 'fdfd:%'\n  AND pos.remote_address NOT LIKE\
    \ 'fc00:%'\n  AND pos.state != 'LISTEN' -- Ignore most common application paths\n\
    \  AND p0.path NOT LIKE '/Applications/%.app/Contents/%'\n  AND p0.path NOT LIKE\
    \ '/Library/Apple/System/Library/%'\n  AND p0.path NOT LIKE '/Library/Application\
    \ Support/%/Contents/%'\n  AND p0.path NOT LIKE '/opt/%'\n  AND p0.path NOT LIKE\
    \ '/private/var/folders/%/go-build%/%' -- Apple programs running from weird places,\
    \ like the UpdateBrainService\n  AND p0.path NOT LIKE '/System/%'\n  AND p0.path\
    \ NOT LIKE '/System/Applications/%'\n  AND p0.path NOT LIKE '/System/Library/%'\n\
    \  AND p0.path NOT LIKE '/Users/%/bin/%'\n  AND p0.path NOT LIKE '/Users/%/code/%'\n\
    \  AND p0.path NOT LIKE '/Users/%/Library/%.app/Contents/MacOS/%'\n  AND p0.path\
    \ NOT LIKE '/Users/%/Library/Caches/JetBrains/%/tmp/GoLand/___%'\n  AND p0.path\
    \ NOT LIKE '/Users/%/src/%'\n  AND p0.path NOT LIKE '/usr/libexec/%'\n  AND p0.path\
    \ NOT LIKE '/usr/local/kolide-k2/%'\n  AND p0.path NOT LIKE '/usr/sbin/%'\n  AND\
    \ p0.path NOT LIKE '/nix/var/nix/profiles/default/bin/%'\n  AND p0.path NOT LIKE\
    \ '/nix/store/%/bin/%'\n  AND NOT (\n    s.identifier LIKE 'com.apple.%'\n   \
    \ AND s.authority = 'Software Signing'\n  )\n  AND NOT exception_key IN (\n  \
    \  '0,AGSService,AGSService,Developer ID Application: Adobe Inc. (JQ525L2MZD),com.adobe.ags',\n\
    \    '0,at.obdev.littlesnitch.networkextension,at.obdev.littlesnitch.networkextension,Developer\
    \ ID Application: Objective Development Software GmbH (MLZF7K7B5R),at.obdev.littlesnitch.networkextension',\n\
    \    '0,chainctl,chainctl,,a.out',\n    '0,com.nordvpn.macos.helper,com.nordvpn.macos.helper,Developer\
    \ ID Application: Nordvpn S.A. (W5W395V82Y),com.nordvpn.macos.helper',\n    '0,licenseDaemon,licenseDaemon,Developer\
    \ ID Application: PACE Anti-Piracy, Inc. (TFZ8226T6X),com.paceap.eden.licenseDaemon',\n\
    \    '500,.Telegram-wrapped,.Telegram-wrapped,,Telegram',\n    '500,agent,agent,Developer\
    \ ID Application: Datadog, Inc. (JKFCB4CN7C),agent',\n    '500,apko,apko,,a.out',\n\
    \    '500,apkoaas,apkoaas,,a.out',\n    '500,Arc Helper,Arc Helper,Developer ID\
    \ Application: The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.browser.helper',\n\
    \    '500,art,art,,a.out',\n    '500,art,art,,a.out',\n    '500,Authy,Authy,Apple\
    \ iPhone OS Application Signing,com.authy',\n    '500,bash,bash,,bash',\n    '500,cloud_sql_proxy,cloud_sql_proxy,,a.out',\n\
    \    '500,com.docker.backend,com.docker.backend,Developer ID Application: Docker\
    \ Inc (9BNSXJN65R),com.docker.docker',\n    '500,com.docker.build,com.docker.build,Developer\
    \ ID Application: Docker Inc (9BNSXJN65R),com.docker',\n    '500,copilot-language-server,copilot-language-server,Developer\
    \ ID Application: GitHub (VEKTX9H2N7),copilot-language-server',\n    '500,core,core,Developer\
    \ ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',\n\
    \    '500,CrossyRoad,CrossyRoad,Apple iPhone OS Application Signing,com.hipsterwhale.crossy',\n\
    \    '500,Fleet,~/Library/Caches/JetBrains/Fleet',\n    '500,codebook-lsp,codebook-lsp,500u,20g',\n\
    \    '500,gh,gh,,gh',\n    '500,git-remote-http,git-remote-http,,git-remote-http-55554944748a32c47cdc35cfa7f071bb69a39ce4',\n\
    \    '500,goland,goland,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.goland',\n\
    \    '500,IterableRichNotifications,IterableRichNotifications,Apple iPhone OS\
    \ Application Signing,com.plexapp.plex.IterableRichNotifications',\n    '500,Java\
    \ Updater,Java Updater,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.Java-Updater',\n\
    \    '500,java,java,Developer ID Application: Azul Systems, Inc. (TDTHCUPYFR),com.azul.zulu.java',\n\
    \    '500,java,java,Developer ID Application: Oracle America, Inc. (VB5E2TV963),com.oracle.java.8u401.java',\n\
    \    '500,jcef Helper,jcef Helper,Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3),org.jcef.jcef.helper',\n\
    \    '500,Kindle,Kindle,TestFlight Beta Distribution,com.amazon.Lassen',\n   \
    \ '500,krisp Helper,krisp Helper,Developer ID Application: Krisp Technologies,\
    \ Inc. (U5R26XM5Z2),ai.krisp.krispMac.helper',\n    '500,krisp,krisp,Developer\
    \ ID Application: Krisp Technologies, Inc. (U5R26XM5Z2),ai.krisp.krispMac',\n\
    \    '500,kubectl,kubectl,Developer ID Application: Docker Inc (9BNSXJN65R),kubectl',\n\
    \    '500,melange,melange,,a.out',\n    '500,nami,nami,,a.out',\n    '500,ngrok,ngrok,Developer\
    \ ID Application: ngrok LLC (TEX8MHRDQ9),a.out',\n    '500,node,node,Developer\
    \ ID Application: Node.js Foundation (HX7739G8FX),node',\n    '500,odo-darwin-amd64-b4853e1fa,odo-darwin-amd64-b4853e1fa,500u,20g',\n\
    \    '500,Paintbrush,Paintbrush,Developer ID Application: Michael Schreiber (G966ML7VBG),com.soggywaffles.paintbrush',\n\
    \    '500,Plex,Plex,Developer ID Application: Plex Inc. (K4QJ56KR4A),tv.plex.desktop',\n\
    \    '500,PlexMobile,PlexMobile,Apple iPhone OS Application Signing,com.plexapp.plex',\n\
    \    '500,podman,podman,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2),podman',\n\
    \    '500,PowerPoint,PowerPoint,Apple Development: Zack Hoherchak (SS9PSPF8UF),PowerPoint',\n\
    \    '500,process-agent,process-agent,Developer ID Application: Datadog, Inc.\
    \ (JKFCB4CN7C),process-agent',\n    '500,proctor,proctor,,a.out',\n    '500,pycharm,pycharm,Developer\
    \ ID Application: JetBrains s.r.o. (2ZEFAR8TH3),com.jetbrains.pycharm',\n    '500,Realm,Realm,Apple\
    \ iPhone OS Application Signing,camera.youpi.metareal',\n    '500,sdaudioswitch,sdaudioswitch,,sdaudioswitch',\n\
    \    '500,Signal Helper (Renderer),Signal Helper (Renderer),500u,20g',\n    '500,Skitch,Skitch,Developer\
    \ ID Application: Skitch Inc (J8RPQ294UB),com.skitch.skitch',\n    '500,Sky Go,Sky\
    \ Go,Developer ID Application: Sky UK Limited (GJ24C8864F),com.bskyb.skygoplayer',\n\
    \    '500,snyk-ls_darwin_arm64,snyk-ls_darwin_arm64,,a.out',\n    '500,syncthing,syncthing,,syncthing',\n\
    \    '500,TextExpander,TextExpander,Developer ID Application: SmileOnMyMac, LLC\
    \ (7PKJ6G4DXL),com.smileonmymac.textexpander',\n    '500,trunk,trunk,Developer\
    \ ID Application: Trunk Technologies, Inc. (LDR5F9BL92),trunk-cli',\n    '500,WebexHelper,WebexHelper,Developer\
    \ ID Application: Cisco (DE8Y96K9QP),Cisco-Systems.SparkHelper',\n    '500,zed,zed,Developer\
    \ ID Application: Zed Industries, Inc. (MQ55VZLNZQ),dev.zed.Zed'\n  )\n  AND NOT\
    \ alt_exception_key IN (\n    '0,velociraptor,velociraptor,0u,0g',\n    '500,sdaudioswitch,sdaudioswitch,500u,0g',\n\
    \    '500,Python,Python,0u,80g',\n    '0,nix,nix,0u,350g',\n    '0,velociraptor,velociraptor,0u,80g'\n\
    \  )\n  AND NOT alt_exception_key LIKE '500,%,500u,20g'\n  AND NOT alt_exception_key\
    \ LIKE '500,%,0u,0g'\n\n  AND NOT s.authority IN (\n    'Developer ID Application:\
    \ Adguard Software Limited (TC3Q7MAJXF)',\n    'Developer ID Application: Adobe\
    \ Inc. (JQ525L2MZD)',\n    'Developer ID Application: AgileBits Inc. (2BUA8C4S2C)',\n\
    \    'Developer ID Application: AMZN Mobile LLC (94KV3E626L)',\n    'Developer\
    \ ID Application: Bookry Ltd (4259LE8SU5)',\n    'Developer ID Application: ANCHORE,\
    \ INC. (9MJHKYX5AT)',\n    'Developer ID Application: Autodesk (XXKJ396S2Y)',\n\
    \    'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',\n    'Developer\
    \ ID Application: Brave Software, Inc. (KL8N8XSYF4)',\n    'Developer ID Application:\
    \ Canonical Group Limited (X4QN7LTP59)',\n    'Developer ID Application: Corsair\
    \ Memory, Inc. (Y93VXCB8Q5)',\n    'Developer ID Application: Determinate Systems,\
    \ Inc. (X3JQ4VPJZ6)',\n    'Developer ID Application: Denver Technologies, Inc\
    \ (2BBY89MBSN)',\n    'Developer ID Application: Determinate Systems, Inc. (X3JQ4VPJZ6)',\n\
    \    'Developer ID Application: Docker Inc (9BNSXJN65R)',\n    'Developer ID Application:\
    \ Ecamm Network, LLC (5EJH68M642)',\n    'Developer ID Application: Elasticsearch,\
    \ Inc (2BT3HPN62Z)',\n    'Developer ID Application: Farhan Ahmed (4RZN52RN5P)',\n\
    \    'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',\n    'Developer ID\
    \ Application: GitHub (VEKTX9H2N7)',\n    'Developer ID Application: Google LLC\
    \ (EQHXZ8M8AV)',\n    'Developer ID Application: Hashicorp, Inc. (D38WU7D763)',\n\
    \    'Developer ID Application: Kandji, Inc. (P3FGV63VK7)',\n    'Developer ID\
    \ Application: Kolide, Inc (X98UFR7HA3)',\n    'Developer ID Application: Logitech\
    \ Inc. (QED4VVPZWA)',\n    'Developer ID Application: Michael Schreiber (G966ML7VBG)',\n\
    \    'Developer ID Application: Microsoft Corporation (UBF8T346G9)',\n    'Developer\
    \ ID Application: Oracle America, Inc. (VB5E2TV963)',\n    'Developer ID Application:\
    \ Panic, Inc. (VE8FC488U5)',\n    'Developer ID Application: PSI Services LLC\
    \ (73AT498HPV)',\n    'Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',\n\
    \    'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',\n    'Developer ID Application:\
    \ Reflect App, LLC (789ULN5MZB)',\n    'Developer ID Application: Slack Technologies,\
    \ Inc. (BQR82RBBHL)',\n    'Developer ID Application: SLACK TECHNOLOGIES L.L.C.\
    \ (BQR82RBBHL)',\n    'Developer ID Application: Spotify (2FNC3A47ZF)',\n    'Developer\
    \ ID Application: SteelSeries (6WGL6CHFH2)',\n    'Developer ID Application: Sublime\
    \ HQ Pty Ltd (Z6D26JE4Y4)',\n    'Developer ID Application: Tailscale Inc. (W5364U7YZB)',\n\
    \    'Developer ID Application: TechSmith Corporation (7TQL462TU8)',\n    'Developer\
    \ ID Application: Tenable, Inc. (4B8J598M7U)',\n    'Developer ID Application:\
    \ The Browser Company of New York Inc. (S6N382Y83G)',\n    'Developer ID Application:\
    \ Valve Corporation (MXGJJ98X76)',\n    'Developer ID Application: Zoom Video\
    \ Communications, Inc. (BJ4HAAB9B3)',\n    'Developer ID Application: Zwift, Inc\
    \ (C2GM8Y9VFM)'\n  )\nGROUP BY\n  p0.cmdline\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
