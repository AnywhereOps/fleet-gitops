- name: CDK - Minimal Socket Client Macos
  description: Slow query to find root programs with an open socket and few shared
    libraries
  query: "SELECT\n  p.uid,\n  p.euid,\n  pos.protocol,\n  pos.pid,\n  pos.remote_address,\n\
    \  pos.local_address,\n  pos.local_port,\n  pos.remote_port,\n  p.name,\n  p.start_time,\n\
    \  p.parent,\n  p.cgroup_path,\n  p.path,\n  pos.state,\n  GROUP_CONCAT(DISTINCT\
    \ pmm.path) AS libs,\n  COUNT(DISTINCT pmm.path) AS lib_count,\n  CONCAT (\n \
    \   MIN(p.euid, 500),\n    ',',\n    p.name,\n    ',',\n    REPLACE(p.path, u.directory,\
    \ '~'),\n    s.authority\n  ) AS exception_key\nFROM\n  processes p\n  JOIN process_memory_map\
    \ pmm ON p.pid = pmm.pid\n  JOIN process_open_sockets pos ON p.pid = pos.pid\n\
    \  LEFT JOIN file f ON p.path = f.path\n  LEFT JOIN users u ON f.uid = u.uid\n\
    \  LEFT JOIN signature s ON p.path = s.path\nWHERE\n  p.pid IN (\n    SELECT\n\
    \      processes.pid\n    FROM\n      process_open_sockets\n      JOIN processes\
    \ ON process_open_sockets.pid = processes.pid\n      AND family != 1 -- The outer\
    \ query is slow due to the use of process_memory_map, so narrow down our choices\
    \ here\n    WHERE\n      processes.path NOT LIKE '/Library/Apple/%'\n      AND\
    \ processes.path NOT LIKE '/Library/Elastic/Agent/data/%'\n      AND processes.path\
    \ NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'\n      AND processes.path\
    \ NOT LIKE '/private/var/kolide-k2/k2device.kolide.com/updates/%.app/Contents/MacOS/%'\n\
    \      AND processes.path NOT LIKE '/sbin/%'\n      AND processes.path NOT LIKE\
    \ '/System/%'\n      AND processes.path NOT LIKE '/usr/bin/%'\n      AND processes.path\
    \ NOT LIKE '/usr/libexec/%'\n      AND processes.path NOT LIKE '/usr/sbin/%'\n\
    \      AND NOT (\n        processes.euid >= 500\n        AND (\n          processes.path\
    \ LIKE '/Applications/%.app/Contents/Frameworks/%/Contents/MacOS/%'\n        \
    \  OR processes.path LIKE '/Applications/%.app/Contents/MacOS/%'\n          OR\
    \ processes.path LIKE '/nix/store/%/bin/nix'\n          OR processes.path LIKE\
    \ '/opt/%/bin/%'\n          OR processes.path LIKE '/private/var/folders/%/X/com.google.Chrome.code_sign_clone/code_sign_clone%'\n\
    \          OR processes.path LIKE '/Users/%/Applications/zoom.us.app/Contents/MacOS/zoom.us'\n\
    \          OR processes.path LIKE '/Users/%/go/bin/%'\n          OR processes.path\
    \ LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/%'\n\
    \          OR processes.path LIKE '/Users/%/Library/Application Support/Figma/FigmaAgent.app/Contents/MacOS/figma_agent'\n\
    \          OR processes.path LIKE '/Users/%/Library/Application Support/Steam/Steam.AppBundle/Steam/Contents/%'\n\
    \          OR processes.path IN (\n            '/Applications/AirBuddy.app/Contents/Library/LoginItems/AirBuddyHelper.app/Contents/XPCServices/MobileDevicesService.xpc/Contents/MacOS/MobileDevicesService',\n\
    \            '/Applications/Elgato Stream Deck.app/Contents/Helpers/node20',\n\
    \            '/Applications/GoLand.app/Contents/plugins/go-plugin/lib/dlv/macarm/dlv',\n\
    \            '/Applications/Google Drive.app/Contents/Applications/FinderHelper.app/Contents/PlugIns/FinderSyncExtension.appex/Contents/MacOS/FinderSyncExtension',\n\
    \            '/Applications/Google Drive.app/Contents/PlugIns/DFSFileProviderExtension.appex/Contents/MacOS/DFSFileProviderExtension',\n\
    \            '/Applications/lghub.app/Contents/MacOS/lghub_updater.app/Contents/MacOS/lghub_updater',\n\
    \            '/Applications/Loom.app/Contents/Resources/binaries/loom-recorder-production',\n\
    \            '/Applications/Ollama.app/Contents/Resources/ollama',\n         \
    \   '/Applications/Rancher Desktop.app/Contents/Resources/resources/darwin/lima/bin/limactl.ventura',\n\
    \            '/Applications/Rancher Desktop.app/Contents/Resources/resources/darwin/lima/bin/qemu-system-aarch64',\n\
    \            '/Applications/Syncthing.app/Contents/Resources/syncthing/syncthing',\n\
    \            '/Library/Application Support/Adobe/Adobe Desktop Common/ADS/Adobe\
    \ Desktop Service.app/Contents/MacOS/Adobe Desktop Service',\n            '/Library/Application\
    \ Support/Adobe/Adobe Desktop Common/IPCBox/AdobeIPCBroker.app/Contents/MacOS/AdobeIPCBroker',\n\
    \            '/Library/Application Support/Kandji/Kandji Menu/Kandji Menu.app/Contents/MacOS/Kandji\
    \ Menu',\n            '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/Frameworks/logioptionsplus_updater.app/Contents/MacOS/logioptionsplus_updater',\n\
    \            '/Library/Application Support/Logitech.localized/LogiOptionsPlus/logioptionsplus_agent.app/Contents/MacOS/logioptionsplus_agent',\n\
    \            '/Library/Developer/CommandLineTools/Library/PrivateFrameworks/LLDB.framework/Versions/A/Resources/debugserver',\n\
    \            '/Library/Frameworks/Python.framework/Versions/3.10/Resources/Python.app/Contents/MacOS/Python',\n\
    \            '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Daemon.app/Contents/MacOS/kandji-daemon',\n\
    \            '/Library/Printers/Brother/Utilities/Server/NETserver.app/Contents/MacOS/NETserver',\n\
    \            '/Library/Printers/Brother/Utilities/Server/USBAppControl.app/Contents/MacOS/USBAppControl',\n\
    \            '/Library/Printers/Brother/Utilities/Server/WorkflowAppControl.app/Contents/MacOS/WorkflowAppControl',\n\
    \            '/usr/local/bin/node',\n            '/Volumes/Google Chrome/Google\
    \ Chrome.app/Contents/MacOS/Google Chrome',\n            '/Volumes/Slack/Slack.app/Contents/Frameworks/Slack\
    \ Helper.app/Contents/MacOS/Slack Helper'\n          )\n        )\n      ) --\
    \ uid0-499 exceptions\n      AND NOT processes.path IN (\n        '/Applications/Tailscale.app/Contents/PlugIns/IPNExtension.appex/Contents/MacOS/IPNExtension',\n\
    \        '/Applications/WiFiman Desktop.app/Contents/service/wifiman-desktopd',\n\
    \        '/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint',\n\
    \        '/Library/Kandji/Kandji Agent.app/Contents/Helpers/Kandji Daemon.app/Contents/MacOS/kandji-daemon',\n\
    \        '/Library/safeqclientcore/bin/safeqclientcore',\n        '/usr/local/sbin/velociraptor'\n\
    \      )\n      AND processes.start_time < (strftime('%s', 'now') -600)\n    GROUP\
    \ BY\n      processes.path\n  )\n  AND NOT exception_key = '500,Steam Helper,~/Library/Application\
    \ Support/Steam/Steam.AppBundle/Steam/Contents/MacOS/Frameworks/Steam Helper.app/Contents/MacOS/Steam\
    \ HelperDeveloper ID Application: Valve Corporation (MXGJJ98X76)'\n  AND NOT exception_key\
    \ LIKE '500,python3.%,~/miniconda/envs/skilljar-api/bin/python3.%'\n  AND pmm.path\
    \ LIKE \"%.dylib\"\nGROUP BY\n  pos.pid\nHAVING\n  lib_count IN (1, 2)\n  AND\
    \ libs NOT LIKE '/Applications/%/Contents/Frameworks/Electron Framework.framework/Versions/A/Libraries/libffmpeg.dylib,/usr/lib/libobjc-trampolines.dylib'\n\
    \  AND libs NOT LIKE '/usr/lib/libobjc-trampolines.dylib,/Applications/%.app/Contents/Frameworks/Electron\
    \ Framework.framework/Versions/A/Libraries/libffmpeg.dylib'\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
