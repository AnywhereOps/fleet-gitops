- name: CDK - Unexpected Listening Port Macos
  description: Unexpected programs listening on a TCP port.
  query: "SELECT\n  lp.address,\n  lp.port,\n  lp.protocol,\n  p.uid,\n  p.pid,\n\
    \  p.name,\n  p.path,\n  p.cmdline,\n  p.cwd,\n  hash.sha256,\n  signature.authority\
    \ AS program_authority,\n  CONCAT (\n    MIN(lp.port, 49152),\n    ',',\n    lp.protocol,\n\
    \    ',',\n    MIN(p.uid, 500),\n    ',',\n    p.name,\n    ',',\n    signature.authority\n\
    \  ) AS exception_key\nFROM\n  listening_ports lp\n  LEFT JOIN processes p ON\
    \ lp.pid = p.pid\n  LEFT JOIN hash ON p.path = hash.path\n  LEFT JOIN signature\
    \ ON p.path = signature.path\nWHERE\n  port != 0\n  AND lp.address NOT IN ('224.0.0.251',\
    \ '::1')\n  AND lp.address NOT LIKE '127.0.0.%'\n  AND lp.address NOT LIKE '172.1%'\n\
    \  AND lp.address NOT LIKE 'fe80::%'\n  AND lp.address NOT LIKE '::ffff:127.0.0.%'\
    \ -- All outgoing UDP (protocol 17) sessions are 'listening'\n  AND NOT (\n  \
    \  lp.protocol = 17\n    AND lp.port > 1024\n  ) -- Random webservers\n  AND NOT\
    \ (\n    p.uid > 500\n    AND lp.port IN (8000, 8080)\n    AND lp.protocol = 6\n\
    \  ) -- Filter out unmapped raw sockets\n  AND NOT (p.pid = '') -- Exceptions:\
    \ the uid is capped at 500 to represent regular users versus system users\n  --\
    \ port is capped at 49152 to represent transient ports\n  AND NOT exception_key\
    \ IN (\n    '10011,6,0,launchd,Software Signing',\n    '10011,6,0,webfilterproxyd,Software\
    \ Signing',\n    '1024,6,0,systemmigrationd,Software Signing',\n    '111,17,1,rpcbind,Software\
    \ Signing',\n    '111,6,1,rpcbind,Software Signing',\n    '1144,6,500,fuscript,',\n\
    \    '1234,6,500,qemu-system-aarch64,',\n    '1313,6,500,hugo,',\n    '1338,6,500,ec2-metadata-mock,',\n\
    \    '1338,6,500,registry,',\n    '13618,6,500,BambuStudio,Developer ID Application:\
    \ Shanghai Lunkuo Technology Co., Ltd (T3UBR9Y3B2)',\n    '137,17,0,launchd,Software\
    \ Signing',\n    '137,17,222,netbiosd,',\n    '137,17,222,netbiosd,Software Signing',\n\
    \    '138,17,0,launchd,Software Signing',\n    '138,17,222,netbiosd,Software Signing',\n\
    \    '2112,6,500,fake,',\n    '2112,6,500,rekor-server,',\n    '2112,6,500,timestamp-server,',\n\
    \    '22,6,0,launchd,Software Signing',\n    '22,6,500,com.docker.backend,Developer\
    \ ID Application: Docker Inc (9BNSXJN65R)',\n    '22000,6,500,syncthing,',\n \
    \   '2345,6,500,dlv,',\n    '24678,6,500,node,',\n    '24800,6,500,deskflow-server,',\n\
    \    '25565,6,500,java,',\n    '3306,6,500,mariadbd,',\n    '33333,6,500,Ultimate,',\n\
    \    '4001,6,500,ipfs,',\n    '41949,6,500,IPNExtension,Apple Mac OS Application\
    \ Signing',\n    '43398,6,500,IPNExtension,Apple Mac OS Application Signing',\n\
    \    '443,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',\n\
    \    '443,6,500,crc,Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',\n \
    \   '443,6,500,limactl,',\n    '443,6,500,OrbStack Helper,Developer ID Application:\
    \ Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',\n    '443,6,500,ssh,Software Signing',\n\
    \    '45972,6,500,IPNExtension,Apple Mac OS Application Signing',\n    '49152,6,0,AirPlayXPCHelper,Software\
    \ Signing',\n    '49152,6,0,launchd,Software Signing',\n    '49152,6,0,remoted,Software\
    \ Signing',\n    '49152,6,0,remotepairingdeviced,Software Signing',\n    '49152,6,0,webfilterproxyd,Software\
    \ Signing',\n    '49152,6,500,AUHostingServiceXPC_arrow,Software Signing',\n \
    \   '49152,6,500,barrier',\n    '49152,6,500,ChatGPT,Developer ID Application:\
    \ OpenAI, L.L.C. (2DC432GLL2)',\n    '49152,6,500,ContinuityCaptureAgent,Software\
    \ Signing',\n    '49152,6,500,curl,Software Signing',\n    '49152,6,500,GarageBand,Apple\
    \ Mac OS Application Signing',\n    '49152,6,500,git-daemon,',\n    '49152,6,500,HP\
    \ Smart,Apple Mac OS Application Signing',\n    '49152,6,500,IPNExtension,Apple\
    \ Mac OS Application Signing',\n    '49152,6,500,java,',\n    '49152,6,500,java,Developer\
    \ ID Application: Azul Systems, Inc. (TDTHCUPYFR)',\n    '49152,6,500,Logic Pro\
    \ X,Apple Mac OS Application Signing',\n    '49152,6,500,Music,Software Signing',\n\
    \    '49152,6,500,node,',\n    '49152,6,500,OmniFocus,Apple Mac OS Application\
    \ Signing',\n    '49152,6,500,org.mozilla.updater,Developer ID Application: Mozilla\
    \ Corporation (43AQ936H96)',\n    '49152,6,500,pCloud Drive,Developer ID Application:\
    \ PCLOUD LTD (KSTWHH4JHP)',\n    '49152,6,500,qemu-system-aarch64,',\n    '49152,6,500,rapportd,Software\
    \ Signing',\n    '49152,6,500,siriactionsd,Software Signing',\n    '49152,6,500,telepresence,',\n\
    \    '49152,6,65,mDNSResponder,Software Signing',\n    '5000,6,500,ControlCenter,Software\
    \ Signing',\n    '5001,6,500,crane,',\n    '5001,6,500,Record It,Apple Mac OS\
    \ Application Signing',\n    '5060,6,500,CommCenter,Software Signing',\n    '53,17,500,dnsmasq,',\n\
    \    '53,17,500,server,',\n    '53,17,65,mDNSResponder,',\n    '53,17,65,mDNSResponder,Software\
    \ Signing',\n    '53,6,500,dnsmasq,',\n    '53,6,65,mDNSResponder,Software Signing',\n\
    \    '5432,6,500,postgres',\n    '5433,6,500,postgres',\n    '546,17,0,configd,Software\
    \ Signing',\n    '547,17,500,dhcp6d,',\n    '547,17,500,dhcp6d,Software Signing',\n\
    \    '5900,6,0,launchd,Software Signing',\n    '5900,6,0,screensharingd,Software\
    \ Signing',\n    '6000,6,500,X11.bin,Developer ID Application: Apple Inc. - XQuartz\
    \ (NA574AWV7E)',\n    '631,6,0,cupsd,Software Signing',\n    '6650,6,500,java,',\n\
    \    '67,17,0,bootpd,Software Signing',\n    '67,17,0,launchd,Software Signing',\n\
    \    '68,17,0,configd,Software Signing',\n    '7000,6,500,ControlCenter,Software\
    \ Signing',\n    '773,17,0,startupdiskhelper,Software Signing',\n    '80,6,500,com.docker.backend,',\n\
    \    '80,6,500,com.docker.backend,Developer ID Application: Docker Inc (9BNSXJN65R)',\n\
    \    '80,6,500,crc,',\n    '80,6,500,crc,Developer ID Application: Red Hat, Inc.\
    \ (HYSCB8KRL2)',\n    '80,6,500,limactl,',\n    '80,6,500,OrbStack Helper,Developer\
    \ ID Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)',\n    '80,6,500,ssh,Software\
    \ Signing',\n    '8055,6,500,java,',\n    '8081,6,500,crane,',\n    '8082,6,500,java,',\n\
    \    '81,6,500,nginx,',\n    '8770,6,500,sharingd,Software Signing',\n    '8771,6,500,sharingd,Software\
    \ Signing',\n    '88,17,0,kdc,Software Signing',\n    '88,6,0,kdc,Software Signing',\n\
    \    '8888,6,500,otel-desktop-viewer,',\n    '9101,6,500,github_actions_exporter,'\n\
    \  )\n  AND NOT exception_key LIKE '%,0,rpc.%,Software Signing'\n  AND NOT (\n\
    \    lp.port > 1024\n    AND lp.protocol = 6\n    -- NOTE: Do not include 'Software\
    \ Signing' in this list, as it may\n    -- hide unanticipated uses of system utilities,\
    \ like Screen Saharing.\n    AND signature.authority IN (\n      'Apple Development:\
    \ Jakub Gluszkiewicz (2LC3SFDY52)',\n      'Developer ID Application: Adguard\
    \ Software Limited (TC3Q7MAJXF)',\n      'Developer ID Application: Apple Inc.\
    \ - XQuartz (NA574AWV7E)',\n      'Developer ID Application: ARDUINO SA (7KT7ZWMCJT)',\n\
    \      'Developer ID Application: Astro HQ LLC (8356ZZ8Y5K)',\n      'Developer\
    \ ID Application: Blackmagic Design Inc (9ZGFBWLSYP)',\n      'Developer ID Application:\
    \ Bohemian Coding (WUGMZZ5K46)',\n      'Developer ID Application: Brother Industries,\
    \ LTD. (5HCL85FLGW)',\n      'Developer ID Application: Canon Electronics Inc.\
    \ (MKRQ6AC8Z5)',\n      'Developer ID Application: Capture One A/S (5WTDB5F65L)',\n\
    \      'Developer ID Application: Cisco (DE8Y96K9QP)',\n      'Developer ID Application:\
    \ CORE.AI SCIENTIFIC TECHNOLOGIES PRIVATE LIMITED (8F632A866K)',\n      'Developer\
    \ ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',\n      'Developer ID Application:\
    \ Cypress.Io, Inc. (7D655LWGLY)',\n      'Developer ID Application: DBeaver Corporation\
    \ (42B6MDKMW8)',\n      'Developer ID Application: Docker Inc (9BNSXJN65R)',\n\
    \      'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',\n      'Developer\
    \ ID Application: Duet, Inc. (J6L96W8A86)',\n      'Developer ID Application:\
    \ Ecamm Network, LLC (5EJH68M642)',\n      'Developer ID Application: Eclipse\
    \ Foundation, Inc. (JCDTMS22B4)',\n      'Developer ID Application: EnterpriseDB\
    \ Corporation (26QKX55P9K)',\n      'Developer ID Application: EXAFUNCTION, INC.\
    \ (83Z2LHX6XW)',\n      'Developer ID Application: Focusrite Audio Engineering\
    \ Ltd. (7VYBQV3T2Q)',\n      'Developer ID Application: Jakob Borg (LQE5SYM783)',\n\
    \      'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',\n      'Developer\
    \ ID Application: Kastelo AB (LQE5SYM783)',\n      'Developer ID Application:\
    \ Linear Orbit, Inc. (7VZ2S3V9RV)',\n      'Developer ID Application: Logitech\
    \ Inc. (QED4VVPZWA)',\n      'Developer ID Application: Loupedeck Oy (M24R8BN5BK)',\n\
    \      'Developer ID Application: Martijn Smit (GX645XXEAX)',\n      'Developer\
    \ ID Application: Microsoft Corporation (UBF8T346G9)',\n      'Developer ID Application:\
    \ Node.js Foundation (HX7739G8FX)',\n      'Developer ID Application: Oracle America,\
    \ Inc. (VB5E2TV963)',\n      'Developer ID Application: Orbital Labs, LLC (U.S.)\
    \ (HUAQ24HBR6)',\n      'Developer ID Application: Postdot Technologies, Inc (H7H8Q7M5CK)',\n\
    \      'Developer ID Application: Quiet Riddle Ventures LLC (U68MSDN6DR)',\n \
    \     'Developer ID Application: Raycast Technologies Inc (SY64MV22J9)',\n   \
    \   'Developer ID Application: Red Hat, Inc. (HYSCB8KRL2)',\n      'Developer\
    \ ID Application: Remo Tech Co.,Ltd. (7GJANK3822)',\n      'Developer ID Application:\
    \ RescueTime, Inc (FSY4RB8H39)',\n      'Developer ID Application: Roon Labs LLC\
    \ (WU8DGC424P)',\n      'Developer ID Application: Seiko Epson Corporation (TXAEAV5RN4)',\n\
    \      'Developer ID Application: Shenzhen Arashi Vision Co., Ltd. (847R5ZLN8S)',\n\
    \      'Developer ID Application: Signal Messenger, LLC (U68MSDN6DR)',\n     \
    \ 'Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',\n      'Developer\
    \ ID Application: Sonos, Inc. (2G4LW83Q3E)',\n      'Developer ID Application:\
    \ SOURCEGRAPH INC (74A5FJ7P96)',\n      'Developer ID Application: Spotify (2FNC3A47ZF)',\n\
    \      'Developer ID Application: Symless Ltd (4HX897Y6GJ)',\n      'Developer\
    \ ID Application: Tailscale Inc. (W5364U7YZB)',\n      'Developer ID Application:\
    \ Tenable, Inc. (4B8J598M7U)',\n      'Developer ID Application: Universal Audio\
    \ (4KAC9AX6CG)',\n      'Developer ID Application: Ubiquiti Inc. (4P645293E8)',\n\
    \      'Developer ID Application: Valve Corporation (MXGJJ98X76)',\n      'Developer\
    \ ID Application: X-Rite, Incorporated (2K7GT73B4R)'\n    )\n  )\n  AND NOT (\n\
    \    exception_key LIKE '%,6,500,IPNExtension,Apple Mac OS Application Signing'\n\
    \    AND lp.port > 5000\n  )\n  AND NOT (\n    exception_key LIKE '3%,6,500,java,'\n\
    \    AND p.cwd LIKE '/Users/%'\n  )\n  AND NOT (\n    p.path LIKE ',ko-app,%'\n\
    \    AND lp.port > 1024\n    and lp.protocol = 6\n  )\n  AND NOT (\n    (\n  \
    \    p.name IN (\n        'caddy',\n        'com.docker.backend',\n        'controller',\n\
    \        'crane',\n        'crc',\n        'curl',\n        'docker-proxy',\n\
    \        'gvproxy',\n        'hugo',\n        'kubectl',\n        'node',\n  \
    \      'OrbStack Helper',\n        'ssh',\n        'webhook'\n      )\n      OR\
    \ p.name LIKE 'kubectl.%'\n      OR p.name LIKE '__%_go'\n      OR p.name LIKE\
    \ 'python3.%'\n      OR p.name LIKE 'python2.7%'\n    )\n    AND lp.port > 1024\n\
    \    and lp.protocol = 6\n  )\n  AND NOT (\n    p.path LIKE '/private/var/folders/%/go-build%/exe/%'\n\
    \    AND lp.port > 1024\n    AND lp.protocol = 6\n  )\n  AND NOT (\n    p.path\
    \ LIKE '/Users/%/Library/Caches/go-build%'\n    AND lp.port > 1024\n    AND lp.protocol\
    \ = 6\n  )\n  AND NOT (\n    (\n      p.cwd LIKE '/Users/%/src/%'\n      OR p.cwd\
    \ LIKE '/Users/%/dev/%'\n    )\n    AND p.cmdline LIKE './%'\n    AND lp.port\
    \ > 1024\n    AND lp.protocol = 6\n  )\n  AND NOT (\n    (\n      p.path = '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent'\n\
    \      AND lp.port = 3283\n      AND lp.protocol = 6\n    )\n  )\n  AND NOT (\n\
    \    p.path = '/System/Library/CoreServices/UniversalControl.app/Contents/MacOS/UniversalControl'\n\
    \    AND lp.port > 5000\n  )\n  AND NOT (\n    (\n      exception_key LIKE '80,6,500,ssh,Software\
    \ Signing'\n      AND p.cmdline LIKE '%/.colima/_lima/colima-docker/ssh.sock%'\n\
    \    )\n  )\nGROUP BY\n  exception_key\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
