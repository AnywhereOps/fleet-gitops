- name: CDK - Unexpected Launchd Program Macos
  description: Unexpected launchd scripts that use the 'program' field
  query: "SELECT\n  l.label,\n  l.name,\n  l.path,\n  l.program,\n  l.program_arguments,\n\
    \  l.keep_alive,\n  signature.authority AS program_authority,\n  signature.identifier\
    \ AS program_identifier,\n  hash.sha256\nFROM\n  launchd l\n  LEFT JOIN signature\
    \ ON l.program = signature.path\n  LEFT JOIN hash ON l.path = hash.path\nWHERE\n\
    \  (\n    run_at_load = 1\n    OR keep_alive = 1\n  )\n  AND l.path NOT LIKE '/System/%'\n\
    \  AND program IS NOT NULL\n  AND program_authority NOT IN (\n    'Developer ID\
    \ Application: Adguard Software Limited (TC3Q7MAJXF)',\n    'Developer ID Application:\
    \ Adobe Inc. (JQ525L2MZD)',\n    'Developer ID Application: Bitdefender SRL (GUNFMW623Y)',\n\
    \    'Developer ID Application: Bjango Pty Ltd (Y93TK974AT)',\n    'Developer\
    \ ID Application: Canonical Group Limited (X4QN7LTP59)',\n    'Developer ID Application:\
    \ Creative Labs Pte. Ltd. (5Q3552844F)',\n    'Developer ID Application: Docker\
    \ Inc (9BNSXJN65R)',\n    'Developer ID Application: EA Swiss Sarl (TSTV75T6Q5)',\n\
    \    'Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z)',\n    'Developer\
    \ ID Application: Expressco Services, LLC (TC292Y5427)', -- ExpressVPN, bleh.\n\
    \    'Developer ID Application: Fortinet, Inc (AH4XFXJ7DK)',\n    'Developer ID\
    \ Application: Hercules Labs Inc. (B8PC799ZGU)',\n    'Developer ID Application:\
    \ Ilya Parniuk (ACC5R6RH47)',\n    'Developer ID Application: iMobie Inc. (2QJGLWL8Y6)',\n\
    \    'Developer ID Application: Jonathan Bullard (Z2SG5H3HC8)',\n    'Developer\
    \ ID Application: Kandji, Inc. (P3FGV63VK7)',\n    'Developer ID Application:\
    \ Logitech Inc. (QED4VVPZWA)',\n    'Developer ID Application: Louis Pontoise\
    \ (QXD7GW8FHY)',\n    'Developer ID Application: Microsoft Corporation (UBF8T346G9)',\n\
    \    'Developer ID Application: Nordvpn S.A. (W5W395V82Y)',\n    'Developer ID\
    \ Application: Objective Development Software GmbH (MLZF7K7B5R)',\n    'Developer\
    \ ID Application: Oracle America, Inc. (VB5E2TV963)',\n    'Developer ID Application:\
    \ PACE Anti-Piracy, Inc. (TFZ8226T6X)',\n    'Developer ID Application: Rapid7\
    \ LLC (UL6CGN7MAL)',\n    'Developer ID Application: Rogue Amoeba Software, Inc.\
    \ (7266XEXAPM)',\n    'Developer ID Application: Signify Netherlands B.V. (PREPN2W95S)',\n\
    \    'Developer ID Application: TPZ Solucoes Digitais Ltda (X37R283V2T)',\n  \
    \  'Developer ID Application: Universal Audio (4KAC9AX6CG)',\n    'Developer ID\
    \ Application: Valve Corporation (MXGJJ98X76)',\n    'Developer ID Application:\
    \ Wireshark Foundation (7Z6EMTD2C6)',\n    'Developer ID Application: Wireshark\
    \ Foundation, Inc. (7Z6EMTD2C6)',\n    'Developer ID Application: Y Soft Corporation,\
    \ a.s. (3CPED8WGS9)',\n    'Developer ID Application: Yufu Fan (S3YBM9ALKM)',\n\
    \    'Developer ID Application: Zoom Video Communications, Inc. (BJ4HAAB9B3)',\n\
    \    'Software Signing'\n  )\n  AND program NOT IN (\n    '/usr/local/bin/warsaw/core',\n\
    \    '/usr/local/MacGPG2/libexec/shutdown-gpg-agent'\n  )\n  -- Special case:\
    \ Docker does not consistently sign their plist files (security fail)\n  AND NOT\
    \ (\n    l.path = '/Library/LaunchDaemons/com.docker.socket.plist'\n    AND program_authority\
    \ = 'Software Signing'\n    AND program_identifier IN ('com.apple.ln', 'com.apple.link')\n\
    \    AND program_arguments LIKE '/bin/ln -s -f /Users/%/run/docker.sock /var/run/docker.sock'\n\
    \  )\n  AND NOT (\n    l.path = '/Library/LaunchDaemons/com.docker.socket.plist'\n\
    \    AND program_identifier = 'com.docker'\n    AND program_authority = NULL\n\
    \    AND program = '/Library/PrivilegedHelperTools/com.docker.socket'\n  )\n \
    \ AND NOT (\n    l.path = '/Library/LaunchDaemons/com.docker.vmnetd.plist'\n \
    \   AND program_identifier = 'com.docker.vmnetd'\n    AND program_authority =\
    \ NULL\n    AND program = '/Library/PrivilegedHelperTools/com.docker.vmnetd'\n\
    \  )\n  AND NOT l.label IN ('org.nix-community.home.sops-nix','com.github.domt4.homebrew-autoupdate')\n\
    GROUP BY\n  l.path\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
