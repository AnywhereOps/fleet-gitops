- name: CDK - Gcp Service Account Keys Mdfind
  description: 'Indicative of stored GCP service account keys just sitting around
    unencrypted * False positives: * Keys exported for non-production purposes'
  query: "SELECT\n  file.path,\n  file.size,\n  file.btime,\n  file.ctime,\n  file.mtime,\n\
    \  magic.data,\n  hash.sha256,\n  u.username,\n  ea.value AS url\nFROM\n  mdfind\n\
    \  JOIN file ON mdfind.path = file.path\n  LEFT JOIN users u ON file.uid = u.uid\n\
    \  LEFT JOIN hash ON mdfind.path = hash.path\n  LEFT JOIN extended_attributes\
    \ ea ON mdfind.path = ea.path\n  AND ea.key = 'where_from'\n  LEFT JOIN magic\
    \ ON mdfind.path = magic.path\n  LEFT JOIN signature ON mdfind.path = signature.path\n\
    WHERE\n  mdfind.query = \"kMDItemFSName == '*.json'\"\n  AND (\n    file.filename\
    \ LIKE \"%-%-%.json\"\n    OR file.filename LIKE '%service%.json'\n    OR file.filename\
    \ LIKE '%acct%.json'\n    OR file.filename LIKE '%key%.json'\n    OR file.filename\
    \ LIKE '%account%.json'\n    OR file.filename LIKE '%-sa.json'\n    OR file.filename\
    \ LIKE 'sa%.json'\n    OR file.filename LIKE '%s%r%v%acc%t%json'\n    OR file.filename\
    \ LIKE '%prod.json'\n    OR file.filename LIKE 'prod%.json'\n  )\n  AND file.size\
    \ BETWEEN 2311 AND 2385 -- Don't alert on tokens that begin with the username-,\
    \ as they may be personal\n  AND NOT INSTR(file.filename, CONCAT (u.username,\
    \ \"-\")) == 1 -- Don't alert on tokens that begin with the users full name and\
    \ a dash\n  AND NOT (\n    LENGTH(u.username) > 4\n    AND INSTR(file.filename,\
    \ SUBSTR(u.username, 3, 8)) > 0\n  )\n  AND NOT INSTR(\n    file.filename,\n \
    \   REPLACE(LOWER(TRIM(u.description)), \" \", \"-\")\n  ) == 1\n  -- Common locations\
    \ of test or demo keys\n  AND NOT file.filename = 'keys.json'\n  AND NOT file.directory\
    \ = \"/Users/Shared/LGHUB\"\n  AND NOT file.directory LIKE '%/pkg/%'\n  AND NOT\
    \ file.directory LIKE '%/go/src/%'\n  AND NOT file.directory LIKE '%/pkg/mod/%'\n\
    \  AND NOT file.directory LIKE '%/aws-sdk/apis'\n  AND NOT file.directory LIKE\
    \ '%/mock-infras/%'\n  AND NOT file.directory LIKE '%/testdata%'\n  AND NOT file.directory\
    \ LIKE '%/conformance/%'\n  AND NOT file.directory LIKE '%/third_party/%'\n  AND\
    \ NOT file.directory LIKE '%/generated/%'\n  AND NOT file.directory LIKE '%/output/%'\n\
    \  AND NOT file.directory LIKE '%/tests%'\n  AND NOT file.directory LIKE '%/validation%'\n\
    \  AND NOT file.directory LIKE '%/data/%'\n  AND NOT file.directory LIKE '%/json%'\n\
    \  AND NOT file.directory LIKE '%/specs%'\n  AND NOT file.directory LIKE '%/schemas'\n\
    \  AND NOT file.directory LIKE '/Users/%/Library/Application Support/%'\n  AND\
    \ NOT file.directory LIKE '%demo'\n  AND NOT file.filename LIKE 'ntia-conformance-%'\n\
    \  AND NOT file.filename LIKE '%-test.json'\n  AND NOT file.filename LIKE '%package%'\n\
    \  AND NOT file.filename LIKE '%expected%'\n  AND NOT file.filename LIKE '%.pom.%'\n\
    \  AND NOT file.filename LIKE '%latest%'\n  AND NOT file.filename LIKE '%2022%'\n\
    \  AND NOT file.filename LIKE '%2023%'\n  AND NOT file.filename LIKE 'host-project-%'\n\
    \  AND NOT file.filename LIKE '%spdx%'\n  AND NOT file.filename LIKE '%-v1%'\n\
    \  AND NOT file.filename LIKE 'libopenblas-%'\n  -- Well known demo keys\n  AND\
    \ NOT hash.sha256 IN (\n    '11ffc5141b4b0071c0796914deef68d012c4f4c289931c5587fe89d7d6dca0a1',\n\
    \    '2d330d059f4af4d314a85418fb031ee628f41dcf3e31fbce46858e52e73180c4',\n   \
    \ '4b4be8c1bc7e3bc7ea1f02932a024466db5faf3eaad885cf31ac7383484b1b1c',\n    '6e55f3eccad59a615189c82cbcbd1133ce94509f7c5d42e3e7fbd00e65f0731f',\n\
    \    'e99b4e6dfbbefa19c9ec9c82bb0c3445a443702f960c2a05f882bb5577a59ef8',\n   \
    \ '421899fb9bfa0252ce7921969339918a5bbacbc7b9cd500e03a88f9c4e33bae4',\n    '81bce2313cd00ffc42303fbf7c08e4d068fccc9c0076867903ef94616d795e12',\n\
    \    '8d740893c1f9163ddfd8c193d9a95caf15da3740b42f2739c4b107ad12661809',\n   \
    \ '998ddcb7d1a7c2931c8546576873e47b399f23cef719227052f245c8240c6528',\n    'af1a2f8e9d581bb1504e3d8801d15d962fdf12ee7ebcf2bb9c475c8b92da6472',\n\
    \    'b68896dc8e8c23ade371cf8b5c9d25853d81b4cfa5baa2bc0200d9242a903d80',\n   \
    \ 'bc4c0ad21d79fea9050e75e80f13dd54bfdc867236342ede901d15d815f31988',\n    'cea85342377ef1bce115629c3d9d3ec405964a43545805c9f7ace98940aa0be2',\n\
    \    'a0f925d91d2ae1d38c13305572b2bf027e09f39e8bea575d55e8fcd5f3bf8b32',\n   \
    \ 'ef2c928c69403e023a332002d8c5c430e1022850b12f834563f6aec111d99f14'\n  )\nGROUP\
    \ BY\n  file.path\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
