- name: CDK - Parent Missing From Disk Macos
  description: 'A program where the parent PID is not on disk Reveals boopkit if a
    child is spawned TODO: Make mount namespace aware'
  query: "SELECT\n  s.authority AS p0_auth,\n  s.identifier AS p0_id,\n  DATETIME(f.ctime,\
    \ 'unixepoch') AS p0_changed,\n  DATETIME(f.mtime, 'unixepoch') AS p0_modified,\n\
    \  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n\
    \  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256\
    \ AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n\
    \  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n\
    \  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path\
    \ = f.path\n  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN hash p0_hash\
    \ ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.pid IN (\n    SELECT\n \
    \     p.pid\n    FROM\n      processes p\n      -- NOTE: This is an expensive\
    \ join on macOS\n      JOIN processes pp ON p.parent = pp.pid\n    WHERE\n   \
    \   p.parent NOT IN (0, 1, 2)\n      AND p.path != \"\"\n      -- macOS Optimization\n\
    \      AND p.path NOT LIKE '/sbin/%'\n      AND p.path NOT LIKE '/System/%'\n\
    \      AND p.path NOT LIKE '/usr/bin/%'\n      AND p.path NOT LIKE '/usr/libexec/%'\n\
    \      -- Exceptions\n      AND pp.path NOT LIKE '/opt/homebrew/Cellar/%'\n  \
    \    AND pp.path NOT LIKE '/private/var/folders/%/T/PKInstallSandboxTrash/%.sandboxTrash/%'\n\
    \      AND pp.path NOT LIKE '%google-cloud-sdk/.install/.backup%'\n      AND pp.path\
    \ NOT IN (\n        '/Applications/Visual Studio Code.app/Contents/Frameworks/Code\
    \ Helper.app/Contents/MacOS/Code Helper',\n        \"\",\n        \"/Applications/Visual\
    \ Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code\
    \ Helper (Plugin)\",\n        \"/Applications/Visual Studio Code.app/Contents/Frameworks/Code\
    \ Helper.app/Contents/MacOS/Code Helper\",\n        \"/sbin/launchd\",\n     \
    \   \"/var/lib/incus/containers\"\n      )\n      AND pp.on_disk != 1\n  );\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
