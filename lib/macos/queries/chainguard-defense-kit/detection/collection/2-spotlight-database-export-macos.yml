---
apiVersion: v1
kind: query
spec:
  name: CDK - Spotlight Database Export Macos
  platform: darwin
  description: Find database exports. Will need tuning based on your table names.
  query: |
    SELECT
      f.path,
      f.size,
      datetime(f.btime, 'unixepoch') AS file_created,
      magic.data
    FROM
      file f
      JOIN mdfind ON mdfind.path = f.path
      LEFT JOIN magic ON f.path = magic.path
    WHERE
      (
        (
          mdfind.query = 'kMDItemFSName == ''*enforce*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*iam*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
        OR (
          mdfind.query = 'kMDItemFSName == ''*tenant*'' && kMDItemTextContent == ''CREATE TABLE'''
        )
      )
      AND f.path NOT LIKE '%.json'
      AND f.path NOT LIKE '%.log'
      AND f.path NOT LIKE '%/testdata/%'
      AND f.path NOT LIKE '%mysql-test/suite/%'
      AND f.size > 32768
  interval: 3600
  logging: snapshot
  observer_can_run: true
  automations_enabled: false
  discard_data: false
  team: both
