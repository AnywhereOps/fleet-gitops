# ==============================================================================
# FILE 1: agent-options.yml
# Apply with: fleetctl apply -f agent-options.yml
# This configures the ATC tables on all macOS hosts.
# Goes in: Settings > Organization settings > Agent options
# Or in your GitOps repo as the agent_options section of your org/team config.
# ==============================================================================

apiVersion: v1
kind: config
spec:
  agent_options:
    overrides:
      platforms:
        darwin:
          auto_table_construction:

            # Core messages table - text, timestamps, direction
            imessage_messages:
              query: >-
                SELECT
                  m.ROWID as message_id,
                  m.text,
                  m.attributedBody,
                  m.date as date_epoch,
                  datetime(m.date / 1000000000 + 978307200, 'unixepoch', 'localtime') as date_utc,
                  m.is_from_me,
                  m.is_read,
                  m.is_delivered,
                  m.is_sent,
                  m.service,
                  m.destination_caller_id,
                  h.id as contact_id
                FROM message m
                LEFT JOIN handle h ON m.handle_id = h.ROWID
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "message_id"
                - "text"
                - "attributedBody"
                - "date_epoch"
                - "date_utc"
                - "is_from_me"
                - "is_read"
                - "is_delivered"
                - "is_sent"
                - "service"
                - "destination_caller_id"
                - "contact_id"

            # Contacts / handles (phone numbers + emails)
            imessage_handles:
              query: >-
                SELECT
                  ROWID as handle_id,
                  id as contact_id,
                  country,
                  service
                FROM handle
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "handle_id"
                - "contact_id"
                - "country"
                - "service"

            # Chat / conversation metadata
            imessage_chats:
              query: >-
                SELECT
                  c.ROWID as chat_id,
                  c.guid,
                  c.style,
                  c.chat_identifier,
                  c.service_name,
                  c.display_name,
                  c.group_id
                FROM chat c
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "chat_id"
                - "guid"
                - "style"
                - "chat_identifier"
                - "service_name"
                - "display_name"
                - "group_id"

            # Pre-joined view: chat + message + contact in one table
            imessage_chat_messages:
              query: >-
                SELECT
                  cmj.chat_id,
                  cmj.message_id,
                  m.date as date_epoch,
                  datetime(m.date / 1000000000 + 978307200, 'unixepoch', 'localtime') as date_utc,
                  m.text,
                  m.is_from_me,
                  h.id as contact_id,
                  c.display_name as chat_name,
                  c.chat_identifier
                FROM chat_message_join cmj
                JOIN message m ON cmj.message_id = m.ROWID
                LEFT JOIN handle h ON m.handle_id = h.ROWID
                LEFT JOIN chat c ON cmj.chat_id = c.ROWID
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "chat_id"
                - "message_id"
                - "date_epoch"
                - "date_utc"
                - "text"
                - "is_from_me"
                - "contact_id"
                - "chat_name"
                - "chat_identifier"

            # Attachments (images, files, etc.)
            imessage_attachments:
              query: >-
                SELECT
                  a.ROWID as attachment_id,
                  a.filename,
                  a.mime_type,
                  a.total_bytes,
                  a.transfer_name,
                  datetime(a.created_date / 1000000000 + 978307200, 'unixepoch', 'localtime') as created_date,
                  m.ROWID as message_id,
                  m.is_from_me,
                  h.id as contact_id
                FROM attachment a
                JOIN message_attachment_join maj ON a.ROWID = maj.attachment_id
                JOIN message m ON maj.message_id = m.ROWID
                LEFT JOIN handle h ON m.handle_id = h.ROWID
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "attachment_id"
                - "filename"
                - "mime_type"
                - "total_bytes"
                - "transfer_name"
                - "created_date"
                - "message_id"
                - "is_from_me"
                - "contact_id"

            # Deleted messages (GUIDs only, no content)
            imessage_deleted:
              query: >-
                SELECT
                  ROWID,
                  guid
                FROM deleted_messages
              path: "/Users/%/Library/Messages/chat.db"
              columns:
                - "ROWID"
                - "guid"
