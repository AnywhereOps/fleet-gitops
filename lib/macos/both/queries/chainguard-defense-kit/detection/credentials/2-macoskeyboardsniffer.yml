- name: CDK - Macos Keyboard Sniffer
  description: Find programs that are sniffing keyboard events on macOS
  query: "SELECT\n  et.enabled,\n  et.process_being_tapped,\n  et.tapping_process,\n\
    \  CONCAT (\n    REPLACE(\n      p0.path,\n      RTRIM(p0.path, REPLACE(p0.path,\
    \ '/', '')),\n      ''\n    ),\n    ',',\n    s.identifier,\n    ',',\n    s.authority\n\
    \  ) AS exception_key,\n  ---\n  s.authority,\n  s.identifier,\n  -- Child\n \
    \ p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS\
    \ p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name\
    \ AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS\
    \ p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n\
    \  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256\
    \ AS p2_sha256\nFROM\n  event_taps et\n  LEFT JOIN processes p0 ON et.tapping_process\
    \ = p0.pid\n  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN hash p0_hash\
    \ ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n\
    \  LEFT JOIN file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  et.event_tapped IN ('EventKeyDown',\
    \ 'EventKeyUp')\n  AND et.enabled != 0\n  AND s.authority != 'Software Signing'\
    \ -- Popular programs that sniff keyboard events, but do not appear to be malware.\n\
    \  AND NOT exception_key IN (\n    'Alfred,com.runningwithcrayons.Alfred,Developer\
    \ ID Application: Running with Crayons Ltd (XZZXE9SED4)',\n    'BetterDisplay,pro.betterdisplay.BetterDisplay,Developer\
    \ ID Application: Istvan Toth (299YSU96J7)',\n    'MonitorControl,app.monitorcontrol.MonitorControl,Developer\
    \ ID Application: Istvan Toth (299YSU96J7)',\n    'BetterTouchTool,com.hegenberg.BetterTouchTool,Developer\
    \ ID Application: folivora.AI GmbH (DAFVSXZ82P)',\n    'CheatSheet,com.mediaatelier.CheatSheet,Developer\
    \ ID Application: Stefan Fuerst (2295B9BX7F)',\n    'Contexts,com.contextsformac.Contexts,Developer\
    \ ID Application: Usman Khalid (RZ7E748ZSC)',\n    'DDPM,Qisda.DDPM,Developer\
    \ ID Application: Yufu Fan (S3YBM9ALKM)',\n    'deskflow-client,deskflow-client,',\n\
    \    'deskflow-server,deskflow-server,',\n    'Display Pilot 2,com.benq.DisplayPilot2,Developer\
    \ ID Application: BenQ Corporation (3YMZ8E4Y5W)',\n    'Grammarly Desktop,com.grammarly.ProjectLlama,Developer\
    \ ID Application: Grammarly, Inc (W8F64X92K3)',\n    'HueSync,com.lighting.huesync,Developer\
    \ ID Application: Signify Netherlands B.V. (PREPN2W95S)',\n    'Hyperkey,com.knollsoft.Hyperkey,Developer\
    \ ID Application: Ryan Hanson (XSYZ3E4B7D)',\n    'iTerm2,com.googlecode.iterm2,Developer\
    \ ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',\n    'lghub_agent,com.logi.ghub.agent,Developer\
    \ ID Application: Logitech Inc. (QED4VVPZWA)',\n    'LinearMouse,com.lujjjh.LinearMouse,Developer\
    \ ID Application: Jiahao Lu (C5686NKYJ7)',\n    'logioptionsplus_agent,com.logi.cp-dev-mgr,Developer\
    \ ID Application: Logitech Inc. (QED4VVPZWA)',\n    'Lunar,fyi.lunar.Lunar,Developer\
    \ ID Application: Alin Panaitiu (RDDXV84A73)',\n    'Magnet,com.crowdcafe.windowmagnet,Apple\
    \ Mac OS Application Signing',\n    'MonitorControl,me.guillaumeb.MonitorControl,Developer\
    \ ID Application: Joni Van Roost (CYC8C8R4K9)',\n    'NotesCmdr,app.smallest.NotesCmdr,Developer\
    \ ID Application: Anders Rex (UL38YXE4DL)',\n    'osqueryd,io.osquery.agent,Developer\
    \ ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',\n    'polyrecorder,polyrecorder,Developer\
    \ ID Application: Adam Pietrasiak (SXF593CX2N)',\n    'Rocket,net.matthewpalmer.Rocket,Developer\
    \ ID Application: Matthew Palmer (Z4JV2M65MH)',\n    'skhd,skhd,',\n    'Superkey,com.knollsoft.Superkey,Developer\
    \ ID Application: Ryan Hanson (XSYZ3E4B7D)',\n    'synergy-core,synergy-core,Developer\
    \ ID Application: Symless Ltd (4HX897Y6GJ)',\n    'TextExpander,com.smileonmymac.textexpander,Developer\
    \ ID Application: SmileOnMyMac, LLC (7PKJ6G4DXL)',\n    'Raycast,com.raycast.macos,Developer\
    \ ID Application: Raycast Technologies Inc (SY64MV22J9)',\n    'Wispr Flow,com.electron.wispr-flow.accessibility-mac-app,Developer\
    \ ID Application: Wispr AI INC (C9VQZ78H85)'\n  )\nGROUP BY\n  p0.path\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
