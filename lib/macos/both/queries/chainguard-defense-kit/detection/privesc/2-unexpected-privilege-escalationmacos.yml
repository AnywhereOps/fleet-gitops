- name: CDK - Unexpected Privilege Escalation Macos
  description: 'Find processes that run with a lower effective UID than their parent
    (state-based) related: * unexpected-privilege-escalation-events.sql'
  query: "SELECT\n  s.authority AS p0_auth,\n  s.identifier AS p0_id,\n  p0.uid AS\
    \ p0_uid,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS\
    \ p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n\
    \  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path\
    \ AS p1_path,\n  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n\
    \  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n \
    \ p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN\
    \ signature s ON p0.path = s.path\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n\
    \  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN file p1_f ON p1.path\
    \ = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN\
    \ processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  p0.euid < p0.uid\n  AND p0.path NOT IN (\n    '',\n    '/Applications/Parallels\
    \ Desktop.app/Contents/MacOS/Parallels Service',\n    '/Applications/VMware Fusion.app/Contents/Library/vmware-vmx',\n\
    \    '/bin/ps',\n    '/Library/Application Support/Google/GoogleUpdater/Current/GoogleUpdater.app/Contents/Helpers/launcher',\n\
    \    '/Library/Application Support/org.pqrs/Karabiner-Elements/bin/karabiner_session_monitor',\n\
    \    '/Library/Application Support/AdGuard Software/com.adguard.mac.adguard/kext/adguard-tcpkill',\n\
    \    '/Library/DropboxHelperTools/Dropbox_u501/dbkextd',\n    '/Library/DropboxHelperTools/Dropbox_u502/dbkextd',\n\
    \    '/usr/bin/login',\n    '/usr/bin/su',\n    '/usr/bin/sudo',\n    '/usr/bin/top',\n\
    \    '/usr/local/bin/doas'\n  )\n  AND NOT (\n    p0.path LIKE '/var/folders/%/T/CanonOFI_TEMP/Data/Software/Install/UniversalInstaller.app/Contents/Frameworks/UIx.framework/Resources/relay'\n\
    \    AND s.authority = 'Developer ID Application: Canon Inc. (XE2XNRRXZ5)'\n \
    \ )\n  AND NOT (\n    p0.path = '/Applications/Adguard.app/Contents/MacOS/Adguard'\n\
    \    AND s.authority = 'Developer ID Application: Adguard Software Limited (TC3Q7MAJXF)'\n\
    \  )\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
