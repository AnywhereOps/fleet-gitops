- name: CDK - Recently Created Executables Long Lived Macos
  description: 'Long-running programs who were started around when they were written
    to disk false-positives: * many'
  query: "SELECT\n  f.ctime,\n  f.btime,\n  f.mtime,\n  p0.start_time,\n  s.authority\
    \ AS s_auth,\n  s.identifier AS s_id,\n  REPLACE(f.directory, u.directory, '~')\
    \ AS dir,\n  COALESCE(\n    REGEX_MATCH (\n      REPLACE(f.directory, u.directory,\
    \ '~'),\n      '(~/.*?/.*?/.*?/)',\n      1\n    ),\n    REPLACE(f.directory,\
    \ u.directory, '~')\n  ) AS top3_dir,\n  REPLACE(f.path, u.directory, '~') AS\
    \ homepath,\n  p0.start_time - f.btime AS start_birth_delta,\n  -- Child\n  p0.pid\
    \ AS p0_pid,\n  p0.start_time AS p0_start,\n  p0.path AS p0_path,\n  s.authority\
    \ AS p0_sauth,\n  s.identifier AS p0_sid,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS\
    \ p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.start_time AS p1_start,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.name AS p2_name,\n  p2.start_time AS p2_start,\n  p2.path AS p2_path,\n\
    \  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n\
    \  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN file f ON p0.path =\
    \ f.path\n  LEFT JOIN users u ON f.uid = u.uid\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent\
    \ = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  p0.pid\
    \ IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n      start_time\
    \ > 0\n      AND start_time > (strftime('%s', 'now') - 86400)\n      AND pid >\
    \ 0\n      AND path != \"\"\n      AND NOT path LIKE '/Applications/%'\n     \
    \ AND NOT path LIKE '/bin/%'\n      AND NOT path LIKE '/Library/Apple/%'\n   \
    \   AND NOT path LIKE '/Library/Elastic/Agent/data/%/components/%'\n      AND\
    \ NOT path LIKE '/nix/store/%'\n      AND NOT path LIKE '/opt/%'\n      AND NOT\
    \ path LIKE '/System/%'\n      AND NOT path LIKE '/usr/bin/%'\n      AND NOT path\
    \ LIKE '/usr/libexec/%'\n      AND NOT path LIKE '/usr/local/kolide-k2/bin/%'\n\
    \      AND NOT path LIKE '/usr/sbin/%'\n      AND NOT path LIKE '%/bin/cargo'\n\
    \  )\n  -- Processes that started around when they were last modified on disk\n\
    \  AND start_birth_delta BETWEEN -900 AND 900\n  -- Exceptions for no-privileged\
    \ execution\n  AND NOT (\n    p0.euid > 499\n    AND (\n      top3_dir IN (\n\
    \        '/Library/Application Support/EcammLive',\n        '/Library/Developer/Xcode/',\n\
    \        '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',\n        '~/.local/share/bob/',\n\
    \        '~/.local/share/nvim/',\n        '~/.cache/selenium/chromedriver/',\n\
    \        '~/.terraform.d/plugin-cache/registry.terraform.io/',\n        '~/.vscode/extensions/ms-vscode.cpptools-1.15.4-darwin-arm64/',\n\
    \        '~/homebrew/Library/Homebrew/',\n        '~/Library/Application Support/BraveSoftware/',\n\
    \        '~/Library/Application Support/com.elgato.StreamDeck/',\n        '~/Library/Application\
    \ Support/duckly/',\n        '~/Library/Application Support/Figma/',\n       \
    \ '~/Library/Application Support/Foxit Software/',\n        '~/Library/Application\
    \ Support/JetBrains/',\n        '~/Library/Application Support/OpenLens',\n  \
    \      '~/Library/Application Support/sourcegraph-sp/',\n        '~/Library/Application\
    \ Support/Steam/',\n        '~/Library/Application Support/WebEx Folder/',\n \
    \       '~/Library/Application Support/Zed/',\n        '~/Library/Application\
    \ Support/Zwift',\n        '~/Library/Application Support/Zwift/',\n        '~/Library/Caches/com.mimestream.Mimestream/',\n\
    \        '~/Library/Caches/com.sempliva.Tiles/',\n        '~/Library/Caches/company.thebrowser.Browser/',\n\
    \        '~/Library/Caches/JetBrains/',\n        '~/Library/Caches/org.gpgtools.updater/',\n\
    \        '~/Library/Caches/snyk/',\n        '~/projects/go/src/'\n      )\n  \
    \    OR dir IN (\n        '/usr/local/aws-cli',\n        '/usr/local/kolide-k2/Kolide.app/Contents/MacOS',\n\
    \        '~/.local/bin',\n        '~/.local/share/gh/extensions/gh-sbom',\n  \
    \      '~/.magefile',\n        '~/bin',\n        '~/code/bin',\n        '~/go/bin',\n\
    \        '~/gohome/bin',\n        '~/Library/Application Support/cloud-code/installer/google-cloud-sdk/bin',\n\
    \        '~/Library/Application Support/dev.warp.Warp-Stable',\n        '~/Library/Application\
    \ Support/snyk-ls',\n        '~/Library/Application Support/zoom.us/Plugins/aomhost.app/Contents/MacOS',\n\
    \        '~/melange',\n        '~/projects/go/bin',\n        '~/repos/bincapz/out'\n\
    \      )\n      OR dir LIKE '~/%.vscode/extensions/%'\n      OR dir LIKE '~/%/go/bin'\n\
    \      OR dir LIKE '~/%/node_modules/%bin'\n      OR dir LIKE '~/.rustup/toolchains/%'\n\
    \      OR dir LIKE '~/.vscode-insiders/extensions/%'\n      OR dir LIKE '~/Applications/%.app/%'\n\
    \      OR dir LIKE '~/dev/%'\n      OR dir LIKE '~/Documents/GH/%'\n      OR dir\
    \ LIKE '~/Downloads/%.app/Contents/MacOS'\n      OR dir LIKE '~/git/%'\n     \
    \ OR f.path LIKE '%go-build%'\n      OR homepath LIKE '~/%/cloud_sql_proxy'\n\
    \      OR homepath LIKE '~/%/gopls'\n      OR homepath LIKE '~/%/pkg/%.test'\n\
    \      OR homepath LIKE '~/%/src/%.test'\n      OR homepath LIKE '~/%/terraform-provider-%'\n\
    \      OR homepath LIKE '~/chainguard-dev/%'\n      OR homepath LIKE '~/repos/%'\n\
    \      OR homepath LIKE '~/github/%'\n      OR homepath LIKE '~/go/%/bin'\n  \
    \    OR homepath LIKE '~/go/src/%'\n      OR homepath LIKE '~/Parallels/%/WinAppHelper'\n\
    \      OR homepath LIKE '~/src/%'\n      OR f.path LIKE '/private/tmp/%/Creative\
    \ Cloud Installer.app/Contents/MacOS/Install'\n      OR f.path LIKE '/private/tmp/go-%'\n\
    \      OR f.path LIKE '/private/tmp/nix-build-%'\n      OR f.path LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'\n\
    \      OR f.path LIKE '/private/var/folders/%/bin/%'\n      OR f.path LIKE '/private/var/folders/%/d/Wrapper/%.app/%'\n\
    \      OR f.path LIKE '/private/var/folders/%/GoLand/%'\n      OR f.path LIKE\
    \ '/private/var/folders/%/T/download/ARMDCHammer'\n      OR f.path LIKE '/private/var/folders/%/T/pulumi-go.%'\n\
    \    )\n  )\n  AND NOT s.authority IN (\n    'Apple iPhone OS Application Signing',\n\
    \    'Apple Mac OS Application Signing',\n    'Developer ID Application: Adobe\
    \ Inc. (JQ525L2MZD)',\n    'Developer ID Application: AMZN Mobile LLC (94KV3E626L)',\n\
    \    'Developer ID Application: Autodesk (XXKJ396S2Y)',\n    'Developer ID Application:\
    \ Azul Systems, Inc. (TDTHCUPYFR)',\n    'Developer ID Application: Bitdefender\
    \ SRL (GUNFMW623Y)',\n    'Developer ID Application: Brave Software, Inc. (KL8N8XSYF4)',\n\
    \    'Developer ID Application: Brother Industries, LTD. (5HCL85FLGW)',\n    'Developer\
    \ ID Application: Bryan Jones (49EYHPJ4Q3)',\n    'Developer ID Application: Canon\
    \ Inc. (XE2XNRRXZ5)',\n    'Developer ID Application: Cisco (DE8Y96K9QP)',\n \
    \   'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',\n    'Developer\
    \ ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',\n    'Developer ID Application:\
    \ Denver Technologies, Inc (2BBY89MBSN)',\n    'Developer ID Application: Docker\
    \ Inc (9BNSXJN65R)',\n    'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',\n\
    \    'Developer ID Application: Eclipse Foundation, Inc. (JCDTMS22B4)',\n    'Developer\
    \ ID Application: Elasticsearch, Inc (2BT3HPN62Z)',\n    'Developer ID Application:\
    \ Emmanouil Konstantinidis (3YP8SXP3BF)',\n    'Developer ID Application: EnterpriseDB\
    \ Corporation (26QKX55P9K)',\n    'Developer ID Application: Fumihiko Takayama\
    \ (G43BCU2T37)',\n    'Developer ID Application: Galvanix (5BRAQAFB8B)',\n   \
    \ 'Developer ID Application: Garmin International (72ES32VZUA)',\n    'Developer\
    \ ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',\n    'Developer ID\
    \ Application: GEORGE NACHMAN (H7V7XYVQ7D)',\n    'Developer ID Application: GitHub\
    \ (VEKTX9H2N7)',\n    'Developer ID Application: Google LLC (EQHXZ8M8AV)',\n \
    \   'Developer ID Application: GPGTools GmbH (PKV8ZPD836)',\n    'Developer ID\
    \ Application: Hashicorp, Inc. (D38WU7D763)',\n    'Developer ID Application:\
    \ JetBrains s.r.o. (2ZEFAR8TH3)',\n    'Developer ID Application: Kandji, Inc.\
    \ (P3FGV63VK7)',\n    'Developer ID Application: Keybase, Inc. (99229SGT5K)',\n\
    \    'Developer ID Application: Kolide Inc (YZ3EM74M78)',\n    'Developer ID Application:\
    \ Kolide, Inc (X98UFR7HA3)',\n    'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n\
    \    'Developer ID Application: Michael Jones (YD6LEYT6WZ)',\n    'Developer ID\
    \ Application: Microsoft Corporation (UBF8T346G9)',\n    'Developer ID Application:\
    \ Mojang AB (HR992ZEAE6)',\n    'Developer ID Application: Objective Development\
    \ Software GmbH (MLZF7K7B5R)',\n    'Developer ID Application: Objective-See,\
    \ LLC (VBG97UB4TA)',\n    'Developer ID Application: Opal Camera Inc (97Z3HJWCRT)',\n\
    \    'Developer ID Application: OPENVPN TECHNOLOGIES, INC. (ACV7L3WCD8)',\n  \
    \  'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',\n\
    \    'Developer ID Application: Parallels International GmbH (4C6364ACXT)',\n\
    \    'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',\n    'Developer ID Application:\
    \ RescueTime, Inc (FSY4RB8H39)',\n    'Developer ID Application: Seiko Epson Corporation\
    \ (TXAEAV5RN4)',\n    'Developer ID Application: SteelSeries (6WGL6CHFH2)',\n\
    \    'Developer ID Application: Sublime HQ Pty Ltd (Z6D26JE4Y4)',\n    'Developer\
    \ ID Application: SUSE LLC (2Q6FHJR3H3)',\n    'Developer ID Application: Tailscale\
    \ Inc. (W5364U7YZB)',\n    'Developer ID Application: The Browser Company of New\
    \ York Inc. (S6N382Y83G)',\n    'Developer ID Application: VMware, Inc. (EG7KH642X6)',\n\
    \    'Developer ID Application: Wesley FURLONG (P4A6FU9KZ3)',\n    'Developer\
    \ ID Application: Wizards of OBS LLC (2MMRE5MTB8)',\n    'Developer ID Application:\
    \ Yubico Limited (LQA3CS5MM7)',\n    'Developer ID Application: Zoom Video Communications,\
    \ Inc. (BJ4HAAB9B3)',\n    'Developer ID Application: Zwift, Inc (C2GM8Y9VFM)',\n\
    \    'Software Signing'\n  )\n  AND NOT (\n    s.identifier = \"com.apple.print.PrinterProxy\"\
    \n    AND p0.path LIKE \"/Users/%/Library/Printers/%/Contents/MacOS/PrinterProxy\"\
    \n    AND p0.uid > 499\n  )\n  -- Local developer testing\n  AND NOT (\n    homepath\
    \ LIKE '~/%'\n    AND p0.uid > 499\n    AND f.ctime = f.mtime\n    AND f.uid =\
    \ p0.uid\n    AND p0.cmdline LIKE './%'\n    AND p0.path NOT LIKE '%Library%'\n\
    \    AND p0.path NOT LIKE '%/.%'\n    AND p0.path NOT LIKE '%Cache%'\n  )\n  AND\
    \ NOT p1.name IN ('makepkg', 'make')\n  -- Arc\n  AND NOT (\n    p0.path LIKE\
    \ '/Users/%/Library/Caches/%/org.sparkle-project.Sparkle/Launcher/%'\n    AND\
    \ s.identifier = 'org.sparkle-project.Sparkle.Updater'\n    AND s.authority !=\
    \ ''\n    AND p0.uid > 499\n  )\n  AND NOT (\n    p0.path = '/Library/PrivilegedHelperTools/com.macpaw.CleanMyMac4.Agent'\n\
    \    AND s_auth = 'Developer ID Application: MacPaw Inc. (S8EX82NJP6)'\n  )\n\
    GROUP BY\n  p0.pid\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
