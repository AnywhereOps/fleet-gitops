- name: CDK - Unexpected Root Signer Events Macos
  description: Programs running as root from unusual signers on macOS Canonical example
    of including process parents from process_events
  query: "SELECT\n  f.directory AS dir,\n  REGEX_MATCH (p.path, '(/.*?/.*?)/', 1)\
    \ AS top_dir,\n  -- Child\n  pe.path AS p0_path,\n  pe.time AS p0_time,\n  pe.euid\
    \ AS p0_euid,\n  s.authority AS p0_sauth,\n  s.identifier AS p0_sid,\n  hash.sha256\
    \ AS p0_hash,\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) AS p0_name,\n  TRIM(pe.cmdline)\
    \ AS p0_cmd,\n  -- pe.cwd is NULL on macOS\n  p.cwd AS p0_cwd,\n  pe.pid AS p0_pid,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.start_time, pe1.time) AS p1_start,\n  COALESCE(p1.path,\
    \ pe1.path) AS p1_path,\n  p1.cwd AS p1_cwd,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256)\
    \ AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n\
    \  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n  TRIM(\n   \
    \ COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS p2_cmd,\n \
    \ p1_p2.cwd AS p2_cwd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n\
    \  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name\nFROM\n  process_events pe\n  LEFT JOIN\
    \ file f ON pe.path = f.path\n  LEFT JOIN users u ON pe.uid = u.uid\n  LEFT JOIN\
    \ signature s ON pe.path = s.path\n  LEFT JOIN processes p ON pe.pid = p.pid\n\
    \  LEFT JOIN hash ON pe.path = hash.path\n  -- Parents (via two paths)\n  LEFT\
    \ JOIN processes p1 ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND\
    \ pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n \
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\nWHERE\n  p0_euid\
    \ = 0\n  AND pe.time > (strftime('%s', 'now') -900)\n  -- query optimization:\
    \ Exclude SIP protected directories\n  AND top_dir NOT IN (\n    '/Library/Apple',\n\
    \    '/System/Library',\n    '/usr/bin',\n    '/usr/libexec',\n    '/usr/sbin'\n\
    \  )\n  AND s.authority NOT IN (\n    'Developer ID Application: Adobe Inc. (JQ525L2MZD)',\n\
    \    'Developer ID Application: Apple Inc. - XQuartz (NA574AWV7E)',\n    'Developer\
    \ ID Application: Bitdefender SRL (GUNFMW623Y)',\n    'Developer ID Application:\
    \ Canonical Group Limited (X4QN7LTP59)',\n    'Developer ID Application: Corsair\
    \ Memory, Inc. (Y93VXCB8Q5)',\n    'Developer ID Application: Docker Inc (9BNSXJN65R)',\n\
    \    'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)',\n    'Developer ID\
    \ Application: Ecamm Network, LLC (5EJH68M642)',\n    'Developer ID Application:\
    \ Elasticsearch, Inc (2BT3HPN62Z)',\n    'Developer ID Application: Fortinet,\
    \ Inc (AH4XFXJ7DK)',\n    'Developer ID Application: Foxit Corporation (8GN47HTP75)',\n\
    \    'Developer ID Application: Fumihiko Takayama (G43BCU2T37)',\n    'Developer\
    \ ID Application: Google LLC (EQHXZ8M8AV)',\n    'Developer ID Application: Kandji,\
    \ Inc. (P3FGV63VK7)',\n    'Developer ID Application: Keybase, Inc. (99229SGT5K)',\n\
    \    'Developer ID Application: Kolide Inc (YZ3EM74M78)',\n    'Developer ID Application:\
    \ Kolide, Inc (X98UFR7HA3)',\n    'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n\
    \    'Developer ID Application: Mersive Technologies (63B5A5WDNG)',\n    'Developer\
    \ ID Application: Microsoft Corporation (UBF8T346G9)',\n    'Developer ID Application:\
    \ Objective Development Software GmbH (MLZF7K7B5R)',\n    'Developer ID Application:\
    \ Objective-See, LLC (VBG97UB4TA)',\n    'Developer ID Application: Opal Camera\
    \ Inc (97Z3HJWCRT)',\n    'Developer ID Application: OSQUERY A Series of LF Projects,\
    \ LLC (3522FA9PXF)',\n    'Developer ID Application: Parallels International GmbH\
    \ (4C6364ACXT)',\n    'Developer ID Application: Private Internet Access, Inc.\
    \ (5357M5NW9W)',\n    'Developer ID Application: Rapid7 LLC (UL6CGN7MAL)',\n \
    \   'Developer ID Application: Rogue Amoeba Software, Inc. (7266XEXAPM)',\n  \
    \  'Developer ID Application: Rogue Amoeba Software, LLC (7266XEXAPM)',\n    'Developer\
    \ ID Application: Ryan Hanson (XSYZ3E4B7D)',\n    'Developer ID Application: Sanford,\
    \ L.P. (N3S6676K3E)',\n    'Developer ID Application: Tailscale Inc. (W5364U7YZB)',\n\
    \    'Software Signing'\n  )\n  AND NOT (\n    s.authority = \"\"\n    AND pe.path\
    \ LIKE \"/nix/store/%-nix-%/bin/nix\"\n    AND p1.path = \"/sbin/launchd\"\n \
    \ )\n  AND NOT (\n    s.authority = \"\"\n    AND (\n      pe.path LIKE \"/nix/store/%-nix-%/bin/nix-%\"\
    \n      OR pe.path LIKE \"/private/var/folders/%/T/tmp.%/nix-installer\"\n   \
    \ )\n    AND p1_path = \"/usr/bin/sudo\"\n  )\n  AND NOT (\n    s.authority =\
    \ \"\"\n    AND pe.path LIKE \"/opt/%/bin/%\"\n    AND p1_path IN (\"/usr/bin/sudo\"\
    , \"/sbin/launchd\")\n  )\n  -- Surfshark\n  AND NOT pe.path LIKE '/Library/SystemExtensions/%/com.surfshark.vpnclient.macos.direct.PacketTunnel-WireGuard.systemextension/Contents/MacOS'\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
