- name: CDK - Unexpected Osascript Calls
  description: Detect unusual calls to osascript This query does some gymnastics,
    as the information on the parent process may be found in the 'process' (currently
    running) or 'process_events' table (recently started). In the case of a long-running
    process that was recently terminated, parent information may not be in either.
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.time\
    \ AS p0_time,\n  pe.pid AS p0_pid,\n  pe.euid AS p0_euid,\n  s.authority AS p0_authority,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  pe_sig1.authority AS p1_authority,\n  -- Grandparent\n  COALESCE(p1.parent,\
    \ pe1.parent) AS p2_pid,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline,\
    \ pe1_pe2.cmdline)\n  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path)\
    \ AS p2_path,\n  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name,\n  COALESCE(\n    p1_p2_sig.authority,\n\
    \    pe1_p2_sig.authority,\n    pe1_pe2_sig.authority\n  ) AS p2_authority\nFROM\n\
    \  process_events pe\n  LEFT JOIN processes p ON pe.pid = p.pid\n  LEFT JOIN signature\
    \ s ON pe.path = s.path\n  -- Parents (via two paths)\n  LEFT JOIN processes p1\
    \ ON pe.parent = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n\
    \  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n\
    \  LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\n  LEFT JOIN signature\
    \ pe_sig1 ON pe1.path = pe_sig1.path\n  -- Grandparents (via 3 paths)\n  LEFT\
    \ JOIN processes p1_p2 ON p1.parent = p1_p2.pid -- Current grandparent via parent\
    \ processes\n  LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid -- Current\
    \ grandparent via parent events\n  LEFT JOIN process_events pe1_pe2 ON pe1.parent\
    \ = pe1_p2.pid\n  AND pe1_pe2.cmdline != '' -- Past grandparent via parent events\n\
    \  LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n  LEFT JOIN hash\
    \ pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash pe1_pe2_hash\
    \ ON pe1_pe2.path = pe1_pe2_hash.path\n  LEFT JOIN signature p1_p2_sig ON p1_p2.path\
    \ = p1_p2_sig.path\n  LEFT JOIN signature pe1_p2_sig ON pe1_p2.path = pe1_p2_sig.path\n\
    \  LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path\nWHERE\n\
    \  pe.path IN ('/usr/bin/osascript', '/usr/bin/osacompile')\n  AND pe.time > (strftime('%s',\
    \ 'now') -300)\n  AND pe.cmdline != ''\n  -- Only include successful executions:\
    \ On macOS, process_events includes unsuccessful path lookups!\n  AND pe.status\
    \ = 0\n  AND NOT (\n    pe.euid > 500\n    AND (\n      p0_cmd IN (\n        'osascript\
    \ -e get POSIX path of (path to application id \"com.garmin.antagent\")',\n  \
    \      'osascript -e get POSIX path of (path to application id \"com.garmin.expressfit\"\
    )',\n        'osascript -e get POSIX path of (path to application id \"com.garmin.LifetimeMapUpdate\"\
    )',\n        'osascript -e tell application \"Finder\" to reveal application file\
    \ id \"com.garmin.renu.client\"',\n        'osascript -e user locale of (get system\
    \ info)',\n        'osascript ./ExpressLoginItem.scpt'\n      )\n      OR p0_cmd\
    \ LIKE '/usr/bin/osascript /Applications/Amazon Photos.app/Contents/Resources/quit_and_restart_app.scpt\
    \ /Applications/Amazon Photos.app com.amazon.clouddrive.mac%'\n      OR p0_cmd\
    \ LIKE '/usr/bin/osascript /Users/%/Library/Caches/com.runningwithcrayons.Alfred/Workflow\
    \ Scripts/%'\n      OR p0_cmd LIKE '/usr/bin/osascript /Users/%/osx-trash/trashfile.AppleScript\
    \ %'\n      OR p0_cmd LIKE '/usr/bin/osascript %com.docker.docker%'\n      OR\
    \ p0_cmd LIKE '%\"CFBundleName\" of property list file (app_path & \":Contents:Info.plist\"\
    )'\n      OR p0_cmd LIKE '%osacompile -o /Users/%/Applications/Home Manager Trampolines/%'\n\
    \      OR p0_cmd LIKE 'osascript -e set zoomStatus to \"closed\"%'\n      OR p0_cmd\
    \ LIKE 'osascript -e tell application \"zoom.us\"%'\n      OR p0_cmd LIKE 'osascript\
    \ -e%tell application \"System Preferences\"%reveal anchor \"shortcutsTab\"%\"\
    com.apple.preference.keyboard\"'\n      OR p0_cmd LIKE 'osascript -l JavaScript\
    \ /tmp/PKInstallSandbox.%/Scripts/org.gpgtools.gpgmailloader.pkg.%/mailbundle-enabled.jxa\
    \ -- GPGMailLoader.mailbundle'\n      OR p0_cmd LIKE 'osascript -l JavaScript%com.elgato.StreamDeck%'\n\
    \      OR p0_cmd LIKE 'osascript openChrome.applescript http://127.0.0.1:%'\n\
    \      OR p0_cmd LIKE 'osascript openChrome.applescript http%://localhost%'\n\
    \      OR p1_cmd LIKE '/bin/sh %/opt/homebrew/bin/git-gui%'\n      OR p1_cmd LIKE\
    \ '% /opt/homebrew/bin/jupyter%notebook'\n      OR p1_cmd LIKE '%auth login'\n\
    \      OR p1_cmd LIKE '%aws %sso%'\n      OR p1_cmd LIKE '%gcloud% auth %login%'\n\
    \      OR p1_cmd LIKE '%gcloud% init'\n      OR p1_cmd LIKE '%jupyter_mac.command'\n\
    \      OR p1_cmd LIKE '%tell application \"Finder\" to empty trash%'\n      OR\
    \ p1_cmd LIKE '%tell application \"System Events\" to sleep%'\n      OR p1_authority\
    \ = 'Developer ID Application: Docker Inc (9BNSXJN65R)'\n      OR p1_name IN ('yubikey-agent')\n\
    \      OR (\n        p1_authority = 'Developer ID Application: VNG ONLINE CO.,LTD\
    \ (CVB6BX97VM)'\n        AND p0_cmd = 'osascript -ss'\n      )\n      OR (\n \
    \       p1_authority = 'Developer ID Application: Dropbox, Inc. (G7HH3F8CAK)'\n\
    \        AND p0_cmd = 'osascript'\n      )\n    )\n  )\n  -- The following apply\
    \ to all uids\n  AND NOT p0_cmd IN (\n    '/usr/bin/osascript -e do shell script\
    \ \"/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant\" with administrator privileges',\n\
    \    'osascript -e do shell script \"/bin/rm -Rf /opt/vagrant /usr/local/bin/vagrant\"\
    \ with administrator privileges',\n    'osascript -e user locale of (get system\
    \ info)'\n  )\nGROUP BY\n  pe.pid\n"
  platform: darwin
  interval: 300
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
