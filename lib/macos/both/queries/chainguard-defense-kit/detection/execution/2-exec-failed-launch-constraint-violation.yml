- name: CDK - Exec Failed Launch Constraint Violation
  description: Catch programs that failed to run due to a launch constraint violation,
    such as a signing issue.
  query: "SELECT\n    s.identifier AS s_id,\n    s.authority AS s_auth,\n    -- Child\n\
    \    pe.path AS p0_path,\n    COALESCE(REGEX_MATCH (pe.path, '.*/(.*)', 1), pe.path)\
    \ AS p0_name,\n    TRIM(pe.cmdline) AS p0_cmd,\n    pe.time AS p0_time,\n    --\
    \ pe.cwd is NULL on macOS\n    p.cwd AS p0_cwd,\n    pe.pid AS p0_pid,\n    pe.euid\
    \ AS p0_euid,\n    -- Parent\n    pe.parent AS p1_pid,\n    TRIM(COALESCE(p1.cmdline,\
    \ pe1.cmdline)) AS p1_cmd,\n    p1.cwd AS p1_cwd,\n    COALESCE(p1.path, pe1.path)\
    \ AS p1_path,\n    COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n   \
    \ REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n    --\
    \ Grandparent\n    COALESCE(p1.parent, pe1.parent) AS p2_pid,\n    TRIM(\n   \
    \     COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n    ) AS p2_cmd,\n\
    \    p1_p2.cwd AS p2_cwd,\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path)\
    \ AS p2_path,\n    COALESCE(\n        p1_p2_hash.path,\n        pe1_p2_hash.path,\n\
    \        pe1_pe2_hash.path\n    ) AS p2_hash,\n    REGEX_MATCH (\n        COALESCE(p1_p2.path,\
    \ pe1_p2.path, pe1_pe2.path),\n        '.*/(.*)',\n        1\n    ) AS p2_name\n\
    FROM\n    process_events pe\n    LEFT JOIN file f ON pe.path = f.path\n    LEFT\
    \ JOIN signature S ON pe.path = s.path\n    LEFT JOIN users u ON pe.uid = u.uid\n\
    \    LEFT JOIN processes p ON pe.pid = p.pid -- Parents (via two paths)\n    LEFT\
    \ JOIN processes p1 ON pe.parent = p1.pid\n    LEFT JOIN hash p_hash1 ON p1.path\
    \ = p_hash1.path\n    LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n  \
    \  AND pe1.cmdline != ''\n    LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path\
    \ -- Grandparents (via 3 paths)\n    LEFT JOIN processes p1_p2 ON p1.parent =\
    \ p1_p2.pid -- Current grandparent via parent processes\n    LEFT JOIN processes\
    \ pe1_p2 ON pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n\
    \    LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n    AND pe1_pe2.cmdline\
    \ != '' -- Past grandparent via parent events\n    LEFT JOIN hash p1_p2_hash ON\
    \ p1_p2.path = p1_p2_hash.path\n    LEFT JOIN hash pe1_p2_hash ON pe1_p2.path\
    \ = pe1_p2_hash.path\n    LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n\
    WHERE\n    pe.time > (strftime ('%s', 'now') -900)\n    AND pe.status = 1\n  \
    \  AND pe.cmdline != ''\n    AND pe.cmdline IS NOT NULL\n    AND p0_cmd NOT IN\
    \ (\n        '/opt/homebrew/opt/tailscale/bin/tailscaled',\n        '/Library/PrivilegedHelperTools/com.docker.vmnetd',\n\
    \        '/Applications/ElasticEndpoint.app/Contents/MacOS/ElasticEndpoint --install'\n\
    \    )\nGROUP BY\n    pe.euid,\n    pe.path,\n    pe.cmdline\n"
  platform: darwin
  interval: 900
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
