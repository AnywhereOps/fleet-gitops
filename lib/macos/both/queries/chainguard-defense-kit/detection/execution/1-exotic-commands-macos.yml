- name: CDK - Exotic Commands Macos
  description: Pick out exotic processes based on their command-line (state-based)
  query: "SELECT\n  s.authority AS p0_auth,\n  s.identifier AS p0_id,\n  -- Child\n\
    \  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS\
    \ p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name\
    \ AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid AS p1_euid,\n  p1.cmdline AS\
    \ p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n\
    \  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256\
    \ AS p2_sha256\nFROM\n  processes p0\n  LEFT JOIN file f ON p0.path = f.path\n\
    \  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN hash p0_hash ON p0.path\
    \ = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN\
    \ file p1_f ON p1.path = p1_f.path\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n\
    \  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path\
    \ = p2_hash.path\nWHERE\n  p0.pid IN (\n    SELECT\n      p.pid\n    FROM\n  \
    \    processes p\n    WHERE\n      p.name IN (\n        'bitspin',\n        'bpftool',\n\
    \        'cpuminer-multi',\n        'cpuminer',\n        'dnscat2',\n        'esxcli',\n\
    \        'heyoka',\n        'httpdns',\n        'incbit',\n        'iodine',\n\
    \        'lushput',\n        'minerd',\n        'mkfifo',\n        'msfvenom',\n\
    \        'nc',\n        'nstx',\n        'rsh',\n        'rshell',\n        'socat',\n\
    \        'tuns',\n        'vim-cmd',\n        'xmrig'\n      ) -- coin miner names\n\
    \      OR REGEX_MATCH (p.name, \"(pwn|xig|xmr)\", 1) != \"\" -- malicious processes\n\
    \      OR REGEX_MATCH (\n        p.cmdline,\n        \"(bitspin|lushput|incbit|traitor|msfvenom|urllib.urlopen|nohup.*tmp|chrome.*--load-extension|tail\
    \ -f /dev/null|wormhole)\",\n        1\n      ) != \"\" -- suspicious things\n\
    \      OR REGEX_MATCH (\n        p.cmdline,\n        \"(UserKnownHostsFile=/dev/null|ransom|fsockopen|openssl.*quiet|pty.spawn|SOCK_STREAM)\"\
    ,\n        1\n      ) != \"\" -- Crypto miners\n      OR REGEX_MATCH (\n     \
    \   p.cmdline,\n        \"(c3pool|cryptonight|f2pool|hashrate|hashvault|minerd|monero|nanopool|nicehash|stratum|wss://|\
    \ --pool| --algo)\",\n        1\n      ) != \"\" -- Needs to be case sensitive\n\
    \      OR (\n        INSTR(p.cmdline, '%Socket.%') > 0\n        AND NOT p.name\
    \ IN ('cc1', 'compile', 'cmake', 'cc1plus')\n      )\n      OR p.cmdline LIKE\
    \ '%dd if=/dev/%'\n  )\n  AND NOT (\n    p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'\n\
    \    AND (\n      p0_cmd LIKE \"%lima/%\"\n      OR p0_cmd LIKE \"%minikube/%\"\
    \n      OR p0_cmd LIKE '%@localhost'\n      OR p0_cmd LIKE '%ServerAliveInterval=0%'\n\
    \      OR p1_cmd LIKE '%gcloud.py%'\n    )\n  )\n  AND NOT (\n    p0_cmd LIKE\
    \ '%sh -i'\n    AND p1_cmd LIKE '%pipenv shell'\n  )\n  AND NOT p0_cmd IN ('pkill\
    \ -f Jabra Direct')\n  AND NOT p0_cmd LIKE \"%dd if=/dev/stdin conv=unblock cbs=79\"\
    \n  AND NOT p0_cmd LIKE '%docker% run % tail -f /dev/null'\n  AND NOT p1_path\
    \ LIKE '/Applications/Emacs.app/Contents/MacOS/Emacs-arm64-%'\n  AND NOT p0_path\
    \ = '/Applications/Google Drive.app/Contents/MacOS/crashpad_handler'\nGROUP BY\n\
    \  p0.cmdline\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
