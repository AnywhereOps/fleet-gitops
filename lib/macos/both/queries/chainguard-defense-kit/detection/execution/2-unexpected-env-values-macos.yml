- name: CDK - Unexpected Env Values Macos
  description: 'Applications setting environment variables to bypass security protections
    Inpsired by BPFdoor and other intrusions https://www.sandflysecurity.com/blog/compromised-linux-cheat-sheet/
    WARNING: This query is known to require a higher than average wall time.'
  query: "SELECT\n  key,\n  value,\n  p.pid,\n  p.path,\n  p.cwd,\n  p.cmdline,\n\
    \  p.parent AS parent_pid,\n  pp.cmdline AS parent_cmd\n  -- Querying processes\
    \ first and filtering by time gives a massive 20X speed improvement\n  -- over\
    \ querying process_envs first and JOIN'ing against processes\nFROM\n  processes\
    \ p\n  LEFT JOIN process_envs pe ON p.pid = pe.pid\n  LEFT JOIN processes pp ON\
    \ p.parent = pp.pid\nWHERE -- This time should match the interval\n  p.start_time\
    \ > (strftime('%s', 'now') - 60)\n  AND (\n    key = 'HISTFILE'\n    AND NOT value\
    \ LIKE '/Users/%/.%_history'\n    AND NOT value = '~/.tramp_history'\n  )\n  OR\
    \ (\n    key = 'LD_PRELOAD'\n    AND NOT p.path LIKE '%/firefox'\n    AND NOT\
    \ pe.value = 'libfakeroot.so'\n    AND NOT pe.value LIKE 'libmozsandbox.so%'\n\
    \    AND NOT pe.value LIKE ':/snap/%' -- Yes, on macOS (emote)\n  )\n  OR (\n\
    \    key = 'DYLD_INSERT_LIBRARIES' -- actively exploited on programs which disable\
    \ library security\n    AND NOT pe.value = '/System/Library/PrivateFrameworks/PreviewsInjection.framework/PreviewsInjection'\n\
    \    AND NOT pe.value LIKE '/opt/homebrew/Cellar/r/4.%/lib/R/lib/libR.dylib'\n\
    \    AND NOT pe.value LIKE '%/libsamply_mac_preload.dylib'\n    AND NOT pe.value\
    \ LIKE '%/Steam/Steam.AppBundle/Steam/Contents/MacOS/steamloader.dylib:%/Steam/Steam.AppBundle/Steam/Contents/MacOS/gameoverlayrenderer.dylib'\n\
    \    AND NOT pe.value LIKE '%/libtrace.dylib'\n    AND NOT pe.value LIKE '%/libR.dylib'\n\
    \  )\n  OR (\n    key = 'DYLD_FRAMEWORK_PATH' -- sort of obsolete, but may affect\
    \ SIP abusers\n    AND NOT pe.value LIKE '%/IDLE.app/%'\n    AND NOT pe.value\
    \ LIKE '/Users/%/Library/Caches/ms-playwright/webkit-%'\n    AND NOT pe.value\
    \ = '/System/Library/Frameworks'\n  )\n"
  platform: darwin
  interval: 60
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
