- name: CDK - Touched Executable Macos
  description: Programs which appear to have been touched on macOS This check is probably
    not very useful as there are plenty of legit reasons why the dates (in particular,
    'btime'), gets doctored.
  query: "SELECT\n  p.path,\n  p.name,\n  p.cmdline,\n  p.euid,\n  DATETIME(p.start_time,\
    \ 'unixepoch') AS started,\n  DATETIME(f.ctime, 'unixepoch') AS changed,\n  DATETIME(f.btime,\
    \ 'unixepoch') AS birthed,\n  DATETIME(f.mtime, 'unixepoch') AS modified,\n  DATETIME(f.atime,\
    \ 'unixepoch') AS accessed,\n  (f.btime - f.ctime) / 86400 AS btime_ctime_days_diff,\n\
    \  (p.start_time - f.atime) / 86400 AS start_atime_days_diff,\n  pp.path AS parent_path,\n\
    \  pp.cmdline AS parent_cmd,\n  pp.cwd AS parent_cwd,\n  hash.sha256 AS sha256,\n\
    \  signature.identifier,\n  signature.authority\nFROM\n  processes p\n  LEFT JOIN\
    \ file f ON p.path = f.path\n  LEFT JOIN processes pp ON p.parent = pp.pid\n \
    \ LEFT JOIN hash ON p.path = hash.path\n  LEFT JOIN signature ON p.path = signature.path\n\
    WHERE\n  p.pid IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n\
    \      path NOT LIKE '/System/%'\n      AND path NOT LIKE '/Applications/%/Contents/MacOS/%'\n\
    \      AND path NOT LIKE '/Library/Apple/%'\n      AND path NOT LIKE '/opt/%/bin/%'\n\
    \      AND path NOT LIKE '/private/var/db/com.apple.xpc.roleaccountd.staging/%'\n\
    \      AND path NOT LIKE '/sbin/%'\n      AND path NOT LIKE '/usr/bin/%'\n   \
    \   AND path NOT LIKE '/usr/libexec/%'\n      AND path NOT LIKE '/usr/local/kolide-k2/bin/launcher-updates/%/Kolide.app/Contents/MacOS/launcher'\n\
    \      AND path NOT LIKE '/usr/local/kolide-k2/bin/osqueryd-updates/%/osqueryd'\n\
    \      AND path NOT LIKE '/usr/sbin/%'\n      AND path NOT LIKE '/Volumes/%'\n\
    \  )\n  AND f.btime = f.mtime\n  AND (\n    -- change time is older than birth\
    \ time\n    btime_ctime_days_diff > 0 -- change time is older than birth time,\
    \ but not 1970\n    OR (\n      (btime_ctime_days_diff < -365)\n      AND (btime_ctime_days_diff\
    \ < -1000)\n    ) -- access time is older than start time\n    OR start_atime_days_diff\
    \ > 90\n  ) -- Vendors that create software packages that look like a touched\
    \ file.\n  AND NOT signature.authority IN (\n    'Apple Mac OS Application Signing',\n\
    \    'Developer ID Application: Adobe Inc. (JQ525L2MZD)',\n    'Developer ID Application:\
    \ Brave Software, Inc. (KL8N8XSYF4)',\n    'Developer ID Application: Brother\
    \ Industries, LTD. (5HCL85FLGW)',\n    'Developer ID Application: Bryan Jones\
    \ (49EYHPJ4Q3)',\n    'Developer ID Application: CodeWeavers Inc. (9C6B7X7Z8E)',\n\
    \    'Developer ID Application: Corsair Memory, Inc. (Y93VXCB8Q5)',\n    'Developer\
    \ ID Application: Docker Inc (9BNSXJN65R)',\n    'Developer ID Application: Emmanouil\
    \ Konstantinidis (3YP8SXP3BF)',\n    'Developer ID Application: Fumihiko Takayama\
    \ (G43BCU2T37)',\n    -- Karibiner\n    'Developer ID Application: Galvanix (5BRAQAFB8B)',\n\
    \    'Developer ID Application: General Arcade (Pte. Ltd.) (S8JLSG5ES7)',\n  \
    \  'Developer ID Application: GEORGE NACHMAN (H7V7XYVQ7D)',\n    'Developer ID\
    \ Application: GitHub (VEKTX9H2N7)',\n    'Developer ID Application: Google LLC\
    \ (EQHXZ8M8AV)',\n    'Developer ID Application: JetBrains s.r.o. (2ZEFAR8TH3)',\n\
    \    'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n    'Developer ID\
    \ Application: Michael Jones (YD6LEYT6WZ)',\n    'Developer ID Application: Microsoft\
    \ Corporation (UBF8T346G9)',\n    'Developer ID Application: Oracle America, Inc.\
    \ (VB5E2TV963)',\n    'Developer ID Application: OSQUERY A Series of LF Projects,\
    \ LLC (3522FA9PXF)',\n    'Developer ID Application: Reflect App, LLC (789ULN5MZB)',\n\
    \    'Developer ID Application: RescueTime, Inc (FSY4RB8H39)',\n    'Developer\
    \ ID Application: Seiko Epson Corporation (TXAEAV5RN4)',\n    'Developer ID Application:\
    \ Slack Technologies, Inc. (BQR82RBBHL)',\n    'Developer ID Application: Sublime\
    \ HQ Pty Ltd (Z6D26JE4Y4)',\n    'Developer ID Application: Yubico Limited (LQA3CS5MM7)',\n\
    \    'Developer ID Application: Zoom Video Communications, Inc.',\n    'Software\
    \ Signing'\n  )\n  AND NOT (\n    p.euid > 500\n    AND (\n      p.path IN (\n\
    \        '/Applications/Canon Utilities/IJ Scan Utility/Canon IJ Scan Utility\
    \ Lite.app/Contents/Library/LoginItems/CIJSULAgent.app/Contents/MacOS/CIJSULAgent',\n\
    \        '/Applications/Canon Utilities/Inkjet Extended Survey Program/Inkjet\
    \ Extended Survey Program.app/Contents/MacOS/ESPController.app/Contents/Library/LoginItems/CanonIJExtendedSurveyLaunchAgent.app/Contents/MacOS/CanonIJExtendedSurveyLaunchAgent',\n\
    \        '/Applications/Divvy.app/Contents/MacOS/Divvy',\n        '/Applications/Sourcetree.app/Contents/MacOS/Sourcetree',\n\
    \        '/Library/CoreMediaIO/Plug-Ins/DAL/LogiCapture.plugin/Contents/MacOS/Assistant',\n\
    \        '/Library/Printers/Brother/Utilities/BrStatusMonitor.app/Contents/MacOS/BrStatusMonitor',\n\
    \        '/opt/homebrew/share/google-cloud-sdk/bin/log-streaming',\n        '/usr/local/bin/node'\n\
    \      )\n      OR p.path LIKE '/Applications/%.app/Contents/Frameworks/%/Versions/A/Resources/%'\n\
    \      OR p.path LIKE '/Users/%/.cache/gitstatus/gitstatusd-darwin-arm64'\n  \
    \    OR p.path LIKE '/Applications/%.app/Contents/MacOS/%'\n      OR p.path LIKE\
    \ '/opt/homebrew/Caskroom/%/bin/%'\n      OR p.path LIKE '/opt/homebrew/Cellar/%/bin/%'\n\
    \      OR p.path LIKE '/private/var/folders/%/T/AppTranslocation/%/Contents/MacOS/%'\n\
    \      OR p.path LIKE '/Users/%/google-cloud-sdk/bin/%'\n      OR p.path LIKE\
    \ '/Users/%/J8RPQ294UB.com.skitch.SkitchHelper'\n      OR p.path LIKE '/Users/%/Library/Application\
    \ Support/com.elgato.StreamDeck/Plugins/%'\n    )\n  )\n  AND NOT (\n    p.euid\
    \ > 300\n    AND p.path LIKE '/nix/store/%'\n  )\n  AND NOT (\n    p.euid > 300\
    \ -- Electron\n    AND p.path LIKE '% Helper'\n  )\n  AND NOT (\n    p.euid =\
    \ 0\n    AND (\n      p.path LIKE '/nix/store/%/bin/nix'\n      OR p.path LIKE\
    \ '/nix/store/%/bin/nix-daemon'\n    )\n  )\nGROUP by\n  p.pid\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
