- name: CDK - Old Binaries Running
  description: Alert on programs running that are unusually old
  query: "SELECT\n  p.path,\n  p.cmdline,\n  p.cwd,\n  p.pid,\n  p.name,\n  f.mtime,\n\
    \  f.ctime,\n  p.cgroup_path,\n  ((strftime('%s', 'now') - f.ctime) / 86400) AS\
    \ ctime_age_days,\n  ((strftime('%s', 'now') - f.mtime) / 86400) AS mtime_age_days,\n\
    \  ((strftime('%s', 'now') - f.btime) / 86400) AS btime_age_days,\n  h.sha256,\n\
    \  f.uid,\n  m.data,\n  f.gid\nFROM\n  processes p\n  LEFT JOIN file f ON p.path\
    \ = f.path\n  LEFT JOIN hash h ON p.path = h.path\n  LEFT JOIN magic m ON p.path\
    \ = m.path\nWHERE\n  (\n    ctime_age_days > 1460\n    OR mtime_age_days > 1460\n\
    \  )\n  -- Jan 1st, 1980 (the source of many false positives)\n  AND f.mtime >\
    \ 315561600\n  AND f.path NOT LIKE '/home/%/idea-IU-223.8214.52/%'\n  AND f.directory\
    \ NOT LIKE '/Applications/%.app/Contents/Frameworks/%/Resources'\n  AND f.directory\
    \ NOT LIKE '/Applications/%.app/Contents/MacOS'\n  AND f.directory NOT LIKE '/opt/homebrew/Cellar/%/bin'\n\
    \  AND f.path NOT IN (\n    '/Applications/Gitter.app/Contents/Library/LoginItems/GitterHelperApp.app/Contents/MacOS/GitterHelperApp',\n\
    \    '/Applications/Pandora.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Resources/crashpad_handler',\n\
    \    '/Applications/Skitch.app/Contents/Library/LoginItems/J8RPQ294UB.com.skitch.SkitchHelper.app/Contents/MacOS/J8RPQ294UB.com.skitch.SkitchHelper',\n\
    \    '/Applications/Vimari.app/Contents/PlugIns/Vimari Extension.appex/Contents/MacOS/Vimari\
    \ Extension',\n    '/Library/Apple/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/A/Resources/usbmuxd',\n\
    \    '/Library/Application Support/EPSON/Scanner/ScannerMonitor/Epson Scanner\
    \ Monitor.app/Contents/MacOS/Epson Scanner Monitor',\n    '/Library/Application\
    \ Support/LogiFacecam.bundle/Contents/MacOS/LogiFacecamService',\n    '/Library/Application\
    \ Support/Logitech/com.logitech.vc.LogiVCCoreService/LogiVCCoreService.app/Contents/MacOS/LogiVCCoreService',\n\
    \    '/Library/Application Support/Razer/RzUpdater.app/Contents/MacOS/RzUpdater',\n\
    \    '/Library/Java/JavaVirtualMachines/jdk-17.0.2.jdk/Contents/Home/bin/java',\n\
    \    '/Volumes/CANON_IJ/Setup.app/Contents/MacOS/Setup',\n    '/opt/IRCCloud/chrome-sandbox',\n\
    \    '/opt/IRCCloud/irccloud',\n    '/snap/brackets/138/opt/brackets/Brackets-node',\n\
    \    '/snap/brackets/138/opt/brackets/Brackets',\n    '/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/A/Resources/usbmuxd',\n\
    \    '/usr/bin/dbus-broker-launch',\n    '/usr/bin/espeak',\n    '/usr/bin/i3blocks',\n\
    \    '/usr/bin/i3lock',\n    '/usr/bin/mono-sgen',\n    '/usr/bin/pavucontrol',\n\
    \    '/usr/bin/sshfs',\n    '/usr/bin/unpigz',\n    '/usr/bin/xbindkeys',\n  \
    \  '/usr/bin/xclip',\n    '/usr/bin/xsel',\n    '/usr/bin/xsettingsd',\n    '/usr/bin/xss-lock',\n\
    \    '/usr/libexec/dconf-service',\n    '/usr/local/bin/dive'\n  )\n  AND f.path\
    \ NOT LIKE '/Library/Printers/%'\n  AND p.name NOT IN (\n    'Android File Transfer\
    \ Agent',\n    'BluejeansHelper',\n    'buildkitd',\n    'dlv',\n    'Flycut',\n\
    \    'gitstatusd-darwin-arm64',\n    'gitstatusd-linu',\n    'J8RPQ294UB.com.skitch.SkitchHelper',\n\
    \    'kail',\n    'Pandora Helper',\n    'Pandora',\n    'SetupWizard',\n    'Vimari\
    \ Extension'\n  )\n  AND f.path NOT LIKE '/private/var/folders/%/T/AppTranslocation/%/d/Skitch.app/Contents/MacOS/Skitch'\n\
    \  AND f.path NOT LIKE '/private/var/folders/%/T/AppTranslocation/%/d/Spectacle.app/Contents/MacOS/Spectacle'\n\
    \  AND f.path NOT LIKE '/snap/surfshark/%/usr/bin/gjs-console'\n  AND f.filename\
    \ NOT LIKE 'protoc-%'\n  AND p.cgroup_path NOT LIKE '/system.slice/docker-%'\n\
    \  AND p.cgroup_path NOT LIKE '/user.slice/user-%.slice/user@%.service/user.slice/nerdctl-%'\n\
    \  AND p.cgroup_path NOT LIKE '/user.slice/user-%.slice/user@%.service/user.slice/podman-%'\n\
    GROUP BY\n  p.pid,\n  p.path\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
