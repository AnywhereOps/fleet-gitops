- name: CDK - Unexpected Kernel Extensions Macos
  description: Find unexpected 3rd-party kernel extensions
  query: "SELECT\n  k.linked_against,\n  k.name,\n  k.path,\n  k.size,\n  k.version,\n\
    \  hash.sha256,\n  k.path || ',' || k.name || ',' || k.version || ',' || k.linked_against\
    \ AS exception_key\nFROM\n  kernel_extensions AS k\n  LEFT JOIN hash ON k.path\
    \ = hash.path\nWHERE\n  k.path NOT LIKE '/System/Library/Extensions/%'\n  AND\
    \ NOT (\n    idx = 0\n    AND name = '__kernel__'\n  )\n  AND exception_key NOT\
    \ IN (\n    '/Library/StagedExtensions/Library/Extensions/CalDigitUSBHubSupport.kext,com.CalDigit.USBHubSupport,1,<3>',\n\
    \    '/Library/StagedExtensions/Library/Filesystems/kbfuse.fs/Contents/Extensions/13/kbfuse.kext,com.github.kbfuse.filesystems.kbfuse,2113.21,<1\
    \ 3 4 5 7>',\n    '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/14/macfuse.kext,io.macfuse.filesystems.macfuse,2128.20,<1\
    \ 3 4 5 7>'\n  )\n  AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/UAD2System.kext,com.uaudio.driver.UAD2System,%'\n\
    \  AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_ExtFS.kext,com.paragon-software.filesystems.extfs,%'\n\
    \  AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Extensions/ufsd_NTFS.kext,com.paragon-software.filesystems.ntfs,%'\n\
    \  AND exception_key NOT LIKE '/Library/StagedExtensions/Library/Filesystems/macfuse.fs/Contents/Extensions/%/macfuse.kext,io.macfuse.filesystems.macfuse,%'\n\
    \  AND exception_key NOT LIKE '/usr/appleinternal/standalone/platform,com.apple.sptm,24.%'\n\
    \  AND exception_key NOT LIKE '/usr/appleinternal/standalone/platform,com.apple.txm,24.%'\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
