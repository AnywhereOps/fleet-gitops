- name: CDK - Unexpected Webmail Downloads
  description: Surface webmail downloads of an unexpected sort
  query: "SELECT\n  file.path,\n  file.size,\n  datetime(file.btime, 'unixepoch')\
    \ AS file_created,\n  magic.data,\n  hash.sha256,\n  s.authority,\n  s.identifier,\n\
    \  LOWER(\n    REGEX_MATCH (RTRIM(file.path, '/'), '.*\\.(.*?)$', 1)\n  ) AS extension\n\
    FROM\n  mdfind\n  LEFT JOIN file ON mdfind.path = file.path\n  LEFT JOIN magic\
    \ ON file.path = magic.path\n  LEFT JOIN hash ON file.path = hash.path\n  LEFT\
    \ JOIN signature s ON file.path = s.path\nWHERE\n  mdfind.query = 'kMDItemWhereFroms\
    \ == ''*https://mail.google.com/*'''\n  AND file.btime > (strftime('%s', 'now')\
    \ -86400)\n  -- Extensions that would not normally raise suspicion if sent by\
    \ e-mail (excludes dmg, iso, lnk, exe)\n  AND extension NOT IN (\n    'ai',\n\
    \    'avi',\n    'cer',\n    'csv',\n    'doc',\n    'Dockerfile',\n    'docx',\n\
    \    'dwg',\n    'eml',\n    'eps',\n    'gif',\n    'heic',\n    'htm',\n   \
    \ 'html',\n    'icloud',\n    'itermexport',\n    'jfif',\n    'jpeg',\n    'jpg',\n\
    \    'json',\n    'key',\n    'loaded_0',\n    'loaded_1',\n    'md',\n    'mov',\n\
    \    'mp3',\n    'mp4',\n    'mpeg',\n    'mpg',\n    'msg',\n    'numbers',\n\
    \    'ods',\n    'odt',\n    'pages',\n    'pdf',\n    'pem',\n    'pgp',\n  \
    \  'pkpass',\n    'png',\n    'potx',\n    'ppt',\n    'pptx',\n    'pub',\n \
    \   'rtf',\n    'svg',\n    'tf',\n    'tif',\n    'tiff',\n    'txt',\n    'wav',\n\
    \    'webp',\n    'xls',\n    'xlsb',\n    'xlsm',\n    'xlsx',\n    'xml',\n\
    \    'yaml',\n    'yml',\n    'zip'\n  )\n  AND file.path NOT LIKE '%/Dockerfile'\n\
    GROUP BY\n  file.path\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
