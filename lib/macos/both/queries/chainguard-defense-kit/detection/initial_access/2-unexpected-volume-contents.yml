- name: CDK - Unexpected Volume Contents
  description: Scan removable volumes for sketchy files
  query: "SELECT\n  RTRIM(file.path, '/') AS trimpath,\n  uid,\n  filename,\n  gid,\n\
    \  mode,\n  REGEX_MATCH (file.path, '(.*)/', 1) AS dirname,\n  REGEX_MATCH (RTRIM(file.path,\
    \ '/'), '.*/(.*?)$', 1) AS basename,\n  REGEX_MATCH (RTRIM(file.path, '/'), '.*\\\
    .(.*?)$', 1) AS extension,\n  mtime,\n  ctime,\n  symlink,\n  type,\n  size,\n\
    \  hash.sha256,\n  magic.data,\n  signature.identifier,\n  signature.authority\n\
    FROM\n  file\n  LEFT JOIN hash on file.path = hash.path\n  LEFT JOIN magic ON\
    \ file.path = magic.path\n  LEFT JOIN signature ON file.path = signature.path\n\
    WHERE\n  (\n    file.path LIKE '/Volumes/%/%'\n    OR file.path LIKE '/Volumes/%/.%'\n\
    \  )\n  AND file.path NOT LIKE '/Volumes/Macintosh HD%'\n  AND file.path NOT LIKE\
    \ '/Volumes/%/.com.apple.timemachine%'\n  AND (\n    extension IN (\n      'command',\n\
    \      'dmg',\n      'gcode',\n      'gz',\n      'iso',\n      'lnk',\n     \
    \ 'mpkg',\n      'pkg',\n      'scpt',\n      'sh',\n      'sql'\n    )\n    OR\
    \ file.symlink != 0\n    OR basename LIKE '.%'\n    OR basename LIKE '%.sql%'\n\
    \    OR basename LIKE '%Chrome%'\n    OR basename LIKE '%enforce%'\n    OR basename\
    \ LIKE '%Extension%'\n    OR basename LIKE '%guard%'\n    OR basename LIKE '%hidden%'\n\
    \    OR basename LIKE '%Installer%'\n    OR basename LIKE '%mono%'\n    OR basename\
    \ LIKE '%secret%'\n    OR basename LIKE '%sql%'\n    OR basename LIKE 'cg%'\n\
    \  ) -- exceptions go here\n  AND basename NOT IN (\n    '.',\n    '..',\n   \
    \ '._.apdisk',\n    '._.TemporaryItems',\n    '._.Trashes',\n    '._AUTORUN.INF',\n\
    \    '._Id.txt',\n    '.actrc',\n    '.angular-config.json',\n    '.apdisk',\n\
    \    '.background',\n    '.background.png',\n    '.background.tiff',\n    '.bash_history',\n\
    \    '.bashrc',\n    '.CFUserTextEncoding',\n    '.dbshell',\n    '.disk_label',\n\
    \    '.disk_label_2x',\n    '.DS_Store',\n    '.file',\n    '.file-revisions-by-id',\n\
    \    '.flyrc',\n    '.gitconfig',\n    '.iotest',\n    '.keystone_install',\n\
    \    '.lesshst',\n    '.metadata_never_index_unless_rootfs',\n    '.mysql_history',\n\
    \    '.pdfbox.cache',\n    '.shortcut-targets-by-id',\n    '.TemporaryItems',\n\
    \    '.Trashes',\n    '.vol',\n    '.VolumeIcon.icns',\n    '.zsh_history',\n\
    \    'GTechnologyFormatWizard_Installer.msi',\n    'KBFS_NOT_RUNNING',\n    'LogiPresentation\
    \ Installer.app',\n    'pve-installer.squashfs',\n    'Seagate Dashboard Installer.exe',\n\
    \    'UFRII_LT_LIPS_LX_Installer.pkg'\n  )\n  AND authority NOT IN (\n    'Developer\
    \ ID Application: Adobe Inc. (JQ525L2MZD)',\n    'Developer ID Application: BlueStack\
    \ Systems, Inc. (QX5T8D6EDU)',\n    'Developer ID Application: Canon Inc. (XE2XNRRXZ5)',\n\
    \    'Developer ID Application: Cisco (DE8Y96K9QP)',\n    'Developer ID Application:\
    \ Dropbox, Inc. (G7HH3F8CAK)',\n    'Developer ID Application: Google LLC (EQHXZ8M8AV)',\n\
    \    'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n    'Developer ID\
    \ Application: Martijn Smit (GX645XXEAX)'\n  ) -- Unsigned programs here\n  AND\
    \ trimpath NOT IN (\n    '/Volumes/Garmin Express/Install Garmin Express.pkg',\n\
    \    '/Volumes/Google Chrome Canary/.keystone_install',\n    '/Volumes/Google\
    \ Chrome/.keystone_install',\n    '/Volumes/Jabra Direct Setup/JabraDirectSetup.pkg',\n\
    \    '/Volumes/macFUSE/.engine_install',\n    '/Volumes/macFUSE/Install macFUSE.pkg',\n\
    \    '/Volumes/PMHOME_3601DL/PMH_INST.pkg'\n  )\n  AND trimpath NOT LIKE '/Volumes/Blackmagic\
    \ DaVinci Resolve/Install Resolve %.pkg'\n  AND trimpath NOT LIKE '/Volumes/Google\
    \ Earth Pro%/Install Google Earth Pro%.pkg'\n  AND trimpath NOT LIKE '/Volumes/JDK\
    \ %/JDK %.pkg'\n  AND trimpath NOT LIKE '/Volumes/mysql-shell-%/mysql-shell-%.pkg'\n\
    \  AND trimpath NOT LIKE '/Volumes/Splunk %/Install Splunk'\n  AND magic.data\
    \ NOT LIKE 'ASCII text%'\n  AND NOT (\n    magic.data = 'AppleDouble encoded Macintosh\
    \ file'\n    AND basename LIKE '._%'\n  )\n  AND NOT (\n    filename = \".install\"\
    \n    AND size = 0\n  )\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
