- name: CDK - Sketchy Mounted Diskimage
  description: Look for sketchy mounted disk images, inspired by Shlayer
  query: "SELECT\n  RTRIM(file.path, '/') AS f,\n  file.bsd_flags AS f_flags,\n  file.gid\
    \ AS f_gid,\n  file.mode AS f_mode,\n  file.size AS f_size,\n  file.type AS f_type,\n\
    \  REGEX_MATCH (file.filename, '.*\\.(.*?)$', 1) AS f_ext,\n  file.uid AS f_uid,\n\
    \  hash.sha256 AS f_sha256,\n  magic.data AS f_data,\n  mdfind.path AS probable_source,\n\
    \  mdhash.sha256 AS probable_source_sha256,\n  ea.value AS probable_url,\n  REGEX_MATCH\
    \ (file.path, '/Volumes/(.*?)/', 1) AS vol_name,\n  signature.authority AS s_auth,\n\
    \  signature.identifier AS s_id\nFROM\n  file\n  LEFT JOIN mdfind ON mdfind.query\
    \ = \"kMDItemFSName == '*\" || REGEX_MATCH (file.path, '/Volumes/(\\w+)', 1) ||\
    \ \"*.dmg'\"\n  LEFT JOIN extended_attributes ea ON mdfind.path = ea.path\n  AND\
    \ ea.key = 'where_from'\n  LEFT JOIN hash on file.path = hash.path\n  LEFT JOIN\
    \ hash mdhash ON mdfind.path = mdhash.path\n  LEFT JOIN magic ON file.path = magic.path\n\
    \  LEFT JOIN signature ON file.path = signature.path\nWHERE\n  file.path IN (\n\
    \    SELECT DISTINCT\n      file.path\n    FROM\n      block_devices\n      JOIN\
    \ mounts ON mounts.device = block_devices.name\n      JOIN file ON file.directory\
    \ = mounts.path\n      OR file.directory LIKE mounts.path || \"/%.app/Contents/MacOS/\"\
    \n      OR file.directory LIKE mounts.path || \"/%.app/Contents/Resources/\"\n\
    \      OR file.directory LIKE mounts.path || \"/%/%.app/Contents/Library/LaunchServices\"\
    \n      OR file.directory LIKE mounts.path || \"/%/%.app/Contents/MacOS/\"\n \
    \     OR file.directory LIKE mounts.path || \"/%/%.app/Contents/Resources/\"\n\
    \    WHERE\n      model = 'Disk Image'\n      AND parent != \"\"\n      AND mounts.path\
    \ LIKE \"/Volumes/%\"\n      -- osquery will traverse symlinks, this prevents\
    \ following symlinks to /Applications (poorly)\n      AND file.path NOT LIKE \"\
    /Volumes/%/Applications/%\"\n      AND file.path NOT LIKE \"/Volumes/%/ /%\"\n\
    \      AND NOT (\n        file.type != \"regular\"\n        AND file.directory\
    \ LIKE '%/Contents/Resources/'\n      )\n  )\n  AND (\n    --   Rule 0. App binaries\
    \ that are hidden, like WnBJLaF/1302.app/Contents/MacOS/1302 (1302.app)\n    (\n\
    \      file.directory LIKE '/Volumes/%/Contents/MacOS'\n      AND file.bsd_flags\
    \ = \"HIDDEN\"\n    ) --   Rule 1. App binaries that are a thin shell script wrapper\
    \ for another resource (Player_009.app, 1302.app)\n    OR (\n      file.directory\
    \ LIKE '/Volumes/%/Contents/MacOS'\n      AND file.mode LIKE \"%7%\"\n      AND\
    \ file.type != 'directory'\n      AND magic.data LIKE '%script%'\n      AND signature.identifier\
    \ != 'net.snowflake.snowsql'\n      AND signature.authority NOT IN (\n       \
    \ 'Developer ID Application: Allen Bai (97DN42T837)',\n        'Developer ID Application:\
    \ BlueStack Systems, Inc. (QX5T8D6EDU)',\n        'Developer ID Application: Galvanix\
    \ (5BRAQAFB8B)'\n      )\n      AND vol_name NOT LIKE 'BBEdit%'\n    ) -- Rule\
    \ 2. App binaries that have mixed-caps names such as LYwjtu0sc3XqkNVbQe_gM4YiRpmgUpRIew\
    \ or yWnBJLaF (AdobeFlashPlayer_567.app)\n    OR (\n      file.mode LIKE \"%7%\"\
    \n      AND file.type != 'directory'\n      AND REGEX_MATCH (file.filename, '([a-z]+[A-Z][A-Z]+[a-z]+)',\
    \ 1) != \"\"\n      AND magic.data LIKE \"%executable%\"\n      -- Some people\
    \ do weird things!\n      AND signature.authority NOT IN (\n        'Software\
    \ Signing',\n        'Developer ID Application: Atlassian Pty Ltd (UPXU4CQZ5P)',\n\
    \        'Developer ID Application: Logitech Inc. (QED4VVPZWA)',\n        'Developer\
    \ ID Application: MacroMates Ltd. (45TL96F76G)',\n        'Developer ID Application:\
    \ OpenAI, L.L.C. (2DC432GLL2)'\n      )\n    ) -- Rule 3. App binaries with a\
    \ numerical name, such as 2829030009 (Player_009.app)\n    OR (\n      file.mode\
    \ LIKE \"%7%\"\n      AND file.type != 'directory'\n      AND REGEX_MATCH (file.filename,\
    \ '^(\\d)+$', 1) != \"\"\n    ) --   4. App resources that are Mach-O binaries,\
    \ such as 2829030009, or enc (Player_009.app, AdobeFlashPlayer_567.app)\n    OR\
    \ (\n      file.directory LIKE '/Volumes/%/Resources'\n      AND magic.data LIKE\
    \ '%executable%'\n      AND f_ext NOT IN ('py', 'sh', 'metallib', 'js')\n    )\
    \ --   5. Volumes with a name containing suspicious names: Player, Flash, Update\n\
    \    OR (\n      (\n        vol_name LIKE \"Install%\"\n        -- The rest are\
    \ synced with sketchy-download-names\n        OR vol_name LIKE \"%.app%\"\n  \
    \      OR vol_name LIKE \"%Advertising%\"\n        OR vol_name LIKE \"%agreement%\"\
    \n        OR vol_name LIKE \"%animated%\"\n        OR vol_name LIKE \"%AnyDesk%\"\
    \n        OR vol_name LIKE \"%Brief%\"\n        OR vol_name LIKE \"%confidential%\"\
    \n        OR vol_name LIKE \"%confidentiality%\"\n        OR vol_name LIKE \"\
    %conract%\"\n        OR vol_name LIKE \"%contract%\"\n        OR vol_name LIKE\
    \ \"%cover%\"\n        OR vol_name LIKE \"%crack%\"\n        OR vol_name LIKE\
    \ \"%curriculum%\"\n        OR vol_name LIKE \"%cv\"\n        OR vol_name LIKE\
    \ \"%description%\"\n        OR vol_name LIKE \"%Flash%\"\n        OR vol_name\
    \ LIKE \"%freyavr%\"\n        OR vol_name LIKE \"%game%\"\n        OR vol_name\
    \ LIKE \"%immediate%\"\n        OR vol_name LIKE \"%logos%\"\n        OR vol_name\
    \ LIKE \"%official%\"\n        OR vol_name LIKE \"%pdf%\"\n        OR vol_name\
    \ LIKE \"%Player%\"\n        OR vol_name LIKE \"%poster%\"\n        OR vol_name\
    \ LIKE \"%presentation%\"\n        OR vol_name LIKE \"%receipt%\"\n        OR\
    \ vol_name LIKE \"%reference%\"\n        OR vol_name LIKE \"%resume%\"\n     \
    \   OR vol_name LIKE \"%secret%\"\n        OR vol_name LIKE \"%terms%\"\n    \
    \    OR vol_name LIKE \"%trading%\"\n        OR vol_name LIKE \"%Update%\"\n \
    \       OR vol_name LIKE \"%weed%\"\n        OR vol_name LIKE \"cv%\"\n      )\n\
    \      AND file.directory LIKE \"/Volumes/%/Contents/MacOS\"\n      AND signature.authority\
    \ NOT IN (\n        \"Developer ID Application: Bookry Ltd (4259LE8SU5)\",\n \
    \       \"Developer ID Application: Bose Corporation (QC9P7FKWH6)\",\n       \
    \ \"Developer ID Application: Cisco (DE8Y96K9QP)\",\n        \"Developer ID Application:\
    \ Geocomply USA, Inc. (6YPTSWJK4P)\",\n        \"Developer ID Application: Google\
    \ LLC (EQHXZ8M8AV)\",\n        \"Developer ID Application: Justin Clift (C34AV33YLK)\"\
    ,\n        \"Developer ID Application: Logitech Inc. (QED4VVPZWA)\",\n       \
    \ \"Developer ID Application: OpenAI, L.L.C. (2DC432GLL2)\",\n        \"Developer\
    \ ID Application: Oracle America, Inc. (VB5E2TV963)\",\n        \"Developer ID\
    \ Application: Orbital Labs, LLC (U.S.) (HUAQ24HBR6)\",\n        \"Developer ID\
    \ Application: Roblox Corporation (2CFABCH843)\",\n        \"Developer ID Application:\
    \ VideoLAN (75GAHG3SZQ)\"\n      )\n    ) --   6. Volumes containing a hidden\
    \ top-level folder or binary, such as yWnBJLaF (1302.app)\n    OR (\n      file.bsd_flags\
    \ = \"HIDDEN\"\n      AND (\n        file.mode LIKE \"%7%\"\n        OR file.mode\
    \ LIKE \"%5%\"\n        OR file.mode LIKE \"%1%\"\n      )\n      AND file.filename\
    \ NOT IN (\n        '.background',\n        '.TemporaryItems',\n        '.Trashes',\n\
    \        '.VolumeIcon.icns'\n      )\n      -- Brother Printer Utilities\n   \
    \   AND f != '/Volumes/brotherwdswML_nonPanel/MacResources'\n      AND file.filename\
    \ NOT LIKE '%.previous'\n      AND file.filename NOT LIKE '%.interrupted'\n  \
    \    AND signature.authority != 'Developer ID Application: Google LLC (EQHXZ8M8AV)'\n\
    \      AND file.filename NOT LIKE '%.backup'\n    ) --   7. Volumes containing\
    \ a top-level symlink to something other than /Applications, such as yWnBJLaF\
    \ (1302.app)\n    OR (\n      file.symlink = 1\n      AND magic.data NOT IN (\n\
    \        '/Library/Application Support/Apple/Safari/SafariForWebKitDevelopment',\n\
    \        'symbolic link to ../Resources/public',\n        'symbolic link to .',\n\
    \        'symbolic link to /Applications',\n        'symbolic link to /Applications/',\n\
    \        'symbolic link to steam_osx'\n      )\n      -- emacs\n      AND magic.data\
    \ NOT LIKE 'symbolic link to bin-x86%'\n      AND magic.data NOT LIKE 'symbolic\
    \ link to /Users/%/My Drive'\n      -- Docker\n      AND magic.data NOT LIKE 'cannot\
    \ open%'\n    )\n  )\nGROUP BY\n  file.path;\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
