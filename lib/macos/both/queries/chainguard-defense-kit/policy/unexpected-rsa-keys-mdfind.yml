- name: CDK - Unexpected Rsa Keys Mdfind
  description: Indicative of stored RSA keys just sitting around unencrypted
  query: "SELECT\n  file.path,\n  file.size,\n  datetime(file.btime, 'unixepoch')\
    \ AS file_created,\n  magic.data,\n  hash.sha256,\n  ea.value AS url\nFROM\n \
    \ mdfind\n  JOIN file ON mdfind.path = file.path\n  JOIN users u ON file.uid =\
    \ u.uid\n  LEFT JOIN hash ON mdfind.path = hash.path\n  LEFT JOIN extended_attributes\
    \ ea ON mdfind.path = ea.path\n  AND ea.key = 'where_from'\n  LEFT JOIN magic\
    \ ON mdfind.path = magic.path\n  LEFT JOIN signature ON mdfind.path = signature.path\n\
    WHERE\n  mdfind.query = \"kMDItemFSName == '*.rsa'\"\n  AND file.filename NOT\
    \ IN ('local-melange.rsa', 'melange.rsa')\n  AND size BETWEEN 128 AND 8192\n \
    \ -- Don't alert on tokens that begin with the username-, as they may be personal\n\
    \  AND NOT INSTR(filename, CONCAT (u.username, \"-\")) == 1\n  -- Don't alert\
    \ on tokens that begin with the users full name and a dash\n  AND NOT INSTR(\n\
    \    filename,\n    REPLACE(LOWER(TRIM(description)), \" \", \"-\")\n  ) == 1\n\
    \  -- Common filenames that are non-controversial\n  AND NOT file.filename LIKE\
    \ '%example.com%'\n  AND NOT file.filename LIKE 'local-%.rsa'\n  AND NOT file.filename\
    \ LIKE 'test-%.rsa'\n  AND NOT file.filename LIKE 'demo-%.rsa'\n  AND NOT file.path\
    \ LIKE \"%/testdata/%\"\nGROUP BY\n  file.path\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
