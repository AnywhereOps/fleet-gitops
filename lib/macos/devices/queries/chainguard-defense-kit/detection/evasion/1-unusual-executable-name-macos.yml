- name: CDK - Unusual Executable Name Macos
  description: Processes with executable names that feel weird
  query: "SELECT\n  COALESCE(REGEX_MATCH (p0.path, '.*/(.*)', 1), p0.path) AS pname,\n\
    \  COALESCE(\n    REGEX_MATCH (p0.path, '.*/.*\\.([a-z]{2,4})$', 1),\n    \"\"\
    \n  ) AS pext,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n  s.authority\
    \ AS p0_sauth,\n  s.identifier AS p0_sid,\n  p0.name AS p0_name,\n  p0.cmdline\
    \ AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256 AS\
    \ p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.path AS p1_path,\n  p1.name\
    \ AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256\
    \ AS p1_sha256,\n  -- Grandparent\n  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n\
    \  p2.path AS p2_path,\n  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\n\
    FROM\n  processes p0\n  LEFT JOIN signature s ON p0.path = s.path\n  LEFT JOIN\
    \ hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes p1 ON p0.parent\
    \ = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes\
    \ p2 ON p1.parent = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\n\
    WHERE\n  (\n    pname LIKE \"%kthread%\"\n    OR pname LIKE '%xprotect%'\n   \
    \ OR pname LIKE \"%-help\"\n    OR pname LIKE \"%acpi%\"\n    OR pname LIKE \"\
    %crypt%\"\n    OR pname LIKE \"%flush%\"\n    OR pname LIKE \"%initd%\"\n    OR\
    \ pname LIKE \"%irq%\"\n    OR pname LIKE \"%kaudit%\"\n    OR pname LIKE \"%kdev%\"\
    \n    OR pname LIKE \"%kdmp%\"\n    OR pname LIKE \"%ksoft%\"\n    OR pname LIKE\
    \ \"%kswap%\"\n    OR pname LIKE \"%kworker%\"\n    OR pname LIKE \"%launchd%\"\
    \n    OR pname LIKE \"%nvme%\"\n    OR pname LIKE \"%tasks%\"\n    OR pname LIKE\
    \ \"%thread%\"\n    OR pname LIKE \"%user_dir%\"\n    OR pname LIKE \"%xdg%\"\n\
    \    OR pname LIKE \"%zswap%\"\n    OR pname LIKE \"cpu%\"\n    OR pname LIKE\
    \ \"events%\"\n    OR pname LIKE \"idle_%\"\n    OR pname LIKE \"mm-%\"\n    OR\
    \ pname LIKE \"nm_%\"\n    OR pname LIKE \"rcu%\"\n    OR REGEX_MATCH (pname,\
    \ '([a-z]{16,})', 1) != \"\"\n    OR REGEX_MATCH (pname, '([a-zA-Z0-9]{32,})',\
    \ 1) != \"\"\n    OR REGEX_MATCH (pname, '(\\w{40,})', 1) != \"\"\n    OR REGEX_MATCH\
    \ (\n      pname,\n      '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)',\n\
    \      1\n    ) != \"\"\n    OR REGEX_MATCH (pname, \"([a-z].*[A-Z].*\\d+.*[a-z].*\\\
    d+)\", 1) != \"\"\n    OR REGEX_MATCH (pname, \"(\\d.*[a-z].*\\d.*[a-z].*\\d+)\"\
    , 1) != \"\"\n    OR REGEX_MATCH (pname, \"(\\d{5,})\", 1) != \"\"\n    OR REGEX_MATCH\
    \ (pname, \"^(\\d\\d)\", 1) != \"\"\n    OR REGEX_MATCH (pname, \"^(\\W)\", 1)\
    \ != \"\"\n    OR (\n      REGEX_MATCH (pname, \"(\\W)$\", 1) != \"\"\n      AND\
    \ pname NOT LIKE \"%)\"\n    )\n    AND pext NOT IN (\"\", \"gui\", \"cli\", \"\
    us\", \"node\", \"com\")\n  )\n  AND NOT pname IN (\n    'at.obdev.littlesnitch.networkextension',\n\
    \    'at.obdev.littlesnitchmini.networkextension',\n    'com.microsoft.teams2.notificationcenter',\n\
    \    'cpu',\n    'dynamiclinkmediaserver',\n    'dynamiclinkmanager',\n    'EcammLiveVideoOutAssistantXPCHelper',\n\
    \    'launchd_startx',\n    'OneSignalNotificationServiceExtension',\n    'test',\n\
    \    'ThingsWidgetExtensionMacAppStore',\n    'TwitterNotificationServiceExtension',\n\
    \    'usercontextservice'\n  )\n  AND NOT pname LIKE '___%Test_%.test'\n  AND\
    \ NOT pname LIKE '__%go_build_%'\n  AND NOT pname LIKE '__%go_test_%'\n  AND NOT\
    \ pname LIKE '__Test%'\n  AND NOT pname LIKE '%.test'\n  AND NOT pname LIKE '.%-wrapped'\n\
    \  AND NOT pname LIKE 'BetterTouch%Runner%'\n  AND NOT pname LIKE 'cody-engine-%'\n\
    \  -- example: 85C27NK92C.com.flexibits.fantastical2.mac.helper\n  AND NOT pname\
    \ LIKE \"%.com.flexibits.fantastical2.mac.helper\"\n  AND NOT s.authority = \"\
    Software Signing\"\n  AND NOT (\n    s.authority = 'Developer ID Application:\
    \ Adobe Inc. (JQ525L2MZD)'\n    AND pname = 'agcinvokerutility'\n  )\n  AND NOT\
    \ p0.path LIKE '/nix/store/%'\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
