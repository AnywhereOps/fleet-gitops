- name: CDK - Exotic Command Events Macos
  description: Pick out exotic processes based on their command-line (events-based)
  query: "SELECT -- Child\n  pe.path AS p0_path,\n  pe.time AS p0_time,\n  REGEX_MATCH\
    \ (pe.path, '.*/(.*)', 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd\
    \ AS p0_cwd,\n  pe.pid AS p0_pid,\n  pe.euid AS p0_euid,\n  s.authority AS p0_authority,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  pe_sig1.authority AS p1_authority,\n  -- Grandparent\n  COALESCE(p1.parent,\
    \ pe1.parent) AS p2_pid,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline,\
    \ pe1_pe2.cmdline)\n  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path)\
    \ AS p2_path,\n  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name,\n  COALESCE(\n    p1_p2_sig.authority,\n\
    \    pe1_p2_sig.authority,\n    pe1_pe2_sig.authority\n  ) AS p2_authority,\n\
    \  -- Exception key\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid,\
    \ 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ','\
    \ || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n   \
    \ '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events pe,\n  uptime\n\
    \  LEFT JOIN processes p ON pe.pid = p.pid\n  LEFT JOIN signature s ON pe.path\
    \ = s.path -- Parents (via two paths)\n  LEFT JOIN processes p1 ON pe.parent =\
    \ p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events\
    \ pe1 ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1\
    \ ON pe1.path = pe_hash1.path\n  LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path\
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n  LEFT JOIN\
    \ signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path\n  LEFT JOIN signature pe1_p2_sig\
    \ ON pe1_p2.path = pe1_p2_sig.path\n  LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path\
    \ = pe1_pe2_sig.path\nWHERE\n  pe.time > (strftime('%s', 'now') -180)\n  AND pe.status\
    \ = 0\n  AND pe.cmdline != ''\n  AND pe.cmdline IS NOT NULL\n  AND (\n    p0_name\
    \ IN (\n      'bitspin',\n      'bpftool',\n      'csrutil',\n      'dnscat2',\n\
    \      'heyoka',\n      'incbit',\n      'iodine',\n      'kmod',\n      'lushput',\n\
    \      'mkfifo',\n      'msfvenom',\n      'nc',\n      'nstx',\n      'rsh',\n\
    \      'rshell',\n      'socat',\n      'tuns'\n    ) -- Chrome Stealer\n    OR\
    \ p0_name LIKE '%pwn%'\n    OR p0_cmd LIKE '%set visible of front window to false%'\n\
    \    OR p0_cmd LIKE '%chrome%-load-extension%' -- Known attack scripts\n    OR\
    \ p0_name LIKE '%attack%' -- Unusual behaviors\n    OR p0_cmd LIKE '%chattr -i%'\n\
    \    OR p0_cmd LIKE '%dd if=/dev/%'\n    OR p0_cmd LIKE '%cat /dev/null >%'\n\
    \    OR p0_cmd LIKE '%truncate -s0 %'\n    OR p0_cmd LIKE '%touch%acmr%'\n   \
    \ OR p0_cmd LIKE '%touch -r%'\n    OR p0_cmd LIKE '%ld.so.preload%'\n    OR p0_cmd\
    \ LIKE 'killall%NotificationCenter'\n    OR p0_cmd LIKE '%urllib.urlopen%'\n \
    \   OR p0_cmd LIKE '%nohup%tmp%'\n    OR p0_cmd LIKE '%killall Terminal%'\n  \
    \  OR (\n      pe.euid = 0\n      AND (\n        p0_cmd LIKE '%pkill -f%'\n  \
    \      OR p0_cmd LIKE '%xargs kill -9%'\n      )\n    )\n    OR p0_cmd LIKE '%rm\
    \ -f /var/tmp%'\n    OR p0_cmd LIKE '%rm -f /tmp%'\n    OR p0_cmd LIKE '%nohup\
    \ /bin/bash%'\n    OR (\n      INSTR(p0_cmd, 'history') > 0\n      AND p0_cmd\
    \ LIKE '%history'\n      AND p0_cmd NOT LIKE '% history'\n    )\n    OR p0_cmd\
    \ LIKE '%echo%|%base64 --decode %|%'\n    OR p0_cmd LIKE '%echo%|%base64 -d %|%'\n\
    \    OR p0_cmd LIKE '%launchctl bootout%'\n    OR p0_cmd LIKE '%chflags uchg%'\n\
    \    OR (\n      p0_cmd LIKE '%UserKnownHostsFile=/dev/null%'\n      AND NOT p1_name\
    \ = 'limactl'\n      AND NOT p1_cmd LIKE '%gcloud.py%'\n    ) -- Random keywords\n\
    \    OR p0_cmd LIKE '%ransom%' -- Reverse shells\n    OR p0_cmd LIKE '%fsockopen%'\n\
    \    OR p0_cmd LIKE '%openssl%quiet%'\n    OR p0_cmd LIKE '%pty.spawn%'\n    OR\
    \ (\n      p0_cmd LIKE '%sh -i'\n      AND NOT p1_name IN ('sh', 'java')\n   \
    \   AND NOT p1_cmd LIKE \"%pipenv shell\"\n    )\n    OR p0_cmd LIKE 'socat %'\n\
    \    OR p0_cmd LIKE '%SOCK_STREAM%'\n    OR INSTR(p0_cmd, 'Socket.') > 0\n  )\
    \ -- Things that could reasonably happen at boot.\n  AND NOT (\n    pe.path =\
    \ '/usr/bin/mkfifo'\n    AND (\n      p0_cmd LIKE '%/org.gpgtools.log.%/fifo'\n\
    \      OR p0_cmd LIKE '%/var/%/gitstatus.POWERLEVEL9K.%'\n      OR p0_cmd LIKE\
    \ '%/var/%/p10k.worker.%'\n      OR p0_cmd LIKE '%/tmp/blesh/%'\n    )\n  )\n\
    \  AND NOT (\n    p0_cmd LIKE '%csrutil status'\n    AND p1_name IN ('Dropbox')\n\
    \  )\n  AND NOT (\n    p0_cmd IN (\n      '/bin/launchctl bootout gui/501 /Library/LaunchAgents/com.logi.optionsplus.plist',\n\
    \      '/bin/launchctl bootout system/com.docker.socket',\n      '/bin/rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',\n\
    \      '/Library/Apple/System/Library/StagedFrameworks/Safari/SafariShared.framework/XPCServices/com.apple.Safari.History.xpc/Contents/MacOS/com.apple.Safari.History',\n\
    \      '/usr/bin/csrutil report',\n      '/usr/bin/csrutil status',\n      '/usr/bin/pkill\
    \ -F /private/var/run/lima/shared_socket_vmnet.pid',\n      '/usr/bin/sudo /bin/rm\
    \ -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress',\n     \
    \ '/usr/bin/xattr -d com.apple.writer_bundle_identifier /Applications/Safari.app',\n\
    \      'dd if=/dev/stdin conv=unblock cbs=79',\n      'dd if=/dev/urandom bs=15\
    \ count=1 status=none',\n      'git history',\n      'helm history',\n      'launchctl\
    \ bootout gui/501/com.grammarly.ProjectLlama.UninstallAgent',\n      'nc -h',\n\
    \      'nc -uv 8.8.8.8 53',\n      'nc localhost 8080 -vz',\n      'nc',\n   \
    \   'nix profile history',\n      'rm -f /tmp/mysql.sock',\n      'sh -c launchctl\
    \ bootout system \"/Library/LaunchDaemons/com.ecamm.EcammAudioXPCHelper.plist\"\
    ',\n      'xpcproxy com.apple.Safari.History'\n    ) -- The source of these commands\
    \ is still a mystery to me.\n    OR pe.parent = -1\n  )\n  AND NOT p0_cmd LIKE\
    \ '-history%'\n  AND NOT p0_cmd LIKE '/bin/cp %history%sessions/%'\n  AND NOT\
    \ p0_cmd LIKE '/bin/rm -f /tmp/com.adobe.%.updater/%'\n  AND NOT p0_cmd LIKE '/bin/rm\
    \ -f /tmp/nix-shell.%'\n  AND NOT p0_cmd LIKE '/bin/rm -f /tmp/periodic.%'\n \
    \ AND NOT p0_cmd LIKE '%find /Applications/LogiTuneInstaller.app -type d -exec\
    \ chmod 777 {}%'\n  AND NOT p0_cmd LIKE '%GNU Libtool%touch -r%'\n  AND NOT p0_cmd\
    \ LIKE '%nc -vz localhost%'\n  AND NOT p0_cmd LIKE '%nc localhost%'\n  AND NOT\
    \ p0_cmd LIKE '%ssh %/lima/%'\n  AND NOT p0_cmd LIKE 'dirname %history'\n  AND\
    \ NOT p0_cmd LIKE 'launchctl bootout gui/501 /Users/%/Library/LaunchAgents/com.elgato.StreamDeck.plist'\n\
    \  AND NOT p0_cmd LIKE 'rm -f /tmp/blesh/%'\n  AND NOT p0_cmd LIKE 'rm -f /tmp/insttmp_%'\n\
    \  AND NOT p0_cmd LIKE 'rm -f /tmp/locate%/_updatedb%'\n  AND NOT p0_cmd LIKE\
    \ 'rm -f /tmp/locate%/mklocate%/_mklocatedb%'\n  AND NOT p0_cmd LIKE 'touch -r\
    \ . /private/tmp/nix-build%'\n  AND NOT p0_cmd LIKE 'touch -r /tmp/KSInstallAction.%'\n\
    \  AND NOT p0_name IN ('cc1', 'compile', 'yara')\n  AND NOT exception_key IN (\n\
    \    'bash,500,idea,launchd',\n    'bat,500,zsh,login',\n    'cat,500,zsh,login',\n\
    \    'dd,500,zsh,login',\n    'git,500,zsh,goland',\n    'git,500,zsh,login',\n\
    \    'go,500,fish,login',\n    'jq,500,zsh,login',\n    'sh,0,Ecamm Live,launchd',\n\
    \    'ssh,500,limactl.ventura,launchd',\n    'yara,500,bash,fish'\n  )\n"
  platform: darwin
  interval: 180
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
