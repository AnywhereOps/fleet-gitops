- name: CDK - Unexpected Xattr Calls Macos
  description: Detect unusual calls to xattr, used to remove filesystem attributes
  query: "SELECT\n  -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.time\
    \ AS p0_time,\n  pe.pid AS p0_pid,\n  pe.euid AS p0_euid,\n  s.authority AS p0_authority,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p_hash1.sha256,\
    \ pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)',\
    \ 1) AS p1_name,\n  pe_sig1.authority AS p1_authority,\n  -- Grandparent\n  COALESCE(p1.parent,\
    \ pe1.parent) AS p2_pid,\n  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline,\
    \ pe1_pe2.cmdline)\n  ) AS p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path)\
    \ AS p2_path,\n  COALESCE(\n    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n\
    \  ) AS p2_hash,\n  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n\
    \    '.*/(.*)',\n    1\n  ) AS p2_name,\n  COALESCE(\n    p1_p2_sig.authority,\n\
    \    pe1_p2_sig.authority,\n    pe1_pe2_sig.authority\n  ) AS p2_authority,\n\
    \  -- Exception key\n  REGEX_MATCH (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid,\
    \ 500) || ',' || REGEX_MATCH (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ','\
    \ || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n   \
    \ '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events pe,\n  uptime\n\
    \  LEFT JOIN processes p ON pe.pid = p.pid\n  LEFT JOIN signature s ON pe.path\
    \ = s.path\n  -- Parents (via two paths)\n  LEFT JOIN processes p1 ON pe.parent\
    \ = p1.pid\n  LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path\n  LEFT JOIN process_events\
    \ pe1 ON pe.parent = pe1.pid\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1\
    \ ON pe1.path = pe_hash1.path\n  LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path\n\
    \  -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\
    \ -- Current grandparent via parent processes\n  LEFT JOIN processes pe1_p2 ON\
    \ pe1.parent = pe1_p2.pid -- Current grandparent via parent events\n  LEFT JOIN\
    \ process_events pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline !=\
    \ '' -- Past grandparent via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path\
    \ = p1_p2_hash.path\n  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n  LEFT JOIN\
    \ signature p1_p2_sig ON p1_p2.path = p1_p2_sig.path\n  LEFT JOIN signature pe1_p2_sig\
    \ ON pe1_p2.path = pe1_p2_sig.path\n  LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path\
    \ = pe1_pe2_sig.path\nWHERE\n  pe.time > (strftime('%s', 'now') -300)\n  AND pe.status\
    \ = 0\n  AND pe.cmdline != ''\n  AND pe.cmdline IS NOT NULL\n  AND pe.status ==\
    \ 0\n  AND pe.path = '/usr/bin/xattr'\n  AND p0_cmd NOT LIKE '%xattr -d -r com.apple.quarantine\
    \ /Applications/%.app'\n  AND p0_cmd NOT LIKE '%xattr -r -d com.apple.quarantine\
    \ /Applications/%.app'\n  AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine\
    \ /Applications/%.app'\n  AND p0_cmd NOT LIKE '%xattr -d com.apple.quarantine\
    \ /Applications/%.app/%.xpc'\n  AND p0_cmd NOT LIKE '%xattr -d com.apple.FinderInfo\
    \ /Applications/Parallels Desktop.app'\n  AND NOT (\n    pe.euid > 500\n    AND\
    \ p0_cmd LIKE '%xattr -l %'\n  )\n  AND NOT (\n    pe.euid > 500\n    AND p0_cmd\
    \ LIKE '%xattr -p com.apple.quarantine %'\n  )\n  AND NOT (\n    pe.euid > 500\n\
    \    AND p0_cmd LIKE '%xattr -p com.apple.metadata:kMDItemAlternateNames %'\n\
    \  )\n  AND NOT (\n    pe.euid > 500\n    AND p0_cmd LIKE '/usr/bin/xattr -w com.apple.metadata:kMDItemAlternateNames\
    \ %'\n  )\n  AND NOT (\n    pe.euid > 500\n    AND p0_cmd LIKE 'xattr -r -d com.apple.quarantine\
    \ /Users/%/.provisio/bin/%.app'\n  )\n  AND NOT (\n    pe.euid > 500\n    AND\
    \ p0_cmd = '/usr/bin/xattr -h'\n    AND p1_cmd LIKE '%brew%'\n  )\n  AND p0_cmd\
    \ NOT LIKE '%xattr -p com.apple.rootless %'\n  AND p0_cmd NOT LIKE '/usr/bin/xattr\
    \ -w com.apple.quarantine 0002;%'\n  AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine\
    \ 0181;%'\n  AND p0_cmd NOT LIKE '/usr/bin/xattr -w com.apple.quarantine 0381;%'\n\
    GROUP BY\n  pe.pid\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
