- name: CDK - Unexpected Long Running Security Framework Macos
  description: Find programs that use the Security Framework on macOS - popular among
    malware authors
  query: "SELECT\n  s.authority,\n  s.identifier,\n  CONCAT (\n    MIN(p0.euid, 500),\n\
    \    ',',\n    p0.name,\n    ',',\n    s.identifier,\n    ',',\n    s.authority\n\
    \  ) AS exception_key,\n  pmm.path AS lib_path,\n  -- Child\n  p0.pid AS p0_pid,\n\
    \  p0.start_time AS p0_start,\n  p0.path AS p0_path,\n  p0.name AS p0_name,\n\
    \  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid AS p0_euid,\n  p0_hash.sha256\
    \ AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n  p1.start_time AS p1_start,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1.euid AS p1_euid,\n  p1.cmdline\
    \ AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n  p1.parent AS\
    \ p2_pid,\n  p2.start_time AS p2_start,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n\
    \  p2.cmdline AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  processes p0\n\
    \  JOIN process_memory_map pmm ON p0.pid = pmm.pid\n  LEFT JOIN signature s ON\
    \ p0.path = s.path\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT\
    \ JOIN processes p1 ON p0.parent = p1.pid\n  LEFT JOIN hash p1_hash ON p1.path\
    \ = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent = p2.pid\n  LEFT JOIN\
    \ hash p2_hash ON p2.path = p2_hash.path\nWHERE -- Focus on longer-running programs\n\
    \  p0.pid IN (\n    SELECT\n      pid\n    FROM\n      processes\n    WHERE\n\
    \      start_time < (strftime('%s', 'now') - 25200)\n      AND parent != 0 --\
    \ Assume STP\n      AND NOT path LIKE '/Applications/%.app/%' -- Other oddball\
    \ binary paths\n      AND NOT path LIKE '/nix/store/%'\n      AND NOT path LIKE\
    \ '/opt/%'\n      AND NOT path LIKE '/private/var/folders%/T/go-build%/exe/%'\n\
    \      AND NOT path LIKE '/System/%'\n      AND NOT path LIKE '/Users/%/.terraform/providers/%'\n\
    \      AND NOT path LIKE '/Users/%/bin/%'\n      AND NOT path LIKE '/Users/%/dev/%'\n\
    \      AND NOT path LIKE '/Users/%/go/%'\n      AND NOT path LIKE '/Users/%/Library/Application\
    \ Support/com.elgato.StreamDeck/Plugins/%'\n      AND NOT path LIKE '/Users/%/Library/Application\
    \ Support/Zed/extensions/%'\n      AND NOT path LIKE '/Users/%/Library/Application\
    \ Support/Zed/supermaven/%'\n      AND NOT path LIKE '/Users/%/src/%'\n      AND\
    \ NOT path LIKE '/usr/libexec/%'\n      AND NOT path LIKE '/usr/sbin/%' -- Regular\
    \ apps\n      AND NOT REGEX_MATCH (path, '(.*)/', 1) LIKE '%/bin'\n      AND NOT\
    \ (\n        path LIKE '/Users/%/Library/Application Support/com.elgato.StreamDeck/Plugins/com.elgato.cpu.sdPlugin/cpu'\n\
    \        AND name = 'cpu'\n      ) -- Takes arguments\n      AND NOT (\n     \
    \   euid >= 500\n        AND cmdline LIKE \"% --%\"\n      )\n  )\n  AND pmm.path\
    \ LIKE '%Security.framework%'\n  AND NOT s.authority IN (\n    'Developer ID Application:\
    \ Corsair Memory, Inc. (Y93VXCB8Q5)',\n    'Developer ID Application: Google,\
    \ Inc. (EQHXZ8M8AV)',\n    'Developer ID Application: Google LLC (EQHXZ8M8AV)',\n\
    \    'Developer ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF)',\n\
    \    'Developer ID Application: Valve Corporation (MXGJJ98X76)'\n  )\n  AND exception_key\
    \ NOT IN (\n    '0,velociraptor,a.out,',\n    '500,docker,docker,',\n    '500,pnpm,pnpm,',\n\
    \    '500,python3,python.exe,',\n    '500,sdaudioswitch,,',\n    '500,sdaudioswitch,sdaudioswitch,',\n\
    \    '500,sdmicmute,sdmicmute,',\n    '500,sdzoomplugin,,'\n  )\n  AND NOT exception_key\
    \ LIKE '500,%,a.out,'\n  AND NOT exception_key LIKE '500,lifx-streamdeck,lifx-streamdeck-%'\n\
    \  AND NOT exception_key LIKE '500,marksman-macos,marksman-%,'\n  AND NOT exception_key\
    \ LIKE '500,nvim,bob-%,'\n  AND NOT exception_key LIKE '500,package-version-server-v%,package_version_server-%,'\n\
    \  AND NOT exception_key LIKE '500,rust-analyzer,rust_analyzer-%,'\n  AND NOT\
    \ exception_key LIKE '500,rust-analyzer-proc-macro-srv,rust_analyzer_proc_macro_srv-%,'\n\
    \  AND NOT exception_key LIKE '500,sm-agent,sm_agent-%'\nGROUP BY\n  p0.pid\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
