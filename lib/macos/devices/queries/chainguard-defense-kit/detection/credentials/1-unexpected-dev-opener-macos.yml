- name: CDK - Unexpected Dev Opener Macos
  description: Detects unexpected programs opening files in /dev on Linux
  query: "SELECT\n  pof.pid,\n  pof.path AS device,\n  s.authority,\n  s.identifier,\n\
    \  CONCAT (\n    IIF(\n      REGEX_MATCH (pof.path, '(/dev/.*)\\d+$', 1) != '',\n\
    \      REGEX_MATCH (pof.path, '(/dev/.*)\\d+', 1),\n      pof.path\n    ),\n \
    \   ',',\n    REPLACE(\n      p0.path,\n      RTRIM(p0.path, REPLACE(p0.path,\
    \ '/', '')),\n      ''\n    ),\n    ',',\n    s.authority,\n    ',',\n    s.identifier\n\
    \  ) AS exception_key,\n  -- Child\n  p0.pid AS p0_pid,\n  p0.path AS p0_path,\n\
    \  p0.name AS p0_name,\n  p0.cmdline AS p0_cmd,\n  p0.cwd AS p0_cwd,\n  p0.euid\
    \ AS p0_euid,\n  p0_hash.sha256 AS p0_sha256,\n  -- Parent\n  p0.parent AS p1_pid,\n\
    \  p1.path AS p1_path,\n  p1.name AS p1_name,\n  p1_f.mode AS p1_mode,\n  p1.euid\
    \ AS p1_euid,\n  p1.cmdline AS p1_cmd,\n  p1_hash.sha256 AS p1_sha256,\n  -- Grandparent\n\
    \  p1.parent AS p2_pid,\n  p2.name AS p2_name,\n  p2.path AS p2_path,\n  p2.cmdline\
    \ AS p2_cmd,\n  p2_hash.sha256 AS p2_sha256\nFROM\n  process_open_files pof\n\
    \  LEFT JOIN processes p0 ON pof.pid = p0.pid\n  LEFT JOIN signature s ON p0.path\
    \ = s.path\n  LEFT JOIN hash p0_hash ON p0.path = p0_hash.path\n  LEFT JOIN processes\
    \ p1 ON p0.parent = p1.pid\n  LEFT JOIN file p1_f ON p1.path = p1_f.path\n  LEFT\
    \ JOIN hash p1_hash ON p1.path = p1_hash.path\n  LEFT JOIN processes p2 ON p1.parent\
    \ = p2.pid\n  LEFT JOIN hash p2_hash ON p2.path = p2_hash.path\nWHERE\n  pof.path\
    \ LIKE '/dev/%'\n  AND pof.path NOT IN (\n    '/dev/null',\n    '/dev/ptmx',\n\
    \    '/dev/random',\n    '/dev/tty',\n    '/dev/urandom',\n    '/dev/zero'\n \
    \ )\n  AND pof.path NOT LIKE '/dev/ttys%'\n  -- Assume SIP\n  AND p0.path NOT\
    \ LIKE '/System/%'\n  AND p0.path NOT LIKE '/usr/libexec/%'\n  AND p0.path NOT\
    \ LIKE '/usr/sbin/%'\n  AND exception_key NOT IN (\n    '/dev/afsc_type,revisiond,Software\
    \ Signing,com.apple.revisiond',\n    '/dev/auditpipe,ir_agent,Developer ID Application:\
    \ Rapid7 LLC (UL6CGN7MAL),ir_agent',\n    '/dev/auditpipe,osqueryd,,',\n    '/dev/auditpipe,osqueryd,Developer\
    \ ID Application: OSQUERY A Series of LF Projects, LLC (3522FA9PXF),io.osquery.agent',\n\
    \    '/dev/auditpipe,osqueryd,Developer ID Application: OSQUERY A Series of LF\
    \ Projects, LLC (3522FA9PXF),osqueryd',\n    '/dev/auditsessions,authd,Software\
    \ Signing,com.apple.authd',\n    '/dev/auditsessions,GSSCred,Software Signing,com.apple.GSSCred',\n\
    \    '/dev/auditsessions,securityd,Software Signing,com.apple.securityd',\n  \
    \  '/dev/auditsessions,TouchBarServer,Software Signing,com.apple.touchbarserver',\n\
    \    '/dev/autofs,automountd,Software Signing,com.apple.automountd',\n    '/dev/bpf,agentbeat,Developer\
    \ ID Application: Elasticsearch, Inc (2BT3HPN62Z),agentbeat',\n    '/dev/bpf,airportd,Software\
    \ Signing,com.apple.airport.airportd',\n    '/dev/bpf,BDLDaemon,Developer ID Application:\
    \ Bitdefender SRL (GUNFMW623Y),com.bitdefender.epsecurity.BDLDaemonApp',\n   \
    \ '/dev/bpf,com.bjango.istatmenus.daemon,Developer ID Application: Bjango Pty\
    \ Ltd (Y93TK974AT),com.bjango.istatmenus',\n    '/dev/bpf,core,Developer ID Application:\
    \ TPZ Solucoes Digitais Ltda (X37R283V2T),com.topaz.warsaw.core',\n    '/dev/bpf,MHLinkServer,Developer\
    \ ID Application: Metric Halo Distribution, Inc. (X7EY8SFM86),com.mhlabs.mhlink.server',\n\
    \    '/dev/bpf,packetbeat,Developer ID Application: Elasticsearch, Inc (2BT3HPN62Z),packetbeat',\n\
    \    '/dev/bus/usb/001/01,scdaemon',\n    '/dev/console,Arc,Developer ID Application:\
    \ The Browser Company of New York Inc. (S6N382Y83G),company.thebrowser.Browser',\n\
    \    '/dev/console,dbeaver,Developer ID Application: DBeaver Corporation (42B6MDKMW8),org.jkiss.dbeaver.core.product',\n\
    \    '/dev/console,kernelmanagerd,Software Signing,com.apple.kernelmanagerd',\n\
    \    '/dev/console,launchd,Software Signing,com.apple.xpc.launchd',\n    '/dev/console,launchd_sim,Software\
    \ Signing,com.apple.xpc.launchd',\n    '/dev/cu.BLTH,bluetoothd,Software Signing,com.apple.bluetoothd',\n\
    \    '/dev/cu.debug-console,ZwiftAppSilicon,Developer ID Application: Zwift, Inc\
    \ (C2GM8Y9VFM),ZwiftAppSilicon',\n    '/dev/cu.usbmodem10,serial-monitor,,a.out',\n\
    \    '/dev/io,airportd,Software Signing,com.apple.airport.airportd',\n    '/dev/io,ControlCenter,Software\
    \ Signing,com.apple.controlcenter',\n    '/dev/io,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',\n\
    \    '/dev/io,symptomsd,Software Signing,com.apple.symptomsd',\n    '/dev/io,WiFiAgent,Software\
    \ Signing,com.apple.wifi.WiFiAgent',\n    '/dev/io,WirelessRadioManagerd,Software\
    \ Signing,com.apple.WirelessRadioManagerd',\n    '/dev/io8log,airportd,Software\
    \ Signing,com.apple.airport.airportd',\n    '/dev/io8log,ControlCenter,Software\
    \ Signing,com.apple.controlcenter',\n    '/dev/io8log,PerfPowerServices,Software\
    \ Signing,com.apple.PerfPowerServices',\n    '/dev/io8log,symptomsd,Software Signing,com.apple.symptomsd',\n\
    \    '/dev/io8log,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',\n    '/dev/io8log,WirelessRadioManagerd,Software\
    \ Signing,com.apple.WirelessRadioManagerd',\n    '/dev/io8logmt,airportd,Software\
    \ Signing,com.apple.airport.airportd',\n    '/dev/io8logtemp,airportd,Software\
    \ Signing,com.apple.airport.airportd',\n    '/dev/io8logtemp,ControlCenter,Software\
    \ Signing,com.apple.controlcenter',\n    '/dev/io8logtemp,PerfPowerServices,Software\
    \ Signing,com.apple.PerfPowerServices',\n    '/dev/io8logtemp,symptomsd,Software\
    \ Signing,com.apple.symptomsd',\n    '/dev/io8logtemp,WiFiAgent,Software Signing,com.apple.wifi.WiFiAgent',\n\
    \    '/dev/io8logtemp,WirelessRadioManagerd,Software Signing,com.apple.WirelessRadioManagerd',\n\
    \    '/dev/kbfuse,kbfs,Developer ID Application: Keybase, Inc. (99229SGT5K),kbfs',\n\
    \    '/dev/kbfuse,keybase-redirector,Developer ID Application: Keybase, Inc. (99229SGT5K),keybase-redirector',\n\
    \    '/dev/klog,syslogd,Software Signing,com.apple.syslogd',\n    '/dev/macfuse,gcsfuse,,a.out',\n\
    \    '/dev/macfuse,rclone,,a.out',\n    '/dev/oslog,logd,Software Signing,com.apple.logd',\n\
    \    '/dev/pf,CloudflareWARP,Developer ID Application: Cloudflare Inc. (68WVV388M8),CloudflareWARP',\n\
    \    '/dev/pf,mullvad-daemon,Developer ID Application: Mullvad VPN AB (CKG9MXH72F),mullvad-daemon',\n\
    \    '/dev/rdisk,etcher-util,Developer ID Application: Balena Ltd (66H43P8FRG),etcher-util',\n\
    \    '/dev/shm,python3',\n    '/dev/tty.usbmodem21430,Bazecor Helper (Renderer),,',\n\
    \    '/dev/xcpm,PerfPowerServices,Software Signing,com.apple.PerfPowerServices',\n\
    \    '/dev/xcpm,systemstats,Software Signing,com.apple.systemstats',\n    '/dev/xcpm,thermald,Software\
    \ Signing,com.apple.thermald',\n    '/dev/zero,bash,Software Signing,com.apple.bash'\n\
    \  )\n  -- Keyboard flashing\n  AND NOT exception_key LIKE '/dev/cu.usbmodem%,Google\
    \ Chrome,Developer ID Application: Google LLC (EQHXZ8M8AV),com.google.Chrome'\n\
    \  AND NOT exception_key LIKE '/dev/tty.usbserial-%,java,,net.java.openjdk.java'\n\
    \  AND NOT exception_key LIKE '/dev/cu.%,screen,Software Signing,com.apple.screen'\n\
    GROUP BY\n  pof.pid\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
