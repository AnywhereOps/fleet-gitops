- name: CDK - Unexpected Elevated Children Events Macos
  description: 'Find processes that run with a lower effective UID than their parent
    (event-based) related: * unexpected-privilege-escalation.sql'
  query: "SELECT -- Child\n  pe.path AS p0_path,\n  REGEX_MATCH (pe.path, '.*/(.*)',\
    \ 1) AS p0_name,\n  TRIM(pe.cmdline) AS p0_cmd,\n  pe.cwd AS p0_cwd,\n  pe.pid\
    \ AS p0_pid,\n  pe.uid AS p0_uid,\n  pe.euid AS p0_euid,\n  s.authority AS p0_authority,\n\
    \  -- Parent\n  pe.parent AS p1_pid,\n  TRIM(COALESCE(p1.cmdline, pe1.cmdline))\
    \ AS p1_cmd,\n  COALESCE(p1.path, pe1.path) AS p1_path,\n  COALESCE(p1.euid, pe1.euid)\
    \ AS p1_euid,\n  COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash,\n  REGEX_MATCH\
    \ (COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name,\n  pe_sig1.authority\
    \ AS p1_authority,\n  -- Grandparent\n  COALESCE(p1.parent, pe1.parent) AS p2_pid,\n\
    \  TRIM(\n    COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)\n  ) AS\
    \ p2_cmd,\n  COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path,\n  COALESCE(\n\
    \    p1_p2_hash.path,\n    pe1_p2_hash.path,\n    pe1_pe2_hash.path\n  ) AS p2_hash,\n\
    \  REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path),\n    '.*/(.*)',\n\
    \    1\n  ) AS p2_name,\n  COALESCE(\n    p1_p2_sig.authority,\n    pe1_p2_sig.authority,\n\
    \    pe1_pe2_sig.authority\n  ) AS p2_authority,\n  -- Exception key\n  REGEX_MATCH\
    \ (pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH (COALESCE(p1.path,\
    \ pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH (\n    COALESCE(p1_p2.path, pe1_p2.path,\
    \ pe1_pe2.path),\n    '.*/(.*)',\n    1\n  ) AS exception_key\nFROM\n  process_events\
    \ pe,\n  uptime\n  LEFT JOIN processes p ON pe.pid = p.pid\n  LEFT JOIN signature\
    \ s ON pe.path = s.path -- Parents (via two paths)\n  LEFT JOIN processes p1 ON\
    \ pe.parent = p1.pid\n  AND p1.start_time <= pe.time\n  LEFT JOIN hash p_hash1\
    \ ON p1.path = p_hash1.path\n  LEFT JOIN process_events pe1 ON pe.parent = pe1.pid\n\
    \  AND pe1.time <= pe.time\n  AND pe1.cmdline != ''\n  LEFT JOIN hash pe_hash1\
    \ ON pe1.path = pe_hash1.path\n  LEFT JOIN signature pe_sig1 ON pe1.path = pe_sig1.path\
    \ -- Grandparents (via 3 paths)\n  LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid\n\
    \  AND p1_p2.start_time <= p1.start_time\n  LEFT JOIN processes pe1_p2 ON pe1.parent\
    \ = pe1_p2.pid\n  AND pe1_p2.start_time <= pe1.time\n  LEFT JOIN process_events\
    \ pe1_pe2 ON pe1.parent = pe1_p2.pid\n  AND pe1_pe2.cmdline != '' -- Past grandparent\
    \ via parent events\n  LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path\n\
    \  LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path\n  LEFT JOIN hash\
    \ pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path\n  LEFT JOIN signature p1_p2_sig\
    \ ON p1_p2.path = p1_p2_sig.path\n  LEFT JOIN signature pe1_p2_sig ON pe1_p2.path\
    \ = pe1_p2_sig.path\n  LEFT JOIN signature pe1_pe2_sig ON pe1_pe2.path = pe1_pe2_sig.path\n\
    WHERE\n  pe.time > (strftime('%s', 'now') -300)\n  AND p0_euid < p1_euid\n  AND\
    \ pe.status = 0\n  AND pe.parent > 0\n  AND pe.cmdline != ''\n  AND pe.cmdline\
    \ IS NOT NULL\n  AND p1_path NOT IN (\n    '/Applications/LogiTune.app/Contents/MacOS/LogiTune',\n\
    \    '/Library/Apple/System/Library/CoreServices/XProtect.app/Contents/XPCServices/XProtectPluginService.xpc/Contents/MacOS/XProtectPluginService',\n\
    \    '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared',\n\
    \    '/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/XPCServices/com.apple.iCloudHelper.xpc/Contents/MacOS/com.apple.iCloudHelper',\n\
    \    '/usr/bin/login',\n    '/usr/bin/su',\n    '/usr/bin/sudo',\n    '/usr/libexec/mdmclient',\n\
    \    '/usr/libexec/PerfPowerServicesExtended',\n    '/usr/local/bin/doas'\n  )\
    \ -- Exclude weird bad data we've seen due to badly recorded macOS parent/child\
    \ relationships, fixable by reboot\n  AND NOT p0_cmd IN (\n    '/System/Library/CoreServices/iconservicesd',\n\
    \    '/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/A/Support/mdworker_shared\
    \ -s mdworker -c MDSImporterWorker -m com.apple.mdworker.shared',\n    '/System/Library/PrivateFrameworks/CoreSymbolication.framework/coresymbolicationd',\n\
    \    '/System/Library/PrivateFrameworks/InstallCoordination.framework/Support/installcoordinationd',\n\
    \    '/usr/libexec/mdmclient daemon',\n    '/usr/libexec/PerfPowerServicesExtended',\n\
    \    '/usr/libexec/wifip2pd',\n    '/usr/sbin/cfprefsd agent',\n    '/usr/sbin/cupsd\
    \ -l'\n  )\n  AND NOT exception_key IN (\n    'amfid,0,com.docker.backend,Docker',\n\
    \    'biometrickitd,0,LogiTune,launchd',\n    'bioutil,0,callservicesd,launchd',\n\
    \    'CAReportingService,0,LogiTune,launchd',\n    'com.apple.AccountPolicyHelper,0,LogiTune,launchd',\n\
    \    'com.apple.geod,0,fmfd,launchd',\n    'com.apple.geod,262,com.docker.backend,Docker',\n\
    \    'com.apple.WebKit.WebContent,200,zsh,Emacs-arm64-11',\n    'containermanagerd,262,com.docker.backend,Docker',\n\
    \    'dprivacyd,0,com.docker.backend,Docker',\n    'efilogin-helper,0,containermanagerd,launchd',\n\
    \    'SCHelper,0,com.docker.backend,Docker',\n    'suhelperd,0,LogiTune,launchd',\n\
    \    'sysextd,0,LogiTune,launchd',\n    'system_profiler,0,callservicesd,launchd',\n\
    \    'trustd,205,trustd,launchd'\n  )\n  AND NOT (\n    pe.euid = 262 -- core\
    \ media helper id\n    AND pe.path = '/System/Library/Frameworks/CoreMediaIO.framework/Versions/A/Resources/AppleCamera.plugin/Contents/Resources/AppleCameraAssistant'\n\
    \  )\n"
  platform: darwin
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
