---
apiVersion: v1
kind: query
spec:
  name: CDK - Fake Apple Launchd
  platform: darwin
  description: Find launchd entries which purport to be by Apple, but point to binaries that are not signed by Apple.
  query: |
    SELECT
      *
    FROM
      launchd
      LEFT JOIN file ON launchd.path = file.path
      LEFT JOIN signature ON launchd.program_arguments = signature.path
    WHERE
      launchd.name LIKE 'com.apple.%'
      -- Optimization, assumes SIP
      AND file.directory NOT IN (
        '/Library/Apple/System/Library/LaunchAgents',
        '/Library/Apple/System/Library/LaunchDaemons',
        '/System/Library/LaunchAgents',
        '/System/Library/LaunchDaemons'
      )
      AND launchd.run_at_load = 1
      AND signature.authority != 'Software Signing'
  interval: 3600
  logging: snapshot
  observer_can_run: true
  automations_enabled: false
  discard_data: false
  team: devices
