- name: CDK - Yara Mounted Stealer
  description: Look for sketchy mounted disk images, inspired by Shlayer
  query: "SELECT\n  RTRIM(file.path, '/') AS f,\n  file.bsd_flags AS f_flags,\n  file.gid\
    \ AS f_gid,\n  file.mode AS f_mode,\n  file.size AS f_size,\n  file.type AS f_type,\n\
    \  REGEX_MATCH (file.filename, '.*\\.(.*?)$', 1) AS f_ext,\n  file.uid AS f_uid,\n\
    \  hash.sha256 AS f_sha256,\n  magic.data AS f_data,\n  mdfind.path AS probable_source,\n\
    \  mdhash.sha256 AS probable_source_sha256,\n  ea.value AS probable_url,\n  REGEX_MATCH\
    \ (file.path, '/Volumes/(.*?)/', 1) AS vol_name,\n  signature.authority AS s_auth,\n\
    \  signature.identifier AS s_id,\n  yara.*\nFROM\n  file\n  JOIN yara ON file.path\
    \ = yara.path\n  LEFT JOIN mdfind ON mdfind.query = \"kMDItemFSName == '*\" ||\
    \ REGEX_MATCH (file.path, '/Volumes/(\\w+)', 1) || \"*.dmg'\"\n  LEFT JOIN extended_attributes\
    \ ea ON mdfind.path = ea.path\n  AND ea.key = 'where_from'\n  LEFT JOIN hash on\
    \ file.path = hash.path\n  LEFT JOIN hash mdhash ON mdfind.path = mdhash.path\n\
    \  LEFT JOIN magic ON file.path = magic.path\n  LEFT JOIN signature ON file.path\
    \ = signature.path\nWHERE\n  file.path IN (\n    SELECT\n      file.path\n   \
    \ FROM\n      block_devices\n      JOIN mounts ON mounts.device = block_devices.name\n\
    \      JOIN file ON file.directory = mounts.path\n      OR file.directory LIKE\
    \ mounts.path || \"/%.app/Contents/MacOS/\"\n      OR file.directory LIKE mounts.path\
    \ || \"/%.app/Contents/Resources/\"\n      OR file.directory LIKE mounts.path\
    \ || \"/%/%.app/Contents/Library/LaunchServices\"\n      OR file.directory LIKE\
    \ mounts.path || \"/%/%.app/Contents/MacOS/\"\n      OR file.directory LIKE mounts.path\
    \ || \"/%/%.app/Contents/Resources/\"\n    WHERE\n      model = 'Disk Image'\n\
    \      AND parent != \"\"\n      AND mounts.path LIKE \"/Volumes/%\"\n      --\
    \ osquery will traverse symlinks, this prevents following symlinks to /Applications\
    \ (poorly)\n      AND file.path NOT LIKE \"/Volumes/%/Applications/%\"\n     \
    \ AND (\n        file.mode LIKE \"%7%\"\n        OR file.mode LIKE \"%5%\"\n \
    \       OR file.mode LIKE \"%1%\"\n      )\n      AND file.type = \"regular\"\n\
    \  )\n  AND magic.data LIKE \"%Executable%\"\n  AND yara.sigrule = '\n    rule\
    \ stealer {\n    strings:\n        $brave_software = \"BraveSoftware\" ascii\n\
    \        $cookies_sqlite = \"cookies.sqlite\" ascii\n        $data_stealers =\
    \ \"data_stealers\" ascii\n        $find_generic_password = \"find-generic-password\"\
    \ ascii\n        $library_keychains = \"/Library/Keychains\" ascii\n        $moz_cookies\
    \ = \"moz_cookies\" ascii\n        $operagx = \"OperaGX\" ascii\n        $osascript\
    \ = \"osascript\" ascii\n\n    condition:\n        2 of them\n}'\n  AND yara.count\
    \ > 0\n  AND NOT (\n    vol_name = \"Docker\"\n    AND s_auth = \"Developer ID\
    \ Application: Docker Inc (9BNSXJN65R)\"\n  )\nGROUP BY\n  file.path\n"
  platform: darwin
  interval: 3600
  observer_can_run: true
  automations_enabled: false
  logging: snapshot
  discard_data: false
